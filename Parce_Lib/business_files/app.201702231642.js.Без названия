
var addLoadEvent=function(func){var oldonload=window.onload;if(typeof window.onload!='function'){window.onload=func;}else{window.onload=function(){oldonload();func();}}}
addDOMLoadEvent=(function(){var load_events=[],load_timer,script,done,exec,old_onload,init=function(){done=true;clearInterval(load_timer);while(exec=load_events.shift())
exec();if(script)script.onreadystatechange='';};return function(func){if(done)return func();if(!load_events[0]){if(document.addEventListener)
document.addEventListener("DOMContentLoaded",init,false);if(/WebKit/i.test(navigator.userAgent)){load_timer=setInterval(function(){if(/loaded|complete/.test(document.readyState))
init();},10);}
old_onload=window.onload;window.onload=function(){init();if(old_onload)old_onload();};}
load_events.push(func);}})();var BooksJSLoaded=false;var DebatesJSLoaded=false;var SubscriptionJSLoaded=false;var SourceJSLoaded=false;var ConstJSLoaded=false;var GroupEditionsJSLoaded=false;var WidgetJSLoaded=false;var EBooksJSLoaded=false;var TagGroupJSLoaded=false;var LiveLibListClass=new Class({initialize:function(event,elementclass)
{this.objList=Array();this.objListH=Array();this.objInitList=Array();this.objInitListOID=Array();this.event=event;this.elementclass=elementclass;},addObject:function(book_id,object_id)
{if(book_id==''||object_id=='')return;this.objInitList.push(book_id);this.objInitListOID.push(object_id);},bindAll:function()
{for(i=0;i<this.objInitList.length;i++)
{this.objList[i]=new this.elementclass(this.objInitList[i]);this.objListH[i]=this.objList[i].send.bindWithEvent(this.objList[i]);$(this.objInitListOID[i]).addEvent(this.event,this.objListH[i]);}},unbindAll:function()
{for(i=0;i<this.objInitList.length;i++)
{if($(this.objInitListOID[i]))
{$(this.objInitListOID[i]).removeEvent(this.event,this.objListH[i]);}}},clear:function()
{this.unbindAll();this.objList=Array();this.objListH=Array();this.objInitList=Array();this.objInitListOID=Array();}});function BindList(HTMLClass,ListObject){if($$(HTMLClass).length>0){ListObject.clear();}
$$(HTMLClass).each(function(item){id=item.id.substr(item.id.lastIndexOf('-')+1);ListObject.addObject(id,item.id);});if($$(HTMLClass).length>0)ListObject.bindAll();}
var trim=function($str){return $str.replace(/^\s+|\s+$/g,"");}
var strToQueryString=function(str)
{var reg=new RegExp('([\\\\"])','g');str=str.replace(reg,'\\$1');str=encodeURIComponent(str);return str;}
function xshow(el){if($(el)!='undefined'&&$(el)!=null)$(el).setStyle('display','');}
function xhide(el){if($(el)!='undefined'&&$(el)!=null)$(el).setStyle('display','none');}
function hidemenu(classname)
{var menus=document.getElementsByTagName('div');for(var i=0;i<menus.length;i++)
{if(menus[i]!=undefined&&menus[i].className==classname)
{menus[i].style.display='none';}}}
function hidegenrespopup(event,classname)
{if($(event.target).className===classname)return;var parent_nodes=$(event.target).getParents();for(var i=0;i<parent_nodes.length;i++)
{if(parent_nodes[i].className===classname)
{return;}}
var menus=document.getElementsByTagName('ul');for(var i=0;i<menus.length;i++)
{if(menus[i]!=undefined&&menus[i].className==classname)
{menus[i].style.display='none';}}}
function xshow_stop(el,evt)
{var evt=(evt)?evt:((window.event)?event:null)
xshow(el);evt.cancelBubble=true;}
function xtoggle(el,dspl){if($(el)=='undefined'||$(el)==null)return false;dspl=typeof(dspl)!='undefined'?dspl:'block';$(el).style.display=$(el).style.display=='none'?dspl:'none';return false;}
function xtoggle2(el,toggler,text1,text2){if($(el)=='undefined'||$(el)==null)return false;var style=$(el).style.display;$(el).style.display=style=='none'?'block':'none';var icon_expand='<span class="i-expand"></span>';var icon_collapse='<span class="i-collapse"></span>';var is_new_design=$('is-new-design')?$('is-new-design').value:'';if(is_new_design=='ll2015b')
{icon_expand='';icon_collapse='';}
if($(toggler)=='undefined'||$(toggler)==null)return false;if(style=='none')
{$(toggler).innerHTML=icon_collapse+text2;$(toggler).setAttribute('title',text2);}
else
{$(toggler).innerHTML=icon_expand+text1;$(toggler).setAttribute('title',text1);}
return false;}
function xtoggleadvisor(el,toggler,text1,text2){if($(toggler)=='undefined'||$(toggler)==null)return false;var elements=getElementsByName('tr',el);if(elements.length==0)return false;var style=$(toggler).innerHTML.indexOf(text1)!=-1?'table-row':'none';for(var i=0;i<elements.length;i++)
{elements[i].style.display=style;}
if(style=='none')
{$(toggler).innerHTML='<span class="i-expand"></span>'+text1;$(toggler).setAttribute('title',text1);}
else
{$(toggler).innerHTML='<span class="i-collapse"></span>'+text2;$(toggler).setAttribute('title',text2);}
return false;}
function xtoggle2all(elname,toggler,text1,text2)
{var elements=getElementsByName('div',elname);var eltoggler;var hide_mob_advices;var now=new Date();var time=now.getTime();var icon_expand='<span class="i-expand"></span>';var icon_collapse='<span class="i-collapse"></span>';var is_new_design=$('is-new-design')?$('is-new-design').value:'';if(is_new_design=='ll2015b')
{icon_expand='';icon_collapse='';}
if(elements.length==0)return false;var display=$(toggler).innerHTML.indexOf(text1)!=-1?'none':'block';for(var i=0;i<elements.length;i++)
{eltoggler=$('mob-responses-toggler-'+elements[i].attributes.getNamedItem('id').value.substring(14));if(eltoggler!=null){elements[i].style.display=display;if(display=='none')
{eltoggler.innerHTML=icon_expand+text2;eltoggler.setAttribute('title',text2);}
else
{eltoggler.innerHTML=icon_collapse+text1;eltoggler.setAttribute('title',text1);}}}
if(display=='none')
{$(toggler).innerHTML=icon_expand+text2+' все заявки';$(toggler).setAttribute('title',text2);hide_mob_advices=0;}
else
{$(toggler).innerHTML=icon_collapse+text1+' все заявки';$(toggler).setAttribute('title',text1);hide_mob_advices=1;}
time+=3600*24*7*1000;now.setTime(time);document.cookie='hide_mob_advices='+hide_mob_advices+'; expires='+now.toUTCString();return false;}
function xtoggle2alladvisors(elname,toggler,text1,text2)
{var elements=getElementsByName('input',elname);var eltoggler;if(elements.length==0)return false;var display=$(toggler).innerHTML.indexOf(text1)!=-1?'none':'table-row';for(var i=0;i<elements.length;i++)
{eltoggler=$('mob-advisors-toggler-'+elements[i].attributes.getNamedItem('id').value.substring(12));var el=elements[i].attributes.getNamedItem('id').value.substring(12);if(eltoggler!=null)
{var elem=getElementsByName('tr',el);if(elem.length>0)
{for(var j=0;j<elem.length;j++)
{elem[j].style.display=display;}}
if(display=='none')
{eltoggler.innerHTML='<span class="i-expand"></span>'+text2;eltoggler.setAttribute('title',text2);}
else
{eltoggler.innerHTML='<span class="i-collapse"></span>'+text1;eltoggler.setAttribute('title',text1);}}}
if(display=='none')
{$(toggler).innerHTML='<span class="i-expand"></span>'+text2+' всех советчиков';$(toggler).setAttribute('title',text2);}
else
{$(toggler).innerHTML='<span class="i-collapse"></span>'+text1+' всех советчиков';$(toggler).setAttribute('title',text1);}
return false;}
function getElementsByName(tag,name)
{var elem=document.getElementsByTagName(tag);var arr=new Array();var iarr=0;for(var i=0;i<elem.length;i++)
{att=elem[i].getAttribute("name");if(att==name)
{arr[iarr]=elem[i];iarr++;}}
return arr;}
var showLoading=false;var periodical;var initAd=function()
{xshow('systemWorking');showLoading=true;showAd();periodical=showAd.periodical(100);}
var showAd=function()
{if(showLoading){if($('systemWorking'))$('systemWorking').setStyle('top',window.getScrollTop()+20);}
else
{$clear(periodical);}}
var closeAd=function(text,xml)
{xhide('systemWorking');showLoading=false;$clear(periodical);}
var failure=function(t)
{if($('systemWorking'))$('systemWorking').innerHTML='Error!';}
var prepare=function(json,param1,param2)
{if(json&&json.tologin&&$('popup-login'))
{if(!$('ulogin-script'))
{var script=new Element('script',{id:'ulogin-script',type:'text/javascript',src:'https://ulogin.ru/js/ulogin.js'});document.getElementsByTagName('body')[0].appendChild(script);}
loginform_show(param1,param2);}
else if(json&&json.confirm_email&&$('popup-confirm-email'))
{if(!$('ulogin-script'))
{var script=new Element('script',{id:'ulogin-script',type:'text/javascript',src:'https://ulogin.ru/js/ulogin.js'});document.getElementsByTagName('body')[0].appendChild(script);}
if($$('.popup-back-ce'))$$('.popup-back-ce').show();$('popup-confirm-email').show();throw new Error();}}
var callback_function=null;var loginform_show=function(redirect,onclick,callback,form)
{if(!$('ulogin-script'))
{var script=new Element('script',{id:'ulogin-script',type:'text/javascript',src:'https://ulogin.ru/js/ulogin.js'});document.getElementsByTagName('body')[0].appendChild(script);}
if($$('.popup-back'))$$('.popup-back').show();$('popup-login').show();if($('popup-input-redirect-login'))$('popup-input-redirect-login').value=redirect?redirect:'';if($('popup-input-redirect-register'))$('popup-input-redirect-register').value=redirect?redirect:'';if($('popup-input-onclick-login'))$('popup-input-onclick-login').value=onclick?onclick:'';if($('popup-input-onclick-register'))$('popup-input-onclick-register').value=onclick?onclick:'';if(callback)callback_function=callback;if(form&&form=='register')
{$$('.popup-menu tr td').removeClass('active');$$('.popup-menu tr td')[0].addClass('active');$$('.loginform-popup-login').hide();$$('.loginform-popup-registr').show();}
else if(form&&form=='login')
{$$('.popup-menu tr td').removeClass('active');$$('.popup-menu tr td')[1].addClass('active');$$('.loginform-popup-registr').hide();$$('.loginform-popup-login').show();}
bind_captcha();}
var loginform_close=function()
{$$('.popup-back').hide();if($('popup-login'))$('popup-login').hide();$$('.social-hide-popup').hide();if($('social-popup-more'))$('social-popup-more').show('inline');if($('popup-input-redirect-login'))$('popup-input-redirect-login').value='';if($('popup-input-redirect-register'))$('popup-input-redirect-register').value='';if($('popup-input-onclick-login'))$('popup-input-onclick-login').value='';if($('popup-input-onclick-register'))$('popup-input-onclick-register').value='';callback_function=null;}
var texteditors=Array();function ll_texteditor_bind(item)
{var llcut=item.hasClass('llcut');var llicons=item.hasClass('llicons');texteditors[texteditors.length]=new TextEditorClass('te'+item.id,llcut,llicons);texteditors[texteditors.length-1].expand({'id':item.id,'name':item.name!=undefined?item.name:'ta','rows':item.rows!=undefined?item.rows:10,'onfocus':item.onfocus!=undefined?item.getAttribute('onfocus'):''});}
var bindLoadEvents=function()
{BindList('.editions-open',editions);$$('.texteditor').each(function(item){ll_texteditor_bind(item);});$$('.shareouter').each(function(item){item.addEvent('mouseover',function(){this.setStyle('border-color','#777777 #bbbbbb #bbbbbb #777777');});item.addEvent('mouseout',function(){this.setStyle('border-color','#bbbbbb #777777 #777777 #bbbbbb');});});if($('txtRainbow'))
var r=new MooRainbow('imgRainbow',{'startColor':[0x34,0x7c,0xd4],'onChange':function(color){$('txtRainbow').value=color.hex;}});if($('register-form'))
{$('register-form').removeEvent('submit',emailcheckobj.check);$('register-form').addEvent('submit',emailcheckobj.check);}
if($('invite-form'))
{$('invite-form').removeEvent('submit',emailcheckobj.check);$('invite-form').addEvent('submit',emailcheckobj.check);}
if($('form[editreview]'))
{$('form[editreview]').removeEvent('submit',editreviewobj.save);$('form[editreview]').addEvent('submit',editreviewobj.save);}
if($('form[editquote]'))
{$('form[editquote]').removeEvent('submit',editquoteobj.save);$('form[editquote]').addEvent('submit',editquoteobj.save);}
if($('form[editselection]'))
{$('form[editselection]').removeEvent('submit',editselectionobj.save);$('form[editselection]').addEvent('submit',editselectionobj.save);}
if($('form[editstory]'))
{$('form[editstory]').removeEvent('submit',editstoryobj.save);$('form[editstory]').addEvent('submit',editstoryobj.save);}
$$('.post-yvideo').each(function(item){$(item).addEvent('click',function(){var video_id=this.dataset.video_id;var width=this.dataset.width;var height=this.dataset.height;this.innerHTML=' <iframe width="'+width+'" height="'+height+'" src="https://www.youtube.com/embed/'+video_id+'?autoplay=1" frameborder="0" allowfullscreen></iframe> ';});});BindList('.ebook-status',ebookstatuschangelist);BindList('.ebook-request-status',ebookrequeststatuschangelist);if(BooksJSLoaded)
{bindBooksLoadEvents();}
if(SubscriptionJSLoaded)
{bindSubscriptionLoadEvents();}
if(GroupEditionsJSLoaded)
{bindGroupEditionsLoadEvents();}
if(WidgetJSLoaded)
{bindWidgetLoadEvents();}
if(EBooksJSLoaded)
{bindEBooksLoadEvents();}
if(TagGroupJSLoaded)
{bindTagGroupLoadEvents();}
if($('genre-ajax'))
{var is_new_design=$('is-new-design')?$('is-new-design').value:0;new Request({method:'post',url:'/genre/tree',onComplete:function(json)
{json=strToJson(json);if(json.html)
{$('genre-ajax').set('html',json.html);xshow('genre-ajax');}}}).send('is_new_design='+is_new_design+'&genre='+$('genre-ajax').innerHTML);}
if($('side-ajax'))
{var_side_params='referer='+encodeURIComponent(location.href);if($('side-ajax-area'))var_side_params+='&area='+$('side-ajax-area').value;if($('side-ajax-no'))var_side_params+='&no='+$('side-ajax-no').value;if($('side-ajax-object-alias'))var_side_params+='&object='+encodeURIComponent($('side-ajax-object-alias').value);if($('side-ajax-object-id'))var_side_params+='&id='+encodeURIComponent($('side-ajax-object-id').value);if($('side-ajax-promo-block'))var_side_params+='&promo_block='+encodeURIComponent($('side-ajax-promo-block').value);var context_url='/side/index';new Request({method:'post',url:context_url,onComplete:function(json)
{json=strToJson(json);if(json.html)
{$('side-ajax').set('html',json.html);xshow('side-ajax');if($('side-context-book')&&$('source-context-book'))
{$('side-context-book').appendChild($('source-context-book'));}}
else
{}
side_scroll_init();}}).send(var_side_params);}
if($('llad'))
{$('llad').innerHTML='<iframe src="https://www.livelib.ru/240x403.htm" width="240" height="400" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" vspace="0" hspace="0"></iframe>';}
if($('lltad'))
{$('lltad').innerHTML='<iframe src="https://s.livelib.ru/rotate/1000x90.html" width="100%" height="90" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" vspace="0" hspace="0"></iframe>';}
if($('redirect-timer'))
{setInterval('redirect_delay(\'redirect-time\')',1000);}
if($('id-login'))
{service_pinger(1);if($('recs-wait'))
new Request({method:'post',url:'/rec/pinger',initialDelay:10000,delay:10000,limit:120000,onComplete:function(json)
{json=strToJson(json);if(json.recs_ready)location.reload();}}).startTimer({});if($('teaser-holder'))
{new Request({method:'post',url:'/book/getteaser',onComplete:function(json)
{json=strToJson(json);if(json.content)
{$('teaser-holder').innerHTML=json.content;}}}).send();}
if($('ebook-block'))
{new Request({method:'post',url:'/book/ebooks/'+$('ebook-block').getAttribute('data-book'),onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.content)
{$('ebook-block').innerHTML=json.content;}}}).send();}}
if($('hint-holder'))
{new Request({method:'post',data:{url:location.pathname},url:'/hint/slides',onComplete:function(json)
{json=strToJson(json);if(json.content)
{$('hint-holder').innerHTML=json.content;$('hint-holder').show();if($('body'))$('body').addClass('hint-visible');if(json.hash)location.hash=json.hash;var gallery=new slideGallery($('slides'),{current:0,steps:1,mode:"line",random:false,stop:".stop",start:".start",duration:7000,speed:400,margin:0,paging:true,nextItem:'.next-carousel',prevItem:'.prev-carousel',onPlay:function(current,visible,count,element){if(current+1==count)
{if(!$('hint-close'))
{var div=new Element('div',{'id':'hint-close','class':'popup-close','onclick':'hint_close('+json.hint_id+');'});$('slides').parentNode.insertBefore(div,$('slides'));}
else
{$('hint-close').show();}}
else if($('hint-close'))$('hint-close').hide();}});}}}).send();}
if($('lead-button'))
{var edition_id=$('lead-button').getAttribute('data-book');var is_new_design=$('is-new-design')?$('is-new-design').value:0;new Request({method:'post',url:'/lead/getbutton',onComplete:function(json)
{json=strToJson(json);if(json.providers&&typeof(ga)=='function')
{var reg='';if($('id-login')&&$('id-login').value&&$('id-login').value!='')reg='/reg';for(var t=0;t<json.providers.length;t++)
{ga('send','pageview','/virtual_url/leadgen/show/'+json.providers[t].ga_name+reg);}}
if(json.content)
{$('lead-button').innerHTML=json.content;$('lead-button').show();}}}).send("edition_id="+edition_id+"&is_new_design="+is_new_design);}
if($('lead-button-left'))
{var edition_id=$('lead-button').getAttribute('data-book');var is_new_design=$('is-new-design')?$('is-new-design').value:0;new Request({method:'post',url:'/lead/getleftbutton',onComplete:function(json)
{json=strToJson(json);if(json.providers&&typeof(ga)=='function')
{var reg='';if($('id-login')&&$('id-login').value&&$('id-login').value!='')reg='/reg';for(var t=0;t<json.providers.length;t++)
{ga('send','pageview','/virtual_url/leadgen/show/'+json.providers[t].ga_name+reg);}}
if(json.content)
{$('lead-button-left').innerHTML=json.content;$('lead-button-left').show();}}}).send("edition_id="+edition_id+"&is_new_design="+is_new_design);}
if($('sources-ajax'))
{var source_edition_id=$('sources-edition-id').value;var is_new_design=$('is-new-design')?$('is-new-design').value:0;new Request({method:'post',url:'/book/getsources',onComplete:function(json)
{json=strToJson(json);if(json.content)
{$('sources-ajax').innerHTML=json.content;}}}).send("edition_id="+source_edition_id+"&is_new_design="+is_new_design);}
if($('sources-api-ajax2'))
{var source_edition_id=$('sources-edition-id').value;var is_new_design=$('is-new-design')?$('is-new-design').value:0;new Request({method:'post',url:'/api/bookprice',onComplete:function(json)
{json=strToJson(json);if(json.data)
{var result=Array();result.paper=Array();result.ebook=Array();result.audio=Array();json.data.each(function(item){if(!result[item.type])result[item.type]=Array();result[item.type].push(item);});var count_paper=result.paper?result.paper.length:0;var count_ebook=result.ebook?result.ebook.length:0;var count_audio=result.audio?result.audio.length:0;var max_rows=5;var html='';for(var t in result)
{var first=true;if(result[t].length>0&&typeof(result[t])=='object')
{var i=0;result[t].each(function(item){if(first)
{if(item.type=='paper')
{html+='<h2>Купить бумажную книгу</h2>';max_rows=5;}
else if(item.type=='ebook')
{html+='<h2 class="source-ebook">Скачать электронную книгу</h2>';max_rows=1;}
else if(item.type=='audio')
{html+='<h2 class="source-ebook">Купить аудиокнигу</h2>';max_rows=1;}
html+='<table cellspacing="0"><tbody>';first=false;}
if(i>=max_rows)html+='</tbody><tbody class="sources-hide" style="display:none;">';html+='<tr>';html+='<td><a onclick="ga(\'send\', \'event\', \'book-buy\', '+source_edition_id+', \''+item.shop_title+'\', 1);" target="_blank" class="source-action" href="'+item.shop_url+'"><img src="'+item.shop_icon+'" style="width:16px;vertical-align: -3px;margin-right: 3px;">'+item.shop_title+'</a></td>';html+='<td style="text-align: right; font-weight: bold; color: '+(item.currency=='UAH'||item.currency=='BYR'?'#2A9430':'#0768D8')+';">';html+='<span class="source-action" style="white-space: nowrap;margin-left:'+(item.currency=='BYR'?-20:10)+'px; padding-left: 2px;">'+item.price_lbl+'</span>'+(item.is_discount?'<br><span style="color: red;">скидка!</span>':'');html+='</td>';if($('sources-advert'))html+='<td style="padding-top: 0px;width: 20px;"><a href="/context/createadvert/book/'+source_edition_id+'/source/'+item.source_original_id+'" title="Создать объявление" style="margin:0px 0px 5px 0px;"><span class="i-fragment"></span></a></td>';if($('sources-link-shop'))html+='<td style="width:26px;">'+(item.shop_url_exact!=''?'<a href="'+item.shop_url_exact+'"><span style="margin: -3px 0 0px 4px;" class="i-book-info"></span></a>':'')+'</td>';html+='</tr>';i++;});html+='</tbody></table>';}}
$('sources-api-ajax').show();$('source-blocks').innerHTML=html;if(count_paper<5&&count_ebook<1&&count_audio<1)
{if($$('#sources-api-ajax .sources-inner'))$$('#sources-api-ajax .sources-inner')[0].addClass('full');}
if(count_ebook>1||count_paper>5||count_audio>1)
{if($$('#sources-api-ajax .sources-footer'))$$('#sources-api-ajax .sources-footer')[0].show();}}}}).send("id="+source_edition_id+'&api_key=419056879c250c02fd39fd2c9034071d');}
if($('friend-ratings')&&$('friend-ratings-book'))
{var fr_book_id=$('friend-ratings-book').value;get_friends_readers(fr_book_id);}
if($('viewed-objects'))
{var object_alias=$('viewed-object-alias')?$('viewed-object-alias').value:'';var object_id=$('viewed-object-id')?$('viewed-object-id').value:0;new Request({method:'post',data:{object_alias:object_alias,object_id:object_id},url:'/main/viewed',onComplete:function(json)
{json=strToJson(json);if(json.content)
{$('viewed-objects').innerHTML=json.content;}}}).send();}}
addDOMLoadEvent(bindLoadEvents);function Message(){}
Message.prototype={clear:function(){if($('message'))
{$('message').innerHTML='';}},display:function(message)
{div=document.createElement('div');div.id='message';tbl=document.createElement('table');tbl.className='message1';div.appendChild(tbl);tr=document.createElement('tr');tbl.appendChild(tr);td1=document.createElement('td');if(message.status)
{td1.className="message1-image";td1.innerHTML='?!';}
else
{td1.className="message-image";td1.innerHTML='OK';}
tr.appendChild(td1);td2=document.createElement('td');td2.className="message-text";td2.innerHTML=message.text;tr.appendChild(td2);$('message').innerHTML=div.innerHTML;}}
messageobj=new Message();function Remover(){};Remover.prototype={processRemove:function(originalRequest)
{data=strToJson(originalRequest);if(data.message)
{messageobj.display(data.message);return;}
xhide(data.elem_id);if(data.elem_id2)
{xhide(data.elem_id2);}},send:function(url,pars)
{new Request({url:url,method:'post',onComplete:this.processRemove,onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send(pars);}}
var remover=new Remover();function EmailChecker(){};EmailChecker.prototype={check:function(e)
{e=new Event(e);if($("invite-form"))
{if($("invite[email]").value==''||$("invite[name]").value=='')
{alert('Пожалуйста, заполните поля формы!');e.stop();return false;}
else
{if($("invite[email]").value!='')
{var email=trim($("invite[email]").value);var reg=new RegExp("^[0-9a-zA-Z_\\.\\-]+@[0-9a-zA-Z_\\.\\-]+?\\.[a-zA-Z]+$",'i');if(!reg.test(email))
{alert('Недопустимый email адрес');e.stop();return false;}
else
{return true;}}
else
{alert('Недопустимый email адрес');e.stop();return false;}}}
else
{if($("register[email]").value==''||$("register[login]").value==''||$("register[password]").value=='')
{alert("Пожалуйста, заполните поля Email, Логин и Пароль!");e.stop();return false;}
else
{if($("register[email]").value!='')
{var email=trim($("register[email]").value);var reg=new RegExp("^[0-9a-zA-Z_\\.\\-]+@[0-9a-zA-Z_\\.\\-]+?\\.[a-zA-Z]+$",'i');if(!reg.test(email))
{alert('Неверный email адрес');e.stop();return false;}
else
{return true;}}
else
{alert('Неверный email адрес');e.stop();return false;}}}}}
var emailcheckobj=new EmailChecker();var Edition=new Class({initialize:function(book_id)
{this.book_id=book_id;},processOpen:function(originalRequest)
{data=strToJson(originalRequest);if(data.message)
{messageobj.display(data.message);return;}
$('editions-'+this.book_id).innerHTML=data.html;xshow('editions-'+this.book_id);loadBookThumbnails();},send:function()
{xhide('editions-plus-'+this.book_id);xshow('editions-minus-'+this.book_id);xshow('editions-tr-'+this.book_id);xshow('editions-hide-'+this.book_id);if($('editions-plus-1-'+this.book_id))
{xhide("editions-plus-1-"+this.book_id);}
new Request({url:'/edition/'+this.book_id,method:'post',onComplete:this.processOpen.bind(this),onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();return false;}});editions=new LiveLibListClass('click',Edition);var EBookStatusChangeClass=new Class({initialize:function(id)
{this.id=id},processUpdate:function(originalRequest)
{data=strToJson(originalRequest);if(data.message)
{messageobj.display(data.message);return;}
if($$('.ebook-status').length>0)ebookstatuschangelist.clear();$('request-status-div-'+this.id).innerHTML=data.html;$$('.ebook-status').each(function(item){id=item.id.substr(item.id.lastIndexOf('-')+1);ebookstatuschangelist.addObject(id,item.id);});if($$('.ebook-status').length>0)ebookstatuschangelist.bindAll();},send:function()
{url='/ebooks/changestatus/'+this.id+'/'+$('request-status-select-'+this.id).value;new Request({url:url,method:'post',onComplete:this.processUpdate.bind(this),onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();return false;}});ebookstatuschangelist=new LiveLibListClass('change',EBookStatusChangeClass);var EBookRequestStatusChangeClass=new Class({initialize:function(id)
{this.id=id},processUpdate:function(originalRequest)
{data=strToJson(originalRequest);if(data.message)
{messageobj.display(data.message);return;}
if($$('.ebook-request-status').length>0)ebookrequeststatuschangelist.clear();$('ebook-request-status-div-'+this.id).innerHTML=data.html;$$('.ebook-request-status').each(function(item){id=item.id.substr(item.id.lastIndexOf('-')+1);ebookrequeststatuschangelist.addObject(id,item.id);});if($$('.ebook-request-status').length>0)ebookrequeststatuschangelist.bindAll();},send:function()
{url='/ebooks/changestatusrequest/'+this.id+'/'+$('ebook-request-status-select-'+this.id).value;new Request({url:url,method:'post',onComplete:this.processUpdate.bind(this),onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();return false;}});ebookrequeststatuschangelist=new LiveLibListClass('change',EBookRequestStatusChangeClass);var MessagesListClass=new Class({initialize:function()
{},processUpdate:function(originalRequest)
{data=strToJson(originalRequest);if(data.message)
{messageobj.display(data.message);return;}
deleted_ids=data.deleted_ids.split(',');for(i=0;i<deleted_ids.length;i++)
{if(deleted_ids[i]>0)
{if($('message-'+deleted_ids[i]))
{$('message-'+deleted_ids[i]).dispose();}
if($('message2-'+deleted_ids[i]))
{$('message2-'+deleted_ids[i]).dispose();}}}},send:function()
{url='/messages/massdelete';ids='';$$('.messages-list-checkbox').each(function(item){item_id=item.id.substr(item.id.lastIndexOf('-')+1);if(item.checked)
{ids+=item_id+',';}});if(ids=='')
{alert("Выберите одно или несколько сообщений");$('messages-list-form').reset();}
else
{if(confirm("Удалить выбранные сообщения из списка. Вы уверены?"))
{pars="act=delete&message_ids="+strToQueryString(ids);new Request({url:url,method:'post',onComplete:messageslist.processUpdate,onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send(pars);}
$('messages-list-form').reset();}}});messageslist=new MessagesListClass();function EditReview(){}
EditReview.prototype={save:function(event)
{if($('review[remove]'))
if($('review[remove]').checked)
if(!confirm('Удалить рецензию?'))
return false;$('form[editreview]').submit();return false;}}
var editreviewobj=new EditReview();function EditQuote(){}
EditQuote.prototype={save:function(event)
{if($('quote[remove]'))
if($('quote[remove]').checked)
if(!confirm('Удалить цитату?'))
return false;$('form[editquote]').submit();return false;}}
var editquoteobj=new EditQuote();function EditSelection(){}
EditSelection.prototype={save:function(event)
{if($('selection[remove]'))
if($('selection[remove]').checked)
if(!confirm($('selection[category]')&&($('selection[category]').value==3||$('selection[category]').value==4)?'Удалить полку?':'Удалить подборку?'))
return false;$('form[editselection]').submit();return false;}}
var editselectionobj=new EditSelection();function EditStory(){}
EditStory.prototype={save:function(event)
{if($('story[remove]'))
if($('story[remove]').checked)
if(!confirm('Удалить историю?'))
return false;$('form[editstory]').submit();return false;}}
var editstoryobj=new EditStory();Resize={addEvent:function(t,ev,fn)
{if(typeof document.addEventListener!='undefined')
{t.addEventListener(ev,fn,false);}
else
{t.attachEvent('on'+ev,fn);}},removeEvent:function(t,ev,fn)
{if(typeof document.removeEventListener!='undefined')
{t.removeEventListener(ev,fn,false);}
else
{t.detachEvent('on'+ev,fn);}},init:function(nid,worker)
{if(Resize)
{Resize.worker=document.getElementById(worker);Resize.worker.style.cursor='s-resize';Resize.targetElement=document.getElementById(nid);Resize.addEvent(document,'mousedown',Resize.initResize);}},initResize:function(event)
{if(typeof event=='undefined')
{event=window.event;}
Resize.targetElement.startHeight=Resize.targetElement.clientHeight;Resize.targetElement.startY=event.clientY;Resize.addEvent(document,'mousemove',Resize.resize);Resize.addEvent(document,'mouseup',Resize.stopResize);try
{event.preventDefault();}
catch(e)
{}},resize:function(event)
{if(typeof event=='undefined')
{event=window.event;}
height_tmp=event.clientY-Resize.targetElement.startY+Resize.targetElement.startHeight;if(height_tmp<20)
{height_tmp=20;}
Resize.targetElement.style.height=height_tmp+'px';},stopResize:function(event)
{Resize.removeEvent(document,'mousedown',Resize.initResize);Resize.removeEvent(document,'mousemove',Resize.resize);Resize.worker.style.cursor='text';}};ll_quote_add=function(book_id)
{if(book_id)location.href='/quote/create/'+book_id;return false;}
ll_selection_add_book=function(book_id,is_work)
{if(!confirm('Добавить '+(is_work?'произведение':'книгу')+' в подборку?'))return false;var selection=$('selection-id');if(book_id)
{new Request({url:'/selection/addbook',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.message);}
else
{location.href=json.redirect;}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("book_id="+book_id+"&selection_id="+selection.value);}
return false;}
ll_selection_add_tag=function()
{var selection=$('selection-id');var tag=$('tag-select');if(tag!=undefined)location.href='/selection/addtag/'+selection.value+'/'+tag.options[tag.selectedIndex].value;return false;}
ll_book_add_to_selection=function(book_id)
{var dropdown=$('select-add-selection-book-'+book_id);var selection_id=dropdown.options[dropdown.selectedIndex].value;if(selection_id&&selection_id!='0')location.href='/selection/addbook/'+selection_id+'/'+book_id;return false;}
ll_selection_add_book_to_sel=function(selection_id,book_id,is_work)
{if(!confirm('Добавить '+(is_work?'произведение':'книгу')+' в подборку?'))return false;if(book_id)
{new Request({url:'/selection/addbook',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.message);}
else
{if($('sel-book-'+book_id))$('sel-book-'+book_id).dispose();}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("book_id="+book_id+"&selection_id="+selection_id);}
return false;}
ll_vote=function(object_alias,object_id,vote,current_value,nocontest)
{rating=current_value+vote;if($('id-login'))
{if(object_alias=='voteobject')
{if(!prepare_voteobject(object_alias,object_id,vote))return false;if(vote>0)
{xhide('vote-plus-'+object_alias+'-'+object_id);xshow('vote-minus-'+object_alias+'-'+object_id);xshow('check-'+object_alias+'-'+object_id);if($('check-link-'+object_alias+'-'+object_id))$('check-link-'+object_alias+'-'+object_id).addClass('poets-checked');}
else
{xshow('vote-plus-'+object_alias+'-'+object_id);xhide('vote-minus-'+object_alias+'-'+object_id);xhide('check-'+object_alias+'-'+object_id);if($('check-link-'+object_alias+'-'+object_id))$('check-link-'+object_alias+'-'+object_id).removeClass('poets-checked');}}
else if(object_alias=='task')
{if(vote>0)
{obj=$('vote-plus-span-'+object_alias+'-'+object_id);obj_act=$('vote-plus-'+object_alias+'-'+object_id);xhide('vote-plus-'+object_alias+'-'+object_id);xhide('vote-minus-'+object_alias+'-'+object_id);xhide('vote-plus-span-'+object_alias+'-'+object_id);ll_set_vote_object(obj,obj_act,rating,'+'+rating);}
else
{obj=$('vote-minus-span-'+object_alias+'-'+object_id);obj_act=$('vote-minus-'+object_alias+'-'+object_id);xhide('vote-minus-'+object_alias+'-'+object_id);xhide('vote-plus-'+object_alias+'-'+object_id);xhide('vote-minus-span-'+object_alias+'-'+object_id);ll_set_vote_object(obj,obj_act,current_value+1,'-'+(current_value+1));}}
else if(rating==0)
{xhide('vote-plus-'+object_alias+'-'+object_id);xhide('vote-plus-span-'+object_alias+'-'+object_id);xhide('vote-minus-'+object_alias+'-'+object_id);xhide('vote-minus-span-'+object_alias+'-'+object_id);xshow('vote-equal-span-'+object_alias+'-'+object_id);}
else if(rating>0)
{xhide('vote-minus-'+object_alias+'-'+object_id);xhide('vote-minus-span-'+object_alias+'-'+object_id);xhide('vote-equal-span-'+object_alias+'-'+object_id);obj=$('vote-plus-span-'+object_alias+'-'+object_id);var no_plus=obj.hasClass('no-plus');obj_act=$('vote-plus-'+object_alias+'-'+object_id);ll_set_vote_object(obj,obj_act,rating,rating>0?(no_plus?'':'+')+rating:rating);if($('vote-plus-hand-'+object_alias+'-'+object_id))
{$('vote-plus-hand-'+object_alias+'-'+object_id).setAttribute('onclick','');$('vote-plus-hand-'+object_alias+'-'+object_id).addClass('is-vote');}}
else if(rating<0)
{xhide('vote-plus-'+object_alias+'-'+object_id);xhide('vote-plus-span-'+object_alias+'-'+object_id);xhide('vote-equal-span-'+object_alias+'-'+object_id);obj=$('vote-minus-span-'+object_alias+'-'+object_id);obj_act=$('vote-minus-'+object_alias+'-'+object_id);ll_set_vote_object(obj,obj_act,rating,rating>0?'+'+rating:rating);}}
pars="id="+object_id+"&vote="+vote+"&alias="+object_alias;if(nocontest)pars+="&nocontest="+nocontest;new Request({url:'/vote',method:'post',onComplete:function(originalRequest)
{data=strToJson(originalRequest);prepare(data,null,'ll_vote(\''+object_alias+'\', '+object_id+', '+vote+', '+current_value+', '+nocontest+')');if(data.message)
{messageobj.display(data.message);return;}
return;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send(pars);}
function prepare_voteobject(object_alias,object_id,vote)
{if(!$('user-count-votes'))return true;if($('vote-plus-'+object_alias+'-'+object_id).hasClass('bb-gray')&&vote>0)return false;var max_votes=parseInt($('user-count-votes').getAttribute('data-max'));max_votes=!isNaN(max_votes)?max_votes:0;if(max_votes<=0)return true;var count_votes=0;var checkes=$$('.bb-check');for(var i=0;i<checkes.length;i++)
{if(checkes[i]&&checkes[i].style.display!='none')count_votes++;}
if(count_votes>=max_votes&&vote>0)return false;var btn_votes=$$('.btn-bb-vote');if(vote>0)
{if(count_votes+1==max_votes)
{for(var i=0;i<btn_votes.length;i++)
{btn_votes[i].addClass('bb-gray');}
$('user-count-votes').innerHTML='Поздравляем! Вы выбрали '+human_ending(max_votes,'книг','','у','и','','','',false);}
else
{$('user-count-votes').innerHTML='Выберите еще '+human_ending(max_votes-count_votes-1,'книг','','у','и','','','',false);}}
else
{if(count_votes-1>max_votes)
{$('user-count-votes').innerHTML='Вы выбрали больше '+human_ending(max_votes,'книг','','и','','','','',false);}
else if(count_votes-1==max_votes)
{$('user-count-votes').removeClass('votes-red');$('user-count-votes').innerHTML='Поздравляем! Вы выбрали '+human_ending(max_votes,'книг','','у','и','','','',false);}
else
{for(var i=0;i<btn_votes.length;i++)
{btn_votes[i].removeClass('bb-gray');}
$('user-count-votes').innerHTML='Выберите '+(count_votes>1?'еще ':'')+human_ending(max_votes-count_votes+1,'книг','','у','и','','','',false);}}
return true;}
ll_reg_ab=function(object_alias,object_id,action)
{var pars="object_id="+object_id+"&object_alias="+object_alias+"&type="+action+"&redirect_url="+window.location;new Request({url:'/service/regab',method:'post'}).send(pars);$('popup-back').show();$('popup-login').show();}
ll_vote_complete=function(originalRequest)
{data=strToJson(originalRequest);prepare(data,null,'');if(data.message)
{messageobj.display(data.message);return;}
return;}
ll_set_vote_object=function(obj,obj_act,value,text)
{if(obj)
{if(value=='0')
{xhide(obj);}
else
{var is_new_design=$('is-new-design')?$('is-new-design').value:0;obj.set('text',text);if(!is_new_design)obj.setAttribute('style','margin-right: -1px !important;');xshow(obj);}}
if(obj_act)
{xhide(obj_act);}}
var count_recs_added=0;function ll_rec_ignore(book_id,ignore)
{new Request({url:'/rec/removebook',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);}
else
{if(json.ask_author)
{if(confirm('Не рекомендовать этого автора вообще?'))
{ll_rec_exclude_author(json.ask_author);}}
if(ignore==0)
{$('rec-book-return-'+book_id).style.display='none';$('rec-book-remove-'+book_id).style.display='inline';count_recs_added--;}
else
{count_recs_added++;$('rec-book-remove-'+book_id).style.display='none';$('rec-book-return-'+book_id).style.display='inline';}
if(count_recs_added==20)
{ll_get_new_recs();}}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("book_id="+book_id+"&ignored="+ignore);}
function ll_rec_exclude_author(author_id)
{new Request({url:'/rec/excludeauthor',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);}
else
{}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("author_id="+author_id);}
function ll_rec_ignored_delete(book_id)
{var ignore=0;new Request({url:'/rec/removebook',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);}
else
{$('rec-book-'+book_id).style.display='none';}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("book_id="+book_id+"&ignored="+ignore);}
ll_rec_ignore_complete=function(originalRequest)
{data=strToJson(originalRequest);if(data.message)
{messageobj.display(data.message);return;}
if(data.book_id)xhide('tr-'+data.book_id);}
strToJson=function($str)
{return eval('('+$str+')');}
var debug=function(obj)
{var x;var s='';for(x in obj)
if(x!='outerText'&&x!='innerText'&&x!='outerHTML'&&x!='innerHTML'&&typeof(obj[x])!='function')
s+=x+': '+obj[x]+';\t';return s;}
function ll_get_new_recs()
{new Request({url:'/rec/getnewrecs',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);}
else
{$('new-rec-holder').innerHTML+=json.content;}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function object_subscribe(p_object_alias,p_object_id,p_bell)
{p_bell=p_bell||false;object_subscription_handler('subscribe',p_object_alias,p_object_id,p_bell);}
function object_unsubscribe(p_object_alias,p_object_id,p_bell,p_target)
{var types=['grouptopic'];if(types.indexOf(p_object_alias)>-1&&$('subscription-popup-'+p_object_alias+'-'+p_object_id))
{clicktoggle('subscription-popup-'+p_object_alias+'-'+p_object_id,p_target);return false;}
p_bell=p_bell||false;object_subscription_handler('unsubscribe',p_object_alias,p_object_id,p_bell);}
function object_subscription_handler(p_action,p_object_alias,p_object_id,p_bell)
{var is_new_design=$('is-new-design')?$('is-new-design').value:0;new Request({url:'/objectsubscription/'+p_action,method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json,null,'object_subscription_handler(\''+p_action+'\', \''+p_object_alias+'\', '+p_object_id+')');if(json.error)
{alert(json.error);}
else if(is_new_design)
{if($$('.subscription-wrapper-'+p_object_alias))$$('.subscription-wrapper-'+p_object_alias).destroy();if(p_bell)
{if(json.content&&$('object-subscription-'+p_object_alias))$('object-subscription-'+p_object_alias).innerHTML=json.content;else if(json.content&&$('object-subscription-'+p_object_alias+'-'+p_object_id))$('object-subscription-'+p_object_alias+'-'+p_object_id).innerHTML=json.content;}
else if($('subscription-menu-toggle'))
{if(p_object_alias==='authreview')
{if(p_action==='subscribe')
{var li=new Element('li',{'id':'object-subscription-'+p_object_alias,'class':'subscription-wrapper-'+p_object_alias});li.innerHTML=json.content;$('subscription-menu-toggle').appendChild(li);}
else
{var div_wrap=new Element('div',{'class':'btn-inline subscription-wrapper-'+p_object_alias});var div=new Element('div',{'id':'object-subscription-'+p_object_alias,'class':'subscription-on-header'});div.innerHTML=json.content;div.inject(div_wrap);div_wrap.inject($('fav-author-'+p_object_id),'after');}}
else if(p_object_alias==='authnewbook'&&$('object-subscription-authnewbook'))
{if(json.content)$('object-subscription-authnewbook').innerHTML=json.content;}}
else if(p_object_alias==='review'||p_object_alias==='selebook'||p_object_alias==='story'||p_object_alias==='critic_review'||p_object_alias==='selection'||p_object_alias==='post')
{var ul=$((p_object_alias==='selebook'?'selection':(p_object_alias==='critic_review'?'review':p_object_alias))+'-more-'+p_object_id).firstElementChild;var li=new Element('li',{'class':'subscription-wrapper-'+p_object_alias});li.innerHTML=json.content;if(p_object_alias==='selebook'&&ul.getElementsByClassName('subscription-wrapper-selection')[0])
{li.inject(ul.getElementsByClassName('subscription-wrapper-selection')[0],'before');}
else
{ul.appendChild(li);}}
else if(p_object_alias==='games'&&$('games-context-more'))
{var ul=$('games-context-more');var li=new Element('li',{'class':'subscription-wrapper-'+p_object_alias});li.innerHTML=json.content;ul.appendChild(li);}
else if((p_object_alias==='gamestep'||p_object_alias==='game')&&$('ul-context-more'))
{var ul=$('ul-context-more');var li=new Element('li',{'class':'subscription-wrapper-'+p_object_alias});li.innerHTML=json.content;ul.appendChild(li);}
else if(p_object_alias==='bookreview'&&$('book-action-bar-vertical-'+p_object_id))
{var span_wrap=new Element('span',{'class':'subscription-wrapper-bookreview','style':'margin-top: 5px; display: inline-block;'});span_wrap.innerHTML=json.content;$('book-action-bar-vertical-'+p_object_id).appendChild(span_wrap);}
else if(p_object_alias==='gameobject'&&$('gameobject-more-'+p_object_id))
{var ul=$('gameobject-more-'+p_object_id).firstElementChild;var li=new Element('li',{'class':'subscription-wrapper-'+p_object_alias});li.innerHTML=json.content;ul.appendChild(li);}
else if(p_object_alias==='group'||p_object_alias==='grouptopic'||p_object_alias==='selebook'||p_object_alias==='groupevent'||p_object_alias==='event-new'||p_object_alias==='special_f')
{if(json.content&&$('object-subscription-'+p_object_alias))$('object-subscription-'+p_object_alias).innerHTML=json.content;}
else if(json.content&&$('object-subscription-'+p_object_alias+'-'+p_object_id))
{$('object-subscription-'+p_object_alias+'-'+p_object_id).innerHTML=json.content;}
if(toggle_elements['subscription-popup-'+p_object_alias+'-'+p_object_id+'-']&&toggle_elements['subscription-popup-'+p_object_alias+'-'+p_object_id+'-']!=null)
{toggle_elements['subscription-popup-'+p_object_alias+'-'+p_object_id+'-']=null;}}
else
{if(p_object_alias==='selebook'&&$('object_subscription_selebook'))
{if(json.content)$('object_subscription_selebook').innerHTML=json.content;}
else if(p_object_alias==='authnewbook'&&$('object-subscription-authnewbook'))
{if(json.content)$('object-subscription-authnewbook').innerHTML=json.content;}
else if($('object_subscription'))
{if(json.content)$('object_subscription').innerHTML=json.content;}
else if($$('.object-subscription-'+p_object_alias+'-'+p_object_id).length>0)
{var elements=$$('.object-subscription-'+p_object_alias+'-'+p_object_id);for(var i=0;i<elements.length;i++)
{elements[i].innerHTML=json.content;}}}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("object_alias="+p_object_alias+"&object_id="+p_object_id+'&is_bell='+p_bell+'&is_new_design='+is_new_design);}
function ll_fav(p_object_alias,p_object_id,p_action,p_style,p_page,p_filter)
{var is_new_design=$('is-new-design')?$('is-new-design').value:0;if(p_page==null||p_page=='undefined')p_page='';if(p_filter==null||p_filter=='undefined')p_filter='';htmlname='fav-'+p_object_alias+'-'+p_object_id;if($('a-'+htmlname)&&!is_new_design)
{if($('a-'+htmlname).hasClass('i-clock'))return;if($('a-'+htmlname).addClass('i-clock'));}
p_style=p_style||0;var object_aliases=['review','quote','selection','story','post','bookswap','critic_review','comment'];if(is_new_design&&is_new_design=='redesign')object_aliases[object_aliases.length]='edition';if(object_aliases.indexOf(p_object_alias)!==-1||(p_object_alias=='edition'&&p_style==0))
{var count_in_fav=$('a-'+htmlname).getNext('.count-in-fav').get('html').replace('(','').replace(')','');if(!count_in_fav)count_in_fav=0;if(p_action)count_in_fav++;else count_in_fav--;}
new Request({url:'/main/managefavorites',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json,null,'ll_fav(\''+p_object_alias+'\', '+p_object_id+', '+p_action+', '+p_style+')');if(json.error)
{alert(json.error);}
else if(json.tologin&&$('a-'+htmlname))
{$('a-'+htmlname).removeClass('i-clock');$('a-'+htmlname).addClass(p_object_alias=='edition'?'i-love':'i-fav');}
else if($(htmlname)&&json.content)
{$(htmlname).innerHTML=json.content;if(object_aliases.indexOf(p_object_alias)!==-1&&count_in_fav>0)
{if(is_new_design&&is_new_design=='redesign'&&p_object_alias=='edition')$('a-'+htmlname).getNext('.count-in-fav').set('html',count_in_fav);else if(is_new_design&&is_new_design=='ll2015b'&&p_object_alias!='bookswap')$('a-'+htmlname).getNext('.count-in-fav').set('html',count_in_fav);else if(p_style==4)$('a-'+htmlname).getNext('.count-in-fav').set('html',count_in_fav);else $('a-'+htmlname).getNext('.count-in-fav').set('html','('+count_in_fav+')');}
else if(p_style==0&&p_object_alias=='edition')$('a-'+htmlname).getNext('.count-in-fav').set('html',count_in_fav);if(is_new_design&&p_object_alias=='message')
{service_pinger(0);bind_message_filter(p_page,p_object_id,p_filter);}}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("object_alias="+p_object_alias+"&object_id="+p_object_id+"&fav_action="+p_action+"&style="+p_style+"&is_new_design="+is_new_design);if((p_object_alias=='edition'||p_object_alias=='author'||p_object_alias=='work')&&p_action>0)
{var p_alias=(p_object_alias=='edition'||p_object_alias=='work'?'book':p_object_alias)+'_fav';social_popup_show(p_alias,p_object_id);if($('is-social-'+p_alias))social_add_queue(p_alias,p_object_id);}
return false;}
function ll_contest(object_id,contest_no)
{var object_url='';if(contest_no==0)
{var elems=getElementsByName('input','contest-list-'+object_id);if(elems.length>0)
{for(var i=0;i<elems.length;i++)
{if(elems[i].checked)contest_no=elems[i].id.substring(14+(object_id).toString().length);}}
if(contest_no==0)
{alert('Пожалуйста, выберите конкурс!');return false;}
object_url=$('contest-url-'+object_id)?$('contest-url-'+object_id).value:'';}
new Request({url:'/contest/contest/'+contest_no+'/'+object_id,method:'post',data:{object_url:object_url},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message.text);return;}
xhide('contest-contest-a-'+object_id);xshow('contest-uncontest-a-'+object_id);if($('contest-uncontest-a-'+object_id))
{$('contest-uncontest-a-'+object_id).set('onclick','ll_uncontest('+object_id+','+contest_no+')');xhide('contest-block-review-'+object_id);}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();return false;}
function ll_uncontest(object_id,contest_no)
{if(!confirm("Вы уверены, что хотите снять объект с конкурса?"))return;new Request({url:'/contest/uncontest/'+contest_no+'/'+object_id,method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{messageobj.display(json.message);return;}
xhide('contest-uncontest-a-'+object_id);xshow('contest-contest-a-'+object_id);},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();return false;}
function ll_kick(object_alias,object_id)
{return ll_kick_unkick(object_alias,object_id,'kick');}
function ll_unkick(object_alias,object_id)
{return ll_kick_unkick(object_alias,object_id,'unkick');}
function ll_kick_unkick(object_alias,object_id,action)
{new Request({url:'/main/kick',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{messageobj.display(json.error);}
else
{xhide($('span-'+object_alias+'-'+action+'-'+object_id));}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("object_alias="+object_alias+"&object_id="+object_id+"&kickaction="+action);return false;}
function ll_ban(object_alias,object_id)
{return ll_ban_unban(object_alias,object_id,'ban');}
function ll_unban(object_alias,object_id)
{return ll_ban_unban(object_alias,object_id,'unban');}
function ll_ban_unban(object_alias,object_id,action)
{var token=$(object_alias+'-'+action+'-'+object_id).getAttribute('t');new Request({url:'/main/'+action,method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{messageobj.display(json.error);}
else
{xhide($(object_alias+'-'+action+'-'+object_id));if(action=='ban')
{xshow($(object_alias+'-unban-'+object_id));}
else
{xshow($(object_alias+'-ban-'+object_id));}}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("object_alias="+object_alias+"&object_id="+object_id+"&action="+action+"&token="+token);return false;}
function ll_info(e,id,content)
{var coords=getMouseCoords(e);var htmlname='-info-'+id;if($('div'+htmlname))
{$('div'+htmlname).destroy();return false;}
var container=$('body');if(container)
{content='<p><a href="javascript:void(0)" title="Закрыть" class="action a-close" onclick="$(\'div'+htmlname+'\').destroy(); return false;"><span class="i-close"></span></a>'+content+'</p>';var div=new Element('div',{id:'div'+htmlname});var st='width:auto;position:absolute;top:'+(coords['y']+10)+'px;left:'+coords['x']+'px;';if(isIE())div.style.cssText=st;div.setAttribute('style',st);div.addClass('share');div.addClass('overlay');div.innerHTML=content;container.adopt(div);}
else
{alert('Ошибка!');}
return false;}
function ll_info_new(e,id,content,styles)
{if(styles==null||styles=='undefined')styles='';var coords=getMouseCoords(e);var htmlname='-info-'+id;if($('div'+htmlname))
{$('div'+htmlname).destroy();return false;}
var container=$('body');if(container)
{content='<p>'+content+'</p>';var div=new Element('div',{id:'div'+htmlname});var st='width:auto;position:absolute;font-size:90%;top:'+(coords['y']+10)+'px;left:'+coords['x']+'px;'+styles;if(isIE())div.style.cssText=st;div.setAttribute('style',st);div.addClass('share');div.addClass('overlay');div.innerHTML=content;container.adopt(div);hideonclick('div'+htmlname);}
else
{alert('Ошибка!');}
return false;}
var share_close=false;function ll_share(e,object_alias,object_id,title,url,social,prefix)
{var htmlname='-share-'+object_alias+'-'+object_id;if($('div'+htmlname))
{var is_display=$('div'+htmlname).isDisplayed();$('div'+htmlname).destroy();if(is_display)
{if(prefix=='fixed')
{$('link'+htmlname).innerHTML='<span class="soc-share link-open"><span class="share-icon"></span></span>';$('count'+htmlname).show();}
return false;}}
var coords=getMouseCoords(e);url=url||'';social=social||'';prefix=prefix||'';var is_new_design=$('is-new-design')?$('is-new-design').value:0;new Request({url:'/main/share',method:'post',onComplete:function(json)
{json=strToJson(json);if(json.error)
{alert(json.error);}
else
{var container=$('body');if($('container-more'+htmlname))
{var div=new Element('div',{id:'div'+htmlname});var st=(!is_new_design?'':'position: relative;')+(object_alias!='author'&&prefix!='fixed'&&prefix!='content'?'padding: 10px;':'');if(prefix=='fixed'||prefix=='content')st+='display:none;';if(isIE())div.style.cssText=st;div.setAttribute('style',st);div.addClass('social-more-share');div.innerHTML=json.content;$('container-more'+htmlname).adopt(div);if(prefix=='fixed')
{clicktoggle(div,$('link'+htmlname),'block','click',function()
{$('link'+htmlname).innerHTML='<span class="soc-share link-cancel"><span class="share-icon"></span></span>';$('count'+htmlname).hide();},function()
{ll_share_fixed_close(object_alias,object_id);});$('link'+htmlname).innerHTML='<span class="soc-share link-cancel"><span class="share-icon"></span></span>';}
if(prefix=='content')
{clicktoggle(div,$('link'+htmlname),'block','click',function()
{$('link'+htmlname).style.visibility='hidden';},function()
{if($('div'+htmlname))$('div'+htmlname).destroy();$('link'+htmlname).style.visibility='visible';});}
if(!share_close)
{$('body').addEvent('click',function(){$$('.container-share .social-more-share').hide();});share_close=true;}}
else if($('container'+htmlname))
{var div=new Element('div',{id:'div'+htmlname});if($$('.social-share-text')&&$$('.social-share-text').length>0)var st='width:189px;position:absolute;margin-top:45px;margin-left:184px;padding: 10px;';else var st='width:189px;position:absolute;margin-top:18px;margin-left:-58px;padding: 10px;';if(isIE())div.style.cssText=st;div.setAttribute('style',st);div.addClass('social-share').addClass('share');div.innerHTML=json.content;$('container'+htmlname).adopt(div);if(!share_close)
{$('body').addEvent('click',function(){$$('.container-share .social-share').hide();});share_close=true;}}
else if(container)
{var div=new Element('div',{id:'div'+htmlname,onmouseout:"this.addClass('sharecontainer');"});var st='width:165px;position:absolute;top:'+(coords['y']-11)+'px;left:'+(coords['x']-8)+'px;';if(isIE())div.style.cssText=st;div.setAttribute('style',st);div.addClass('share');div.innerHTML=json.content;container.adopt(div);}
else
{alert('Ошибка!');}}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("object_alias="+object_alias+"&object_id="+object_id+"&social="+social+"&title="+encodeURIComponent(title)+"&url="+encodeURIComponent(url)+"&prefix="+encodeURIComponent(prefix)+"&is_new_design="+is_new_design);return false;}
function ll_share_fixed_close(object_alias,object_id)
{var htmlname='-share-'+object_alias+'-'+object_id;if($('div'+htmlname))$('div'+htmlname).destroy();if($('link'+htmlname))$('link'+htmlname).innerHTML='<span class="soc-share link-open"><span class="share-icon"></span></span>';if($('count'+htmlname))$('count'+htmlname).show();}
function ll_share_object(event,social,object_alias,object_id)
{if(object_alias=='html')
{ll_html(event,object_alias,object_id);}
ll_share_post(social,object_alias,object_id);return false;new Request({url:'/main/shareobject',method:'post',onComplete:function(json)
{json=strToJson(json);if(json.error)
{alert(json.error);return false;}
if(json.url)
{ll_share_post(social,object_alias,object_id);$('span-share-'+object_alias+'-'+object_id).setAttribute('onclick','');$('span-share-'+object_alias+'-'+object_id).setAttribute('href',json.url);$('span-share-'+object_alias+'-'+object_id).click();}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("object_alias="+object_alias+"&object_id="+object_id+"&social="+encodeURIComponent(social));}
function ll_share_post(social,object_alias,object_id)
{if(typeof(ga)=='function')ga('send','event','share',social,object_alias+'-'+object_id,0);new Request({url:'/main/sharepost',method:'post',onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("social="+social+"&object_alias="+object_alias+"&object_id="+object_id);if($('icon-share-'+object_alias+'-'+object_id))
{$('icon-share-'+object_alias+'-'+object_id).className='i-soc-'+social;}
if($('count-share-'+object_alias+'-'+object_id))
{var count=parseInt($('count-share-'+object_alias+'-'+object_id).innerHTML);count=isNaN(count)?0:count;$('count-share-'+object_alias+'-'+object_id).innerHTML=(count+1);}
var ab_shares=object_alias=='edition'?'book':object_alias;if($('ab-shares')&&$('ab-shares').value==ab_shares)
{ll_pagegoal_ab('shares');}
return false;}
function ll_bookfi_destroy(edition_id)
{var htmlname='-bookfi-'+edition_id;if($('div'+htmlname))
{$('div'+htmlname).destroy();$('a'+htmlname).removeClass('i-closewin');return true;}
return false;}
function ll_bookfi(e,edition_id)
{var htmlname='-bookfi-'+edition_id;if($('a'+htmlname))
{if($('a'+htmlname).hasClass('i-clock'))return;if(!$('div'+htmlname))$('a'+htmlname).addClass('i-clock');}
if(ll_bookfi_destroy(edition_id))return;var coords=getMouseCoords(e);new Request({url:'/book/bookfi',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json['error'])
{alert(json.error);}
else
{var container=$('body');if(container)
{if($('div'+htmlname))$('div'+htmlname).destroy();var div=new Element('div',{id:'div'+htmlname});var w=getClientWidth();if(coords['x']+470>w)coords['x']-=470
if(coords['x']<0)coords['x']=0;var st='position:absolute;top:'+(coords['y']+10)+'px;left:'+coords['x']+'px;width: 420px;';if(isIE())div.style.cssText=st;div.setAttribute('style',st);div.addClass('share');div.innerHTML=json.content;container.adopt(div);}
else
{alert('Ошибка!');}}},onRequest:initAd,onSuccess:function()
{if($('a'+htmlname))
{$('a'+htmlname).removeClass('i-clock');$('a'+htmlname).addClass('i-closewin');}
closeAd();},onFailure:function()
{if($('a'+htmlname))$('a'+htmlname).removeClass('i-clock');failure();}}).send("edition_id="+edition_id);return false;}
function ll_elib_destroy(edition_id)
{var htmlname='-elib-'+edition_id;if($('div'+htmlname))
{$('div'+htmlname).destroy();$('a'+htmlname).removeClass('i-closewin');return true;}
return false;}
function ll_elib(e,edition_id)
{var htmlname='-elib-'+edition_id;if($('a'+htmlname))
{if($('a'+htmlname).hasClass('i-clock'))return;if(!$('div'+htmlname))$('a'+htmlname).addClass('i-clock');}
if(ll_elib_destroy(edition_id))return;var coords=getMouseCoords(e);new Request({url:'/book/elib',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json['error'])
{alert(json.error);}
else
{var container=$('body');if(container)
{if($('div'+htmlname))$('div'+htmlname).destroy();var div=new Element('div',{id:'div'+htmlname});var w=getClientWidth();if(coords['x']+470>w)coords['x']-=470
if(coords['x']<0)coords['x']=0;var st='position:absolute;top:'+(coords['y']+10)+'px;left:'+coords['x']+'px;width: 420px;';if(isIE())div.style.cssText=st;div.setAttribute('style',st);div.addClass('share');div.innerHTML=json.content;container.adopt(div);}
else
{alert('Ошибка!');}
if(json.can_add_request==true)xshow('span-ebookrequest-'+edition_id);}},onRequest:initAd,onSuccess:function()
{if($('a'+htmlname))
{$('a'+htmlname).removeClass('i-clock');$('a'+htmlname).addClass('i-closewin');}
closeAd();},onFailure:function()
{if($('a'+htmlname))$('a'+htmlname).removeClass('i-clock');xshow('span-ebookrequest-'+edition_id);failure();}}).send("edition_id="+edition_id);return false;}
function ll_ebookrequest(e,edition_id)
{var htmlname='-ebookrequest-'+edition_id;if($('a'+htmlname))
{if($('a'+htmlname).hasClass('i-clock'))return;if(!$('div'+htmlname))$('a'+htmlname).addClass('i-clock');}
new Request({url:'/book/ebookrequest',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json['error'])
{alert(json.error);}
else
{if(json.result=='close')alert('Вы можете оставить не более трёх заявок в день');if(json.result=='exists')alert('Вы уже оставляли запрос');if(json.result=='okay')alert('Запрос добавлен');if($('a'+htmlname))xhide('a'+htmlname);}},onRequest:initAd,onSuccess:function()
{if($('a'+htmlname))
{$('a'+htmlname).removeClass('i-clock');$('a'+htmlname).addClass('i-clear');}
closeAd();},onFailure:function()
{if($('a'+htmlname))$('a'+htmlname).removeClass('i-clock');failure();}}).send("edition_id="+edition_id);return false;}
function ll_html_destroy(object_alias,object_id)
{var htmlname='-html-'+object_alias+'-'+object_id;if($('div'+htmlname))
{$('div'+htmlname).destroy();$('a'+htmlname).removeClass('i-clear');return true;}
return false;}
function ll_html(e,object_alias,object_id)
{var htmlname='-html-'+object_alias+'-'+object_id;if($('a'+htmlname))
{if($('a'+htmlname).hasClass('i-clock'))return;if(!$('div'+htmlname))$('a'+htmlname).addClass('i-clock');}
if(ll_html_destroy(object_alias,object_id))return;if($('icon-share-'+object_alias+'-'+object_id))
{$('icon-share-'+object_alias+'-'+object_id).className='i-soc-html';}
var coords=getMouseCoords(e);new Request({url:'/main/html',method:'post',onComplete:function(json)
{json=strToJson(json);if(json['error'])
{alert(json.error);}
else
{var container=$('body');if(container)
{if($('div'+htmlname))$('div'+htmlname).destroy();var div=new Element('div',{id:'div'+htmlname});var w=getClientWidth();if(coords['x']+700>w)coords['x']-=700
if(coords['x']<0)coords['x']=0;var st='position:absolute;top:'+(coords['y']-100)+'px;left:'+coords['x']+'px;width: 642px;';if(isIE())div.style.cssText=st;div.setAttribute('style',st);div.addClass('share');div.innerHTML=json.content;container.adopt(div);}
else
{alert('Ошибка!');}}},onRequest:initAd,onSuccess:function()
{if($('a'+htmlname))
{$('a'+htmlname).removeClass('i-clock');$('a'+htmlname).addClass('i-clear');}
closeAd();},onFailure:function()
{if($('a'+htmlname))$('a'+htmlname).removeClass('i-clock');failure();}}).send("object_alias="+object_alias+"&object_id="+object_id);return false;}
function ll_code_destroy(object_alias,object_id)
{var htmlname='-llcode-'+object_alias+'-'+object_id;if($('div'+htmlname))
{$('div'+htmlname).destroy();$('a'+htmlname).removeClass('i-clear');return true;}
return false;}
function ll_social_action(e,object_alias,object_id,object_action)
{var htmlname='-ll'+object_action+'-'+object_alias+'-'+object_id;if($('a'+htmlname))
{if($('a'+htmlname).hasClass('i-clock'))return;if(!$('div'+htmlname))$('a'+htmlname).addClass('i-clock');}
var current_location=window.location.href;if(ll_code_destroy(object_alias,object_id))return;if($('icon-share-'+object_alias+'-'+object_id))
{$('icon-share-'+object_alias+'-'+object_id).className='i-soc-html';}
var coords=getMouseCoords(e);new Request({url:'/main/llsocaction',method:'post',onComplete:function(json)
{json=strToJson(json);if(json['error'])
{alert(json.error);}
else
{var container=$('body');if(container)
{if($('div'+htmlname))$('div'+htmlname).destroy();var div=new Element('div',{id:'div'+htmlname});var w=getClientWidth();if(coords['x']+700>w)coords['x']-=700
if(coords['x']<0)coords['x']=0;var st='position:absolute;top:'+(coords['y']-100)+'px;left:'+coords['x']+'px;width: 642px;';if(isIE())div.style.cssText=st;div.setAttribute('style',st);div.addClass('share');div.innerHTML=json.content;container.adopt(div);}
else
{alert('Ошибка!');}}},onRequest:initAd,onSuccess:function()
{if($('a'+htmlname))
{$('a'+htmlname).removeClass('i-clock');$('a'+htmlname).addClass('i-clear');}
closeAd();},onFailure:function()
{if($('a'+htmlname))$('a'+htmlname).removeClass('i-clock');failure();}}).send("object_alias="+object_alias+"&object_id="+object_id+"&object_action="+object_action+"&current_location="+current_location);return false;}
function ll_ub_destroy(edition_id,userbook_id)
{if(userbook_id=='undefined')userbook_id=0;var htmlname='-userbook-'+edition_id+'-'+userbook_id;if($('div'+htmlname))
{$('div'+htmlname).destroy();$('a'+htmlname).removeClass('i-clear');return true;}
return false;}
function ll_userbook(e,edition_id,actual_id,content_edition_id,userbook_id)
{var htmlname='-userbook-'+actual_id+'-'+userbook_id;if(content_edition_id=='undefined')content_edition_id=0;if(userbook_id=='undefined')userbook_id=0;if($('a'+htmlname))
{if($('a'+htmlname).hasClass('i-clock'))return;if(!$('div'+htmlname))$('a'+htmlname).addClass('i-clock');}
if(ll_ub_destroy(actual_id,userbook_id))return;var coords=getMouseCoords(e);var is_new_design=$('is-new-design')?$('is-new-design').value:0;new Request({url:'/user/userbook',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json['error'])
{alert(json.error);}
else
{var container=$('body');if(container)
{if($('div'+htmlname))$('div'+htmlname).destroy();var div=new Element('div',{id:'div'+htmlname});var w=getClientWidth();if(is_new_design==0&&coords['x']+500>w)coords['x']-=450;if(!is_new_design||is_new_design=='vizov2015')
{var x_coord=0;var y_coord=10;if(is_new_design=='redesign')
{x_coord=-20;}
if(coords['x']<0)coords['x']=0;var st='position:absolute;top:'+(coords['y']+y_coord)+'px;left:'+(coords['x']+x_coord)+'px;';}
else
{var st='top: 28px;left: -7px;';}
if(isIE())div.style.cssText=st;div.setAttribute('style',st);div.addClass('userbook');div.innerHTML=json.content;if(is_new_design&&$('userbook-details-'+actual_id+'-'+userbook_id))
{$('userbook-details-'+actual_id+'-'+userbook_id).adopt(div);}
else
{container.adopt(div);}
if(is_new_design)hideonclick('div'+htmlname);}
else
{alert('Ошибка!');}}},onRequest:initAd,onSuccess:function()
{if($('a'+htmlname))
{$('a'+htmlname).removeClass('i-clock');$('a'+htmlname).addClass('i-clear');}
closeAd();},onFailure:function()
{if($('a'+htmlname))$('a'+htmlname).removeClass('i-clock');failure();}}).send("edition_id="+edition_id+"&actual_id="+actual_id+'&content_edition_id='+content_edition_id+'&userbook_id='+userbook_id+'&is_new_design='+is_new_design);return false;}
function ll_quick_ub(edition_id,actual_id,evt,plain,strict,content_edition_id,userbook_id)
{if(content_edition_id=='undefined')content_edition_id=0;if(userbook_id=='undefined')userbook_id=0;if(strict||actual_id==0)actual_id=edition_id;var is_new_design=$('is-new-design')?$('is-new-design').value:0;var view_mode=$('ub-viewmode-'+edition_id)?$('ub-viewmode-'+edition_id).value:'plain';var htmlname='-userbook-'+actual_id+'-'+userbook_id;var coords=getMouseCoords(evt);new Request({url:'/user/quickbook',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json,null,'ll_quick_ub('+edition_id+', '+actual_id+', event, '+plain+', '+strict+', '+content_edition_id+', '+userbook_id+')');if(json['error'])
{alert(json.error);}
else if(json.tologin)
{return false;}
else
{var container=$('body');if(container&&view_mode=='popup')
{if($('div'+htmlname))$('div'+htmlname).dispose();var div=new Element('div',{id:'div'+htmlname});var w=getClientWidth(true);if(coords['x']+500>w)coords['x']-=450;var x_coord=-30;var y_coord=20;if(coords['x']<0)coords['x']=0;var st='position:absolute;top:'+(coords['y']+y_coord)+'px;left:'+(coords['x']+x_coord)+'px;';if(isIE())div.style.cssText=st;div.setAttribute('style',st);div.innerHTML=json.content;container.adopt(div);}
else if(json.content)$('xa-main-'+edition_id+'-'+userbook_id).innerHTML=json.content;xshow('xa-'+actual_id+'-'+userbook_id);if($('xa-menu-'+actual_id+'-'+userbook_id))
{hideonclick('xa-menu-'+actual_id+'-'+userbook_id,null,false,function(){if($('div'+htmlname))$('div'+htmlname).dispose();},'click');userbook_change('xa-menu-'+actual_id+'-'+userbook_id,edition_id,actual_id,userbook_id);}}},onRequest:initAd,onSuccess:function()
{closeAd();},onFailure:function()
{failure();}}).send("edition_id="+edition_id+"&actual_id="+actual_id+"&plain="+plain+"&view_mode="+view_mode+"&strict="+strict+'&content_edition_id='+content_edition_id+'&userbook_id='+userbook_id+'&is_new_design='+is_new_design);return false;}
function ll_ub_show_access_switcher(edition_id,selection_id)
{$$('.switch').each(function(item){item.id=='shelf-'+selection_id+'-access-switch-'+edition_id?$(item).setStyle('display','block'):$(item).setStyle('display','none');});}
function ll_ub_change_active_objects(obj,edition_id,object_alias)
{if($(obj.target).hasClass('active'))return false;if(object_alias=='selections')
{$('ub-menu-item-shelfs-'+edition_id).removeClass('active');xhide('ub-shelfs-block-'+edition_id);xhide('ub-shelfs-block2-'+edition_id);xshow('ub-'+object_alias+'-block-'+edition_id);xshow('ub-'+object_alias+'-block2-'+edition_id);}
else
{$('ub-menu-item-selections-'+edition_id).removeClass('active');xhide('ub-selections-block-'+edition_id);xhide('ub-selections-block2-'+edition_id);xshow('ub-'+object_alias+'-block-'+edition_id);xshow('ub-'+object_alias+'-block2-'+edition_id);}
$('s-resizer-'+edition_id).onmousemove='';$('s-resizer-'+edition_id).removeEvents('mousemove').addEvent('mousemove',function(){Resize.init(object_alias+'-'+edition_id,'s-resizer-'+edition_id);});$('ub-menu-item-'+object_alias+'-'+edition_id).addClass('active');}
function ll_ub_shelf_set_access(visible_all,selection_id)
{new Request({url:'/selection/setaccess',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json['error'])
{alert(json.error);}
else if(json['okay'])
{$$('.shelf-access-'+selection_id).each(function(item)
{if(visible_all)
{$(item).hasClass('i-shelf-access-all')?$(item).setStyle('display','block'):$(item).setStyle('display','none');}
else
{$(item).hasClass('i-shelf-access-private')?$(item).setStyle('display','block'):$(item).setStyle('display','none');}});}},onRequest:initAd,onSuccess:function()
{closeAd();},onFailure:function()
{failure();}}).send("selection_id="+selection_id+"&visible_all="+visible_all);return false;}
function ll_ub_set_rating(edition_id,rating,halfs)
{var value=$('ub-rating-'+edition_id).value!=rating?rating:0;ll_stars(edition_id,rating,halfs);var norating_el=$('ub-no-rating-'+edition_id);if(rating==0)norating_el.className='action standard';else norating_el.className='action';$('ub-rating-'+edition_id).value=value;}
function ll_ub_set_rating_new(edition_id,rating,halfs,rand_id,size,is_forecast,userbook_id)
{size=size||'';var rand_name=!rand_id?'':('-'+rand_id);var old_rating=$('ub-rating-'+edition_id)?$('ub-rating-'+edition_id).value:($('ub-rating-other-'+edition_id+rand_name)?$('ub-rating-other-'+edition_id+rand_name).value:0);var value=$('ub-rating-'+edition_id)&&$('ub-rating-'+edition_id).value!=rating?rating:($('ub-rating-other-'+edition_id+rand_name)&&$('ub-rating-other-'+edition_id+rand_name).value!=rating?rating:0);if(old_rating==value)
{rating=0;value=0;}
userbook_id=userbook_id||0;ll_stars_new(edition_id,rating,halfs,size,false,rand_id);var norating_el=$('ub-no-rating-'+edition_id+rand_name);if(rating==0)
{norating_el.className='action standard';if($('ub-no-rating_other-'+edition_id+rand_name))$('ub-no-rating_other-'+edition_id+rand_name).className='action standard';}
else
{norating_el.className='action';if($('ub-no-rating_other-'+edition_id+rand_name))$('ub-no-rating_other-'+edition_id+rand_name).className='action';}
if($('ub-rating-'+edition_id))$('ub-rating-'+edition_id).value=value;if($('ub-rating-other-'+edition_id+rand_name))$('ub-rating-other-'+edition_id+rand_name).value=value;if($('ub-rating-'+edition_id))
{ub_current_id=0;ub_popup_close=true;var status=$('ub-status-'+edition_id)?$('ub-status-'+edition_id).value:-3;if(status>-3&&status!=1&&status!=3&&(!is_forecast||(is_forecast&&status==-2)))
{ll_ub_set_status_new(edition_id,is_forecast?(status!=2?0:2):1,edition_id,userbook_id);}
else
{userbook_update_new(edition_id,edition_id,userbook_id);}}
if($$('.xa-main-rating-'+edition_id+'-'+userbook_id).length>0)
{$$('.xa-main-rating-'+edition_id+'-'+userbook_id).each(function(item,key){var item_rand_id=item.dataset.rand_id;if(rand_id!=item_rand_id)
{ll_stars_new(edition_id,rating,halfs,size,false,item_rand_id);var rand_name=!item_rand_id?'':('-'+item_rand_id);var value=$('ub-rating-'+edition_id+rand_name)&&$('ub-rating-'+edition_id+rand_name).value!=rating?rating:($('ub-rating-other-'+edition_id+rand_name)&&$('ub-rating-other-'+edition_id+rand_name)!=rating?rating:0);var norating_el=$('ub-no-rating-'+edition_id+rand_name);if(rating==0)
{norating_el.className='action standard';if($('ub-no-rating_other-'+edition_id+rand_name))$('ub-no-rating_other-'+edition_id+rand_name).className='action standard';}
else
{norating_el.className='action';if($('ub-no-rating_other-'+edition_id+rand_name))$('ub-no-rating_other-'+edition_id+rand_name).className='action';}
if($('ub-rating-'+edition_id))$('ub-rating-'+edition_id).value=value;if($('ub-rating-other-'+edition_id+rand_name))$('ub-rating-other-'+edition_id+rand_name).value=value;}});}}
function ll_ub_editions(edition_id,alias,userbook_id,page_no)
{if(alias==null||alias=='undefined')alias='';if(userbook_id==null||userbook_id=='undefined')userbook_id=0;if(page_no==null||page_no=='undefined'||page_no<1)page_no=1;var is_new_design=$('is-new-design')&&$('is-new-design').value&&alias!='selebook'?$('is-new-design').value:'';var params="edition_id="+edition_id+'&alias='+alias+'&userbook_id='+userbook_id+'&is_new_design='+is_new_design;var htmlname;if(alias=='work_editions')
{var htmlname='-ub-work-editions-'+edition_id+'-'+userbook_id;params+='&page_no='+page_no;}
else
{var htmlname='-ub-editions-'+edition_id;}
if($('a'+htmlname))
{if($('a'+htmlname).getChildren()[0].hasClass('i-clock'))return;if(!$('div'+htmlname).isDisplayed())$('a'+htmlname).getChildren()[0].addClass('i-clock');else
{$('div'+htmlname).hide();$('a'+htmlname).getChildren()[0].removeClass('i-clear');return;}}
new Request({url:'/user/bookeditions',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json['error'])
{alert(json.error);}
else
{if(is_new_design&&alias=='work_editions')
{$('work-editions-block-'+edition_id+'-'+userbook_id).show();}
$('div'+htmlname).show();$('div'+htmlname).innerHTML=json.content;if($('xa-change-edition-'+edition_id+'-'+userbook_id))$('xa-change-edition-'+edition_id+'-'+userbook_id).show();if($('ub-data-'+edition_id))$('ub-data-'+edition_id).hide();}},onRequest:initAd,onSuccess:function()
{if($('a'+htmlname))
{$('a'+htmlname).getChildren()[0].removeClass('i-clock');$('a'+htmlname).getChildren()[0].addClass('i-clear');}
closeAd();},onFailure:function()
{if($('a'+htmlname))$('a'+htmlname).getChildren()[0].removeClass('i-clock');failure();}}).send(params);return false;}
function ll_quick_ub_new(edition_id,actual_id,evt,plain,strict,content_edition_id,userbook_id,rand_id)
{if(content_edition_id=='undefined')content_edition_id=0;if(userbook_id=='undefined')userbook_id=0;if(strict||actual_id==0)actual_id=edition_id;rand_id=rand_id||'';var is_new_design=$('is-new-design')?$('is-new-design').value:0;var view_mode=$('ub-viewmode-'+edition_id)?$('ub-viewmode-'+edition_id).value:'plain';var htmlname='-userbook-'+actual_id+'-'+userbook_id;var coords=getMouseCoords(evt);ub_popup_close=false;new Request({url:'/user/quickbook',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json,null,'ll_quick_ub_new('+edition_id+', '+actual_id+', event, '+plain+', '+strict+', '+content_edition_id+', '+userbook_id+','+rand_id+')');if(json['error'])
{alert(json.error);}
else if(json.tologin)
{return false;}
else
{var container=$('body');if(container&&view_mode=='popup')
{if($('div'+htmlname))$('div'+htmlname).dispose();var div=new Element('div',{id:'div'+htmlname});var w=getClientWidth(true);if(coords['x']+500>w)coords['x']-=450;var x_coord=-75;var y_coord=20;if(coords['x']<0)coords['x']=0;var st='position:absolute;top:'+(coords['y']+y_coord)+'px;left:'+(coords['x']+x_coord)+'px;';if(isIE())div.style.cssText=st;div.setAttribute('style',st);div.innerHTML=json.content;container.adopt(div);}
else if(json.content)
{var w=getClientWidth(true);$('xa-main-'+edition_id+'-'+userbook_id+'-'+rand_id).innerHTML=json.content;if(coords['x']+500>w&&$('xa-arrow-'+edition_id+'-'+userbook_id))
{if(view_mode=='list')
{if($('xa-menu-'+edition_id+'-'+userbook_id))$('xa-menu-'+edition_id+'-'+userbook_id).style.left='-210px';$('xa-arrow-'+edition_id+'-'+userbook_id).style.left='242px';}
else
{if($('xa-menu-'+edition_id+'-'+userbook_id))$('xa-menu-'+edition_id+'-'+userbook_id).style.left='-150px';$('xa-arrow-'+edition_id+'-'+userbook_id).style.left='235px';}}
if(view_mode=='list'&&coords['x']-300<0&&$('xa-arrow-'+edition_id+'-'+userbook_id))
{if($('xa-menu-'+edition_id+'-'+userbook_id))$('xa-menu-'+edition_id+'-'+userbook_id).style.left='0px';$('xa-arrow-'+edition_id+'-'+userbook_id).style.left='32px';}}
xshow('xa-'+actual_id+'-'+userbook_id);if($('xa-menu-'+actual_id+'-'+userbook_id))
{hideonclick('xa-menu-'+actual_id+'-'+userbook_id,null,false,function(){if($('div'+htmlname))$('div'+htmlname).dispose();},'click',function(){ub_popup_close=true;});userbook_change_new('xa-menu-'+actual_id+'-'+userbook_id,edition_id,actual_id,userbook_id);}}},onRequest:initAd,onSuccess:function()
{closeAd();},onFailure:function()
{failure();}}).send("edition_id="+edition_id+"&actual_id="+actual_id+"&plain="+plain+"&view_mode="+view_mode+"&strict="+strict+'&content_edition_id='+content_edition_id+'&userbook_id='+userbook_id+'&is_new_design='+is_new_design+'&rand_id='+rand_id);return false;}
function userbook_change_new(elem,edition_id,actual_id,userbook_id)
{var ub={edition_id:edition_id,actual_id:actual_id,userbook_id:userbook_id};if($$('#'+elem+' input','#'+elem+' select').length>0)
{$$('#'+elem+' .input','#'+elem+' select').addEvent('change',function(event){var edition_id=ub.edition_id;var actual_id=ub.actual_id;var userbook_id=ub.userbook_id;userbook_update_new(edition_id,actual_id,userbook_id);});}}
function ll_ub_set_status_new(edition_id,status,actual_id,userbook_id)
{var value=$('ub-status-'+edition_id).value!=status?status:-2;if(value==-2&&$('ub-review-'+edition_id).value!='')
{if(!confirm('Удалить книгу из коллекции? Ваша рецензия также будет удалена.'))
return false;$('ub-review-'+edition_id).value='';}
$('ub-status-'+edition_id).value=value;var is_new_design=$('is-new-design')?$('is-new-design').value:0;userbook_update_new(edition_id,actual_id,userbook_id);var cls='ub-actions';var cls_active='ub-actions active';var prefix_read_again='<span class="i-ub-read-again"></span> ';if(value==1)
{$('ub-status-date-'+edition_id).innerHTML='Дата прочтения';$('ub-status-read-'+edition_id).set('class',cls_active);xshow($('ub-status-read-'+edition_id).getChildren()[1]);if($('ub-read-again-'+edition_id))
{$('ub-read-again-'+edition_id+'-span').innerHTML=prefix_read_again+$('ub-read-again-'+edition_id+'-hid').value;if($('read_again_ph'))
{$('read_again_ph').setStyle('margin-left','-10px');$('read_again_ph').setStyle('margin-top','6px');}}}
else
{$('ub-status-read-'+edition_id).set('class',cls);xhide($('ub-status-read-'+edition_id).getChildren()[1]);}
if(value==0)
{$('ub-status-wish-'+edition_id).set('class',cls_active);xshow($('ub-status-wish-'+edition_id).getChildren()[1]);if($('ub-read-again-'+edition_id))
{$('ub-read-again-'+edition_id+'-span').innerHTML=prefix_read_again+'Хочу перечитать';if($('read_again_ph'))
{$('read_again_ph').setStyle('margin-left','0');$('read_again_ph').setStyle('margin-top','12px');}}}
else
{$('ub-status-wish-'+edition_id).set('class',cls);xhide($('ub-status-wish-'+edition_id).getChildren()[1]);}
if(value==2)
{$('ub-status-reading-'+edition_id).set('class',cls_active);xshow($('ub-status-reading-'+edition_id).getChildren()[1]);if($('ub-read-again-'+edition_id))
{$('ub-read-again-'+edition_id+'-span').innerHTML=prefix_read_again+'Перечитываю';if($('read_again_ph'))
{$('read_again_ph').setStyle('margin-left','0');$('read_again_ph').setStyle('margin-top','47px');}}}
else
{$('ub-status-reading-'+edition_id).set('class',cls);xhide($('ub-status-reading-'+edition_id).getChildren()[1]);}
if(value==3)
{$('ub-status-date-'+edition_id).innerHTML='Дата завершения чтения';$('ub-status-unread-'+edition_id).set('class',cls_active);xshow($('ub-status-unread-'+edition_id).getChildren()[1]);}
else
{$('ub-status-unread-'+edition_id).set('class',cls);xhide($('ub-status-unread-'+edition_id).getChildren()[1]);}
if(value==1||value==3)
{xshow($('block5-'+edition_id));if($('status-read-'+edition_id))$('status-read-'+edition_id).show();if($('status-forecast-'+edition_id))$('status-forecast-'+edition_id).hide();}
else
{xhide($('block5-'+edition_id));if($('status-read-'+edition_id))$('status-read-'+edition_id).hide();if($('status-forecast-'+edition_id))$('status-forecast-'+edition_id).show();}
if(value==0)
{$('block2-'+edition_id).show('inline-block');}
else
{$('block2-'+edition_id).hide();}
if(value>-1)
{var tags=$('ub-tags-'+edition_id)?$('ub-tags-'+edition_id).value:'';if(tags!='')
{if($('ss-my-tags-'+edition_id+'-'+userbook_id))$('ss-my-tags-'+edition_id+'-'+userbook_id).show();if($('my-tags-block-'+edition_id+'-'+userbook_id))$('my-tags-block-'+edition_id+'-'+userbook_id).show();if($('my-tags-'+edition_id+'-'+userbook_id))$('my-tags-'+edition_id+'-'+userbook_id).show();}
else
{if($('add-tags-block-'+edition_id+'-'+userbook_id))$('add-tags-block-'+edition_id+'-'+userbook_id).show();}
if($('ss-add-tags-'+edition_id+'-'+userbook_id))$('ss-add-tags-'+edition_id+'-'+userbook_id).show();}
else
{if($('ss-my-tags-'+edition_id+'-'+userbook_id))$('ss-my-tags-'+edition_id+'-'+userbook_id).hide();if($('my-tags-block-'+edition_id+'-'+userbook_id))$('my-tags-block-'+edition_id+'-'+userbook_id).hide();if($('ss-add-tags-'+edition_id+'-'+userbook_id))$('ss-add-tags-'+edition_id+'-'+userbook_id).hide();if($('add-tags-block-'+edition_id+'-'+userbook_id))$('add-tags-block-'+edition_id+'-'+userbook_id).hide();if($('my-tags-'+edition_id+'-'+userbook_id))$('my-tags-'+edition_id+'-'+userbook_id).hide();}}
function userbook_update_new(edition_id,actual_id,userbook_id)
{if(userbook_id=='undefined')userbook_id=0;if(actual_id==0)actual_id=edition_id;var params="edition_id="+edition_id;var is_new_design=$('is-new-design')?$('is-new-design').value:0;params+="&is_new_design="+is_new_design;if($('from-rec-genres'))params+='&fromrecgenres=true';if($('ub-viewmode-'+edition_id))params+="&viewmode="+$('ub-viewmode-'+edition_id).value;if($('ub-edition-id-'+edition_id)&&$('ub-edition-id-'+edition_id).value!=edition_id)params+="&new_edition_id="+$('ub-edition-id-'+edition_id).value;if($('ub-work-edition-id-'+edition_id)&&$('ub-work-edition-id-'+edition_id).value)params+="&work-edition-id="+$('ub-work-edition-id-'+edition_id).value;if($('ub-from-content-'+edition_id))params+='&content_edition_id='+$('ub-from-content-'+edition_id).value;var own='';if($('ub-own-p-'+edition_id+'-value').value>0)own+='p';if($('ub-own-a-'+edition_id+'-value').value>0)own+='a';if($('ub-own-e-'+edition_id+'-value').value>0)own+='e';var status=$('ub-status-'+edition_id).value;var rating=$('ub-rating-'+edition_id)?$('ub-rating-'+edition_id).value:0;if(status!=1&&status!=3&&!$('ub-forecast-'+edition_id))rating=0;var day=$('date-'+edition_id+'-day').value;var month=$('date-'+edition_id+'-month').value;var year=$('date-'+edition_id+'-year').value;var shelfs=$('ub-shelfs-'+edition_id).value;var selections=$('ub-selections-'+edition_id).value;var priority=$('ub-priority-'+edition_id)?$('ub-priority-'+edition_id).value:0;if($('span-userbook-'+edition_id+'-'+userbook_id))
{var view_mode=$('ub-viewmode-'+edition_id)?$('ub-viewmode-'+edition_id).value:'';var text='';if(status==1)
{text=view_mode=='list'?'<span class="i-userbook-read"></span>':($('ub-status-read-'+edition_id)?$('ub-status-read-'+edition_id).innerHTML.replace(/(.+\<\/span\>)(.+)/g,"$2").replace(/(.+)(.+\<\/span\>)/g,"$1"):'Прочитал(а)');}
else if(status==3)
{text=view_mode=='list'?'<span class="i-userbook-unread"></span>':($('ub-status-unread-'+edition_id)?$('ub-status-unread-'+edition_id).innerHTML.replace(/(.+\<\/span\>)(.+)/g,"$2").replace(/(.+)(.+\<\/span\>)/g,"$1"):'Прочитал(а)');}
else if(status==2)
{text=view_mode=='list'?'<span class="i-userbook-reading"></span>':'Читаю';}
else if(status==0)
{text=view_mode=='list'?'<span class="i-userbook-wish"></span>':'Хочу прочитать';}
else
{text='<span class="i-userbook-add"></span>'+(view_mode=='list'?'':'Добавить');}
if(text!=''&&$$('.span-userbook-'+edition_id+'-'+userbook_id).length>0)
{$$('.span-userbook-'+edition_id+'-'+userbook_id).each(function(item,key){item.innerHTML=text;if(status==-2)item.removeClass('active').addClass('inactive');else item.removeClass('inactive').addClass('active');});}
else
{if(status==-2)$('span-userbook-'+edition_id+'-'+userbook_id).removeClass('active').addClass('inactive');else $('span-userbook-'+edition_id+'-'+userbook_id).removeClass('inactive').addClass('active');}
if(status==-2&&$$('.xa-main-rating-'+edition_id+'-'+userbook_id).length>0)
{if($$('.xa-main-rating-'+edition_id+'-'+userbook_id).length>0)
$$('.xa-main-rating-'+edition_id+'-'+userbook_id).each(function(item,key){var item_rand_id=item.dataset.rand_id;var user_rating_mode=item.dataset.user_rating_mode;var star_size=item.dataset.star_size;ll_stars_new(edition_id,0,user_rating_mode==1?true:false,star_size,false,item_rand_id);var rand_name=!item_rand_id?'':('-'+item_rand_id);var value=$('ub-rating-'+edition_id)&&$('ub-rating-'+edition_id+rand_name)&&$('ub-rating-'+edition_id+rand_name).value!=rating?rating:($('ub-rating-other-'+edition_id+rand_name)&&$('ub-rating-other-'+edition_id+rand_name)!=rating?rating:0);var norating_el=$('ub-no-rating-'+edition_id+rand_name);if(rating==0)
{norating_el.className='action standard';if($('ub-no-rating_other-'+edition_id+rand_name))$('ub-no-rating_other-'+edition_id+rand_name).className='action standard';}
else
{norating_el.className='action';if($('ub-no-rating_other-'+edition_id+rand_name))$('ub-no-rating_other-'+edition_id+rand_name).className='action';}
if($('ub-rating-'+edition_id+rand_name))$('ub-rating-'+edition_id+rand_name).value=value;if($('ub-rating-other-'+edition_id+rand_name))$('ub-rating-other-'+edition_id+rand_name).value=value;});}}
if($('ub-novelty-'+edition_id)&&$('ub-novelty-'+edition_id).value>0)
{var rating_text='МОЙ ПРОГНОЗ ОЦЕНКИ:';if(status==1||status==3)
{rating_text='МОЯ ОЦЕНКА:';}
$$('.user-rating-text-'+edition_id).each(function(item){item.innerHTML=rating_text;});}
params+="&rating="+rating+"&status="+status+"&day="+day+"&month="+month+"&year="+year+"&shelfs="+shelfs+"&selections="+selections+"&userbook_id="+userbook_id+"&priority="+priority+"&own="+own;if($('ub-read-again-'+edition_id)&&$('ub-read-again-'+edition_id).value==1)
{params+='&read_again=1';$('ub-read-again-'+edition_id).value=-1;}
if($('from-rec-page'))
{params+='&calc=true';if($('recrating-'+edition_id))params+=('&rec_rating='+$('recrating-'+edition_id).value);}
if($('rec-status-'+edition_id))$('rec-status-'+edition_id).style.display='none';new Request({url:'/user/savebook',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{if(document.getElementById('ub-'+edition_id+'-shelf-save').offsetLeft)
{$('ub-'+edition_id+'-shelf-save').removeClass('btn-ub-save').addClass('btn-ub-error');$('ub-'+edition_id+'-shelf-save').innerHTML='<span class="i-ub-error"></span>Изменения не сохранены';$('ub-'+edition_id+'-shelf-save').addEvent('click',function(){$(this).removeClass('btn-ub-error').addClass('btn-ub-save');$(this).innerHTML='Сохранить';});setTimeout(function(){$('ub-'+edition_id+'-shelf-save').removeClass('btn-ub-error').addClass('btn-ub-save');$('ub-'+edition_id+'-shelf-save').innerHTML='Сохранить';$('ub-'+edition_id+'-shelf-save').title='Сохранить';},3000);}
else
{$('ub-'+edition_id+'-selection-save').removeClass('btn-ub-save').addClass('btn-ub-error');$('ub-'+edition_id+'-selection-save').innerHTML='<span class="i-ub-error"></span>Изменения не сохранены';$('ub-'+edition_id+'-selection-save').addEvent('click',function(){$(this).removeClass('btn-ub-error').addClass('btn-ub-save');$(this).innerHTML='Сохранить';});setTimeout(function(){$('ub-'+edition_id+'-selection-save').removeClass('btn-ub-error').addClass('btn-ub-save');$('ub-'+edition_id+'-selection-save').innerHTML='Сохранить';$('ub-'+edition_id+'-selection-save').title='Сохранить';},3000);}}
else
{var htmlname='-userbook-'+actual_id+'-'+userbook_id;if(json.new_book&&$('my-book-list-tr-'+json.ub_id))
{$('my-book-list-tr-'+json.ub_id).innerHTML=json.new_book;}
if(json.ub_rating&&$('xa-rating-'+edition_id+'-'+userbook_id))$('xa-rating-'+edition_id+'-'+userbook_id).innerHTML=json.ub_rating;if(($('from-rec-page')||$('from-rec-genres'))&&typeof(ga)=='function')
{var page='hasread';if(status==2)page='reading';else if(status==0)page='wish';ga('send','pageview','/virtual_url/rec/book/'+page);}
if($('from-alike-rec-page')&&typeof(ga)=='function')
{var page='hasread';if(status==2)page='reading';else if(status==0)page='wish';ga('send','pageview','/virtual_url/recalike/book/'+page);}
if(json.ab_action)ll_pagegoal_ab(json.ab_action);if(status>-1&&$('ab-test-ub-add'))
{ll_pagegoal_ab('userbookadd');}
if(rating>0&&$('ab-test-ub-rating'))
{ll_pagegoal_ab('userbookrating');}
if(json.read_again&&json.ub_id&&$('ub-read-again-'+edition_id))$('ub-read-again-'+edition_id).value=json.ub_id;count_recs_added++;if(count_recs_added==20)
{ll_get_new_recs();}
if(document.getElementById('ub-'+edition_id+'-shelf-save')&&document.getElementById('ub-'+edition_id+'-shelf-save').offsetLeft)
{$('ub-'+edition_id+'-shelf-save').removeClass('btn-ub-save').addClass('btn-ub-okay');$('ub-'+edition_id+'-shelf-save').innerHTML='<span class="i-ub-okay"></span>Изменения сохранены';$('ub-'+edition_id+'-shelf-save').title='Изменения сохранены';$('ub-'+edition_id+'-shelf-save').addEvent('click',function(){$(this).removeClass('btn-ub-okay').addClass('btn-ub-save');$(this).innerHTML='Сохранить';$(this).title='Сохранить';});setTimeout(function(){if($('ub-'+edition_id+'-shelf-save'))
{$('ub-'+edition_id+'-shelf-save').removeClass('btn-ub-okay').addClass('btn-ub-save');$('ub-'+edition_id+'-shelf-save').innerHTML='Сохранить';$('ub-'+edition_id+'-shelf-save').title='Сохранить';}},3000);}
else if(document.getElementById('ub-'+edition_id+'-selection-save'))
{$('ub-'+edition_id+'-selection-save').removeClass('btn-ub-save').addClass('btn-ub-okay');$('ub-'+edition_id+'-selection-save').innerHTML='<span class="i-ub-okay"></span>Изменения сохранены';$('ub-'+edition_id+'-selection-save').title='Изменения сохранены';$('ub-'+edition_id+'-selection-save').addEvent('click',function(){$(this).removeClass('btn-ub-okay').addClass('btn-ub-save');$(this).innerHTML='Сохранить';$(this).title='Сохранить';});setTimeout(function(){if($('ub-'+edition_id+'-selection-save'))
{$('ub-'+edition_id+'-selection-save').removeClass('btn-ub-okay').addClass('btn-ub-save');$('ub-'+edition_id+'-selection-save').innerHTML='Сохранить';$('ub-'+edition_id+'-selection-save').title='Сохранить';}},3000);}
ub_current_id=json.ub_id;if(json.is_new)ub_new_id=json.ub_id;ub_soc_type=rating>0&&(status==1||status==3)?'book_rate':'book_add';}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send(params);if($('ga-track-ub')&&status)
{var type=$('ga-track-ub').value;ll_ga_track_ub(status,edition_id,type);}}
function ll_ub_set_shelf_new(edition_id,selection_id,actual_id,userbook_id,type)
{if(!type||type=='undefined')
type='shelf';if($('ub-'+type+'-'+edition_id+'-'+selection_id)&&$('ub-'+type+'-'+edition_id+'-'+selection_id).hasClass('active'))
{var params="edition_id="+edition_id+'&selection_id='+selection_id+'&type='+type;new Request({url:'/user/checkugc',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{alert(json.message);}
else
{var has_ugc=json.has_ugc;if(has_ugc)
{if(!confirm('При удалении книги '+(type=='shelf'?'с полки':'из подборки')+' исчезнет добавленное вами описание.\nВы уверены?'))
return false;}
if($('ub-'+type+'-'+edition_id+'-'+selection_id))
{if($('ub-'+type+'-'+edition_id+'-'+selection_id).hasClass('active'))
{$('ub-'+type+'-'+edition_id+'-'+selection_id).removeClass('active');$('ub-'+type+'s-'+edition_id).value=$('ub-'+type+'s-'+edition_id).value.replace(','+selection_id,'');}
else
{$('ub-'+type+'-'+edition_id+'-'+selection_id).addClass('active');if($('ub-'+type+'s-'+edition_id).value.indexOf(','+selection_id+',')==-1)
{$('ub-'+type+'s-'+edition_id).value=$('ub-'+type+'s-'+edition_id).value+selection_id+',';}}
$('ub-'+type+'-'+edition_id+'-'+selection_id).onclick='';$('ub-'+type+'-'+edition_id+'-'+selection_id).removeEvents('click').addEvent('click',function(){ll_ub_set_shelf_new(edition_id,selection_id,actual_id,userbook_id,type)});userbook_update_new(edition_id,actual_id,userbook_id);}}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send(params);}
else
{if($('ub-'+type+'-'+edition_id+'-'+selection_id))
{if($('ub-'+type+'-'+edition_id+'-'+selection_id).hasClass('active'))
{$('ub-'+type+'-'+edition_id+'-'+selection_id).removeClass('active');$('ub-'+type+'s-'+edition_id).value=$('ub-'+type+'s-'+edition_id).value.replace(','+selection_id,'');}
else
{$('ub-'+type+'-'+edition_id+'-'+selection_id).addClass('active');if($('ub-'+type+'s-'+edition_id).value.indexOf(','+selection_id+',')==-1)
{$('ub-'+type+'s-'+edition_id).value=$('ub-'+type+'s-'+edition_id).value+selection_id+',';}}
$('ub-'+type+'-'+edition_id+'-'+selection_id).onclick='';$('ub-'+type+'-'+edition_id+'-'+selection_id).removeEvents('click').addEvent('click',function(){ll_ub_set_shelf_new(edition_id,selection_id,actual_id,userbook_id,type)});userbook_update_new(edition_id,actual_id,userbook_id);}}}
function ll_ub_shelf_add_new(edition_id,actual_id,userbook_id,type)
{if(!type||type=='undefined')type='shelf';var visible_all=0;var title=$('ub-input-'+type+'-'+edition_id).value;if(title=='')
{alert('Введите название '+(type=='shelf'?'полки':'подборки'));return false;}
if($('ub-a-'+type+'-spinner-'+edition_id))$('ub-a-'+type+'-spinner-'+edition_id).show();new Request({url:'/selection/addusershelf',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);return false;}
if(json.selection_id)
{var a=new Element('a',{'href':'javascript:void(0)','id':'ub-'+type+'-'+edition_id+'-'+json.selection_id,'class':'menu-item','title':json.title,'onclick':'ll_ub_set_shelf_new('+edition_id+', '+json.selection_id+','+actual_id+', '+userbook_id+(type=='selection'?', \'selection\'':'')+')'});a.innerHTML='<span class="ub-check"></span>'+json.title;var tr=new Element('tr');var first_td=new Element('td');var second_td=new Element('td');var str_number=$$('#ub-'+type+'s-'+edition_id+'-table tr').length;var span_access_all_icon=new Element('span',{'class':'i-shelf-access-all shelf-access-'+json.selection_id,});var span_access_private_icon=new Element('span',{'class':'i-shelf-access-private shelf-access-'+json.selection_id,'title':(type=='selection'?'Личная подборка.':'Книжная полка.')+' Вижу только я.'});$(span_access_all_icon).style.display='none';span_access_private_icon.inject(second_td);span_access_all_icon.inject(second_td);a.inject(first_td);first_td.inject(tr);second_td.inject(tr);if($('ub-'+type+'s-'+edition_id+'-table'))
{if($('no-'+type+'s-'+edition_id))$('no-'+type+'s-'+edition_id).dispose();$('ub-'+type+'s-'+edition_id+'-table').appendChild(tr);$('ub-'+type+'s-'+edition_id+'-table').scrollTop=$('ub-'+type+'s-'+edition_id+'-table').scrollHeight;$('ub-input-'+type+'-'+edition_id).value='';$('ub-'+type+'-'+edition_id).hide();$('ub-a-'+type+'-'+edition_id).show();ll_ub_set_shelf_new(edition_id,json.selection_id,actual_id,userbook_id,type);}}
$('ub-a-'+type+'-spinner-'+edition_id).hide();},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send('edition_id='+edition_id+'&title='+encodeURIComponent(title)+'&type='+type+'&visible_all='+visible_all);}
function ll_ub_set_status(edition_id,status,actual_id,userbook_id)
{var value=$('ub-status-'+edition_id).value!=status?status:-2;$('ub-status-'+edition_id).value=value;var is_new_design=$('is-new-design')?$('is-new-design').value:0;if(is_new_design=='ll2015b')
{userbook_update(edition_id,actual_id,userbook_id);if(value==-2)
{xhide('block6-'+edition_id);xhide('xa-menu-tags-'+edition_id+'-'+userbook_id);}
else
{xshow('block6-'+edition_id);xshow('xa-menu-tags-'+edition_id+'-'+userbook_id);}
var cls='bookmenu';var cls_active='bookmenu active';var prefix_read_again='<span class="ub-check"></span> ';}
else
{var cls='action';var cls_active='action standard';var prefix_read_again='';}
if(value==1)
{$('ub-status-read-'+edition_id).set('class',cls_active);if($('ub-read-again-'+edition_id))
{$('ub-read-again-'+edition_id+'-span').innerHTML=prefix_read_again+$('ub-read-again-'+edition_id+'-hid').value;if($('read_again_ph'))
{$('read_again_ph').setStyle('margin-left','-10px');$('read_again_ph').setStyle('margin-top','6px');}}}
else
{$('ub-status-read-'+edition_id).set('class',cls);}
if(value==0)
{$('ub-status-wish-'+edition_id).set('class',cls_active);if($('ub-read-again-'+edition_id))
{$('ub-read-again-'+edition_id+'-span').innerHTML=prefix_read_again+'хочу перечитать';if($('read_again_ph'))
{$('read_again_ph').setStyle('margin-left','0');$('read_again_ph').setStyle('margin-top','12px');}}}
else
{$('ub-status-wish-'+edition_id).set('class',cls);}
if(value==2)
{$('ub-status-reading-'+edition_id).set('class',cls_active);if($('ub-read-again-'+edition_id))
{$('ub-read-again-'+edition_id+'-span').innerHTML=prefix_read_again+'перечитываю';if($('read_again_ph'))
{$('read_again_ph').setStyle('margin-left','0');$('read_again_ph').setStyle('margin-top','47px');}}}
else
{$('ub-status-reading-'+edition_id).set('class',cls);}
if(value==3)
{$('ub-status-unread-'+edition_id).set('class',cls_active);}
else
{$('ub-status-unread-'+edition_id).set('class',cls);}
if(value==1||value==3)
{xshow($('block5-'+edition_id));if($('status-read-'+edition_id))$('status-read-'+edition_id).show();if($('status-forecast-'+edition_id))$('status-forecast-'+edition_id).hide();}
else
{xhide($('block5-'+edition_id));if($('status-read-'+edition_id))$('status-read-'+edition_id).hide();if($('status-forecast-'+edition_id))$('status-forecast-'+edition_id).show();}
if(value==0)
{xshow($('block21-'+edition_id));}
else
{xhide($('block21-'+edition_id));}}
function ll_ub_set_own(edition_id,own,actual_id,userbook_id)
{var el='ub-own-'+own+'-'+edition_id+'-value';if($(el).value>0)$(el).value=0;else $(el).value=1;var is_new_design=$('is-new-design')?$('is-new-design').value:0;if(is_new_design=='ll2015b')
{userbook_update(edition_id,actual_id,userbook_id);var cls='menu-item';var cls_active='menu-item active';}
else
{var cls='action';var cls_active='action standard';}
if($('ub-own-p-'+edition_id+'-value').value>0)$('ub-own-p-'+edition_id).set('class',cls_active);else $('ub-own-p-'+edition_id).set('class',cls);if($('ub-own-a-'+edition_id+'-value').value>0)$('ub-own-a-'+edition_id).set('class',cls_active);else $('ub-own-a-'+edition_id).set('class',cls);if($('ub-own-e-'+edition_id+'-value').value>0)$('ub-own-e-'+edition_id).set('class',cls_active);else $('ub-own-e-'+edition_id).set('class',cls);}
function ll_ub_set_edition(edition_id,new_edition_id)
{_ll_set_edition(edition_id,new_edition_id,false);}
function ll_ub_set_work_edition_id(edition_id,new_edition_id,userbook_id)
{popap='div-ub-work-editions-'+edition_id;var is_new_design=$('is-new-design')?$('is-new-design').value:0;var params="userbook_id="+userbook_id+'&new_edition_id='+new_edition_id+'&is_new_design='+is_new_design;new Request({url:'/user/saveworkedition',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);}
else
{xhide(popap);if(json.new_book&&$('my-book-list-tr-'+userbook_id))
{$('my-book-list-tr-'+userbook_id).innerHTML=json.new_book;}
if(is_new_design)
{var span=$('work-editions-picture-'+edition_id+'-'+userbook_id)?$('work-editions-picture-'+edition_id+'-'+userbook_id):new Element('span',{class:'work-edition-picture',id:'work-editions-picture-'+edition_id+'-'+userbook_id});span.innerHTML=json.new_edition_picture;$('event-userbook-'+edition_id+'-'+userbook_id).appendChild(span);}}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send(params);}
function ll_ub_check_work_edition(edition_id,new_edition_id,userbook_id)
{if($$('.work-edition-'+edition_id+'-'+userbook_id+'-row').length>0)
{for(var i=0;i<$$('.work-edition-'+edition_id+'-'+userbook_id+'-row').length;i++)
{if($$('.work-edition-'+edition_id+'-'+userbook_id+'-row')[i].id=='work-edition-'+new_edition_id)
{if($$('.work-edition-'+edition_id+'-'+userbook_id+'-row')[i].hasClass('checked'))
{$$('.work-edition-'+edition_id+'-'+userbook_id+'-row')[i].removeClass('checked');}
else
{$$('.work-edition-'+edition_id+'-'+userbook_id+'-row')[i].addClass('checked');}
continue;}
$$('.work-edition-'+edition_id+'-'+userbook_id+'-row')[i].removeClass('checked');}}}
function ll_proceed_ub_work_edition(edition_id,userbook_id)
{if($$('.work-edition-'+edition_id+'-'+userbook_id+'-row').length>0)
{var work_edition_id=0;$$('.work-edition-'+edition_id+'-'+userbook_id+'-row').each(function(item){if($(item).hasClass('checked'))
{work_edition_id=$(item).dataset.edition_id;}});ll_ub_set_work_edition_id(edition_id,work_edition_id,userbook_id);$('work-editions-block-'+edition_id+'-'+userbook_id).hide();}}
function _ll_set_edition(edition_id,new_edition_id,is_work)
{var prefix='ub-edition-'+edition_id+'-'+new_edition_id;var pic=$(prefix+'-pic').getChildren()[0].getChildren()[0];var html_selector_pic;var html_selector_name;var el;var alias;if(is_work)
{html_selector_pic='ub-pic-work-'+edition_id;html_selector_name='';el='ub-work-edition-id-'+edition_id;alias='work_editions';}
else
{html_selector_pic='ub-pic-'+edition_id;html_selector_name='ub-book-'+edition_id;el='ub-edition-id-'+edition_id;alias=null;}
if($(html_selector_pic))$(html_selector_pic).getChildren()[0].getChildren()[0].src=pic.src;if($(html_selector_name))$(html_selector_name).set('html','<a href=/book/'+new_edition_id+'><b>'+
($(prefix+'-author')?$(prefix+'-author').get('text')+'<br>':'')+
$(prefix+'-name').get('text')+'</b></a>');$(el).value=new_edition_id;if(is_work)$('div-ub-work-editions-'+edition_id).innerHTML='';else ll_ub_editions(edition_id,alias);}
function ll_ub_clear_work_edition(edition_id)
{html_selector_pic='ub-pic-work-'+edition_id;html_selector_name='ub-book-work-'+edition_id;el='ub-work-edition-id-'+edition_id;if($(html_selector_pic))
{$(html_selector_pic).set('html','<a href="" title=""><img src="" alt="" style="background-color: #ffffff;float: left; margin-right: 7px;"></a>');}
if($(html_selector_name))$(html_selector_name).set('html','');$('ub-clear_work').setStyle('display','none');$(el).value=0;}
function ll_ub_sele_only(edition_id)
{var el='ub-selection-'+edition_id+'-only';}
function ll_checkbox_confirm(object_name,checked,msg)
{var obj=$(object_name);if(!obj)return;if(obj.checked==checked)
if(!confirm(msg))
obj.checked=!checked;}
function ll_ub_save(edition_id,actual_id,in_collection,userbook_id)
{if(userbook_id=='undefined')userbook_id=0;if(actual_id==0)actual_id=edition_id;if($('a-ub-save-'+edition_id))
{if($('a-ub-save-'+edition_id).hasClass('i-clock'))return;$('a-ub-save-'+edition_id).addClass('i-clock');}
var params="edition_id="+edition_id;if($('ub-viewmode-'+edition_id))params+="&viewmode="+$('ub-viewmode-'+edition_id).value;if($('ub-tagschanged-'+edition_id)&&$('ub-tagschanged-'+edition_id).value)params+="&tagschanged=true";if($('ub-edition-id-'+edition_id)&&$('ub-edition-id-'+edition_id).value!=edition_id)params+="&new_edition_id="+$('ub-edition-id-'+edition_id).value;if($('ub-work-edition-id-'+edition_id)&&$('ub-work-edition-id-'+edition_id).value)params+="&work-edition-id="+$('ub-work-edition-id-'+edition_id).value;if($('ub-from-content-'+edition_id))params+='&content_edition_id='+$('ub-from-content-'+edition_id).value;var selections='';$$('.ub-selecheck-'+edition_id).each(function(item){if(item.checked)selections+=item.id.substr(item.id.lastIndexOf('-')+1)+',';});if($('ub-selection-'+edition_id+'-only')&&$('ub-selection-'+edition_id+'-only').checked)
{params+="&seleonly=1&selections="+selections;}
else
{var status=$('ub-status-'+edition_id).value;var rating=$('ub-rating-'+edition_id)?$('ub-rating-'+edition_id).value:0;if(status==-2)
{if(in_collection)
{ll_delete_book(edition_id,($$('.review-'+edition_id).length>0?1:0),userbook_id);ll_ub_destroy(edition_id,userbook_id);}
else
{alert('Пожалуйста, укажите статус прочтения книги!');if($('a-ub-save-'+edition_id).hasClass('i-clock'))$('a-ub-save-'+edition_id).removeClass('i-clock');}
return false;}
else if(status==1&&rating==-2)
{alert('Пожалуйста, укажите оценку книги!');if($('a-ub-save-'+edition_id))$('a-ub-save-'+edition_id).removeClass('i-clock');return false;}
var own='';if($('ub-own-p-'+edition_id+'-value').value>0)own+='p';if($('ub-own-a-'+edition_id+'-value').value>0)own+='a';if($('ub-own-e-'+edition_id+'-value').value>0)own+='e';var day=$('date-'+edition_id+'-day').value;var month=$('date-'+edition_id+'-month').value;var year=$('date-'+edition_id+'-year').value;var priority=$('ub-priority-'+edition_id)?$('ub-priority-'+edition_id).value:0;var tags=$('ub-tags-'+edition_id).value;var notes=($('ub-notes-'+edition_id))?$('ub-notes-'+edition_id).value:'';var is_new_design=$('is-new-design')?$('is-new-design').value:0;params+="&rating="+rating+"&status="+status+"&own="+own+"&day="+day+"&month="+month+"&year="+year+"&priority="+priority+"&selections="+selections+"&tags="+encodeURIComponent(tags)+"&notes="+encodeURIComponent(notes)+"&userbook_id="+userbook_id+"&is_new_design="+is_new_design;if($('ub-read-again-'+edition_id)&&$('ub-read-again-'+edition_id).checked)
{params+='&read_again=1';}}
if($('from-rec-page'))params+='&calc=true';if($('rec-status-'+edition_id))$('rec-status-'+edition_id).style.display='none';new Request({url:'/user/savebook',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);if($('a-ub-save-'+edition_id).hasClass('i-clock'))$('a-ub-save-'+edition_id).removeClass('i-clock');}
else
{var htmlname='-userbook-'+actual_id+'-'+userbook_id;if($('div'+htmlname))
{$('div'+htmlname).destroy();}
if($('div-userbook-'+actual_id+'-'+0))
{$('div-userbook-'+actual_id+'-'+0).destroy();}
if(json.content&&$('xa-main-'+edition_id+'-'+userbook_id))
{$('xa-main-'+edition_id+'-'+userbook_id).innerHTML=json.content;}
if(json.content&&$('xa-main-'+edition_id+'-'+0))
{$('xa-main-'+edition_id+'-'+0).innerHTML=json.content;}
if(json.new_book&&$('my-book-list-tr-'+json.ub_id))
{$('my-book-list-tr-'+json.ub_id).innerHTML=json.new_book;}
if(json.ub_rating&&$('xa-rating-'+edition_id+'-'+userbook_id))$('xa-rating-'+edition_id+'-'+userbook_id).innerHTML=json.ub_rating;if(($('from-rec-page')||$('from-rec-genres'))&&typeof(ga)=='function')
{var page='hasread';if(status==2)page='reading';else if(status==0)page='wish';ga('send','pageview','/virtual_url/rec/book/'+page);}
if($('from-alike-rec-page')&&typeof(ga)=='function')
{var page='hasread';if(status==2)page='reading';else if(status==0)page='wish';ga('send','pageview','/virtual_url/recalike/book/'+page);}
if(json.ab_action)ll_pagegoal_ab(json.ab_action);}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send(params);if($('ga-track-ub'))
{var type=$('ga-track-ub').value;ll_ga_track_ub(status,edition_id,type);}
return false;}
function ll_bs_destroy(edition_id)
{var htmlname='-bookswap-'+edition_id;if($('div'+htmlname))
{$('div'+htmlname).destroy();$('a'+htmlname).removeClass('i-clear');return true;}
return false;}
function ll_bookswap(e,edition_id)
{var htmlname='-bookswap-'+edition_id;if($('a'+htmlname))
{if($('a'+htmlname).hasClass('i-clock'))return;if(!$('div'+htmlname))$('a'+htmlname).addClass('i-clock');}
if(ll_bs_destroy(edition_id))return;var coords=getMouseCoords(e);new Request({url:'/user/bookswap',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json,null,'ll_bookswap(event, '+edition_id+');');if(json['error'])
{alert(json.error);}
else
{if(!json.content)return false;var container=$('body');if(container)
{if($('div'+htmlname))$('div'+htmlname).destroy();var div=new Element('div',{id:'div'+htmlname});var w=getClientWidth();if(coords['x']+500>w)coords['x']-=400;if(coords['x']<0)coords['x']=0;var st='position:absolute;top:'+(coords['y']+10)+'px;left:'+coords['x']+'px;';if(isIE())div.style.cssText=st;div.setAttribute('style',st);div.addClass('bookswap');div.innerHTML=json.content;if(coords['x']==0&&coords['y']==0&&$('container-bookswap-'+edition_id))$('container-bookswap-'+edition_id).adopt(div);else container.adopt(div);}
else
{alert('Ошибка!');}}},onRequest:initAd,onSuccess:function()
{if($('a'+htmlname))
{$('a'+htmlname).removeClass('i-clock');$('a'+htmlname).addClass('i-clear');}
closeAd();},onFailure:function()
{if($('a'+htmlname))$('a'+htmlname).removeClass('i-clock');failure();}}).send("edition_id="+edition_id);return false;}
function ll_bs_set_swap_type(edition_id,swap_type)
{var el='bs-swap-type-'+swap_type+'-'+edition_id+'-value';if($(el).value>0)$(el).value=0;else $(el).value=1;if(swap_type=='w')
{if($(el).value==1)
{$('bs-swap-type-s-'+edition_id+'-value').value=0;$('bs-swap-type-x-'+edition_id+'-value').value=0;$('bs-swap-type-l-'+edition_id+'-value').value=0;$('bs-swap-type-g-'+edition_id+'-value').value=0;}}
else
{if($(el).value==1)
{$('bs-swap-type-w-'+edition_id+'-value').value=0;}}
if($('bs-swap-type-s-'+edition_id+'-value').value>0)$('bs-swap-type-s-'+edition_id).set('class','action standard');else $('bs-swap-type-s-'+edition_id).set('class','action');if($('bs-swap-type-x-'+edition_id+'-value').value>0)$('bs-swap-type-x-'+edition_id).set('class','action standard');else $('bs-swap-type-x-'+edition_id).set('class','action');if($('bs-swap-type-l-'+edition_id+'-value').value>0)$('bs-swap-type-l-'+edition_id).set('class','action standard');else $('bs-swap-type-l-'+edition_id).set('class','action');if($('bs-swap-type-g-'+edition_id+'-value').value>0)$('bs-swap-type-g-'+edition_id).set('class','action standard');else $('bs-swap-type-g-'+edition_id).set('class','action');if($('bs-swap-type-w-'+edition_id+'-value').value>0)$('bs-swap-type-w-'+edition_id).set('class','action standard');else $('bs-swap-type-w-'+edition_id).set('class','action');}
function ll_bs_set_status(edition_id,status)
{var value=$('bs-status-'+edition_id).value!=status?status:-2;$('bs-status-'+edition_id).value=value;if(value==1)$('bs-status-hidden-'+edition_id).set('class','action standard');else $('bs-status-hidden-'+edition_id).set('class','action');if(value==2)$('bs-status-active-'+edition_id).set('class','action standard');else $('bs-status-active-'+edition_id).set('class','action');if(value==3)$('bs-status-reserved-'+edition_id).set('class','action standard');else $('bs-status-reserved-'+edition_id).set('class','action');if(value==4)$('bs-status-closed-'+edition_id).set('class','action standard');else $('bs-status-closed-'+edition_id).set('class','action');}
function ll_bs_save(edition_id)
{if($('a-bs-save-'+edition_id))
{if($('a-bs-save-'+edition_id).hasClass('i-clock'))return;$('a-bs-save-'+edition_id).addClass('i-clock');}
var params="edition_id="+edition_id;if($('ub-viewmode-'+edition_id))params+="&viewmode="+$('ub-viewmode-'+edition_id).value;var status_id=$('bs-status-'+edition_id).value;var swap_type='';if($('bs-swap-type-s-'+edition_id+'-value').value>0)swap_type+='s';if($('bs-swap-type-x-'+edition_id+'-value').value>0)swap_type+='x';if($('bs-swap-type-l-'+edition_id+'-value').value>0)swap_type+='l';if($('bs-swap-type-g-'+edition_id+'-value').value>0)swap_type+='g';if($('bs-swap-type-w-'+edition_id+'-value').value>0)swap_type+='w';if(swap_type=='')
{alert('Пожалуйста, укажите действие!');if($('a-bs-save-'+edition_id))$('a-bs-save-'+edition_id).removeClass('i-clock');return false;}
var city_id=$('bs-city-id-'+edition_id).value;var description=($('bs-description-'+edition_id))?$('bs-description-'+edition_id).value:'';var notes=($('bs-notes-'+edition_id))?$('bs-notes-'+edition_id).value:'';var save_city=($('bs-save-city-'+edition_id))?$('bs-notes-'+edition_id).value:'';params+='&status_id='+status_id+'&swap_type='+swap_type+'&city_id='+city_id+'&description='+encodeURIComponent(description)+'&notes='+encodeURIComponent(notes);if($('bs-save-city-'+edition_id).checked)
params+='&save_city=1'
if($('bs-post-okay-'+edition_id).checked)
params+='&post_okay=1'
new Request({url:'/user/savebookswap',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);}
else
{var htmlname='-bookswap-'+edition_id;if($('div'+htmlname))
{$('div'+htmlname).destroy();}
if(json.content)
{$('action-userbook-'+edition_id).innerHTML=json.content;}}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send(params);return false;}
function getMouseCoords(e){var posx=0;var posy=0;if(!e)var e=window.event;if(e.pageX||e.pageY){posx=e.pageX;posy=e.pageY;}
else if(e.clientX||e.clientY){posx=e.clientX+document.body.scrollLeft
+document.documentElement.scrollLeft;posy=e.clientY+document.body.scrollTop
+document.documentElement.scrollTop;}
var margin_left=$('body').getStyle('margin-left').toInt();if(isNaN(margin_left)||margin_left==null||margin_left=='undefined'||margin_left<0)margin_left=0;return{'x':posx-margin_left,'y':posy};}
function getClientWidth(width_unlim)
{var w=0,h=0;if(typeof(window.innerWidth)=='number'){w=window.innerWidth;h=window.innerHeight;}
else if(document.documentElement&&(document.documentElement.clientWidth||document.documentElement.clientHeight)){w=document.documentElement.clientWidth;h=document.documentElement.clientHeight;}
else if(document.body&&(document.body.clientWidth||document.body.clientHeight)){w=document.body.clientWidth;h=document.body.clientHeight;}
if((!width_unlim||width_unlim=='undefined')&&w>1200)w=1200;return w;}
function isIE(){return'\v'=='v';}
var message_set_status=function(p_message_id,p_status_id,p_page,p_filter,p_mass,p_url)
{var is_new_design=$('is-new-design')?$('is-new-design').value:'';if(p_filter=='undefined'||typeof(p_filter)=='undefined')p_filter='';if(p_mass=='undefined'||typeof(p_mass)=='undefined')p_mass=0;if(p_url=='undefined'||typeof(p_url)=='undefined')p_url='';var elements=$$('.sysmsg-row');var message_ids='';if(elements.length>0)
{for(var i=0;i<elements.length;i++)
{var id=elements[i].id.substring(7);message_ids+=id+',';}}
new Request({url:'/message/setstatus',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.content)
{if($('message-'+json.message_id+'-actions'))$('message-'+json.message_id+'-actions').innerHTML=json.content;if($('messageview-'+json.message_id+'-actions'))
{$('messageview-'+json.message_id+'-actions').innerHTML=json.content;}}
if(json.deleted==1)
{if($('message-row-'+json.message_id))$('message-row-'+json.message_id).innerHTML='Сообщение удалено.';if($('messageview-'+json.message_id))
{$('messageview-'+json.message_id).innerHTML='Сообщение удалено.';}}
if($('sysmsg-'+json.message_id))
{$('sysmsg-'+json.message_id).dispose();sysmsg_update();}
if($('msg-read-'+p_message_id)&&$('msg-'+p_message_id))
{$('msg-'+p_message_id).dispose();}
if(is_new_design)
{if(p_status_id==0)
{$('message-row-'+p_message_id).addClass('again-new');$('message-row-'+p_message_id).addEvent('click',function(event){eventstop(event);});}
else if(p_status_id==1)
{$('message-row-'+p_message_id).removeClass('new');$('message-brief-'+p_message_id).hide();$('message-text-'+p_message_id).show();}
if(p_page=='in'||p_page=='notifications')
{if($('unread-counter-'+p_message_id))
{if(json.count_unread&&json.count_unread>0)
{$('unread-counter-'+p_message_id).innerHTML='+ '+json.count_unread;$('unread-counter-'+p_message_id).style.display='inline-block';}
else
{$('unread-counter-'+p_message_id).hide();}}}
else if(p_status_id==1)
{if($('unread-counter-'+p_message_id))$('unread-counter-'+p_message_id).hide();}
if(p_page=='correspondence'||p_page=='notifications')
{bind_message_filter(p_page,p_message_id,p_filter);}}
service_pinger(0);if(is_new_design&&p_url!=''&&(p_page=='in'||p_page=='notifications'))location.href=p_url;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("message_id="+p_message_id+"&status_id="+p_status_id+"&page="+p_page+"&is_new_design="+is_new_design+"&message_ids="+message_ids+"&filter="+p_filter+"&mass="+p_mass);}
function ll_select(id)
{$(id).focus();$(id).select();}
var genre_toggle_node=function(genre_id)
{el_prefix='genre-tree-node-'+genre_id;if($(el_prefix+'-subnodes').style.display=='none')
{xshow(el_prefix+'-subnodes');$(el_prefix+'-icon').src='https://s.livelib.ru/img/icons/arrow-270-small.png';}
else
{xhide(el_prefix+'-subnodes');$(el_prefix+'-icon').src='https://s.livelib.ru/img/icons/arrow-000-small.png';}};function ll_stars(id,no,halfs)
{var i;if(!halfs)
{for(i=1;i<=10;i++)
if($('star-'+id+'-'+i)!=undefined)
$('star-'+id+'-'+i).src=i<=no?'https://s.livelib.ru/img/icons/star-green.png':'https://s.livelib.ru/img/icons/star-empty.png';}
else
{for(i=1;i<=10;i++)
{if(i%2==0)
$('star-'+id+'-'+i).src=i<=no?'https://s.livelib.ru/img/icons/star-half2-green.png':'https://s.livelib.ru/img/icons/star-half2-empty.png';else
$('star-'+id+'-'+i).src=i<=no?'https://s.livelib.ru/img/icons/star-half1-green.png':'https://s.livelib.ru/img/icons/star-half1-empty.png';}}}
function ll_restore_stars(id,halfs)
{no=$('ub-rating-'+id).value;ll_stars(id,no,halfs);}
function ll_stars_new(id,no,halfs,size,other_name,rand_id)
{if(size==null)size='';var color=no<5?'darkred':(no>6?'darkgreen':'darkblue');if(!other_name)other_name='other-';var rand_name=!rand_id?'':('-'+rand_id);var is_new_design=$('is-new-design')?$('is-new-design').value:0;var is_design_version=$('is-design-version')?$('is-design-version').value:0;var path='icons/';var prefix='-new';if(is_new_design=='ll2015b')
{var no_change_color=$('no-change-color')?true:false;if(!no_change_color)color='orange';size=size==''?'-l':('-'+size);path='skins/ll2015b/';prefix='';}
var i;if(!halfs)
{for(i=1;i<=10;i++)
{if($('star-'+id+'-'+i)!=undefined)
$('star-'+id+'-'+i).src=i<=no?'https://s.livelib.ru/img/'+path+'star'+size+'-'+color+'.png':'https://s.livelib.ru/img/'+path+'star'+size+'-empty'+prefix+'.png';if($('star-'+other_name+id+'-'+i+rand_name))$('star-'+other_name+id+'-'+i+rand_name).src=i<=no?'https://s.livelib.ru/img/'+path+'star'+size+'-'+color+'.png':'https://s.livelib.ru/img/'+path+'star'+size+'-empty'+prefix+'.png';}}
else
{for(i=1;i<=10;i++)
{if(i%2==0)
{if(is_new_design=='ll2015b')
{prefix='';if(i-1==no)prefix='-'+color;}
if($('star-'+id+'-'+i))$('star-'+id+'-'+i).src=i<=no?'https://s.livelib.ru/img/'+path+'star'+size+'-half2-'+color+'.png':'https://s.livelib.ru/img/'+path+'star'+size+'-half2-empty'+prefix+'.png';if($('star-'+other_name+id+'-'+i+rand_name))$('star-'+other_name+id+'-'+i+rand_name).src=i<=no?'https://s.livelib.ru/img/'+path+'star'+size+'-half2-'+color+'.png':'https://s.livelib.ru/img/'+path+'star'+size+'-half2-empty'+prefix+'.png';}
else
{if(is_new_design=='ll2015b')prefix='';if($('star-'+id+'-'+i))$('star-'+id+'-'+i).src=i<=no?'https://s.livelib.ru/img/'+path+'star'+size+'-half1-'+color+'.png':'https://s.livelib.ru/img/'+path+'star'+size+'-half1-empty'+prefix+'.png';if($('star-'+other_name+id+'-'+i+rand_name))$('star-'+other_name+id+'-'+i+rand_name).src=i<=no?'https://s.livelib.ru/img/'+path+'star'+size+'-half1-'+color+'.png':'https://s.livelib.ru/img/'+path+'star'+size+'-half1-empty'+prefix+'.png';}}}
if(is_new_design=='ll2015b')
{if($('rating-book-value-'+id+rand_name))
{if(is_design_version)$('rating-book-value-'+id+rand_name).hide();else if(no==0)$('rating-book-value-'+id+rand_name).innerHTML='нет оценки';else if(!halfs)$('rating-book-value-'+id+rand_name).innerHTML=$('star-other-'+id+'-'+(no+1)+rand_name)||$('star-other-'+id+'-'+(no-1)+rand_name)?no:no/2;else $('rating-book-value-'+id+rand_name).innerHTML=no/2;}
if($('rating-book-visible-'+id+rand_name))
{$('rating-book-visible-'+id+rand_name).hide();$('rating-book-status-'+id+rand_name).style.marginTop='5px';}
if($('rating-book-icon-'+id+rand_name))
{$('rating-book-icon-'+id+rand_name).hide();}
if($('rating-book-status-'+id+rand_name))
{if(no==0)$('rating-book-status-'+id+rand_name).innerHTML='без оценки';else if(no<3)$('rating-book-status-'+id+rand_name).innerHTML='книга совсем не понравилась';else if(no<5)$('rating-book-status-'+id+rand_name).innerHTML='книга не понравилась';else if(no<7)$('rating-book-status-'+id+rand_name).innerHTML='нейтральная оценка';else if(no<9)$('rating-book-status-'+id+rand_name).innerHTML='книга понравилась';else $('rating-book-status-'+id+rand_name).innerHTML='книга очень понравилась';}}}
function ll_restore_stars_new(id,halfs,size,rand_id)
{var rand_name=!rand_id?'':('-'+rand_id);var is_new_design=$('is-new-design')?$('is-new-design').value:0;no=is_new_design=='ll2015b'?($('ub-rating-other-'+id+rand_name)?$('ub-rating-other-'+id+rand_name).value:0):$('ub-rating-'+id+rand_name).value;ll_stars_new(id,no,halfs,size,null,rand_id);}
function ll_seledate_setmonth(name)
{var year=$(name+'-year').value;if(year!=0)return;var month=$(name+'-month').value;if(month==0)return;var d=new Date();var curr_month=d.getMonth();var curr_year=d.getFullYear();$(name+'-year').value=month<=curr_month+1?curr_year:curr_year-1;}
function ll_voting_more()
{var num=$('voting[number]').value*1;$('voting[number]').value=num+5;if(num+5>100)$('voting[number]').value=100;if($('voting[number]').value<=num)return;var a5=$('voting[a'+num+']');var i;for(i=0;i<5;i++)
{name='voting[a'+(num+5-i)+']';var inp=new Element('input',{type:'text',id:name,name:name});inp.addClass('wide');inp.inject(a5,'after');var span=new Element('span');span.innerHTML=(num+5-i)+'. ';span.inject(a5,'after');new Element('<br>').inject(a5,'after');}}
function ll_voting_vote(id,vote)
{var votes='';if(vote)
{var multiple=$('voting'+id+'-multiple')?1:0;$$('.voting'+id).each(function(item){if(item.checked)votes+=(votes==''?'':',')+item.id.substr(item.id.lastIndexOf('-')+1);});}
if(votes!='')votes='&votes='+votes;var is_new_design=$('is-new-design')?$('is-new-design').value:'';new Request({url:'/voting/vote',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.html)
{$('voting-container-'+id).set('html',json.html);}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("id="+id+"&vote="+vote+votes+'&is_new_design='+is_new_design);}
function ll_mouseout_hide(e,id)
{if(!e)var e=window.event;var tg=(window.event)?e.srcElement:e.target;if(tg.nodeName!='DIV')return;var reltg=(e.relatedTarget)?e.relatedTarget:e.toElement;while(reltg!=tg&&reltg.nodeName!='BODY')
reltg=reltg.parentNode
if(reltg==tg)return;xhide(id);}
var advert_preview=function()
{var preview=document.getElementById('advert_preview');preview.innerHTML='';new Request({url:'/context/advertpreview',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code!=0)
{preview.innerHTML=json.message;}
if(!json.content)return false;if(json.error_code==0)
{preview.innerHTML=json.content;}
return false;},onFailure:function()
{failure();}}).post($('advert'));}
var change_status=function(object_id,object_alias,status_id)
{if(status_id==6)
{var object='';if(object_alias=='drive')object='кампанию';if(object_alias=='advert')object='объявление';if(!confirm('Вы действительно желаете удалить '+object+'?'))return false;}
new Request({url:'/context/changestatus',method:'post',data:{object_id:object_id,object_alias:object_alias,status_id:status_id},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)document.getElementById('message').innerHTML=json.message;if(!json.content)return false;if(json.error_code==0)
{document.getElementById(object_alias+'-actionbar-'+object_id).innerHTML=json.content;if(status_id==6)document.getElementById('item-'+object_alias+'-'+object_id).destroy();if(document.getElementById('moderate'))document.getElementById('item-'+object_alias+'-'+object_id).destroy();if(status_id==6&&object_alias=='drive'&&location.href.search('context/drive/')>0)location.href='/context/drives';}
if(!json.state)return false;document.getElementById(object_alias+'-'+object_id).innerHTML=json.state;return false;},onFailure:function()
{failure();}}).send();}
var max_length=function(event,count,element)
{var clicked_element=$(event.target);var text=clicked_element.value.replace(/\r\n/g,"\n").replace(/\n/g,"\n\n");var elem=document.getElementById(element);if(text.length>=count)elem.setAttribute('style','color: red;');else elem.setAttribute('style','color: black;');elem.innerHTML=count-text.length;}
var addresponse=function(mob_id,request_id,type)
{var is_new_design=$('is-new-design')?$('is-new-design').value:'';new Request({url:'/mob'+type+'/getresponseform',method:'post',data:{mob_id:mob_id,request_id:request_id,act:'add',is_new_design:is_new_design},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message.text);}
if(!json.content)return false;if($('req-response-add-'+request_id))$('req-response-add-'+request_id).hide();document.getElementById('responsereq'+request_id).innerHTML=json.content;ll_texteditor_bind($('response_text-'+json.guid));return false;},onFailure:function()
{failure();}}).send();}
var editresponse=function(mob_id,request_id,response_id)
{new Request({url:'/mob/getresponseform',method:'post',data:{mob_id:mob_id,request_id:request_id,response_id:response_id,act:'edit'},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message.text);}
if(!json.content)return false;document.getElementById('responseedit'+response_id).innerHTML=json.content;ll_texteditor_bind($('response_text-'+json.guid));return false;},onFailure:function()
{failure();}}).send();}
var answeradvice=function(response_id,act)
{new Request({url:'/mob/getanswerform',method:'post',data:{response_id:response_id,act:act},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message.text);}
if(!json.content)return false;if($('req-resp-answer-'+response_id))$('req-resp-answer-'+response_id).hide();var el=document.getElementById('response-'+response_id);el.innerHTML=json.content;el.style.display='block';ll_texteditor_bind($('answer_text'));return false;},onFailure:function()
{failure();}}).send();}
var addresponsedd=function(mob_id,request_id,book_id,type)
{new Request({url:'/mob'+type+'/getresponseform',method:'post',data:{mob_id:mob_id,request_id:request_id,act:'add',book_id:book_id},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message.text);}
if(!json.content)return false;document.getElementById('responsereq'+request_id+'-'+book_id).innerHTML=json.content;ll_texteditor_bind($('response_text-'+json.guid));return false;},onFailure:function()
{failure();}}).send();}
var answeradvicedd=function(request_id,act)
{var is_new_design=$('is-new-design')?$('is-new-design').value:'';new Request({url:'/mobdd/getanswerform',method:'post',data:{request_id:request_id,act:act,is_new_design:is_new_design},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message.text);}
if(!json.content)return false;document.getElementById('responsereq'+request_id).innerHTML=json.content;ll_texteditor_bind($('answer_text'));return false;},onFailure:function()
{failure();}}).send();}
var getmonthstats=function(user_id,year)
{var is_new_design=$('is-new-design')?$('is-new-design').value:0;new Request({url:'/user/monthstats',method:'post',data:{user_id:user_id,year:year,is_new_design:is_new_design},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message);}
if(!json.content)return false;document.getElementById('rating-data').innerHTML='';document.getElementById('month-data').innerHTML=json.content;if(Modernizr.inlinesvg||supportsVml())
{document.getElementById('monthchart').innerHTML='';if(json.empty==false)
{var dataTable=new google.visualization.DataTable();dataTable.addColumn({'type':'string','role':'domain'});dataTable.addColumn('number','Количество книг');dataTable.addColumn({'type':'string','role':'annotation'});dataTable.addColumn({'type':'string','role':'tooltip','p':{'html':true}});dataTable.addColumn('number','Средняя оценка');dataTable.addColumn({'type':'string','role':'annotation'});dataTable.addColumn({'type':'string','role':'tooltip','p':{'html':true}});dataTable.addRows(13);for(var i=0;i<13;i++)
{dataTable.setCell(i,0,json.month[i+1].name.substring(0,3));dataTable.setCell(i,1,parseInt(json.month[i+1].count_book));dataTable.setCell(i,2,parseInt(json.month[i+1].count_book)==0?null:(json.month[i+1].count_book).toString());dataTable.setCell(i,3,'<div style="padding: 5px;"><b>'+json.month[i+1].name+'</b><br>Количество книг: <b>'+Number(json.month[i+1].count_book)+'</b></div>');dataTable.setCell(i,4,Number(json.month[i+1].avg_rating)==0?null:Number(json.month[i+1].avg_rating));dataTable.setCell(i,5,Number(json.month[i+1].avg_rating)==0?null:(json.month[i+1].avg_rating).toFixed(2).toString());dataTable.setCell(i,6,'<div style="padding: 5px;"><b>'+json.month[i+1].name+'</b><br>Средняя оценка: <b>'+Number(json.month[i+1].avg_rating)+'</b></div>');}
var options={title:json.title,vAxes:[{minValue:0,gridlines:{count:6},maxValue:json.max},{minValue:0,maxValue:5,gridlines:{count:6}}],hAxis:{slantedText:true,slantedTextAngle:30},chartArea:{top:45},seriesType:"bars",colors:['#73b0e6','#df5346'],bar:{groupWidth:15},series:{1:{type:"line",targetAxisIndex:1,pointSize:3}},legend:{position:"bottom"},tooltip:{isHtml:true}};var monthchart=new google.visualization.ComboChart(document.getElementById('monthchart'));monthchart.draw(dataTable,options);location.hash='';location.hash='#month-data';}}
else
{document.getElementById('monthchart-img').style.display='';}
return false;},onFailure:function()
{failure();}}).send();}
var getratingstats=function(user_id,year,month)
{var is_new_design=$('is-new-design')?$('is-new-design').value:0;new Request({url:'/user/ratingstats',method:'post',data:{user_id:user_id,year:year,month:month,is_new_design:is_new_design},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message);}
if(!json.content)return false;document.getElementById('rating-data').innerHTML=json.content;if((Modernizr.inlinesvg||supportsVml())&&json.is_mobile==false)
{document.getElementById('ratingchart').innerHTML='';if(json.empty==false)
{var dataTable=new google.visualization.DataTable();dataTable.addColumn({'type':'string','role':'domain'});for(var i=0;i<=parseInt(json.count_stars);i++)
{if(json.is_half)dataTable.addColumn('number',(i/2).toString());else dataTable.addColumn('number',i.toString());dataTable.addColumn({'type':'string','role':'tooltip','p':{'html':true}});dataTable.addColumn('number');}
dataTable.addRows(1);var color='';var k=0;var span='';var chart_color;if(json.count_stars==5)chart_color=['grey','white','#D84E4A','white','#D84E4A','white','#355CD7','white','#48D03F','white','#48D03F','white'];else chart_color=['grey','white','#D84E4A','white','#D84E4A','white','#D84E4A','white','#D84E4A','white','#355CD7','white','#355CD7','white','#48D03F','white','#48D03F','white','#48D03F','white','#48D03F','white'];for(i=0;i<=parseInt(json.count_stars);i++)
{color='';k=0;span='';if(json.count_stars==10&&json.is_half)
{k=i/2*10;if(k==0)color='';else if(i<5)color='red';else if(i<7)color='darkblue';else color='darkgreen';if(k==5)k='05';if(k==0)k='00';}
else if(json.count_stars==10&&!json.is_half)
{if(i==0)color='';else if(i<5)color='red';else if(i<7)color='darkblue';else color='darkgreen';if(i-4>0)k=(i-5)*10;else k='00';span='<span class="r'+k+(color!=''&&i>5?'-'+color:'')+'"></span>';if(i>5)k=50;else k=i*10;if(k==0)k='00';}
else
{if(i==0)color='';else if(i<3)color='red';else if(i<4)color='darkblue';else color='darkgreen';k=i*10;if(k==0)k='00';}
dataTable.setCell(0,3*i+2,'<div style="padding: 5px;"><span class="r'+k+(color!=''?'-'+color:'')+'"></span>'+span+'<br>Количество книг: '+parseInt(json.rating[(i)].count_book)+'</div>');dataTable.setCell(0,3*i+1,parseInt(json.rating[(i)].count_book));dataTable.setCell(0,3*i+3,null);}
var options={title:json.title,vAxis:{minValue:0,gridlines:{count:5},maxValue:json.max},hAxis:{},chartArea:{top:45,width:440},colors:chart_color,seriesType:"bars",bar:{groupWidth:300},legend:{position:"bottom",textStyle:{fontSize:10}},tooltip:{isHtml:true}};var ratingchart=new google.visualization.ComboChart(document.getElementById('ratingchart'));ratingchart.draw(dataTable,options);location.hash='';location.hash='#rating-data';}}
else
{document.getElementById('ratingchart-img').style.display='';}
return false;},onFailure:function()
{failure();}}).send();}
var select_mode=function(request_id)
{var element=document.getElementById('req-mod');if(element.value==3)$('mobreq'+request_id).style.display='block';else $('mobreq'+request_id).style.display='none';if(element.value==3)$('mobpersreq'+request_id).style.display='table-row';else $('mobpersreq'+request_id).style.display='none';}
var buybook=function(edition_id)
{new Request({url:'/order/check/'+edition_id,method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message&&json.error_code!=0)
{alert(json.message);return false;}
if(json.error_code==0)
{$('paym').innerHTML=json.content;}
return false;},onFailure:function()
{failure();}}).send();}
var getbookchart=function(edition_id,object_alias)
{if($(object_alias+'chart').isDisplayed())
{xhide(object_alias+'chart');return;}
xhide('ratingchart');xhide('topchart');var is_new_design=$('is-new-design')?$('is-new-design').value:0;new Request({url:'/book/get'+object_alias+'chart',method:'post',data:{edition_id:edition_id,is_new_design:is_new_design},onComplete:function(json)
{json=strToJson(json);if(json.message&&json.error_code!=0)
{alert(json.message);return false;}
if(json.error_code==0)
{$(object_alias+'chart').innerHTML=json.content;xshow(object_alias+'chart');}
return false;},onFailure:function()
{failure();}}).send();}
var get_section=function(section_type,book_id)
{new Request({url:'/book/getsection',method:'post',data:{section_type:section_type,book_id:book_id},onComplete:function(json)
{json=strToJson(json);if(json.message&&json.error_code!=0)
{alert(json.message);return false;}
if(json.error_code==0)
{$('section-'+section_type).innerHTML=json.content;$$('.post-yvideo').each(function(item){$(item).addEvent('click',function(){var video_id=this.dataset.video_id;var width=this.dataset.width;var height=this.dataset.height;this.innerHTML=' <iframe width="'+width+'" height="'+height+'" src="https://www.youtube.com/embed/'+video_id+'?autoplay=1" frameborder="0" allowfullscreen></iframe> ';});});}
return false;},onFailure:function()
{failure();}}).send();}
var get_search_form=function(type_alias,book_id)
{new Request({url:'/book/getsearchform',method:'post',data:{type_alias:type_alias,book_id:book_id},onComplete:function(json)
{json=strToJson(json);if(type_alias!='rec')prepare(json,null,'get_search_form(\''+type_alias+'\', '+book_id+')');if(json.message&&json.error_code!=0)
{alert(json.message);return false;}
if(json.error_code==0)
{$('search-form').innerHTML=json.content;}
return false;},onFailure:function()
{failure();}}).send();}
function ll_get_claim_form(e,object_alias,object_id)
{var coords=getMouseCoords(e);var htmlname='_claim_form_'+object_alias+'_'+object_id;if($('div'+htmlname))
{$('div'+htmlname).destroy();return false;}
new Request({url:'/main/getclaimform',method:'post',data:{object_alias:object_alias,object_id:object_id},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message&&json.error_code!=0)
{alert(json.message);return false;}
if(json.error_code==0)
{var container=$('body');if(container)
{var w=getClientWidth();if(coords['x']+500>w)coords['x']-=450;if(coords['x']<0)coords['x']=0;var div=new Element('div',{id:'div'+htmlname});var st='width:115px;position:absolute;top:'+(coords['y']+10)+'px;left:'+coords['x']+'px;';if(isIE())div.style.cssText=st;div.setAttribute('style',st);div.innerHTML=json.content;container.adopt(div);}}
return false;},onFailure:function()
{failure();}}).send();}
function ll_claim(object_alias,object_id)
{var htmlname='_claim_form_'+object_alias+'_'+object_id;comments=$$('.textarea'+htmlname).get('value').toString();type=$$('.select'+htmlname).get('value').toString();$('div'+htmlname).destroy();new Request({url:'/main/claim',method:'post',data:{object_alias:object_alias,object_id:object_id,comments:comments,type:type},onComplete:function(json)
{json=strToJson(json);prepare(json);color='green';if(json.error_code)color='red';$('tinyalert').innerHTML+='<div id="server_err_msg" class="'+color+'"><a href="javascript:void(0)" title="Закрыть" class="action a-close" onclick="this.getParent().hide();"><span class="i-clear"></span></a>'+json.message+'</div>';return false;},onFailure:function()
{failure();}}).send();}
function ll_cancel_claim(id,is_claim)
{new Request({url:'/main/statusclaim',method:'post',data:{id:id,is_claim:!!is_claim,status:'cancel'},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{$('tinyalert').innerHTML+='<div id="server_err_msg" class="red"><a href="javascript:void(0)" title="Закрыть" class="action a-close" onclick="this.getParent().hide();"><span class="i-clear"></span></a>'+json.message+'</div>';}
$$('.cancelclaim-'+id).destroy();if(json.status_html)$$('.cancelclaim-status-'+id).set('html',json.status_html);return false;},onFailure:function()
{failure();}}).send();}
function ll_confirm_claim(id)
{new Request({url:'/main/statusclaim',method:'post',data:{id:id,status:'confirm'},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{$('tinyalert').innerHTML+='<div id="server_err_msg" class="red"><a href="javascript:void(0)" title="Закрыть" class="action a-close" onclick="this.getParent().hide();"><span class="i-clear"></span></a>'+json.message+'</div>';}
$$('.cancelclaim-'+id).destroy();if(json.status_html)$$('.cancelclaim-status-'+id).set('html',json.status_html);return false;},onFailure:function()
{failure();}}).send();}
var get_search_text=function(page_no)
{var text=$('search-text').value;var type=$('search-type').value;var book_id=$('hint-book').value;var similar_book_id=$('similar-book-id')?$('similar-book-id').value:0;$('hint-book').value=0;$('hint-result').innerHTML='';new Request({url:'/book/getsearchtext',method:'post',data:{type:type,text:text,page_no:page_no,book_id:book_id,similar_book_id:similar_book_id},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message&&json.error_code!=0)
{alert(json.message);return false;}
if(json.error_code==0)
{$('result-books').innerHTML=json.content;$('result-books').scrollTo(0,0);$('content').style.minHeight='600px';if(type=='rec')$('result-books').style.padding='10px';}
return false;},onFailure:function()
{failure();}}).send();}
var get_all_editions=function(book_id,page_no)
{var type=$('search-type').value;new Request({url:'/book/getalleditions',method:'post',data:{type:type,book_id:book_id,page_no:page_no},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message&&json.error_code!=0)
{alert(json.message);return false;}
if(json.error_code==0)
{$('result-books').innerHTML=json.content;$('result-books').scrollTo(0,0);$('content').style.minHeight='600px';}
return false;},onFailure:function()
{failure();}}).send();}
var searchhints=Array();var is_search_query_back=true;var ll_search=function(event,search_element,input_element,object_alias)
{if(event.keyCode==13||event.keyCode==38||event.keyCode==40)
{set_selection_search(event.keyCode,input_element);}
if(event.keyCode>=9&&event.keyCode<=27)return false;if(event.keyCode>=33&&event.keyCode<=46)return false;if(event.keyCode>=91&&event.keyCode<=93)return false;if(event.keyCode>=112&&event.keyCode<=157)return false;var width=$(search_element).style.width;var text=$(search_element).value.trim();if(text=='')
{$(input_element).innerHTML='';return;}
if(!is_search_query_back)return false;if(typeof searchhints[search_element]!='undefined'&&searchhints[search_element]==text)return;searchhints[search_element]=text;is_search_query_back=false;new Request({url:'/main/search',method:'post',data:{text:text,object_alias:object_alias,input_element:input_element,width:width},onComplete:function(json)
{is_search_query_back=true;json=strToJson(json);if(json.message&&json.error_code!=0)
{alert(json.message);return false;}
if(json.error_code==0)
{$(input_element).innerHTML=json.content;if(text!=$(search_element).value.trim())
{ll_search({keyCode:158},search_element,input_element,object_alias);}}
return false;},onFailure:function()
{failure();}}).send();}
var taghints=Array();var is_searchtag_query_back=true;var tag_search=function(event,search_element,input_element)
{if(event.keyCode==13||event.keyCode==38||event.keyCode==40)
{set_selection_search(event.keyCode,input_element);}
if(event.keyCode>=9&&event.keyCode<=27)return false;if(event.keyCode>=33&&event.keyCode<=46)return false;if(event.keyCode>=91&&event.keyCode<=93)return false;if(event.keyCode>=112&&event.keyCode<=157)return false;if(event.keyCode>=186||event.keyCode==188)return false;var width=$(search_element).style.width;var text=$(search_element).value;if(text=='')
{$(input_element).innerHTML='';return;}
if(!is_searchtag_query_back)return false;if(typeof taghints[search_element]!='undefined'&&taghints[search_element]==text)return;taghints[search_element]=text;is_searchtag_query_back=false;new Request({url:'/user/tags',method:'post',data:{text:text,input_element:input_element,width:width,search_element:search_element},onComplete:function(json)
{json=strToJson(json);is_searchtag_query_back=true;if(json.message&&json.error_code!=0)
{alert(json.message);return false;}
if(json.error_code==0)
{$(input_element).innerHTML=json.content;if(text!=$(search_element).value.trim())
{tag_search({keyCode:158},search_element,input_element);}}
return false;},onFailure:function()
{failure();}}).send();}
var userhints=Array();var is_search_query_back=true;var ll_user_search=function(event,search_element,input_element)
{if(event.keyCode==13||event.keyCode==38||event.keyCode==40)
{set_selection_search(event.keyCode,input_element);}
if(event.keyCode>=9&&event.keyCode<=27)return false;if(event.keyCode>=33&&event.keyCode<=46)return false;if(event.keyCode>=91&&event.keyCode<=93)return false;if(event.keyCode>=112&&event.keyCode<=157)return false;var width=$(search_element).style.width;var text=$(search_element).value.trim();if(text=='')
{$(input_element).innerHTML='';return;}
if(!is_search_query_back)return false;if(typeof userhints[search_element]!='undefined'&&userhints[search_element]==text)return;userhints[search_element]=text;is_search_query_back=false;new Request({url:'/user/search',method:'post',data:{text:text,input_element:input_element,width:width,search_element:search_element},onComplete:function(json)
{is_search_query_back=true;json=strToJson(json);if(json.message&&json.error_code!=0)
{alert(json.message);return false;}
if(json.error_code==0)
{$(input_element).innerHTML=json.content;if(text!=$(search_element).value.trim())
{ll_user_search({keyCode:158},search_element,input_element);}}
return false;},onFailure:function()
{failure();}}).send();}
var set_selection_search=function(key_code,element)
{var elem=getElementsByName('td','hint-'+element);if(elem.length<=0)return false;var select_element=0;for(var i=0;i<elem.length;i++)
{if(elem[i].style.backgroundColor=='rgb(250, 250, 160)')
{select_element=i+1;var last_element=elem[i];}}
if(key_code==13&&select_element>0)
{$(element+'-hint-'+select_element).click();return false;}
if(key_code==40)
{select_element=select_element+1;}
if(key_code==38)
{select_element=select_element-1;}
var el=$(element+'-hint-'+select_element);if($(el)=='undefined'||$(el)==null)
{return false;}
else
{el.style.backgroundColor='#fafaa0';if(!($(last_element)=='undefined'||$(last_element)==null))last_element.style.backgroundColor='';}}
var reset_select=function(element)
{var elem=getElementsByName('td','hint-'+element);if(elem.length<=0)return false;for(var i=0;i<elem.length;i++)
{elem[i].style.backgroundColor=''}}
function ll_ub_quick_save(edition_id,actual_id,status,rating,strict,content_edition_id,userbook_id,forecast,rand_id)
{if(content_edition_id=='undefined')content_edition_id=0;if(userbook_id=='undefined')userbook_id=0;if(forecast=='undefined')forecast=0;var tmp_status;if(status==-1&&$('redes-ub-status-'+edition_id))
{var tmp_status=$('redes-ub-status-'+edition_id).value;if(tmp_status!=3)status=1;else status=3;}
var is_new_design=$('is-new-design')?$('is-new-design').value:0;if($('a-userbook-'+edition_id+'-'+userbook_id)&&(!is_new_design||is_new_design!='ll2015b'))
{if($('a-userbook-'+edition_id+'-'+userbook_id).hasClass('i-clock'))return;$('a-userbook-'+edition_id+'-'+userbook_id).addClass('i-clock');}
if(strict||actual_id==0)actual_id=edition_id;var params="edition_id="+actual_id;var date=new Date();var viewmode=$('ub-viewmode-'+edition_id).value;var rand_name=!rand_id?'':('-'+rand_id);var old_rating=$('ub-rating-'+edition_id)?$('ub-rating-'+edition_id).value:($('ub-rating-other-'+edition_id+rand_name)?$('ub-rating-other-'+edition_id+rand_name).value:0);if(old_rating!=rating&&is_new_design)rating=old_rating;params+="&viewmode="+viewmode+"&rating="+rating+"&status="+status+"&own="+"&day=0"+"&month="+(date.getMonth()+1)+"&year="+date.getFullYear()+"&priority="+1+"&selections="+"&tags="+"&work-edition-id="+content_edition_id+"&userbook_id="+userbook_id+"&notes="+"&quick=true"+"&is_new_design="+is_new_design+"&forecast="+forecast;if($$('.rec-master-steps')&&$('from-rec-page'))params+='&newrm=true';if($('recmaster-page'))params+='&recmaster=true';if($('rec-status-'+edition_id))$('rec-status-'+edition_id).style.display='none';if($('xa-rating-'+edition_id+'-'+userbook_id))
{var user_rating_mode=$('xa-rating-'+edition_id+'-'+userbook_id).getAttribute('data-user_rating_mode');if(user_rating_mode)params+='&user_rating_mode='+user_rating_mode;}
new Request({url:'/user/savebook',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json,null,'ll_ub_quick_save('+edition_id+', '+actual_id+', '+status+', '+rating+', '+strict+', '+content_edition_id+', '+userbook_id+')');if(json.error)
{alert(json.error);}
else
{if(json.content)
{if($$('.xa-main-'+edition_id+'-'+userbook_id))
{var view_mode=$('ub-viewmode-'+edition_id)?$('ub-viewmode-'+edition_id).value:'';var text='';if(json.text)
{text=json.text;}
else
{if(status==1)
{text=view_mode=='list'?'<span class="i-userbook-read"></span>':($('ub-status-read-'+edition_id)?$('ub-status-read-'+edition_id).innerHTML.replace(/(.+\<\/span\>)(.+)/g,"$2").replace(/(.+)(.+\<\/span\>)/g,"$1"):'Прочитал(а)');}
else if(status==3)
{text=view_mode=='list'?'<span class="i-userbook-unread"></span>':($('ub-status-unread-'+edition_id)?$('ub-status-unread-'+edition_id).innerHTML.replace(/(.+\<\/span\>)(.+)/g,"$2").replace(/(.+)(.+\<\/span\>)/g,"$1"):'Прочитал(а)');}
else if(status==2)
{text=view_mode=='list'?'<span class="i-userbook-reading"></span>':'Читаю';}
else if(status==0)
{text=view_mode=='list'?'<span class="i-userbook-wish"></span>':'Хочу прочитать';}
else
{text='<span class="i-userbook-add"></span>'+(view_mode=='list'?'':'Добавить');}}
if(text!=''&&$$('.span-userbook-'+edition_id+'-'+userbook_id).length>0)
{$$('.span-userbook-'+edition_id+'-'+userbook_id).each(function(item,key){item.innerHTML=text;if(status==-2)item.removeClass('active').addClass('inactive');else item.removeClass('inactive').addClass('active');});}}
else if($('xa-main-'+edition_id+'-'+userbook_id))
{$('xa-main-'+edition_id+'-'+userbook_id).innerHTML=json.content;}}
if(json.new_book&&$('my-book-list-tr-'+json.ub_id))
{$('my-book-list-tr-'+json.ub_id).innerHTML=json.new_book;}
if(json.ub_rating&&$('xa-rating-'+edition_id+'-'+userbook_id))$('xa-rating-'+edition_id+'-'+userbook_id).innerHTML=json.ub_rating;if(json.ab_action)ll_pagegoal_ab(json.ab_action);if(status>-1&&$('ab-test-ub-add'))
{ll_pagegoal_ab('userbookadd');}
if(rating>0&&$('ab-test-ub-rating'))
{ll_pagegoal_ab('userbookrating');}
if(($('from-rec-page')||$('from-rec-genres'))&&typeof(ga)=='function')
{var page='hasread';if(status==2)page='reading';else if(status==0)page='wish';ga('send','pageview','/virtual_url/rec/book/'+page);}
if($('from-alike-rec-page')&&typeof(ga)=='function')
{var page='hasread';if(status==2)page='reading';else if(status==0)page='wish';ga('send','pageview','/virtual_url/recalike/book/'+page);}
ub_soc_type='book_rate';ub_current_id=json.ub_id;if(json.is_new)ub_new_id=json.ub_id;}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send(params);if($('ga-track-ub'))
{var type=$('ga-track-ub').value;ll_ga_track_ub(status,edition_id,type);}
return false;}
function paste_image(editor_id,secret_code,title,name,size,login,href)
{var cursorPos=$(editor_id).selectionEnd;var beforeTag=$(editor_id).value.substr(0,cursorPos);var th_ext;if(size=='r')th_ext='jpg';else th_ext='png';var tag='<userpic size="'+size+'" id="'+secret_code+'" reader="'+login+'" href="'+href+'" e="'+th_ext+'">'+title+'</userpic>';var afterTag=$(editor_id).value.substr(cursorPos);$(editor_id).value=beforeTag+tag+afterTag;$('div-pict-list-'+editor_id).destroy();}
function paste_image_url(editor_id)
{var url=$(editor_id+'-src').value;var alt=$(editor_id+'-img-title').value;$(editor_id).value+='<img src="'+url+'" alt="'+escape(alt)+'"/>';$('div-pict-list-'+editor_id).destroy();}
function upload_picture(editor_id,event)
{$('upload-'+editor_id).innerHTML='<a class="i-clock"></a>';var title=$(editor_id+'-pic-title').value;var src=$(editor_id+'-src').value;if(src!=undefined&&src!='')
{new Request({url:'/user/uploadpicture',method:'post',async:false}).send('id='+editor_id+'&source='+src);var xhr=true;}
else
{var file=$(editor_id+'-picture').files[0];var xhr=new XMLHttpRequest();upload=xhr.upload;formData=new FormData();formData.append('userpicture',file);formData.append('title',title);addEvent(xhr,'readystatechange',function(){if(xhr.readyState==4)
if((xhr.status>=200&&xhr.status<300)||xhr.status==304){this.response=this.response||this.responseText;onload.call(xhr);}else onerror.call(xhr);});xhr.open('POST','/user/uploadpicture',false);xhr.setRequestHeader('X-Requested-With','XMLHttpRequest');xhr.send(formData);}
getpictures(editor_id,1,event);}
function getpictures(id,page_no,event)
{if(page_no==undefined||page_no==null)page_no=1;var coords=$('te'+id+'-ed_picture').getPosition();new Request({url:'/user/userpics',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);}
else
{var container=$('body');if(container)
{if($('div-pict-list-'+id)){$('div-pict-list-'+id).destroy();}
var div=new Element('div',{id:'div-pict-list-'+id});var st='position:absolute;top:'+(coords['y']-100)+'px;left:'+(coords['x']+80)+'px; background: white;';if(isIE())div.style.cssText=st;div.setAttribute('style',st);div.innerHTML=json.content;container.adopt(div);}
else
{alert('Ошибка!');}}}}).send('id='+id+'&page_no='+page_no);}
function get_gallery(event,object_alias,object_id,picture_id,picture_no,page_no,max_on_page)
{if(page_no==undefined)page_no=1;if(max_on_page==undefined)max_on_page=0;var data={object_alias:object_alias,object_id:object_id,picture_id:picture_id,adm:adm,page_no:page_no,max_on_page:max_on_page};var adm=0;if($('adm'))adm=$('adm').value;new Request({url:'/picture/getgallery',method:'post',data:data,onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code!=0)
{return false;}
var gallery=json.result;milkbox.addGalleries(gallery);event.preventDefault();if(picture_id>0)
{milkbox.open('gall1',json.picture_no);}
else
{milkbox.open('gall1',picture_no-max_on_page*(page_no-1));}
return false;},onFailure:function()
{failure();}}).send();}
if($('picture-preview'))
{$('picture-preview').click();}
function gallery_open_one(event,href,title)
{event.preventDefault();milkbox.openWithFile({href:href,title:title});}
var select_books=function(request_id)
{new Request({url:'/mobdd/selectbooks',method:'post',data:{request_id:request_id},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.content)
{$('select-books'+request_id).innerHTML=json.content;$('select-books'+request_id).show();}
return false;},onFailure:function()
{failure();}}).send();}
var reqcomment=function(request_id,is_cur)
{var is_new_design=$('is-new-design')?$('is-new-design').value:'';is_cur=is_cur||false;if($('newreqcomment'+request_id).innerHTML!='')
{xshow($('newreqcomment'+request_id));}
else
{new Request({url:'/mobdd/getcommentform',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message.text);}
if(json.content)$('newreqcomment'+request_id).innerHTML=json.content;ll_texteditor_bind($(request_id+'comment_text'));return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("request_id="+request_id+'&is_new_design='+is_new_design+'&is_cur='+is_cur);}
location.hash='newreqcomment'+request_id;}
var get_content=function(content_id,edition_id,search)
{var is_new_design=$('is-new-design')?$('is-new-design').value:0;var search=search||'';new Request({url:'/content/index',method:'post',data:{content_id:content_id,edition_id:edition_id,search:search,is_new_design:is_new_design},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message);}
if(json.content)
{$('content'+content_id).innerHTML=json.content;if($('content[is_section]'))$('content[is_section]').set('value',0);}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
var SortableList;var save_content=function(content_id)
{var content_table='';new Request({url:'/content/save',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message);return false;}
if(json.content)
{if(json.is_new)
{var table_name='content-table';if(!json.is_confirmed)
{if($('content-maybe'))$('content-maybe').show();table_name='content-table-unconfirmed';}
if($(table_name))
{content_table=$(table_name).innerHTML+json.content;$(table_name).innerHTML=content_table;}}
else $('content-tr'+content_id).innerHTML=json.content;}
$('content'+content_id).innerHTML='';if($('content-block'))$('content-block').hide();if($('content-unconfirmed-tr'+content_id))$('content-unconfirmed-tr'+content_id).dispose();if(!json.isset_unconfirmed&&$('content-maybe')&&json.is_confirmed)
{}
if(json.book_content&&$('row-content'))
{$('row-content').innerHTML=json.book_content;if($('row-container-content'))$('row-container-content').show();}
if(json.id)
{drag_content();}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).post($('form-content'+content_id));}
var content_confirm=function(content_id)
{var content_table='';new Request({url:'/content/confirm',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message);return false;}
if(json.content)
{if($('content-table'))
{content_table=$('content-table').innerHTML+json.content;$('content-table').innerHTML=content_table;}}
if(!json.isset_unconfirmed&&$('content-maybe'))
{$('content-maybe').dispose();}
$('content'+content_id).innerHTML='';if($('content-block'))$('content-block').hide();if($('content-unconfirmed-tr'+content_id))$('content-unconfirmed-tr'+content_id).dispose();drag_content();return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).post('content_id='+content_id);}
var contents_check=function(el,edition_id)
{var status=el&&el.hasClass('checked')?false:true;new Request({url:'/content/check',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message);return false;}
if($('content-maybe')&&json.status)
{$('content-maybe').dispose();}
if($('content-add'))
{json.status?$('content-add').hide():$('content-add').show('inline');}
var elements=$$('.content-actionbar');if(json.status)elements.hide();else
{for(var i=0;i<elements.length;i++)
{elements[i].style.display='';}}
if(json.status)
{el.addClass('checked');el.style.color='green';el.innerHTML='<span class="i-info"></span>Содержание проверено';}
else
{el.removeClass('checked');el.style.color='';el.innerHTML='<span class="i-check-gray"></span>Содержание проверено';}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).post('edition_id='+edition_id+"&status="+status);}
var drag_content=function()
{var k;SortableList=new Sortables('content-table',{constrain:true,clone:true,snap:10,handle:'.handle-drag-content',revert:{duration:50},onComplete:function(el){var content_id=el.getAttribute('id').substring(10);k=1;SortableList.serialize(0,function(element,index){if(el==element)
{new Request({url:'/content/sort',method:'post',data:{content_id:content_id,no:index+k},onComplete:function(json)
{json=strToJson(json);prepare(json);return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}});}});}
var searchwork_content=function(context_id)
{var text=$('search-work').value.trim();$('work-name-0').set('value','');$('work-author-0').set('value','');$('work-translator-0').set('value','');$('work-description-0').set('value','');if(text=='')
{alert('Введите текст для поиска!');return false;}
new Request({url:'/content/searchwork',method:'post',data:{text:text},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message);}
$('result-work-div').innerHTML=json.content;if(json.count==0)
{$$('.content-section-addinfo').setStyle('display','block');$$('.content-section-notwork-div').setStyle('display','block');$('work-name-0').set('value',$('search-work').value);$('work-author-'+context_id).value=$('work-author-'+context_id+'-hidden').value;$('work-new').innerHTML='';$('work_form_name').value=0;}
else
{$$('.content-section-notwork-div').setStyle('display','none');$('result-work-div').setStyle('display','block');$('work-new').setStyle('display','block');}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
var select_work=function(context_id)
{var work_id=$('result-work').value;if($('content[is_section_yes]').get('checked')||$('content[is_work_isset]').get('checked'))work_id=0;if(work_id==0)
{$('work-name-'+context_id).value='';$('work-name-'+context_id).set('readonly',false);$('work-author-'+context_id).value=$('work-author-'+context_id+'-hidden').value;$('work-translator-'+context_id).value='';$('work-translator-'+context_id).set('readonly',false);$('work-new').setStyle('display','none');$$('.content-section-addinfo').setStyle('display','none');}
else
{new Request({url:'/content/getwork',method:'post',data:{work_id:work_id},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message);}
$('work-new').innerHTML='';$$('.content-section-addinfo').setStyle('display','block');$('work-new').setStyle('display','block');if($$('.content-section-search-work'))$$('.content-section-search-work').setStyle('display','block');if(json.content.name)
{$('work-name-'+context_id).value=json.content.name;$('work-name-'+context_id).set('readonly',true);}
if(json.content.author)
{$('work-author-'+context_id).value=json.content.author;$('work-author-'+context_id).set('readonly',true);}
var inner_html=(json.content.author?json.content.author+' ':'')+(json.content.name?'«'+json.content.name+'»':'');if(json.content.translators)
{$('work-translator-'+context_id).value=json.content.translators;$('work-translator-'+context_id).set('readonly',true);inner_html+=', '+json.content.translators;}
else
{$('work-translator-'+context_id).value='';}
if(json.content.genre_name)
{inner_html+=', '+json.content.genre_name;}
$('work-new').innerHTML=inner_html;if($('work-new').innerHTML=='')$('work-new').innerHTML='Существуюшее произведение';$('work-description-'+context_id).value='';return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}}
var count_blocks=0;var add_block=function(block_id)
{count_blocks++;var elements=$$('.text_blocks');if(count_blocks<elements.length)count_blocks=elements.length;var elem=new Element('tr',{'id':'tr'+count_blocks});if(block_id==0)elem.injectBefore($('tr'+block_id));else elem.injectAfter($('tr'+block_id));var el=new Element('td',{'id':'td1'+count_blocks});el.inject($('tr'+count_blocks));el=new Element('td',{'id':'td2'+count_blocks,style:'padding-top: 19px;'});el.inject($('tr'+count_blocks));el=$('block'+block_id).clone();el.id='block'+count_blocks;el.inject($('td2'+count_blocks));el=$('ablock'+block_id).clone();el.id='ablock'+count_blocks;el.set('onclick','add_block('+count_blocks+');');el.inject($('td2'+count_blocks));el=$('ablockdel'+block_id).clone();el.id='ablockdel'+count_blocks;el.set('onclick','delete_block('+count_blocks+');');el.inject($('td2'+count_blocks));var block_type=$('block'+block_id).options[$('block'+block_id).selectedIndex].value;var rows=5;var type='';elem=new Element('textarea',{'class':'text_blocks','name':'subscription['+count_blocks+'][text]','rows':5,'styles':{'width':'500px'}});var elem_title=new Element('div');elem_title.innerHTML=$('block'+block_id).options[$('block'+block_id).selectedIndex].innerHTML+'<br>';var elem_type=new Element('input',{type:'hidden',name:'subscription['+count_blocks+'][type_id]',value:block_type});elem_title.inject($('td1'+count_blocks));elem.inject($('td1'+count_blocks));elem_type.inject($('td1'+count_blocks));}
var delete_block=function(block_id)
{if(!confirm('Вы действительно хотите удалить блок?'))return false;var elem;var id=0;if($('twoblockid'+block_id))
{id=$('twoblockid'+block_id).value;elem=new Element('input',{'name':'blocksdelete['+id+']','type':'hidden'});elem.inject($('delete_blocks'));}
if($('blockid'+block_id))
{id=$('blockid'+block_id).value;elem=new Element('input',{'name':'blocksdelete['+id+']','type':'hidden'});elem.inject($('delete_blocks'));}
$('tr'+block_id).dispose();}
function show_event_objects()
{if($('event_type').value=='library')
{$('event_objects_lib').setAttribute('style','display:block;');$('event_objects_club').setAttribute('style','display:none;');}
else if($('event_type').value=='club')
{$('event_objects_club').setAttribute('style','display:block;');$('event_objects_lib').setAttribute('style','display:none;');}
else
{$('event_objects_lib').setAttribute('style','display:none;');$('event_objects_club').setAttribute('style','display:none;');$('object_id').options[0].selected=true;}}
function add_tag(search_element,tag,from_popular,changed_element,list_element)
{var old_tags=$(search_element).value.trim();var tags;var start;if(old_tags.length==0)tags=tag;else
{old_tags=old_tags.replace(/;+/g,',');old_tags=old_tags.replace(/,+/g,',');var last_char=old_tags.charAt(old_tags.length-1);var start_pos=old_tags.lastIndexOf(',')+1;if(last_char==',')tags=old_tags.substr(0,start_pos)+' '+tag;else if(from_popular>0)tags=old_tags+', '+tag;else
{start=old_tags.substr(start_pos).trim();if(start.length==0)tags=tag;else if(tag.indexOf(start)>-1)tags=old_tags.substr(0,start_pos)+' '+tag;else tags=old_tags+', '+tag;}}
if($(list_element))$(list_element).innerHTML='';if($(changed_element))$(changed_element).value=1;$(search_element).value=tags;}
if($('count-genres'))var genres_checked=$('count-genres').value;function select_genre(id)
{if(genres_checked==undefined)genres_checked=0;if(document.getElementById('genre-'+id).checked)
{if(genres_checked<7)genres_checked++;else
{alert('Не более 7 жанров');document.getElementById('genre-'+id).checked=false;}}
else
{genres_checked--;}}
function toggle_event_date(classname,enabled)
{var elements=$$(classname);var i=0;if(enabled)
for(i=0;i<2;i++)
{elements[i].disabled=false;elements[i].style.color='#000';}
else
for(i=0;i<2;i++)
{elements[i].disabled=true;elements[i].style.color='#777';}}
var buyextra=function(spec_alias,now,to_coord,e)
{var message;if(spec_alias=='account_rename')message='Вы действительно хотите изменить логин?';else message='Вы действительно желаете приобрести расширенную настройку аккаунта?';if(now&&!confirm(message))return false;var form=$('extra-'+spec_alias)?$('extra-'+spec_alias):null;new Request({url:'/account/extra',method:'post',data:{spec_alias:spec_alias,now:now},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message&&json.error_code!=0)
{alert(json.message);return false;}
if(json.error_code==0)
{if(to_coord&&!$('paym'))
{var div=new Element('div',{'id':'paym'});$('body').adopt(div);}
$('paym').innerHTML=json.content;if(to_coord)
{var coord=getMouseCoords(e);var elements=$$('#paym .userbook');if(elements&&elements[0])
{elements[0].style.top=coord.y+'px';elements[0].style.left=coord.x+'px';}}}
return false;},onFailure:function()
{failure();}}).post(form);}
function change_sele_category()
{var category=($('category').value);if(category==400||category==1000)
{$('tr-access').style.display='none';$('tr-type').style.display='none';$('urltitle').innerHTML='Ссылка на серию на сайте издательства';}
else
{$('tr-access').style.display='table-row';$('tr-type').style.display='table-row';$('urltitle').innerHTML='Ссылка на подборку на внешнем сайте';}
if(category==1000||category==1300)
{$('tr-title-original').style.display='table-row';$('tr-title-other').style.display='table-row';}
else
{$('tr-title-original').style.display='none';$('tr-title-other').style.display='none';}}
var country_select=function()
{var country_code=$('country-list').options[$('country-list').selectedIndex].value;$('city-list').innerHTML='';$('city-list').options[0]=new Option(' -- ',0);if(country_code==0||country_code=='')return false;new Request({url:'/main/getcities',method:'post',data:{country_code:country_code},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message&&json.error_code!=0)
{alert(json.message);return false;}
$('city-list').innerHTML='';$('city-list').options[0]=new Option(' -- ',0);if(json.error_code==0&&json.result)
{for(var i=0;i<json.result.length;i++)
{$('city-list').options[i+1]=new Option(json.result[i].name,json.result[i].id);}}
return false;},onFailure:function()
{failure();}}).send();}
function ll_selebook(e,selebook_id)
{var htmlname='-selebook-'+selebook_id;var coords=getMouseCoords(e);new Request({url:'/selection/editbook',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);}
else
{var container=$('body');if(container)
{if($('div'+htmlname))$('div'+htmlname).destroy();var div=new Element('div',{id:'div'+htmlname});var w=getClientWidth();if(coords['x']+500>w)coords['x']-=450;if(coords['x']<0)coords['x']=0;var st='position:absolute;top:'+(coords['y']+10)+'px;left:'+coords['x']+'px;';if(isIE())div.style.cssText=st;div.setAttribute('style',st);div.addClass('userbook');div.innerHTML=json.content;container.adopt(div);ll_texteditor_bind($('description_'+selebook_id));if($('div-info-selebook-hint'))
{hideonclick('div-info-selebook-hint');var date=new Date;date.setDate(date.getDate()+365*10);document.cookie='__selebook_hint='+1+'; path=/; expires='+date.toUTCString();}}
else
{alert('Ошибка!');}}},onRequest:initAd,onSuccess:function()
{if($('a'+htmlname))
{$('a'+htmlname).removeClass('i-clock');$('a'+htmlname).addClass('i-clear');}
closeAd();},onFailure:function()
{if($('a'+htmlname))$('a'+htmlname).removeClass('i-clock');failure();}}).send("selebook_id="+selebook_id);return false;}
function ll_selebook_save(selebook_id)
{var params="selebook_id="+selebook_id;var is_new_design=$('is-new-design')?$('is-new-design').value:0;var sort_order=$('sort_order_'+selebook_id).value;var show_annotation=$('show_annotation_'+selebook_id).checked;var hide=false;var remove=false;var edition_id=0;if($('hide_'+selebook_id))
{hide=$('hide_'+selebook_id).checked;}
if($('remove_'+selebook_id))
{remove=$('remove_'+selebook_id).checked;}
if($('edition_id_'+selebook_id))
{edition_id=$('edition_id_'+selebook_id).value;}
var description=$('description_'+selebook_id).value;params+="&sort_order="+sort_order+"&show_annotation="+show_annotation+"&description="+encodeURIComponent(description)+"&hide="+hide+"&remove="+remove+"&edition_id="+edition_id+"&is_new_design="+is_new_design;new Request({url:'/selection/savebook',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);}
else
{ll_selebook_destroy(selebook_id);if(json.content&&$('my-selection-book-list-tr-'+selebook_id))
{$('my-selection-book-list-tr-'+selebook_id).innerHTML=json.content;}
else if(remove&&$('my-selection-book-list-tr-'+selebook_id))
{$('my-selection-book-list-tr-'+selebook_id).dispose();}}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send(params);return false;}
function ll_selebook_destroy(selebook_id)
{if($('div-selebook-'+selebook_id))
{$('div-selebook-'+selebook_id).destroy();return true;}
return false;}
function ll_selebook_set_edition(edition_id,new_edition_id)
{var selebook_id=0;if($('block-edition-'+new_edition_id)&&$('current-edition-'+edition_id))
{$('current-edition-'+edition_id).innerHTML='';$('current-edition-'+edition_id).appendChild($('block-edition-'+new_edition_id));$('current-edition-'+edition_id).id='current-edition-'+new_edition_id;selebook_id=$('current-edition-'+new_edition_id).get('selebook_id');if($('edition_id_'+selebook_id))$('edition_id_'+selebook_id).value=new_edition_id;if($('div-ub-editions-'+edition_id))
{$('div-ub-editions-'+edition_id).innerHTML='';$('div-ub-editions-'+edition_id).id='div-ub-editions-'+new_edition_id;}
if($('a-ub-editions-'+edition_id))
{$('a-ub-editions-'+edition_id).set('onclick','ll_ub_editions('+new_edition_id+', \'selebook\')');$('a-ub-editions-'+edition_id).id='a-ub-editions-'+new_edition_id;}
ll_ub_editions(new_edition_id,'selebook');}}
ll_similar_add=function(similar_id)
{var book_id=$('similar-book-id').value;var edition_id=0;if($('similar-edition-id'))edition_id=$('similar-edition-id').value;new Request({url:'/book/similaradd',method:'post',data:{book_id:book_id,similar_id:similar_id,edition_id:edition_id},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message&&json.error_code!=0)
{alert(json.message);return false;}
if(json.error_code==0)
{$('similar-'+similar_id+'-add').style.display='none';$('similar-'+similar_id+'-delete').style.display='block';if(json.content_similar)$$('.book-similar-placeholder').set('html',json.content_similar);}
return false;},onFailure:function()
{failure();}}).send();}
ll_similar_delete=function(similar_id)
{var book_id=$('similar-book-id').value;var edition_id=0;if($('similar-edition-id'))edition_id=$('similar-edition-id').value;new Request({url:'/book/similardelete',method:'post',data:{book_id:book_id,similar_id:similar_id,edition_id:edition_id},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message&&json.error_code!=0)
{alert(json.message);return false;}
if(json.error_code==0)
{$('similar-'+similar_id+'-delete').style.display='none';$('similar-'+similar_id+'-add').style.display='block';if(json.content_similar)$$('.book-similar-placeholder').set('html',json.content_similar);}
return false;},onFailure:function()
{failure();}}).send();}
var ll_similar=function(book_id,similar_id,type)
{new Request({url:'/book/similar'+type,method:'post',data:{book_id:book_id,similar_id:similar_id},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message&&json.error_code!=0)
{alert(json.message);return false;}
if(json.error_code==0)
{$('similar-'+book_id+'-'+similar_id+'-'+type).style.display='none';$('similar-'+book_id+'-'+similar_id+'-'+(type=='delete'?'add':'delete')).style.display='block';}
return false;},onFailure:function()
{failure();}}).send();}
var ll_similarcouple_delete=function(book_id,similar_id)
{new Request({url:'/book/similardelete',method:'post',data:{book_id:book_id,similar_id:similar_id},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message&&json.error_code!=0)
{alert(json.message);return false;}
if(json.error_code==0)
{$('similar-book-'+book_id+'-'+similar_id).dispose();if($('similar-book-'+similar_id+'-'+book_id))$('similar-book-'+similar_id+'-'+book_id).dispose();}
return false;},onFailure:function()
{failure();}}).send();}
var _bind_mobstat_click=function()
{$$('.mobstats-tablecell').addEvent('click',function(){var cells=$$('.mobstats-tablecell-new');cells.each(function(item){if(item.getParent('tr'))
item.setStyle('display','none');item.getSiblings('span').setStyle('display','none');item.getSiblings('div').setStyle('display','block');});this.getChildren('textarea').setStyle('display','block');this.getChildren('span').setStyle('display','block');this.getChildren('div').setStyle('display','none');});$$('.mobstats-tablecell-new').addEvent('click',function(event){event.stop();});$$('.mobstats-tablecell-new').addEvent('blur',function(){var value=this.get('value');var value_html=this.get('value').split("\n").join("<br>");var mob=this.getSiblings('div').get('data_mob');var id=this.getParent('tr').get('data_row_id');pars="id="+id+"&value="+value+"&mob="+mob;var that=this;new Request({url:'/mob/savestats',method:'post',onRequest:initAd,onSuccess:closeAd,onFailure:failure,onComplete:function(){that.getSiblings('div').setStyle('display','block').set('html',value_html);that.setStyle('display','none');}}).send(pars);});$$('.mobstats-flag').addEvent('click',function(){var colors_position={'mob2009':0,'mob2010':1,'mob2011':2,'mob2012':3,'mob2013':4,'mob2014':5,'mob2015':6,'mob2016':7};var color='';var new_colors='';if(this.hasClass('i-neformat'))
{this.removeClass('i-neformat');this.addClass('i-format');this.getParent('td').setStyle('background-color','#f4aaaa');color=1;}
else
{this.removeClass('i-format');this.addClass('i-neformat');var color='';if(this.getParent('tr').hasClass('mobstats-tablerow-odd'))color='#E0E0E0';else color='white';this.getParent('td').setStyle('background-color',color);color=0;}
var mob=this.getSiblings('div').get('data_mob');var colors=this.getParent('tr').get('data_row_colors');var row_id=this.getParent('tr').get('data_row_id');for(var i=0;i<colors.length;i++)
{if(i==colors_position[mob])new_colors+=color;else new_colors+=colors[i];}
this.getParent('tr').set('data_row_colors',new_colors);_mobstats_save_colors(row_id,new_colors);});};var _mobstats_save_colors=function(row_id,colors){pars="save_colors="+true+"&colors="+colors+"&id="+row_id;new Request({url:'/mob/savestats',method:'post',onRequest:initAd,onSuccess:closeAd,onFailure:failure,onComplete:function(){}}).send(pars);};_bind_mobstat_click();$$('.mobstats-add').addEvent('click',function(){var item=$$('.mobstats-new');if(item.getStyle('display').toString()==="table-row")
{item.setStyle('display','none');}
else
{item.setStyle('display','table-row');}});$$('.mobstats-new-save').addEvent('click',function(){var login=$$('.mobstats-new-login').get('value');var mob2009=$$('.mobstats-new-mob2009').get('value');var mob2010=$$('.mobstats-new-mob2010').get('value');var mob2011=$$('.mobstats-new-mob2011').get('value');var mob2012=$$('.mobstats-new-mob2012').get('value');var mob2013=$$('.mobstats-new-mob2013').get('value');var mob2014=$$('.mobstats-new-mob2014').get('value');var mob2015=$$('.mobstats-new-mob2015').get('value');var mob2016=$$('.mobstats-new-mob2016').get('value');var mob2009_html=mob2009.toString().split("\n").join("<br>");var mob2010_html=mob2010.toString().split("\n").join("<br>");var mob2011_html=mob2011.toString().split("\n").join("<br>");var mob2012_html=mob2012.toString().split("\n").join("<br>");var mob2013_html=mob2013.toString().split("\n").join("<br>");var mob2014_html=mob2014.toString().split("\n").join("<br>");var mob2015_html=mob2015.toString().split("\n").join("<br>");var mob2016_html=mob2016.toString().split("\n").join("<br>");var new_colors=this.getParent('tr').get('data_row_colors');pars="login="+login+"&mob2009="+mob2009+"&mob2010="+mob2010+"&mob2011="
+mob2011+"&mob2012="+mob2012+"&mob2013="+mob2013+"&mob2014="+mob2014+"&mob2015="+mob2015+"&mob2016="+mob2016+"&colors="+new_colors;new Request({url:'/mob/addstats',method:'post',onRequest:initAd,onSuccess:closeAd,onFailure:failure,onComplete:function(json){json=strToJson(json);prepare(json);if(json.error)alert(json.error);else
{alert('Читатель успешно добавлен!');var last_item=$$('.mobstats-table tbody tr').getLast('tr').getPrevious();var class_name='';if(last_item.hasClass('mobstats-tablerow-odd'))class_name='mobstats-tablerow';else class_name='mobstats-tablerow-odd';var new_row=new Element('tr',{'html':'<td>'+'<span class="reader"><a href="/reader/'+login+' " title="'+login+'" class="action"><span class="i-reader"></span></a><a href="/reader/'+login+'" title="'+login+'">'+login+'</a></span></td>'
+'<td class="mobstats-tablecell"'+(new_colors[0]==1?' style="background-color: #f4aaaa"':'')+'><div class="mobstats-tablecell-div" data_user_id="" data_mob="mob2009" style="display: block;">'+mob2009_html+'</div><textarea class="mobstats-tablecell-new" rows="4">'+mob2009+'</textarea>\n\
                            <span class="'+(new_colors[0]==1?'i-format mobstats-flag':'i-neformat mobstats-flag')+'" style="display: none;" ></span></td>'
+'<td class="mobstats-tablecell"'+(new_colors[1]==1?' style="background-color: #f4aaaa"':'')+'><div class="mobstats-tablecell-div" data_user_id="" data_mob="mob2010" style="display: block;">'+mob2010_html+'</div><textarea class="mobstats-tablecell-new" rows="4">'+mob2010+'</textarea>\n\
                            <span class="'+(new_colors[1]==1?'i-format mobstats-flag':'i-neformat mobstats-flag')+'" style="display: none;" ></span></td>'
+'<td class="mobstats-tablecell"'+(new_colors[2]==1?' style="background-color: #f4aaaa"':'')+'><div class="mobstats-tablecell-div" data_user_id="" data_mob="mob2011" style="display: block;">'+mob2011_html+'</div><textarea class="mobstats-tablecell-new" rows="4">'+mob2011+'</textarea>\n\
                            <span class="'+(new_colors[2]==1?'i-format mobstats-flag':'i-neformat mobstats-flag')+'" style="display: none;" ></span></td>'
+'<td class="mobstats-tablecell"'+(new_colors[3]==1?' style="background-color: #f4aaaa"':'')+'><div class="mobstats-tablecell-div" data_user_id="" data_mob="mob2012" style="display: block;">'+mob2012_html+'</div><textarea class="mobstats-tablecell-new" rows="4">'+mob2012+'</textarea>\n\
                            <span class="'+(new_colors[3]==1?'i-format mobstats-flag':'i-neformat mobstats-flag')+'" style="display: none;" ></span></td>'
+'<td class="mobstats-tablecell"'+(new_colors[4]==1?' style="background-color: #f4aaaa"':'')+'><div class="mobstats-tablecell-div" data_user_id="" data_mob="mob2013" style="display: block;">'+mob2013_html+'</div><textarea class="mobstats-tablecell-new" rows="4">'+mob2013+'</textarea>\n\
                             <span class="'+(new_colors[4]==1?'i-format mobstats-flag':'i-neformat mobstats-flag')+'" style="display: none;" ></span></td>'
+'<td class="mobstats-tablecell"'+(new_colors[5]==1?' style="background-color: #f4aaaa"':'')+'><div class="mobstats-tablecell-div" data_user_id="" data_mob="mob2014" style="display: block;">'+mob2014_html+'</div><textarea class="mobstats-tablecell-new" rows="4">'+mob2014+'</textarea>\n\
                             <span class="'+(new_colors[5]==1?'i-format mobstats-flag':'i-neformat mobstats-flag')+'" style="display: none;" ></span></td>'
+'<td class="mobstats-tablecell"'+(new_colors[6]==1?' style="background-color: #f4aaaa"':'')+'><div class="mobstats-tablecell-div" data_user_id="" data_mob="mob2015" style="display: block;">'+mob2015_html+'</div><textarea class="mobstats-tablecell-new" rows="4">'+mob2015+'</textarea>\n\
                             <span class="'+(new_colors[6]==1?'i-format mobstats-flag':'i-neformat mobstats-flag')+'" style="display: none;" ></span></td>'
+'<td class="mobstats-tablecell"'+(new_colors[7]==1?' style="background-color: #f4aaaa"':'')+'><div class="mobstats-tablecell-div" data_user_id="" data_mob="mob2016" style="display: block;">'+mob2016_html+'</div><textarea class="mobstats-tablecell-new" rows="4">'+mob2016+'</textarea>\n\
                             <span class="'+(new_colors[7]==1?'i-format mobstats-flag':'i-neformat mobstats-flag')+'" style="display: none;" ></span></td>','class':class_name,'data_row_id':json.id,'data_row_colors':new_colors});$$('.mobstats-table tbody').adopt(new_row,'after');$$('.mobstats-table tbody').adopt($$('.mobstats-new'),'after');$$('.mobstats-new').setStyle('display','none');$$('.mobstats-new-login').set('value','');$$('.mobstats-new-mob2009').set('value','');$$('.mobstats-new-mob2010').set('value','');$$('.mobstats-new-mob2011').set('value','');$$('.mobstats-new-mob2012').set('value','');$$('.mobstats-new-mob2013').set('value','');$$('.mobstats-new-mob2014').set('value','');$$('.mobstats-new-mob2015').set('value','');$$('.mobstats-new-mob2016').set('value','');_bind_mobstat_click();}}}).send(pars);});function ll_delete_book(book_id,has_review,userbook_id,strict_edition_id,read_again)
{if(!userbook_id)userbook_id=0;if(!strict_edition_id)strict_edition_id=0;if(!read_again)read_again=0;if(read_again||confirm('Удалить книгу из коллекции? '+(has_review?'Ваша рецензия также будет удалена.':'')))
{var is_new_design=$('is-new-design')?$('is-new-design').value:0;pars='act=delete&book_id='+book_id+'&userbook_id='+userbook_id+'&strict_edition_id='+strict_edition_id+'&is_new_design='+is_new_design;url='/book/del';new Request({url:url,method:'post',onRequest:initAd,onSuccess:closeAd,onFailure:failure,onComplete:function(json){json=strToJson(json);prepare(json);if(json.content)
{if($('xa-main-'+book_id+'-'+userbook_id))$('xa-main-'+book_id+'-'+userbook_id).innerHTML=json.content;}
if(json.ub_rating&&$('xa-rating-'+book_id+'-'+userbook_id))$('xa-rating-'+book_id+'-'+userbook_id).innerHTML=json.ub_rating;if(json.deleted_ids&&$('my-book-list-tr-'+json.deleted_ids))
{$('my-book-list-tr-'+json.deleted_ids).getNext('.separator').dispose();$('my-book-list-tr-'+json.deleted_ids).dispose();}
if($('div-userbook-'+book_id+'-'+userbook_id))
{$('div-userbook-'+book_id+'-'+userbook_id).dispose();}}}).send(pars);}
if($('ga-track-ub'))
{var type=$('ga-track-ub').value;ll_ga_track_ub(-1,book_id,type);}}
$$('.event-select-types').addEvent('change',function(){if(this.value=='club')
{document.getElementById('event_div_clubs').style.display='block';document.getElementById('event_div_libraries').style.display='none';$$('.event-input-library').set('disabled','disabled');$$('.event-input-clubs').set('disabled','');}
else if(this.value=='library')
{document.getElementById('event_div_libraries').style.display='block';document.getElementById('event_div_clubs').style.display='none';$$('.event-input-clubs').set('disabled','disabled');$$('.event-input-library').set('disabled','');}
else
{document.getElementById('event_div_libraries').style.display='none';document.getElementById('event_div_clubs').style.display='none';$$('.event-input-library').set('disabled','disabled');$$('.event-input-clubs').set('disabled','disabled');}});$$('.move-to-blog-type').addEvent('change',function(){$$('.move-to-blog-div').setStyle('display','none');if($$('.type_'+this.value))$$('.type_'+this.value).setStyle('display','block');});var post_add_source=function()
{var elements_count=$$('.post-source').length;if($('post-source'))
{var source_new='<span style="line-height: 24px;">Ссылка на источник</span><br>\n\
                            <input type="text" class="post-source wide" name="post[source]['+elements_count+'][url]" value=""><br>\n\
                            <span style="line-height: 24px;">Название</span><br>\n\
                            <input type="text" class="wide" name="post[source]['+elements_count+'][name]" value=""><br>';var elem=new Element('div',{'class':'row','style':'width: 350px; padding-top: 5px;'});$('post-source').appendChild(elem);elem.innerHTML=source_new;}}
function ll_advanced_search_form(elem)
{if(elem)
{var display=elem.innerHTML=='<span class="i-search-down"></span>'?true:false;elem.innerHTML=display?'<span class="i-search-up"></span>':'<span class="i-search-down"></span>';elem.setAttribute('title',display?'Свернуть':'Развернуть');}
$$('.userbook-search-div').toggle();$$('.userbook-search-button').toggle();$$('.userbook-search-text').toggle();}
function ll_content_new_form(is_work)
{var div1=$$('.content-section-notwork-div');var div2=$$('.content-section-work-div');var context_id=0;$('work-name-'+context_id).value='';$('work-name-'+context_id).set('readonly',false);$('work-author-'+context_id).value=$('work-author-'+context_id+'-hidden').value;$('work-author-'+context_id).set('readonly',false);$('work-translator-'+context_id).value='';$('work-translator-'+context_id).set('readonly',false);$('work-pages-'+context_id).value='';$('work-pages-'+context_id).set('readonly',false);$('work-description-'+context_id).value='';$('work-description-'+context_id).set('readonly',false);if(is_work)
{div1.setStyle('display','none');div2.setStyle('display','block');$$('.content-section-addinfo').setStyle('display','none');$$('.content-section-genres').setStyle('display','block');$('result-work-div').innerHTML='';$('search-work').set('value','');$('work-new').innerHTML='';$('search-form').setStyle('display','block');}
else
{$$('.content-section-genres').setStyle('display','none');div1.setStyle('display','block');div2.setStyle('display','none');$$('.content-section-addinfo').setStyle('display','block');}}
function ll_content_new_work()
{$$('.content-section-addinfo').setStyle('display','block');$$('.content-section-notwork-div').setStyle('display','block');$('result-work-div').setStyle('display','none');$('work-new').setStyle('display','none');$('search-form').setStyle('display','none');$('work-name-0').set('value',$('search-work').value);$('work-author-0').value=$('work-author-0-hidden').value;$('work-new').innerHTML='';$('work_form_name').value=0;}
function del_usermenu(id)
{if(confirm('Удалить ссылку?')&&$('link-'+id))
$('link-'+id).destroy();if($('menu-settings').rows.length<=101&&!($('add-row')))
{var row=$('menu-settings').insertRow($('menu-settings').rows.length-1);row.setAttribute('id','add-row');var td=row.insertCell(0);td.setAttribute('colspan',4);td.innerHTML='<a class="action" href="javascript:void(0)" onclick="add_usermenu();"><span class="i-add"></span>добавить</a>';}}
function add_usermenu()
{var count_rows=$('menu-settings').rows.length;if(count_rows>101)$('menu-settings').deleteRow(count_rows-2);$('menu-settings-head').setAttribute('style','display:table-row;text-align:left');var tmp_id=Math.floor(Math.random()*10001);var row=$('menu-settings').insertRow(count_rows-2);row.setAttribute('id','link-'+tmp_id);var sortno_cell=row.insertCell(0);var url_cell=row.insertCell(1);var title_cell=row.insertCell(2);var action_cell=row.insertCell(3);url_cell.innerHTML='<input type="text" class="normal um_url" name="ownmenu['+tmp_id+'][url]">';title_cell.innerHTML='<input type="text" class="normal" name="ownmenu['+tmp_id+'][url_name]">';sortno_cell.innerHTML='<input type="text" name="ownmenu['+tmp_id+'][sort_no]" style="width:40px">';action_cell.innerHTML='<a class="action" href="javascript:void(0)" onclick="del_usermenu('+tmp_id+');"><span class="i-clear"></span>удалить</a>';}
function check_user_menu()
{var url_list=document.getElementsByClassName('um_url');var i=0;var count=url_list.length;for(i=0;i<count;i++)
{if(url_list[i].value=='')
{url_list[i].focus();$('tinyalert').innerHTML+='<div class="red"><a href="javascript:void(0)" title="Закрыть" class="action a-close" onclick="this.getParent().hide();"><span class="i-clear"></span></a>Укажите ссылку!</div>';return false;}}
return true;}
function ll_ub_read_again(edition_id,halfs)
{var is_new_design=$('is-new-design')?$('is-new-design').value:0;var checked=false;if(is_new_design=='ll2015b')
{checked=$('ub-read-again-'+edition_id+'-span').hasClass('active')?false:true;var cls='menu-item';var cls_active='active';var cls_all='menu-item active';}
else
{var cls='action';var cls_active='standard';var cls_all='action standard';}
if($('ub-read-again-'+edition_id).checked||(is_new_design=='ll2015b'&&checked))
{if(is_new_design)ll_stars_new(edition_id,0,halfs);else ll_stars(edition_id,0,halfs);d=new Date();$('date-'+edition_id+'-day').set('value',0);$('date-'+edition_id+'-month').set('value',d.getMonth()+1);$('date-'+edition_id+'-year').set('value',d.getFullYear());$('ub-rating-'+edition_id).value=0;$('ub-own-p-'+edition_id).removeClass(cls_active);$('ub-own-p-'+edition_id+'-value').set('value',0);$('ub-own-e-'+edition_id).removeClass(cls_active);$('ub-own-e-'+edition_id+'-value').set('value',0);$('ub-own-a-'+edition_id).removeClass(cls_active);$('ub-own-a-'+edition_id+'-value').set('value',0);if($('ub-read-again-'+edition_id+'-notice'))$('ub-read-again-'+edition_id+'-notice').setStyle('display','block');if(checked&&is_new_design=='ll2015b')
{$('ub-read-again-'+edition_id+'-span').addClass('active');$('ub-read-again-'+edition_id).value=1;userbook_update(edition_id);}}
else
{$('ub-rating-'+edition_id).value=$('ub-rating-'+edition_id+'-hid').value;if(is_new_design)ll_restore_stars_new(edition_id,halfs);else ll_restore_stars(edition_id,halfs);$('date-'+edition_id+'-day').set('value',$('ub-'+edition_id+'-date_day-h').value);$('date-'+edition_id+'-month').set('value',$('ub-'+edition_id+'-date_month-h').value);$('date-'+edition_id+'-year').set('value',$('ub-'+edition_id+'-date_year-h').value);$('ub-own-p-'+edition_id+'-value').set('value',$('ub-own-p-'+edition_id+'-value-hid').value);$('ub-own-e-'+edition_id+'-value').set('value',$('ub-own-e-'+edition_id+'-value-hid').value);$('ub-own-a-'+edition_id+'-value').set('value',$('ub-own-a-'+edition_id+'-value-hid').value);if($('ub-own-p-'+edition_id+'-value-hid').value>0)$('ub-own-p-'+edition_id).set('class',cls_all);else $('ub-own-p-'+edition_id).set('class',cls);if($('ub-own-a-'+edition_id+'-value-hid').value>0)$('ub-own-a-'+edition_id).set('class',cls_all);else $('ub-own-a-'+edition_id).set('class',cls);if($('ub-own-e-'+edition_id+'-value-hid').value>0)$('ub-own-e-'+edition_id).set('class',cls_all);else $('ub-own-e-'+edition_id).set('class',cls);if($('ub-read-again-'+edition_id+'-notice'))$('ub-read-again-'+edition_id+'-notice').setStyle('display','none');$('ub-read-again-'+edition_id+'-span').removeClass('active');if(is_new_design=='ll2015b')
{if($('ub-read-again-'+edition_id).value>1)
{ll_delete_book(edition_id,($$('.review-'+edition_id).length>0?1:0),$('ub-read-again-'+edition_id).value,0,true);}
$('ub-read-again-'+edition_id).value=0;}}}
function ll_ub_read_again_new(edition_id,halfs)
{var is_new_design=$('is-new-design')?$('is-new-design').value:0;var checked=false;if(is_new_design=='ll2015b')
{checked=$('ub-read-again-'+edition_id+'-span').hasClass('active')?false:true;var cls='menu-item';var cls_active='active';var cls_all='menu-item active';}
else
{var cls='action';var cls_active='standard';var cls_all='action standard';}
if($('ub-read-again-'+edition_id).checked||(is_new_design=='ll2015b'&&checked))
{if(is_new_design)ll_stars_new(edition_id,0,halfs);else ll_stars(edition_id,0,halfs);d=new Date();$('date-'+edition_id+'-day').set('value',0);$('date-'+edition_id+'-month').set('value',d.getMonth()+1);$('date-'+edition_id+'-year').set('value',d.getFullYear());$('ub-rating-'+edition_id).value=0;$('ub-own-p-'+edition_id+'-value').set('value',0);$('ub-own-e-'+edition_id+'-value').set('value',0);$('ub-own-a-'+edition_id+'-value').set('value',0);if($('ub-read-again-'+edition_id+'-notice'))$('ub-read-again-'+edition_id+'-notice').setStyle('display','block');if(checked&&is_new_design=='ll2015b')
{$('ub-read-again-'+edition_id+'-span').addClass('active');$('ub-read-again-'+edition_id).value=1;userbook_update_new(edition_id);}}
else
{$('ub-rating-'+edition_id).value=$('ub-rating-'+edition_id+'-hid').value;if(is_new_design)ll_restore_stars_new(edition_id,halfs);else ll_restore_stars(edition_id,halfs);$('date-'+edition_id+'-day').set('value',$('ub-'+edition_id+'-date_day-h').value);$('date-'+edition_id+'-month').set('value',$('ub-'+edition_id+'-date_month-h').value);$('date-'+edition_id+'-year').set('value',$('ub-'+edition_id+'-date_year-h').value);$('ub-own-p-'+edition_id+'-value').set('value',$('ub-own-p-'+edition_id+'-value-hid').value);$('ub-own-e-'+edition_id+'-value').set('value',$('ub-own-e-'+edition_id+'-value-hid').value);$('ub-own-a-'+edition_id+'-value').set('value',$('ub-own-a-'+edition_id+'-value-hid').value);if($('ub-own-p-'+edition_id+'-value-hid').value>0&&$('ub-own-p-'+edition_id))$('ub-own-p-'+edition_id).set('class',cls_all);else if($('ub-own-p-'+edition_id))$('ub-own-p-'+edition_id).set('class',cls);if($('ub-own-a-'+edition_id+'-value-hid').value>0&&$('ub-own-a-'+edition_id))$('ub-own-a-'+edition_id).set('class',cls_all);else if($('ub-own-a-'+edition_id))$('ub-own-a-'+edition_id).set('class',cls);if($('ub-own-e-'+edition_id+'-value-hid').value>0&&$('ub-own-e-'+edition_id))$('ub-own-e-'+edition_id).set('class',cls_all);else if($('ub-own-e-'+edition_id))$('ub-own-e-'+edition_id).set('class',cls);if($('ub-read-again-'+edition_id+'-notice'))$('ub-read-again-'+edition_id+'-notice').setStyle('display','none');$('ub-read-again-'+edition_id+'-span').removeClass('active');if(is_new_design=='ll2015b')
{if($('ub-read-again-'+edition_id).value>1)
{ll_delete_book(edition_id,($$('.review-'+edition_id).length>0?1:0),$('ub-read-again-'+edition_id).value,0,true);}
$('ub-read-again-'+edition_id).value=0;}}}
function ll_ub_change_work_edition(work_id,work_edition_id,halfs)
{new Request({url:'/user/changeworkedition',method:'post',onRequest:initAd,onSuccess:closeAd,onFailure:failure,onComplete:function(json){json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);return;}
$('ub_change_work_edition').setStyle('display','none');$('ub-pic-work-'+work_id).innerHTML=json.html;$('ub-work-edition-id-'+work_id).value=work_edition_id;$('ub-status-read-'+work_id).set('class','action');$('ub-status-wish-'+work_id).set('class','action');$('ub-status-reading-'+work_id).set('class','action');if(json.userbook)
{$('read_again_ph').innerHTML='';ll_restore_stars(work_id);$('date-'+work_id+'-day').set('value',json.userbook.date_day);$('date-'+work_id+'-month').set('value',json.userbook.date_month);$('date-'+work_id+'-year').set('value',json.userbook.date_year);ll_stars(work_id,json.userbook.rating,halfs);$('ub-rating-'+work_id).value=json.userbook.rating;$('ub_save').set('onclick',' ll_ub_save('+work_id+', '+work_id+', 1, '+json.userbook.id+' );');if(json.userbook.book_read==1)$('ub-status-read-'+work_id).set('class','action standard');else $('ub-status-read-'+work_id).set('class','action');if(json.userbook.book_read==0)$('ub-status-wish-'+work_id).set('class','action standard');else $('ub-status-wish-'+work_id).set('class','action');if(json.userbook.book_read==2)$('ub-status-reading-'+work_id).set('class','action standard');else $('ub-status-reading-'+work_id).set('class','action');}
else
{$('read_again_ph').innerHTML=json.read_again_html;ll_stars(work_id,0,halfs);d=new Date();$('date-'+work_id+'-day').set('value',0);$('date-'+work_id+'-month').set('value',d.getMonth()+1);$('date-'+work_id+'-year').set('value',d.getFullYear());}}}).send('work_id='+work_id+'&work_edition_id='+work_edition_id);}
function ll_add_character_form(work_id,character_id)
{new Request({url:'/character/searchform',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message);}
if(json.content)
{$('character_add_form-'+character_id).innerHTML=json.content;}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send('work_id='+work_id+'&character_id='+character_id);}
function ll_search_character()
{var text=$('search-character').value.trim();new Request({url:'/character/search',method:'post',data:{text:text},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message);return;}
$('result-character-div').innerHTML=json.content;if(json.count==0)
{$('character-add-new').setStyle('display','block');$('character-name-0').set('value',$('search-character').value);}
else
{$('character-add-new').setStyle('display','none');}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function ll_save_work_character(work_id,is_new,character_id)
{if(character_id==undefined)character_id=0;var data={};data.is_new=is_new;data.work_id=work_id;if(is_new)
{data.name=$('character-name-0').value;data.name_original=$('character-name_original-0').value;data.nickname=$('character-nickname-0').value;data.sex=$('character-sex-0').value;data.nationality=$('character-nationality-0').value;data.species=$('character-species-0').value;data.location=$('character-location-0').value;data.sort_no=$('character-sort_no-0').value;data.local_name=$('character-local_name-0').value;data.comments=$('character-comments-0').get('value').toString();}
else
{if(character_id>0)
{data.character_id=character_id;data.sort_no=$('character-sort_no-'+character_id).value;data.local_name=$('character-local_name-'+character_id).value;data.comments=$('character-comments-'+character_id).get('value').toString();}
else
{data.sort_no=$('character-sort_no').value;data.local_name=$('character-local_name').value;data.comments=$('character-comments').get('value').toString();data.character_id=$('result-character').value;}}
new Request({url:'/character/save',method:'post',data:data,onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message);return;}
$('character_add_form-'+character_id).innerHTML='';if(is_new)
{var firstTr=new Element('tr',{id:'character-'+json.character_id});firstTr.innerHTML=json.content;firstTr.inject($('characters-table'),'top');}
else
{$('character-'+character_id).innerHTML=json.content;}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function ll_select_character()
{var character_id=$('result-character').value;var work_id=$('character-work_id').value;var character_name=$('result-character').getSelected().get('data-name');$('character-selected-a').set('href','/character/'+character_id);$('character-selected-a').set('target','_blank');$('character-selected-a').innerHTML='<span class="i-character"></span>'+character_name;if(character_id>0)
{new Request({url:'/character/select',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message);$('character-add').setStyle('display','none');return;}
$('character-'+character_id).setStyle('display','none');return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send('work_id='+work_id+'&character_id='+character_id);$('character-add-new').setStyle('display','none');$('character-add').setStyle('display','block');}
else
{$('character-add').setStyle('display','none');}
return;}
function ll_add_new_character()
{$('character-add-new').setStyle('display','block');$('character-add').setStyle('display','none');$('character-name-0').set('value',$('search-character').value);$('result-character').value=0;$('character-selected-a').set('href','');$('character-selected-a').set('target','_blank');$('character-selected-a').innerHTML='';}
function ll_character_delete(work_id,character_id)
{if(confirm("Удалить персонажа из списка?"))
{new Request({url:'/character/delete',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message);return;}
$('character-'+character_id).setStyle('display','none');return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send('work_id='+work_id+'&character_id='+character_id);}}
function ll_character_add_tag_form(e,character_id)
{var coords=getMouseCoords(e);var htmlname='-character-form-'+character_id;if($('div'+htmlname))
{$('div'+htmlname).destroy();return false;}
new Request({url:'/character/tagsform',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message);return;}
var container=$('body');var div=new Element('div',{id:'div'+htmlname});var st='width:305px;padding:5px;position:absolute;top:'+(coords['y']+10)+'px;left:'+coords['x']+'px;';if(isIE())div.style.cssText=st;div.setAttribute('style',st);div.addClass('share');div.innerHTML=json.content;container.adopt(div);return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send('character_id='+character_id);}
function ll_character_save_tags(character_id)
{var tags=$('character-tags-'+character_id).value;var params='character_id='+character_id+'&tags='+encodeURIComponent(tags);if($('character-tags-changed-'+character_id).value)params+="&tagschanged=true";new Request({url:'/character/savetags',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message);return;}
$('div-character-form-'+character_id).destroy();return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send(params);}
var get_promo=function(url,promo_areas,google_block)
{scrollconf.promo_url=url;var areas='';for(var i=0;i<promo_areas.length;i++)
{var area_id=(promo_areas[i].id).replace(url,'');if(area_id!='')areas=areas+area_id+',';}
if(areas=='')return false;if(!google_block)google_block=0;var promo_scheme=$('column-fixed')?2:1;var is_new_design=$('is-new-design')?$('is-new-design').value:'';var side_blocks=['1','9','10','11'];var new_blocks=Array();var arg=url;new Request({url:'/'+arg,method:'post',data:{areas:areas,url:location.pathname,google_block:google_block,promo_scheme:promo_scheme},onComplete:function(json)
{json=strToJson(json);try{if(json.areas||!json.areas)var succes=true;}catch(e){if(typeof(context_replace_init)=='function')setTimeout(context_replace_init,1000);return false;}
if(json.areas)
{for(var i in json.areas)
{if($(url+json.areas[i].no))
{if(promo_scheme==2&&side_blocks.indexOf(json.areas[i].no)>-1)
{$(url+json.areas[i].no).hide();new_blocks[json.areas[i].no]=true;}
else
{if($(url+json.areas[i].no).style.display=='none')$(url+json.areas[i].no).style.display='block';}
if($(url+json.areas[i].no)&&$(url+json.areas[i].no).parentNode)
{$(url+json.areas[i].no).parentNode.style.display='block';}
$(url+json.areas[i].no).innerHTML=json.areas[i].html;if(promo_scheme!=2||side_blocks.indexOf(json.areas[i].no)==-1)nodeScriptReplace($(url+json.areas[i].no));else if(side_blocks.indexOf(json.areas[i].no)>-1){$(url+json.areas[i].no).addClass('side-blocks');}}}}
if(typeof(context_replace_init)=='function')setTimeout(context_replace_init,1000);if(promo_scheme==2&&$$('.side-blocks'))
{$$('.side-blocks').hide();$$('.side-blocks')[0].show();var id=$$('.side-blocks')[0].getAttribute('id');var current_no=id?id.replace(url,''):null;if(current_no&&new_blocks.indexOf(current_no)&&!scrollconf.promo_replaces[0])
{nodeScriptReplace($$('.side-blocks')[0]);scrollconf.promo_replaces[0]=true;}
side_scroll_init();}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:function(){if(typeof(context_replace_init)=='function')setTimeout(context_replace_init,1000);}}).send();}
function menu_change()
{var container=$('menu-container');var elements=$$('#menu-container li');if(elements.length<=0)return false;var more=container.getElementById('ul-context-more');var elementsmore=more.getElementsByTagName("LI");var size=$('menu-inner').getSize();var width=0;var margin_li=container.getElementById('a-context-more').hasClass('button')?10:23;var margin_container=container.getElementById('a-context-more').hasClass('button')?0:125;var more_count=container.getElementById('a-context-more').hasClass('button')?0:1;for(var i=0;i<elements.length-more_count-elementsmore.length;i++)
{var elsize=elements[i].getSize();width+=(i>0?margin_li:0)+elsize.x;if(width>size.x-margin_container)
{if(container.getElementById('more-li'))container.getElementById('more-li').style.display='';container.getElementById('a-context-more').style.display=container.getElementById('a-context-more').hasClass('button')?'inline-block':'inline';for(var j=elements.length-1-more_count-elementsmore.length;j>=i;j--)
{var current_menus=more.getElementsByTagName("LI");if(current_menus.length>0)
{more.insertBefore(elements[j],current_menus[0]);}
else
{more.appendChild(elements[j]);}}
return false;}}
if(elementsmore.length<=0)
{container.getElementById('a-context-more').hide();more.style.visibility='hidden';if(container.getElementById('more-li'))container.getElementById('more-li').hide();return false;}
for(i=0;i<elementsmore.length;i++)
{var elsize=elementsmore[i].getSize();width+=(i>0?margin_li:0)+elsize.x;if(width<=size.x-margin_container)
{container.insertBefore(elementsmore[i],container.getElementById('more-li'));if(i==elementsmore.length-1)
{container.getElementById('a-context-more').hide();more.style.visibility='hidden';}}
else
{return false;}}
return false;}
if($('menu-container'))
{menu_change();window.onresize=function(event){menu_change();};}
if($$('.select').length>0)
{$$('.select').addEvent('click',function(event){var elements=$$('.select');if(elements.length<0)return false;var old_element_name='';for(var i=0;i<elements.length;i++)
{if(elements[i].hasClass('active'))
{old_element_name=elements[i].get('data-toolbar');break;}}
if(old_element_name!='')
{toolbar_picker_close();eventstop(event);return false;}
var element_name=this.get('data-toolbar');this.addClass('active');var toolbars=$$('.toolbar');for(var i=0;i<toolbars.length;i++)
{toolbars[i].hide();}
toolbar_picker_close();var exclude_elements=['innerwrapper','bodywrapper','footer','footer_link','footer_link_hover','header','header_link','header_link_hover','header_link_visited','top','content','maincontent'];var position_elements=['content','footer','innerwrapper','bodywrapper','contentwrapper','maincontent'];if(old_element_name!=''&&exclude_elements.indexOf(old_element_name)==-1&&(element_name=='bodywrapper'||element_name=='content'))
{if($('toolbar-'+element_name))$('toolbar-'+element_name).hide();}
else
{if($('toolbar-'+element_name))
{if(position_elements.indexOf(element_name)>-1)
{var coords=getMouseCoords();var size=$('body').getSize();if(coords.x+320>size.x&&size.x>0)coords.x=size.x-320;$('toolbar-'+element_name).setAttribute('style','top:'+coords.y+'px;left:'+coords.x+'px;');}
$('toolbar-'+element_name).show();}}
toolbar_picker_close();eventstop(event);});toolbar_default();}
if($$('.toolbar').length>0)
{var elements=$$('.toolbar');elements.addEvent('click',function(e){toolbar_picker_close();eventstop(e);});for(var i=0;i<elements.length;i++)
{new Drag(elements[i].id,{handle:elements[i].id+'-title'});}}
if($$('.input-toolbar').length>0)
{$$('.input-toolbar').addEvent('change',function(event){var element_name=this.id.replace(/skin-([^-]+)-(.+)/g,"$1");if(element_name=='body')element_name='bodywrapper';if($('toolbar-'+element_name+'-unset'))$('toolbar-'+element_name+'-unset').show('inline');});}
function toolbar_picker_close()
{var pickers=$$('.moor-box');if(pickers.length>0)
{for(var i=0;i<pickers.length;i++)
{var elem=pickers[i].parentNode;var area_hidden=elem.get('aria-hidden');if(area_hidden=='false')
{var id=elem.id.substring(11);if($(id))$(id).click();}}}}
function toolbar_default()
{var elements=$$('.select');if(elements.length>0)
{var properties=['background-color','font-size','color','background-position','background-size','font-family','font-style','font-weight','text-decoration','border-width','border-style','border-top-width','border-bottom-width','border-left-width','border-right-width','border-color','border-radius','background-repeat','height'];var properties_checkbox=['background-size','font-family','font-weight','text-decoration','font-style'];var properties_size=['border-top-width','border-bottom-width','border-left-width','border-right-width','border-width','font-size','height','border-radius'];var properties_select=['border-top-width','border-bottom-width','border-left-width','border-right-width','border-width','font-size','border-radius','border-style'];for(var i=0;i<elements.length;i++)
{var element_name=elements[i].get('data-toolbar');elements[i].addClass('select-'+element_name);for(var j=0;j<properties.length;j++)
{if($('skin-'+element_name+'-'+properties[j])&&($('skin-'+element_name+'-'+properties[j]).value==0||$('skin-'+element_name+'-'+properties[j]).value==''||$('skin-'+element_name+'-'+properties[j]).type=='checkbox'))
{var styles=elements[i].getStyles(properties[j]);if(styles!=null&&styles[properties[j]]!=null)
{var position=properties_checkbox.indexOf(properties[j]);if(position>=0)
{if(styles[properties[j]].indexOf($('skin-'+element_name+'-'+properties[j]).value)>=0)
{$('skin-'+element_name+'-'+properties[j]).checked='checked';$('skin-'+element_name+'-'+properties[j]).set('data-default','checked');}}
else
{$('skin-'+element_name+'-'+properties[j]).value=properties_size.indexOf(properties[j])>-1?Number(styles[properties[j]].replace(/\D+/g,"")):styles[properties[j]];$('skin-'+element_name+'-'+properties[j]).set('data-default',properties_size.indexOf(properties[j])>-1?Number(styles[properties[j]].replace(/\D+/g,"")):styles[properties[j]]);if(properties[j]=='background-color')
{if(styles[properties[j]]=='transparent')
{$('skin-'+element_name+'-'+properties[j]+'-transparent').checked=true;$('skin-'+element_name+'-'+properties[j]).value='#FFF';}}
if(properties_select.indexOf(properties[j])>-1)
{if($('skin-'+element_name+'-'+properties[j]).selectedIndex=='undefined'||isNaN($('skin-'+element_name+'-'+properties[j]).selectedIndex)||$('skin-'+element_name+'-'+properties[j]).selectedIndex<0||$('skin-'+element_name+'-'+properties[j]).selectedIndex>$('skin-'+element_name+'-'+properties[j]).options.length||$('skin-'+element_name+'-'+properties[j]).value==''||$('skin-'+element_name+'-'+properties[j]).value==undefined)
{$('skin-'+element_name+'-'+properties[j]).value=0;}}}}}}}}}
function toolbar_image(element_name,property_name,action)
{var show_property=false;if(action=='change')
{$('skin-'+element_name+'-'+property_name+'-cancel').show('inline-block');show_property=true;}
else if(action=='cancel')
{$('skin-'+element_name+'-'+property_name+'-cancel').hide();$('skin-'+element_name+'-'+property_name).value='';var default_value=$('skin-'+element_name+'-'+property_name).get('data-default');if(default_value!=null&&default_value!='undefined'&&default_value!='')
{$('skin-'+element_name+'-'+property_name+'-nohref').hide();$('skin-'+element_name+'-'+property_name+'-add').hide();$('skin-'+element_name+'-'+property_name+'-load').show('inline-block');$('skin-'+element_name+'-'+property_name+'-remove').show('inline-block');$('skin-'+element_name+'-'+property_name+'-href').show('inline');show_property=true;$('skin-'+element_name+'-'+property_name+'-delete').value=0;}
else
{$('skin-'+element_name+'-'+property_name+'-load').hide();$('skin-'+element_name+'-'+property_name+'-remove').hide();$('skin-'+element_name+'-'+property_name+'-href').hide();$('skin-'+element_name+'-'+property_name+'-nohref').show('inline');$('skin-'+element_name+'-'+property_name+'-add').show('inline-block');$('skin-'+element_name+'-'+property_name+'-delete').value=1;}
$('skin-'+element_name+'-'+property_name).hide();}
else if(action=='delete')
{$('skin-'+element_name+'-'+property_name+'-delete').value=1;if($('toolbar-'+(element_name=='body'?'bodywrapper':element_name)+'-unset'))$('toolbar-'+(element_name=='body'?'bodywrapper':element_name)+'-unset').show('inline');$('skin-'+element_name+'-'+property_name+'-load').show('inline-block');$('skin-'+element_name+'-'+property_name+'-remove').hide();$('skin-'+element_name+'-'+property_name+'-href').hide();$('skin-'+element_name+'-'+property_name+'-add').hide();$('skin-'+element_name+'-'+property_name+'-nohref').show('inline');$('skin-'+element_name+'-'+property_name+'-cancel').show('inline-block');$('skin-'+element_name+'-'+property_name).hide();}
else if(action=='load')
{$('skin-'+element_name+'-'+property_name+'-load').hide();$('skin-'+element_name+'-'+property_name+'-remove').hide();$('skin-'+element_name+'-'+property_name+'-href').hide();$('skin-'+element_name+'-'+property_name+'-nohref').hide();$('skin-'+element_name+'-'+property_name+'-add').hide();$('skin-'+element_name+'-'+property_name).show('inline');$('skin-'+element_name+'-'+property_name+'-cancel').show('inline-block');show_property=true;}
else if(action=='new')
{if($('skin-'+element_name+'-'+property_name+'-delete'))$('skin-'+element_name+'-'+property_name+'-delete').value=0;$('skin-'+element_name+'-'+property_name).hide();if($('skin-'+element_name+'-'+property_name+'-cancel'))$('skin-'+element_name+'-'+property_name+'-cancel').hide();var new_href=$('skin-'+element_name+'-'+property_name).get('data-default');if(new_href)
{$('skin-'+element_name+'-'+property_name+'-href').setAttribute('href','https://s.livelib.ru'+new_href);$('skin-'+element_name+'-'+property_name+'-new').value=new_href;var name=new_href.replace(/(.+)\/([^\/]+)/g,"$2");if(name.length>25)name=name.substring(0,10)+'...'+name.substring(name.length-10);$('skin-'+element_name+'-'+property_name+'-href').innerHTML=name;}
show_property=true;toolbar_image(element_name,property_name,'cancel');}
if(show_property)
{if($('skin-'+element_name+'-background-repeat'))$('skin-'+element_name+'-background-repeat').show('inline');if($('skin-'+element_name+'-background-position'))$('skin-'+element_name+'-background-position').show('inline');if($('skin-'+element_name+'-background-size-size'))$('skin-'+element_name+'-background-size-size').show('inline');}
else
{if($('skin-'+element_name+'-background-repeat'))$('skin-'+element_name+'-background-repeat').hide();if($('skin-'+element_name+'-background-position'))$('skin-'+element_name+'-background-position').hide();if($('skin-'+element_name+'-background-size-size'))$('skin-'+element_name+'-background-size-size').hide();}}
function toolbar_close(element_name)
{toolbar_unset(element_name);$('toolbar-'+element_name).hide();var elements=$$('.select');if(elements.length<0)return false;for(var i=0;i<elements.length;i++)
{if(elements[i].hasClass('active'))
{elements[i].removeClass('active');break;}}}
function toolbar_unset(element_name)
{toolbar_picker_close();var properties=['background-color','font-size','color','background-position','background-size','font-family','font-style','font-weight','text-decoration','border-width','border-style','border-top-width','border-bottom-width','border-left-width','border-right-width','border-color','border-radius','background-repeat','height','background-image'];var properties_checkbox=['background-size','font-family','font-weight','text-decoration','font-style'];var properties_size=['border-top-width','border-bottom-width','border-left-width','border-right-width','border-width','font-size','height','border-radius'];var properties_select=['border-top-width','border-bottom-width','border-left-width','border-right-width','border-width','font-size','border-radius','border-style'];for(var i=0;i<properties.length;i++)
{if(!$('skin-'+element_name+'-'+properties[i]))continue;var previous=$('skin-'+element_name+'-'+properties[i]).get('data-default');var position=properties_checkbox.indexOf(properties[i]);if(position>=0)
{if(previous=='checked')$('skin-'+element_name+'-'+properties[i]).checked=true;else $('skin-'+element_name+'-'+properties[i]).checked=false;}
else
{if(properties[i]=='background-image')
{toolbar_image(element_name,properties[i],'cancel');}
else
{$('skin-'+element_name+'-'+properties[i]).value=properties_size.indexOf(properties[i])>-1?Number(previous.replace(/\D+/g,"")):previous;if(properties[i]=='background-color')
{if($('skin-'+element_name+'-'+properties[i]+'-transparent'))
{var previous_other=$('skin-'+element_name+'-'+properties[i]+'-transparent').get('data-default');$('skin-'+element_name+'-'+properties[i]+'-transparent').checked=previous_other=='transparent'?true:false;}
if($('picker-skin-'+element_name+'-'+properties[i]))$('picker-skin-'+element_name+'-'+properties[i]).style.backgroundColor=previous;}
if(properties_select.indexOf(properties[i])>-1)
{if($('skin-'+element_name+'-'+properties[i]).selectedIndex=='undefined'||isNaN($('skin-'+element_name+'-'+properties[i]).selectedIndex)||$('skin-'+element_name+'-'+properties[i]).selectedIndex<0||$('skin-'+element_name+'-'+properties[i]).selectedIndex>$('skin-'+element_name+'-'+properties[i]).options.length||$('skin-'+element_name+'-'+properties[i]).value==''||$('skin-'+element_name+'-'+properties[i]).value==undefined)
{$('skin-'+element_name+'-'+properties[i]).value=0;}}}}}
if($('toolbar-'+element_name+'-unset'))$('toolbar-'+element_name+'-unset').hide();}
function toolbar_save(element_name)
{var skin_id=$('skin-id').value==''||$('skin-id').value=='undefined'?0:$('skin-id').value;if($('toolbar-'+element_name))
{var inputs=$('toolbar-'+element_name).getElements('input');var xhr=new XMLHttpRequest();upload=xhr.upload;formData=new FormData();if(inputs.length>0)
{for(var i=0;i<inputs.length;i++)
{if(inputs[i].get('type')!='file')continue;if(inputs[i].files&&inputs[i].files[0]&&inputs[i].files[0]!='undefined')
{formData.append(inputs[i].get('name'),inputs[i].files[0]);}}}
xhr.onreadystatechange=function(){if(xhr.readyState==4)
{if((xhr.status>=200&&xhr.status<300)||xhr.status==304)
{var json=strToJson(xhr.responseText);if(json.error)
{alert(json.message);prepare(json);return false;}
if(json.styles)
{for(var i=0;i<json.styles.length;i++)
{if(!json.styles[i])continue;var element=$$('.select-'+json.styles[i].element_name);if(element[0]&&element[0]!='undefined')
{element[0].setAttribute('style',json.styles[i].style);var properties=['background-color','font-size','color','background-position','background-size','font-family','font-style','font-weight','text-decoration','border-width','border-style','border-top-width','border-bottom-width','border-left-width','border-right-width','border-color','border-radius','background-repeat','height','background-image'];var properties_checkbox=['background-size','font-family','font-weight','text-decoration','font-style'];var properties_size=['border-top-width','border-bottom-width','border-left-width','border-right-width','border-width','font-size','height','border-radius'];var properties_select=['border-top-width','border-bottom-width','border-left-width','border-right-width','border-width','font-size','border-radius','border-style'];for(var j=0;j<properties.length;j++)
{if(!$('skin-'+json.styles[i].element_name+'-'+properties[j]))continue;if(!json.properties[json.styles[i].element_name][properties[j]])continue;var current_property=json.properties[json.styles[i].element_name][properties[j]];var previous=$('skin-'+json.styles[i].element_name+'-'+properties[j]).get('data-default');var position=properties_checkbox.indexOf(properties[j]);if(position>=0)
{$('skin-'+json.styles[i].element_name+'-'+properties[j]).setAttribute('data-default',current_property.value==''||current_property.value==0||current_property.value==undefined?'':'checked');}
else
{if(current_property.value!='transparent')$('skin-'+json.styles[i].element_name+'-'+properties[j]).setAttribute('data-default',current_property.value);if(properties[j]=='background-image')
{var action=current_property.is_delete&&current_property.is_delete==1?'delete':(current_property.value&&current_property.value!=''?'new':'');if(action=='delete')$('skin-'+json.styles[i].element_name+'-'+properties[j]).setAttribute('data-default','');if(action!='')toolbar_image(json.styles[i].element_name,properties[j],action);}
if(properties[j]=='background-color')
{if($('skin-'+json.styles[i].element_name+'-'+properties[j]+'-transparent'))
{$('skin-'+json.styles[i].element_name+'-'+properties[j]+'-transparent').checked=current_property.transparent==1?true:false;$('skin-'+json.styles[i].element_name+'-'+properties[j]+'-transparent').setAttribute('data-default',current_property.transparent==1?'transparent':'');}}
if(properties_select.indexOf(properties[j])>-1)
{if($('skin-'+json.styles[i].element_name+'-'+properties[j]).selectedIndex=='undefined'||isNaN($('skin-'+json.styles[i].element_name+'-'+properties[j]).selectedIndex)||$('skin-'+json.styles[i].element_name+'-'+properties[j]).selectedIndex<0||$('skin-'+json.styles[i].element_name+'-'+properties[j]).selectedIndex>$('skin-'+element_name+'-'+properties[j]).options.length||$('skin-'+json.styles[i].element_name+'-'+properties[j]).value==''||$('skin-'+json.styles[i].element_name+'-'+properties[j]).value==undefined)
{$('skin-'+element_name+'-'+properties[j]).value=0;}}}}
if($('toolbar-'+json.styles[i].element_name+'-unset'))$('toolbar-'+json.styles[i].element_name+'-unset').hide();toolbar_close(element_name);}}}
onload.call(xhr);}
else onerror.call(xhr);}};xhr.open('POST','/skin/prepare/'+skin_id+'?'+$('toolbar-'+element_name).toQueryString(),true);xhr.setRequestHeader('X-Requested-With','XMLHttpRequest');xhr.send(formData);}}
function contact_category_select(type)
{var hide_el=$$('.contact-visible');var show_el=$('type-description-'+type);xshow(document.getElementById('text-message'));if(hide_el!=null)
{hide_el.addClass('contact-hidden');hide_el.removeClass('contact-visible');}
if(show_el!=null)
{$('type-description-'+type).removeClass('contact-hidden');$('type-description-'+type).addClass('contact-visible');var hide_form=show_el.getAttribute('data-hide_form');if(hide_form)
{$('text-message').hide();}
else
{$('text-message').show();}}}
function skin_save()
{var xhr=new XMLHttpRequest();upload=xhr.upload;formData=new FormData($('skin-form'));$('skin-save').hide();$('skin-save-bottom').hide();$('skin-save-result').innerHTML='Сохранение...';$('skin-save-result-bottom').innerHTML='Сохранение...';xhr.onreadystatechange=function(){if(xhr.readyState==4)
{if((xhr.status>=200&&xhr.status<300)||xhr.status==304)
{var json=strToJson(xhr.responseText);prepare(json);if(json.error)
{alert(json.message);$('skin-save').show();$('skin-save-result').innerHTML='';$('skin-save-bottom').show();$('skin-save-result-bottom').innerHTML='';return false;}
if(json.id)
{$('skin-id').value=json.id;location.href='/skins';}
onload.call(xhr);}
else onerror.call(xhr);$('skin-save').show();$('skin-save-result').innerHTML='';$('skin-save-bottom').show();$('skin-save-result-bottom').innerHTML='';}};xhr.open('POST','/skin/save',true);xhr.setRequestHeader('X-Requested-With','XMLHttpRequest');xhr.send(formData);}
function skin_load(list_type,start,per_page)
{new Request({url:'/skin/all',method:'post',data:{list_type:list_type,start:start,per_page:per_page},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.message);return;}
if(json.content&&$('skins-'+list_type))
{$('skins-'+list_type).innerHTML+=json.content;if($('skins-'+list_type+'-button'))
{if(json.ended)$('skins-'+list_type+'-button').dispose();else $('skins-'+list_type+'-button').set('onclick','skin_load(\''+list_type+'\', '+(start+1)+', '+per_page+')');milkbox.reloadPageGalleries();}}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function skin_set(skin_id)
{skin_set_unset(skin_id,'set');}
function skin_unset(skin_id)
{skin_set_unset(skin_id,'unset');}
function skin_set_unset(skin_id,type)
{var elements=$$('.skin-small');if(elements.length<=0)return false;for(var i=0;i<elements.length;i++)
{elements[i].removeClass('active');}
if($('skin-'+skin_id))
{$$('.skin-unset').hide();$$('.skin-set').show('inline');var default_id=$$('.skin-default')[0]?$$('.skin-default')[0].id.substring(5):0;if(type=='set')
{$('skin-'+skin_id).addClass('active');$('skin-set-'+skin_id).hide();$$('.skin-unset-'+skin_id).show('inline');if(default_id==skin_id)$('skin-unset-'+skin_id).hide();}
else
{$('skin-set-'+skin_id).show('inline');$$('.skin-unset-'+skin_id).hide();}
new Request({url:'/skin/setskin',method:'post',data:{skin_id:skin_id,type:type},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.message);return;}
if($('skin-css'))$('skin-css').dispose();if(type=='set'&&json.src)
{var link=new Element('link',{id:'skin-css',rel:'stylesheet',type:'text/css',href:json.src});document.getElementsByTagName('head')[0].appendChild(link);}
if(default_id==skin_id&&type=='set')
{$('skin-unset-'+default_id).hide();}
if(default_id>0&&type=='unset'&&$('skin-set-'+default_id))
{$('skin-'+default_id).addClass('active');$('skin-set-'+default_id).hide();$$('.skin-unset-'+default_id).show();$('skin-unset-'+default_id).hide();}
if($$('.skin-popup-containers'))$$('.skin-popup-containers').dispose();return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}}
function skin_preview(skin_id)
{new Request({url:'/skin/preview',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);}
else
{if($$('.skin-popup-containers'))$$('.skin-popup-containers').dispose();var container=$('body');if(container)
{var div=new Element('div',{id:'div-skin-'+skin_id,class:'skin-popup-containers'});div.innerHTML=json.content;container.adopt(div);if($$('#div-skin-'+skin_id+' .popup-back')[0])$$('#div-skin-'+skin_id+' .popup-back')[0].show();}
else
{alert('Ошибка!');}}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("skin_id="+skin_id);return false;}
function eventstop(e)
{var evt=(e)?e:((window.event)?window.event:null);if(evt.preventDefault){evt.stopPropagation();}else{evt.cancelBubble=true;}}
function portal_upload(type,param)
{var elements=document.getElementsByClassName('carousel-element-'+type+'-'+param);var count=elements.length;var i;var excluded='';for(i=0;i<count;i++)
{excluded+=elements[i].value+',';}
new Request({url:'/book/portal',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.message);return;}
if(json.content)
{$('carousel-'+type+'-'+param).innerHTML+=json.content;}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("list_type="+type+"&param="+param+"&excluded="+excluded.slice(0,-1));}
var promo_add_url=function()
{var elements_count=$$('.promo-url').length;if($('promo-urls'))
{var url_new='<input class="wide" type="text" name="form[patterns]['+elements_count+'][pattern][url]" value=""><br>\n\
                        <label for="form[patterns]['+elements_count+'][pattern][current_path_only]">\n\
                            <input type="checkbox" style="vertical-align: -2px" value="1" id="form[patterns]['+elements_count+'][pattern][current_path_only]" name="form[patterns]['+elements_count+'][pattern][current_path_only]"> точное совпадение с url-адресом\n\
                        </label><br>\n\
                        <label for="form[patterns]['+elements_count+'][pattern][with_pagination]">\n\
                            <input type="checkbox" style="vertical-align: -2px" value="1" id="form[patterns]['+elements_count+'][pattern][with_pagination]" name="form[patterns]['+elements_count+'][pattern][with_pagination]"> включать постраничную навигацию\n\
                        </label><br>\n\
                        <label for="form[patterns]['+elements_count+'][pattern][block_id]">\n\
                            <input type="checkbox" style="vertical-align: -2px" value="5" id="form[patterns]['+elements_count+'][pattern][block_id]" name="form[patterns]['+elements_count+'][pattern][block_id]"> не показывать на старнице\n\
                        </label>';var elem=new Element('div',{'class':'p promo-url','style':''});$('promo-urls').appendChild(elem);elem.innerHTML=url_new;}}
var promo_area_preview=function(area_id)
{if($('form[areas]['+area_id+'][html]')&&$('promo-area-preview'))
{$('promo-area-preview').innerHTML=$('promo-area-preview').innerHTML!=''?'':$('form[areas]['+area_id+'][html]').value;nodeScriptReplace($('promo-area-preview'));}}
var promo_add_genre=function()
{var genre_id=$('promo-genres-select').value;if($('promo-genre-'+genre_id))
{alert('Жанр уже добавлен к правилу');return false;}
var genre_name=$('promo-genres-select').options[$('promo-genres-select').selectedIndex].text;var html='<span id="promo-genre-'+genre_id+'"><input type="hidden" name="form[genres]['+genre_id+']" value="'+genre_name+'">'+genre_name+'<a class="action" href="javascript:void(0);" onclick="'+'$(\'promo-genre-'+genre_id+'\').dispose();"><span class="i-delete"></span></a>, </span>';$('promo-genres').innerHTML+=html;}
var promo_url_add_new=function()
{var alias=$('promo-set-urls')?$('promo-set-urls').value:'';if(!$('promo-urls')||!$('promo-url-'+alias))return false;var elements_count=$$('#promo-urls .promo-url').length;if(!elements_count)elements_count=0;var elements_count_new=$$('#promo-url-'+alias+' .promo-url').length;if(!elements_count_new||elements_count_new<=0)return false;var html=$('promo-url-'+alias).innerHTML;for(var i=0;i<elements_count_new;i++)
{html=html.replace(new RegExp('key-'+i,'g'),elements_count);elements_count++;}
$('promo-urls').innerHTML+=html;}
var promo_url_delete=function(alias)
{var elements=$$('#promo-urls .promo-url-text-'+alias);if(elements.length>0)
{for(var i=0;i<elements.length;i++)
{elements[i].dispose();}}
var elems=$$('#promo-urls .promo-url-'+alias);if(elems.length>0)
{for(var i=0;i<elems.length;i++)
{elems[i].getParent().dispose();}}}
var promo_change_campaign=function(id)
{picker_date_start.input=$('form[campaign][start_at]');picker_date_start.visual=$('form[campaign][start_at]-0');picker_date_end.input=$('form[campaign][end_at]');picker_date_end.visual=$('form[campaign][end_at]-0');if(id==0)
{var now=new Date();var d={'year':now.getFullYear(),'month':now.getMonth(),'day':now.getDate(),'hours':now.getHours(),'minutes':now.getMinutes()};if($('form[campaign][id]'))$('form[campaign][id]').value=0;if($('form[campaign][name]'))$('form[campaign][name]').value='';picker_date_start.select(d);now.setDate(now.getDate()+7);var d={'year':now.getFullYear(),'month':now.getMonth(),'day':now.getDate(),'hours':now.getHours(),'minutes':now.getMinutes()};picker_date_end.select(d);if($('form[campaign][end_at]'))$('form[campaign][end_at]').value=now.getDate()+'.'+(now.getMonth()+1)+'.'+now.getFullYear()+' '+now.getHours()+':'+now.getMinutes();if($('form[campaign][unique_shows]'))$('form[campaign][unique_shows]').value=0;if($('form[campaign][all_shows]'))$('form[campaign][all_shows]').value=0;if($('form[campaign][day_shows]'))$('form[campaign][day_shows]').value=0;if($('form[campaign][all_clicks]'))$('form[campaign][all_clicks]').value=0;return false;}
new Request({url:'/promo/getcampaign',data:{id:id},method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(json.campaign)
{if(json.campaign.name&&$('form[campaign][name]'))
{$('form[campaign][name]').value=json.campaign.name;}
if($('form[campaign][id]'))$('form[campaign][id]').value=id;if($('form[campaign][start_at]'))
{$('form[campaign][start_at]').value=json.campaign.start_at;var d={'year':json.campaign.start_year,'month':json.campaign.start_month,'day':json.campaign.start_day,'hours':json.campaign.start_hour,'minutes':json.campaign.start_minute,'seconds':json.campaign.start_second};picker_date_start.select(d);}
if($('form[campaign][end_at]'))
{$('form[campaign][end_at]').value=json.campaign.end_at;var d={'year':json.campaign.end_year,'month':json.campaign.end_month,'day':json.campaign.end_day,'hours':json.campaign.end_hour,'minutes':json.campaign.end_minute,'seconds':json.campaign.end_second};picker_date_end.select(d);}
if($('form[campaign][unique_shows]'))$('form[campaign][unique_shows]').value=json.campaign.unique_shows;if($('form[campaign][all_shows]'))$('form[campaign][all_shows]').value=json.campaign.all_shows;if($('form[campaign][day_shows]'))$('form[campaign][day_shows]').value=json.campaign.day_shows;if($('form[campaign][all_clicks]'))$('form[campaign][all_clicks]').value=json.campaign.all_clicks;}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function promo_days_limit()
{if($('form[campaign][day_shows_auto]').checked==false)
{$('form[campaign][day_shows]').removeAttribute('readonly');return false;}
var start_date=$('form[campaign][start_at]')?$('form[campaign][start_at]').value:0;var end_date=$('form[campaign][end_at]')?$('form[campaign][end_at]').value:0;var all_shows=$('form[campaign][all_shows]')?$('form[campaign][all_shows]').value:0;var count_shows=$('form[campaign][count_shows]')?$('form[campaign][count_shows]').value:0;if(!all_shows||all_shows==0)
{alert('Укажите количество показов всем посетителям');$('form[campaign][day_shows_auto]').checked=false;return false;}
var matches=start_date.match(/.*(\d{2})\.(\d{2})\.(\d{4}).*(\d{2}):(\d{2}).*/);if(!matches||!matches[1])
{alert('Некорректная дата начала');$('form[campaign][day_shows_auto]').checked=false;return false;}
var now=new Date();var year=matches[3]?matches[3]:now.getYear();var month=matches[2]?matches[2]-1:now.getMonth();var day=matches[1]?matches[1]:now.getDate();var hour=matches[4]?matches[4]:now.getHours();var minute=matches[5]?matches[5]:now.getMinutes();var start=new Date(year,month,day,hour,minute);var matches=end_date.match(/.*(\d{2})\.(\d{2})\.(\d{4}).*(\d{2}):(\d{2}).*/);if(!matches||!matches[1])
{alert('Некорректная дата окончания');$('form[campaign][day_shows_auto]').checked=false;return false;}
var year=matches[3]?matches[3]:now.getYear();var month=matches[2]?matches[2]-1:now.getMonth();var day=matches[1]?matches[1]:now.getDate();var hour=matches[4]?matches[4]:now.getHours();var minute=matches[5]?matches[5]:now.getMinutes();var end=new Date(year,month,day,hour,minute);start=now.getTime()>start?now.getTime():start;if(start>end)
{alert('Дата начала должна быть меньше даты окончания');$('form[campaign][day_shows_auto]').checked=false;return false;}
var count_days=(end-start)/(1000*60*60*24);if($('form[campaign][day_shows]'))
{$('form[campaign][day_shows]').value=Math.ceil((all_shows-count_shows)/count_days);$('form[campaign][day_shows]').setAttribute('readonly','readonly');}}
function promo_visitor_limit()
{if($('form[campaign][percent_visitor_auto]').checked==false)
{$('form[campaign][percent_visitor]').removeAttribute('readonly');return false;}
$('form[campaign][percent_visitor]').value=30;$('form[campaign][percent_visitor]').setAttribute('readonly','readonly');}
function ulogin_data(token,social)
{social=social||'';new Request({url:'/user/contactadd',data:{token:token,social:social},method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);return false;}
if(json.network)
{if($('ulogin-'+json.network+'-profile')&&json.profile_url!=''&&json.profile_url!=null)
{$('ulogin-'+json.network+'-profile').innerHTML='<a target="_blank" href="'+json.profile_url+'">'+(json.short_url?json.short_url:json.profile_url)+'</a>';}
if($('ulogin-'+json.network+'-change'))
{$('ulogin-'+json.network+'-change').innerHTML='изменить';}
if($('ulogin-'+json.network+'-access')&&$('ulogin-'+json.network+'-access').innerHTML=='')
{var text='';if(json.access==0)text='показывается всем';else if(json.access==1)text='показывается только друзьям';else if(json.access==2)text='не показывается';$('ulogin-'+json.network+'-access').innerHTML=text;}
if($('ulogin-'+json.network+'-delete'))$('ulogin-'+json.network+'-delete').show('inline');}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function ulogin_confirmation(token)
{new Request({url:'/user/networkadd',data:{token:token},method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);return false;}
location.reload();},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function loginform(token,social)
{var action=$('form-login').style.display!='none'?'login':'register';var is_socnet=token==null||token==undefined||token==''?false:true;var form_send=!is_socnet?$('form-'+action):null;var redirect=$('popup-input-redirect-'+action)?$('popup-input-redirect-'+action).value:'';var onclick=$('popup-input-onclick-'+action)?$('popup-input-onclick-'+action).value:'';var current_url=window.location.href;social=social||'';var messages_send=$('reg[messages_send]')?($('reg[messages_send]').checked?1:0):1;var subs_send=$('reg[subs_send]')?($('reg[subs_send]').checked?1:0):1;if($('popup-input-url-'+action))$('popup-input-url-'+action).value=current_url;var old_email=$('popup-input-email-'+action)?$('popup-input-email-'+action).value:'';new Request({url:'/account/'+action,data:{token:token,redirect:redirect,onclick:onclick,current_url:current_url,social:social,messages_send:messages_send,subs_send:subs_send},method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);if(json.error_code==-8)location.reload();if(json.error_code==-2)bind_captcha();if(json.error_code==1)
{if($('popup-input-check_email_old-'+action))$('popup-input-check_email_old-'+action).value=old_email;if(json.email&&$('popup-input-check_email-'+action))$('popup-input-check_email-'+action).value=json.email;if($('popup-input-check_email_count-'+action))
{var count_mail=parseInt($('popup-input-check_email_count-'+action).value);$('popup-input-check_email_count-'+action).value=count_mail+1;}
if(json.email)
{var div=new Element('div',{'class':'share ub-menu','style':'top:-54px;padding: 5px 10px;'});div.innerHTML='Возможно, правильный email '+json.email+'. <a href="javascript:void(0);" onclick="$(\'popup-input-email-register\').value = \''+json.email+'\';">Исправить</a>';$('form-register-data').appendChild(div);}}
return false;}
if(typeof(ga)=='function'&&json.object&&json.object.action)
{if(json.object.action_object_alias)
{ga('send','event','user-'+json.object.event,json.object.action,json.object.action_object_alias+'-'+json.object.action_object_id,0);}
else
{ga('send','event','user-'+json.object.event,json.object.action);}}
if(typeof(callback_function)=='function')
{callback_function();}
else if(json.redirect)
{if(json.ab_action)
{ll_pagegoal_ab(json.ab_action,function(){window.location=decodeURI(json.redirect);});}
else if(json.object==''&&json.is_register)
{window.location='/rec/master';}
else
{window.location=decodeURI(json.redirect);}}
else
{if(json.ab_action)
{ll_pagegoal_ab(json.ab_action,function(){location.reload();});}
else if(json.object==''&&json.is_register)
{window.location='/rec/master';}
else
{location.reload();}}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send(form_send);}
function social_change_access(network)
{new Request({url:'/user/contactaccess',data:{network:network},method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(json.result&&$('ulogin-'+network+'-access'))
{$('ulogin-'+network+'-access').innerHTML=json.result;}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function social_delete(network)
{new Request({url:'/user/contactdelete',data:{network:network},method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if($('ulogin-'+network+'-access'))$('ulogin-'+network+'-access').innerHTML='';if($('ulogin-'+network+'-delete'))$('ulogin-'+network+'-delete').hide();if($('ulogin-'+network+'-profile'))$('ulogin-'+network+'-profile').innerHTML='не задан';if($('ulogin-'+network+'-change'))$('ulogin-'+network+'-change').innerHTML='задать';return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function human_ending(number,base,e0,e1,e2,prefix,postfix,zero,skip_number)
{if(number==0&&zero!=null&&zero!='undefined')
{return zero;}
var ending='';if(number%10==0)
{ending=e0;}
else if(number%100>10&&number%100<20)
{ending=e0;}
else if(number%10>=5)
{ending=e0;}
else if(number%10==1)
{ending=e1;}
else
{ending=e2;}
var result='';if(prefix!=null&&prefix!='undefined')result+=prefix;if(skip_number!=true)result+=number+' ';if(base!=null&&base!='undefined')result+=base;result+=ending;if(postfix!=null&&postfix!='undefined')result+=postfix;return result;}
function sysmsg_check(alias)
{if(!$('sysmsg-'+alias))return false;new Request({url:'/account/fill',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if($('sysmsg-'+json.message_id))
{$('sysmsg-'+json.message_id).dispose();sysmsg_update();}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send($('sysmsg-'+alias));}
function sysmsg_update()
{$$('.sysmsg-row').removeClass('last');var is_new_design=$('is-new-design')?$('is-new-design').value:0;var length=$$('.sysmsg-row').length;if(length>0)
{$$('.sysmsg-row')[length-1].addClass('last');if($('sysmsg-empty'))$('sysmsg-empty').dispose();if(is_new_design=='ll2015b')$('system-msgs-count').style.visibility='visible';$('system-msgs-count').show('inline-block');$('system-msgs-count').innerHTML='<span>'+length+'</span>';if(length==1&&$$('.sysmsg-row .sysmsg-title')&&$$('.sysmsg-row .sysmsg-title')[0])
{$('system-msgs').setAttribute('title',$$('.sysmsg-row .sysmsg-title')[0].innerHTML);}
else
{$('system-msgs').setAttribute('title',human_ending(length,'уведомлен','ий','ие','ия'));}
$('system-msgs').show('inline-block');}
else
{if(!$('sysmsg-empty'))
{var div=new Element('div',{id:'sysmsg-empty',style:'padding:15px;'});div.innerHTML='Для вас нет уведомлений';$('system-msgs-holder').adopt(div);}
$('system-msgs').setAttribute('title','Нет уведомлений');if($('system-msgs-count').hasClass('sysmessage-count'))
{$('system-msgs-count').style.visibility='hidden';$('system-msgs').hide();if($('system-msgs-triangle'))$('system-msgs-triangle').hide();if($('system-msgs-holder'))$('system-msgs-holder').hide();}
else $('system-msgs-count').hide();}}
function friend_load(list_type,start,per_page,date_modified)
{var date_m=date_modified!='undefined'&&date_modified!=null?date_modified:'0000-00-00 00:00:00';new Request({url:'/account/friendall',method:'post',data:{list_type:list_type,start:start,per_page:per_page,date_modified:date_m},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.message);return;}
if(json.content&&$('friends-'+list_type))
{$('friends-'+list_type).innerHTML+=json.content;if($('friends-'+list_type+'-button'))
{if(json.ended)$('friends-'+list_type+'-button').dispose();else $('friends-'+list_type+'-button').set('onclick','friend_load(\''+list_type+'\', '+(start+1)+', '+per_page+', \''+date_m+'\')');}}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function friend_status(user_id,action)
{new Request({url:'/account/friend'+action,method:'post',data:{user_id:user_id},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.message);return;}
if($('user-'+user_id+'-friend-add-bar')&&$('user-'+user_id+'-friend-add'))
{$('user-'+user_id+'-friend-add').dispose();var span_in_friends=new Element('span',{'id':'in-friends-'+user_id,'styles':{'display':'inline-block','margin':'11px 0','vertical-align':'middle','text-align':'center','color':'#1752b6'}});span_in_friends.innerHTML='В друзьях';span_in_friends.inject($('user-'+user_id+'-friend-add-bar'),'top');}
else if($$('.user-maybe-friend-'+user_id))
{$$('.user-maybe-friend-'+user_id).dispose();}
if($('a-add-friend-'+user_id)&&$('span-add-friend-'+user_id))
{$('a-add-friend-'+user_id).dispose();$('span-add-friend-'+user_id).innerHTML='в друзьях';$('span-add-friend-'+user_id).show('inline-block');}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function friend_find(login)
{if($('friends-find').value=='Идет поиск...')return false;$('friends-find').value='Идет поиск...';new Request({url:'/account/friendsocial',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);$('friends-find').value='Найти друзей сейчас';if(json.error)
{if(json.message)alert(json.message);return false;}
if(typeof(login)=='undefined'||login=='')
{location.href='/friends/maybe';}
else
{location.href='/reader/'+login+'/maybe';}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function ll_quote_add_to_collection(quote_id,value)
{var htmlname='in-collection-'+quote_id;var is_new_design=$('is-new-design')?$('is-new-design').value:0;new Request({url:'/quote/addtocollection',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json,null,'ll_quote_add_to_collection('+quote_id+','+value+')');if(json.error)
{alert(json.error);}
else if($(htmlname)&&json.content)
{$(htmlname).innerHTML=json.content;}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("quote_id="+quote_id+"&value="+value+"&is_new_design="+is_new_design);return false;}
function lead_send()
{new Request({method:'post',url:'/lead/add',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.error_code==-3)
{if($('lead[object_id]')&&$('lead-popup-'+$('lead[object_id]').value))$('lead-popup-'+$('lead[object_id]').value).destroy();if($('lead-button'))$('lead-button').dispose();}
if(json.message)alert(json.message);return false;}
if(json.url)
{location.href=json.url;if($('lead[object_id]')&&$('lead-popup-'+$('lead[object_id]').value))$('lead-popup-'+$('lead[object_id]').value).destroy();}}}).send($('leadbook'));}
function lead_get(object_id,is_open,provider)
{var provider_orig=provider;provider=provider&&provider!=null&&provider!='undefined'?'/'+provider:'';if($('id-login')&&$('id-login').value&&$('id-login').value!='')provider+='/reg';if(typeof(ga)=='function')
{ga('send','pageview','/virtual_url/leadgen/click'+provider);if(is_open===true)ga('send','pageview','/virtual_url/leadgen/auth'+provider);}
new Request({method:'post',data:{object_id:object_id,provider:provider_orig},url:'/lead/get',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(typeof(ga)=='function')ga('send','pageview','/virtual_url/leadgen/go'+provider);if(is_open===true&&json.url)
{window.open(json.url);}
else if(json.content&&$('lead-block-'+object_id))
{$('lead-block-'+object_id).innerHTML=json.content;}}}).send();}
function lead_form(object_id,is_open,provider)
{var provider_orig=provider;provider=provider&&provider!=null&&provider!='undefined'?'/'+provider:'';if($('id-login')&&$('id-login').value&&$('id-login').value!='')provider+='/reg';if(typeof(ga)=='function')
{ga('send','pageview','/virtual_url/leadgen/click'+provider);if(is_open)ga('send','pageview','/virtual_url/leadgen/auth'+provider);}
new Request({method:'post',data:{object_id:object_id,provider:provider_orig},url:'/lead/getform',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(typeof(ga)=='function')ga('send','pageview','/virtual_url/leadgen/go'+provider);if(json.content&&$('lead-block-'+object_id))
{$('lead-block-'+object_id).innerHTML=json.content;}}}).send();}
function bestbook_vote(category_no,book_id,year)
{new Request({method:'post',data:{category_no:category_no,book_id:book_id,year:year},url:'/vote/bestbook',onComplete:function(json)
{json=strToJson(json);prepare(json);var gender=$('user-gender')?$('user-gender').value:0;if(json.error_code||json.tologin)
{if(json.message)alert(json.message);$('nomination-'+category_no+'-'+book_id).addClass('btn-bb-vote').removeClass('btn-bb-unvote');$('nomination-'+category_no+'-'+book_id).title='Голосовать';$('nomination-'+category_no+'-'+book_id).innerHTML='Голосовать';$('nomination-'+category_no+'-'+book_id).setAttribute('onclick','bestbook_vote('+category_no+','+book_id+','+year+');');if($('book-'+category_no+'-'+book_id))$('book-'+category_no+'-'+book_id).removeClass('bb-check');return false;}
if($('nomination-'+category_no+'-'+book_id))
{$('nomination-'+category_no+'-'+book_id).removeClass('btn-bb-vote').addClass('btn-bb-unvote');$('nomination-'+category_no+'-'+book_id).title='Забрать голос';$('nomination-'+category_no+'-'+book_id).innerHTML='Передумал'+(gender==2?'а':'');$('nomination-'+category_no+'-'+book_id).setAttribute('onclick','bestbook_unvote('+category_no+','+book_id+','+year+');');if($('book-'+category_no+'-'+book_id))$('book-'+category_no+'-'+book_id).addClass('bb-check');}}}).send();}
function bestbook_unvote(category_no,book_id,year)
{new Request({method:'post',data:{category_no:category_no,book_id:book_id,year:year,is_unset:1},url:'/vote/bestbook',onComplete:function(json)
{json=strToJson(json);prepare(json);var gender=$('user-gender')?$('user-gender').value:0;if(json.error_code||json.tologin)
{if(json.message)alert(json.message);$('nomination-'+category_no+'-'+book_id).removeClass('btn-bb-vote').addClass('btn-bb-unvote');$('nomination-'+category_no+'-'+book_id).title='Забрать голос';$('nomination-'+category_no+'-'+book_id).innerHTML='Передумал'+(gender==2?'а':'');$('nomination-'+category_no+'-'+book_id).setAttribute('onclick','bestbook_unvote('+category_no+','+book_id+','+year+');');if($('book-'+category_no+'-'+book_id))$('book-'+category_no+'-'+book_id).addClass('bb-check');return false;}
if($('nomination-'+category_no+'-'+book_id))
{$('nomination-'+category_no+'-'+book_id).addClass('btn-bb-vote').removeClass('btn-bb-unvote');$('nomination-'+category_no+'-'+book_id).title='Голосовать';$('nomination-'+category_no+'-'+book_id).innerHTML='Голосовать';$('nomination-'+category_no+'-'+book_id).setAttribute('onclick','bestbook_vote('+category_no+','+book_id+','+year+');');if($('book-'+category_no+'-'+book_id))$('book-'+category_no+'-'+book_id).removeClass('bb-check');}}}).send();}
var hideonclick=function(elem,display,clear,callback,event_name,close)
{if(!callback)callback=function(){};if(!close||typeof(close)!='function')close=function(){};if(!event_name||event_name==''||event_name=='undefined')event_name='mousedown';if($(elem).addEventListener)
{$('body').addEventListener(event_name,function(){if(!$(elem))return false;if($(elem).removeEventListener)$(elem).removeEventListener('mousedown',function(){},false);callback();callback=function(){};close();if(clear!=false)$(elem).innerHTML='';if(display=='')$(elem).style.display='';else if(display!='undefined'&&display!=null)$(elem).style.display='none';else if($(elem))$(elem).destroy();},false);$(elem).addEventListener(event_name,function(e){eventstop(e);},false);}
else
{$('body').attachEvent('on'+event_name,function(){if(!$(elem))return false;$(elem).detachEvent('onmousedown',function(){});callback();callback=function(){};close();if(clear!=false)$(elem).innerHTML='';if(display=='')$(elem).style.display='';else if(display!='undefined'&&display!=null)$(elem).style.display='none';else if($(elem))$(elem).destroy();});$(elem).attachEvent('on'+event_name,function(e){eventstop(e);});}}
var toggle_elements=Array();function clicktoggle(elem,target,display,event_name,callback_open,callback_close)
{if(!$(elem))return false;if(!display||display==''||display=='undefined')display='block';var current_display=$(elem).style.display;$$('.active-toggle').hide();if(!callback_open||typeof(callback_open)!='function')callback_open=function(){};if(!callback_close||typeof(callback_close)!='function')callback_close=function(){};if(current_display=='none')
{$(elem).style.display=display;callback_open();}
else
{callback_close();}
if(toggle_elements[elem+'-'+target.id]!=null)return false;toggle_elements[elem+'-'+target.id]=1;if(!event_name||event_name==''||event_name=='undefined')event_name='mousedown';$(elem).addClass('active-toggle');if($(elem).addEventListener)
{if(target)
{target.addEventListener(event_name,function(e){eventstop(e);},false);}
$('body').addEventListener(event_name,function()
{if(!$(elem))return false;if($(elem).style.display!='none')$(elem).style.display='none';callback_close();},false);$(elem).addEventListener(event_name,function(e){eventstop(e);},false);}
else
{if(target)
{target.attachEvent('on'+event_name,function(e){eventstop(e);},false);}
$('body').attachEvent('on'+event_name,function(){if(!$(elem))return false;if($(elem).style.display!='none')$(elem).style.display='none';callback_close();});$(elem).attachEvent('on'+event_name,function(e){eventstop(e);});}}
function rec_master_add_genre(genre_id,genre_name,element_id,count_books)
{if(!count_books)count_books=24;var el=$(element_id);var all_genres=$$('.btn-gray-selected');var i,count=all_genres.length;if(el&&el.hasClass('btn-gray-selected'))
{rec_master_remove_genre(element_id);var index_genres=$$('.main-genre');for(i=0;i<index_genres.length;i++)
{genre_id=index_genres[i].id.substring(6);rec_master_add_genre(genre_id,'',index_genres[i].id,8);}
return false;}
new Request({url:'/genre/getbooks',method:'post',onComplete:function(json)
{json=strToJson(json);if(json.error)
{alert(json.error);}
else
{if(count_books==24)
{for(i=0;i<count;i++)
{if(all_genres[i].id!=element_id)
{rec_master_remove_genre(all_genres[i].id);}}
if(json.genre_id)el=$('genre-'+json.genre_id);el.addClass('btn-gray-selected');$('genres-books').innerHTML=json.content;document.cookie='llmgenre='+genre_name+'; path=/;';window.location.hash=genre_name;}
else
{$('genres-books').innerHTML+=json.content;document.cookie='llmgenre=; path=/;';window.location.hash='';}}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("genre_id="+genre_id+"&count="+count_books+"&name="+genre_name+"&is_new_design="+($('is-new-design')?1:0));}
function rec_master_remove_genre(element_id)
{var el=$(element_id);if(!el)return false;var genre_id=element_id.substring(6);$$('.btn-gray-selected').each(function(item){item.removeClass('btn-gray-selected');});if($('genre-books-'+genre_id))
{$$('.genre-books-block').each(function(item){if(item.id==='genre-books-'+genre_id)item.destroy();});}
return;}
function rec_master_add_books(genre_id,start,count,line)
{if(!line)line=-1;if(line<0&&$('show-more-'+genre_id))$('show-more-'+genre_id).destroy();new Request({url:'/genre/getbooks',method:'post',onComplete:function(json)
{json=strToJson(json);if(json.error)
{alert(json.error);}
else
{if(json.content==''&&$('show-more-'+genre_id))$('show-more-'+genre_id).destroy();if(count==4&&$('genre-'+genre_id+'-line-'+line))
{var div=document.createElement('div');div.innerHTML=json.content;var new_el=div.firstChild;new_el.inject($('genre-'+genre_id+'-line-'+line),'after');}
else if($('main-genre-'+genre_id))
{$('main-genre-'+genre_id).innerHTML+=json.content;}
else
{var div=document.createElement('div');div.innerHTML=json.content;var new_el=div.firstChild;var exit=false
$$('.genre-books-block').reverse().each(function(item){if(item.id=='genre-books-'+genre_id&&exit===false)
{new_el.inject($(item),'after');exit=true;}});}}},onRequest:initAd,onSuccesstos:closeAd,onFailure:failure}).send("genre_id="+genre_id+"&start="+start+"&count="+count+"&hide_title="+true+"&is_new_design="+($('is-new-design')?1:0));}
function rec_master_get_author_books(book_id,author_id,count_books,line)
{if(!line)line=-1;var genres=$$('.btn-gray-selected');if(genres.length>0)
{genres[0].removeClass('btn-gray-selected');}
var genres_books=$$('.genre-books-block');var i,count=genres_books.length;for(i=0;i<count;i++)
{if(author_id>0&&genres_books[i].id!='author-books-'+author_id)genres_books[i].destroy();}
var start=$$('.rec-book-0').length;if($('show-more-author'))$('show-more-author').destroy();if($('return-to-genre'))$('return-to-genre').destroy();if($('more-genres-block'))$('more-genres-block').destroy();if($('more-more-genres-block'))$('more-more-genres-block').destroy();if($('hide-genres'))
{$('hide-genres').destroy();var a=new Element('a',{'href':'javascript:void(0)','id':'more-genres','class':'semiref','title':'Еще жанры','onclick':'getgenres(20)','styles':{'display':'inline-block','color':'#777','margin-top':'5px'}});a.inject($('master-genres'),'after');a.innerHTML='Еще жанры';}
new Request({url:'/rec/getauthorbooks',method:'post',onComplete:function(json)
{json=strToJson(json);if(json.error)
{alert(json.error);}
else
{if(json.content==''&&$('show-more-'+author_id))$('show-more-'+author_id).destroy();if(count==4&&$('genre-0-line-'+line))
{var div=document.createElement('div');div.innerHTML=json.content;var new_el=div.firstChild;new_el.inject($('genre-0-line-'+line),'after');}
else
{if(start>0)$('genres-books').innerHTML+=json.content;else $('genres-books').innerHTML=json.content;}
if($('result-books'))$('result-books').style.display='none';window.location.hash='';}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("book_id="+book_id+"&author_id="+author_id+"&start="+start+"&count="+count_books+"&is_new_design="+($('is-new-design')?1:0));}
function rec_master_get_recs()
{if($('get-recs').hasClass('btn-disabled'))
{$('rec-msg').style.display='block';}
else
{location.href='/rec';}}
function rec_master_set_rating(edition_id,rating,genre_id,line,halfs)
{if(!halfs)halfs=false;var books_el=$('count-books');var count_books=(books_el==null?0:parseInt(books_el.innerHTML));if(isNaN(count_books))count_books=0;var date=new Date();new Request({url:'/user/savebook',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json,null,'rec_master_set_rating('+edition_id+', '+rating+', '+genre_id+', \''+line+'\')');if(json.error)
{alert(json.error);}
else
{var value=$('ub-rating-'+edition_id)&&$('ub-rating-'+edition_id).value!=rating?rating:($('ub-rating-other-'+edition_id)&&$('ub-rating-other-'+edition_id)!=rating?rating:0);ll_stars_new(edition_id,rating,halfs,'-l');if($('ub-rating-'+edition_id))
{$('ub-rating-'+edition_id).value=value;}
else if($('ub-rating-other-'+edition_id))
{$('ub-rating-other-'+edition_id).value=value;}
if(json.content)
{$('top-block').innerHTML=json.content;if(!($('top-block-header')))
{$('top-block').innerHTML='<h2 id="top-block-header" style="display:block;border:none;">Мастер рекомендаций</h2>'+'<p id="top-block-text">Чтобы получить рекомендации Лайвлиб, оцените 15 книг.</p>'+
json.content;}
if(json.books_left<1)$('getrecs').innerHTML='<input class="btn200" type="button" style="margin-left: 5px;" value="Получить рекомендации" onclick="location.href=\'/rec\';">';}
var start=$$('.rec-book-'+genre_id).length;if(genre_id>0)
{rec_master_add_books(genre_id,start,4,line);}
else
{rec_master_get_author_books(edition_id,0,4,line);}}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("edition_id="+edition_id+"&rating="+rating+"&status=1&quick=true&from_rec=true&is_new_design=redesign&calc=true");}
function rec_master_delete_book(edition_id)
{$('ub-rating-'+edition_id).value=0;ll_stars(edition_id,0,false);}
function getgenres(count)
{var exclude_ids='';$('master-genres').getChildren().each(function(item){if(item.tagName=='SPAN')
{if($(item).getChildren()[0].tagName=='A'&&$(item).getChildren()[0].hasClass('main-genre'))
{exclude_ids+=$(item).getChildren()[0].id.substring(6)+'|';}}});new Request({url:'/genre/getadditional',method:'post',onComplete:function(json)
{prepare(json);json=strToJson(json);if(json.error)
{alert(json.error);}
else
{$('master-genres').innerHTML+=json.content;if($('more-genres'))$('more-genres').destroy();if(count>20)
{if($('more-genres-block'))$('more-genres-block').destroy();if($('more-more-genres'))$('more-more-genres').destroy();}}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("count="+count+"&exclude_ids="+exclude_ids);}
function rec_findgenre()
{var genre_name=$('genre-name').value;if(genre_name=='')
{alert('Введите название жанра');return;}
new Request({url:'/genre/find',method:'post',onComplete:function(json)
{prepare(json);json=strToJson(json);if(json.error)
{alert(json.error);}
else
{rec_master_toggle_genre(json.genre_id,0,10,0,genre_name);}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("name="+genre_name);}
function rec_master_to_collection(login)
{if(login=='')
{loginform_show(null,'rec_master_to_collection()');}
else
{document.cookie='llmgenre='+window.location.hash.substring(1)+'; path=/;';location.href='/reader/'+login;}}
var master_start=32;var recmaster_loading=false;window.onscroll=function(e)
{var el=$('rec-master-top');if(el)
{scrollTop=(window.pageYOffset!==undefined)?window.pageYOffset:document.body.scrollTop;if(scrollTop>=($('is-new-design')?220:120))
{el.className='fixed';var old_html=$('top-block').innerHTML;if(!($('top-block-header')))$('top-block').innerHTML='<h2 id="top-block-header" style="display:block;border:none;padding:0px;font-weight:bold">Мастер рекомендаций</h2>'
+'<p id="top-block-text">Чтобы получить рекомендации Лайвлиб, оцените 15 книг.</p>'
+old_html;}
else
{el.className='';if($('top-block-header'))$('top-block-header').destroy();if($('top-block-text'))$('top-block-text').destroy();}}
el=$('send-message-form');if(el)
{var top_height=0;var top_width=0;if(!$('send-message-form').style.height)
{var size=$('send-message-form').getSize();top_height=size.y;}
else
{top_height=$('send-message-form').style.height.replace('px','');}
if(!$('send-message-form').style.width||$('send-message-form').style.width=='100%')
{var size=$('send-message-form').getSize();if(size.x>0)$('send-message-form').style.width=size.x+'px';top_width=size.x;}
else
{top_width=$('send-message-form').style.width.replace('px','');}
var autoanswer_height=0;if($('autoanswer-wrapper')&&!$('autoanswer-wrapper').style.height)
{var autoanswer_size=$('autoanswer-wrapper').getSize();autoanswer_height=autoanswer_size.y;}
else
{autoanswer_height=$('autoanswer-wrapper').style.height.replace('px','');}
scrollTop=(window.pageYOffset!==undefined)?window.pageYOffset:document.body.scrollTop;if(scrollTop>=parseInt(($('meganfox4')?250:0))+400+autoanswer_height)
{el.addClass('spec-fixed');el.style.width=top_width+'px';$('send-message-wrapper').style.height=top_height+'px';}
else
{$('send-message-wrapper').style.height='auto';el.removeClass('spec-fixed');el.style.width='100%';}}
el=$('special-top');if(el)
{var top_height=0;var top_width=0;if(!$('special-top-inner').style.height)
{var size=$('special-top-inner').getSize();if(size.y>0)$('special-top-inner').style.height=size.y+'px';top_height=size.y;}
else
{top_height=$('special-top-inner').style.height.replace('px','');}
if(!$('special-top-inner').style.width||$('special-top-inner').style.width=='100%')
{var size=$('special-top-inner').getSize();if(size.x>0)$('special-top-inner').style.width=size.x+'px';top_width=size.x;}
else
{top_width=$('special-top-inner').style.width.replace('px','');}
scrollTop=(window.pageYOffset!==undefined)?window.pageYOffset:document.body.scrollTop;if(scrollTop>=parseInt(($('top')?250:0))+138)
{el.addClass('spec-fixed');el.style.width=top_width+'px';}
else
{el.removeClass('spec-fixed');el.style.width='100%';}}
el=$('fixed-buy');if(el)
{var scrollTop=(window.pageYOffset!==undefined)?window.pageYOffset:document.body.scrollTop;var parent=el.parentNode;var body=document.body,html=document.documentElement;var height=Math.max(body.scrollHeight,body.offsetHeight,html.clientHeight,html.scrollHeight,html.offsetHeight);var scroll=$('body').getSize();var parent_pos=parent.getPosition();var footer_top=parent_pos?(height-parent_pos.y):(474+51+80);if(height-scrollTop<=footer_top+scroll.y)
{el.addClass('non-fixed');}
else
{el.removeClass('non-fixed');}}
el=$('fixed-menu');if(el)
{var scrollTop=((window.pageYOffset!==undefined)?window.pageYOffset:document.body.scrollTop)+$('pageh').offsetHeight;var height=$$('.header')[0].offsetTop;if(scrollTop>height)
{el.addClass('fixd');$('pageh').show();}
else if(scrollTop<height||scrollTop==$('pageh').offsetHeight)
{el.removeClass('fixd');$('pageh').hide();}}
el=$('fixed-menu');if(el)
{var scrollTop=((window.pageYOffset!==undefined)?window.pageYOffset:document.body.scrollTop)+$('pageh').offsetHeight;var height=$$('.header')[0].offsetTop;if(scrollTop>height&&scrollTop!=$('pageh').offsetHeight)
{el.addClass('fixd');$('pageh').show();}
else if(scrollTop<height||scrollTop==$('pageh').offsetHeight)
{el.removeClass('fixd');$('pageh').hide();}}
el=$('checked-form');if(el)
{var scrollTop=(window.pageYOffset!==undefined)?window.pageYOffset:document.body.scrollTop;var cliendHeight=(window.innerHeight!==undefined)?window.innerHeight:document.documentElement.clientHeight;var body=document.body,html=document.documentElement;var height=Math.max(body.scrollHeight,body.offsetHeight,html.clientHeight,html.scrollHeight,html.offsetHeight);var scroll=$('body').getSize();if(height-scrollTop<=588+51+85+scroll.y)
{el.addClass('non-fixed');}
else
{el.removeClass('non-fixed');}}
el=$('br-pager-fixed');if(el)
{var body=document.body,html=document.documentElement;var height=Math.max(body.scrollHeight,body.offsetHeight,html.clientHeight,html.scrollHeight,html.offsetHeight);var client=(window.innerHeight!==undefined)?window.innerHeight:document.documentElement.clientHeight;var scroll=(window.pageYOffset!==undefined)?window.pageYOffset:document.body.scrollTop;if(scroll+client>height-400)el.style.display='none';else el.style.display='block';}
el=$('recmaster-page');if(el)
{if(window.body.scrollTop>=(document.body.offsetHeight-window.innerHeight-400))
{if(recmaster_loading)return false;var type=$('recmaster-page').value;if(type!='novelties'&&type!='best')return false;recmaster_loading=true;$('recmaster-holder').innerHTML+='<span class="recloader" style="position:relative;" id="rm-loader"></span>';new Request({url:'/rec/masterbooks',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.content)
{if($('rm-loader'))$('rm-loader').destroy();$('recmaster-holder').innerHTML+=json.content;}
else if(json.error)
{alert(json.error);}
master_start+=16;if($('rm-loader'))$('rm-loader').destroy();recmaster_loading=false;},onFailure:function()
{if($('rm-loader'))$('rm-loader').destroy();recmaster_loading=false;}}).send('type='+type+'&start='+master_start);}}}
function rec_hidegenres()
{var current_genre=$$('.btn-gray-selected')[0];var main_genres=$$('.main-genre');var genre_found=false;if(current_genre)
{var genre_id=current_genre.id.substring(6);for(i=0;i<main_genres.length;i++)
{if(main_genres[i].id==current_genre.id)
{genre_found=true;break;}}
if(!genre_found)
{$$('.btn-gray-selected').each(function(item,key){item.removeClass('btn-gray-selected');});$('master-genres').innerHTML+='<span style="margin:5px 10px 5px 0px; display:inline-block"><a id="genre-'+
genre_id+'" href="javascript:void(0)" onclick="rec_master_add_genre(\''+genre_id+'\', \''+
current_genre.innerHTML+'\', \''+current_genre.id+'\');"'+'class="semiref main-genre btn-gray-selected">'+
current_genre.innerHTML+'</a></span>';}}
var a=new Element('a',{'href':'javascript:void(0)','id':'more-genres','class':'semiref','title':'Еще жанры','onclick':'getgenres(20)','styles':{'display':'inline-block','color':'#777','margin-top':'5px'}});a.inject($('master-genres'),'after');a.innerHTML='Еще жанры';if($('more-genres-block'))$('more-genres-block').destroy();if($('more-more-genres-block'))$('more-more-genres-block').destroy();if($('hide-genres'))$('hide-genres').destroy();}
function redirect_delay(element_id)
{if(!$(element_id))return false;var url='/';if($('redirect-url'))url=$('redirect-url').href;var redirect_after=parseInt($(element_id).innerHTML);if(redirect_after<2)location.href=url;redirect_after--;$(element_id).innerHTML=redirect_after;}
ll_pagegoal_ab=function(action,callback)
{new Request({url:'/service/abtest/'+action,method:'post',onComplete:typeof(callback)=='function'?callback:function(){}}).send();}
function ll_ga_track_ub(status,edition_id,type)
{var page='hasread';if(typeof(ga)=='function')
{if(status==0)page='wish';else if(status==2)page='reading';else if(status==-1)page='removebook';ga('send','pageview','/virtual_url/add'+type+'/'+edition_id+'/'+page);}}
function book_row_toogle(section)
{if(section==13&&$('ds-links-part')&&$('ds-links-full'))return book_row_toggle_links(section);if($('row-'+section))
{var is_open=$('row-container-'+section)&&$('row-container-'+section).hasClass('open')?false:true;if(is_open)
{if($('row-container-'+section))$('row-container-'+section).addClass('open');}
else
{if($('row-container-'+section))$('row-container-'+section).removeClass('open');}
$('row-'+section).toggle();return is_open;}
return false;}
function book_row_toggle_links(section)
{var is_open=$('ds-links-full').style.display=='block'?true:false;if(is_open)
{$('ds-links-full').hide();if($('row-container-'+section))$('row-container-'+section).removeClass('open');}
else
{$('ds-links-part').hide();$('ds-links-full').show();if($('row-container-'+section))$('row-container-'+section).addClass('open');}
return is_open;}
function context_ad_search(event,drive_id)
{if(event.keyCode>=9&&event.keyCode<=27)return false;if(event.keyCode>=33&&event.keyCode<=46)return false;if(event.keyCode>=91&&event.keyCode<=93)return false;if(event.keyCode>=112&&event.keyCode<=157)return false;var text=$('context-search').value.trim();if(text=='')return;if(!is_search_query_back)return false;is_search_query_back=false;new Request({url:'/context/search',method:'post',data:{text:text,drive_id:drive_id},onComplete:function(json)
{is_search_query_back=true;json=strToJson(json);if(json.content)
{$('ads-list').innerHTML=json.content;if(json.search!=text)context_ad_search({keyCode:158});}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function getshelves(start)
{new Request({url:'/selection/getshelves',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.content&&$('shelf-list'))
{if(start>2)
{if($('more-shelves'))$('more-shelves').destroy();$('shelf-list').innerHTML+=json.content;}
else
{$('shelf-list').innerHTML=json.content;}}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("start="+start);}
function ll_close_teaser(teaser_show_id)
{new Request({url:'/book/closeteaser',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);}
else if(json.status)
{$('teaser-'+teaser_show_id).destroy();}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("teaser_show_id="+teaser_show_id);}
function ll_ub_note(edition_id,type,go,strict_edition_id)
{var is_new_design=$('is-new-design')?$('is-new-design').value:0;var notes=($('ub-notes-'+edition_id))?$('ub-notes-'+edition_id).value:'';if(!strict_edition_id)strict_edition_id=0;new Request({url:'/user/note',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);}
else
{if(type=='delete'&&$('user-note-container-'+edition_id))
{$('user-note-container-'+edition_id).hide();if($('user-note-text-'+edition_id))$('user-note-text-'+edition_id).innerHTML='';}
else if(type=='edit'||type=='save')
{if(json.content&&$('user-note-container-'+edition_id))$('user-note-container-'+edition_id).innerHTML=json.content;if($('user-note-container-'+edition_id))$('user-note-container-'+edition_id).show();}
if(go&&type=='edit')
{location.hash='';location.hash='#user-note-container-'+edition_id;}}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("edition_id="+edition_id+"&notes="+encodeURIComponent(notes)+"&type="+encodeURIComponent(type)+"&is_new_design="+is_new_design+"&strict_edition_id="+strict_edition_id);}
function userbook_change(elem,edition_id,actual_id,userbook_id)
{var ub={edition_id:edition_id,actual_id:actual_id,userbook_id:userbook_id};if($$('#'+elem+' input','#'+elem+' select').length>0)
{$$('#'+elem+' .input','#'+elem+' select').addEvent('change',function(event){var edition_id=ub.edition_id;var actual_id=ub.actual_id;var userbook_id=ub.userbook_id;userbook_update(edition_id,actual_id,userbook_id);});}}
function userbook_update(edition_id,actual_id,userbook_id)
{if(userbook_id=='undefined')userbook_id=0;if(actual_id==0)actual_id=edition_id;var params="edition_id="+edition_id;var is_new_design=$('is-new-design')?$('is-new-design').value:0;params+="&is_new_design="+is_new_design;if($('ub-viewmode-'+edition_id))params+="&viewmode="+$('ub-viewmode-'+edition_id).value;if($('ub-edition-id-'+edition_id)&&$('ub-edition-id-'+edition_id).value!=edition_id)params+="&new_edition_id="+$('ub-edition-id-'+edition_id).value;if($('ub-work-edition-id-'+edition_id)&&$('ub-work-edition-id-'+edition_id).value)params+="&work-edition-id="+$('ub-work-edition-id-'+edition_id).value;if($('ub-from-content-'+edition_id))params+='&content_edition_id='+$('ub-from-content-'+edition_id).value;var status=$('ub-status-'+edition_id).value;var rating=$('ub-rating-'+edition_id)?$('ub-rating-'+edition_id).value:0;if(status!=1&&status!=3)rating=0;var own='';if($('ub-own-p-'+edition_id+'-value').value>0)own+='p';if($('ub-own-a-'+edition_id+'-value').value>0)own+='a';if($('ub-own-e-'+edition_id+'-value').value>0)own+='e';var day=$('date-'+edition_id+'-day').value;var month=$('date-'+edition_id+'-month').value;var year=$('date-'+edition_id+'-year').value;var priority=$('ub-priority-'+edition_id)?$('ub-priority-'+edition_id).value:0;var shelfs=$('ub-shelfs-'+edition_id).value;var selections=$('ub-selections-'+edition_id).value;if($('span-userbook-'+edition_id+'-'+userbook_id))
{if(status==1)
{$('span-userbook-'+edition_id+'-'+userbook_id).innerHTML=$('ub-status-read-'+edition_id)?$('ub-status-read-'+edition_id).innerHTML.replace(/(.+\<\/span\>)(.+)/g,"$2"):'Прочитал(а)';}
else if(status==3)
{$('span-userbook-'+edition_id+'-'+userbook_id).innerHTML=$('ub-status-unread-'+edition_id)?$('ub-status-unread-'+edition_id).innerHTML.replace(/(.+\<\/span\>)(.+)/g,"$2"):'Прочитал(а)';}
else if(status==2)
{$('span-userbook-'+edition_id+'-'+userbook_id).innerHTML='Читаю';}
else
{$('span-userbook-'+edition_id+'-'+userbook_id).innerHTML='Хочу прочитать';}
if(status==-2)$('span-userbook-'+edition_id+'-'+userbook_id).removeClass('active').addClass('inactive').addEvent('click',function(){ll_ub_quick_save(edition_id,actual_id,0,rating,0,0,0,0)});else $('span-userbook-'+edition_id+'-'+userbook_id).removeClass('inactive').addClass('active');}
params+="&rating="+rating+"&status="+status+"&own="+own+"&day="+day+"&month="+month+"&year="+year+"&priority="+priority+"&shelfs="+shelfs+"&selections="+selections+"&userbook_id="+userbook_id;if($('ub-read-again-'+edition_id)&&$('ub-read-again-'+edition_id).value==1)
{params+='&read_again=1';$('ub-read-again-'+edition_id).value=-1;}
if($('from-rec-page'))params+='&calc=true';if($('rec-status-'+edition_id))$('rec-status-'+edition_id).style.display='none';new Request({url:'/user/savebook',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);if($('a-ub-save-'+edition_id).hasClass('i-clock'))$('a-ub-save-'+edition_id).removeClass('i-clock');}
else
{var htmlname='-userbook-'+actual_id+'-'+userbook_id;if(json.new_book&&$('my-book-list-tr-'+json.ub_id))
{$('my-book-list-tr-'+json.ub_id).innerHTML=json.new_book;}
if(json.ub_rating&&$('xa-rating-'+edition_id+'-'+userbook_id))$('xa-rating-'+edition_id+'-'+userbook_id).innerHTML=json.ub_rating;if(($('from-rec-page')||$('from-rec-genres'))&&typeof(ga)=='function')
{var page='hasread';if(status==2)page='reading';else if(status==0)page='wish';ga('send','pageview','/virtual_url/rec/book/'+page);}
if($('from-alike-rec-page')&&typeof(ga)=='function')
{var page='hasread';if(status==2)page='reading';else if(status==0)page='wish';ga('send','pageview','/virtual_url/recalike/book/'+page);}
if(json.ab_action)ll_pagegoal_ab(json.ab_action);if(status>-1&&$('ab-test-ub-add'))
{ll_pagegoal_ab('userbookadd');}
if(rating>0&&$('ab-test-ub-rating'))
{ll_pagegoal_ab('userbookrating');}
if(json.read_again&&json.ub_id&&$('ub-read-again-'+edition_id))$('ub-read-again-'+edition_id).value=json.ub_id;count_recs_added++;if(count_recs_added==20)
{ll_get_new_recs();}}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send(params);if($('ga-track-ub')&&status)
{var type=$('ga-track-ub').value;ll_ga_track_ub(status,edition_id,type);}}
function userbook_tag_update(edition_id,actual_id,userbook_id)
{if(userbook_id=='undefined')userbook_id=0;if(actual_id==0)actual_id=edition_id;var params="edition_id="+actual_id;params+="&tagschanged=true";var tags=$('ub-tag-'+actual_id)?$('ub-tag-'+actual_id).value:$('ub-tags-other-'+actual_id).value;var is_new_design=$('is-new-design')?$('is-new-design').value:0;params+="&tags="+encodeURIComponent(tags)+"&is_new_design="+is_new_design;new Request({url:'/user/savebook',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);if($('a-ub-save-'+edition_id).hasClass('i-clock'))$('a-ub-save-'+edition_id).removeClass('i-clock');}
else
{var htmlname='-userbook-'+actual_id+'-'+userbook_id;if(json.new_book&&$('my-book-list-tr-'+json.ub_id))
{$('my-book-list-tr-'+json.ub_id).innerHTML=json.new_book;}
if(json.ub_rating&&$('xa-rating-'+edition_id+'-'+userbook_id))$('xa-rating-'+edition_id+'-'+userbook_id).innerHTML=json.ub_rating;if(json.ab_action)ll_pagegoal_ab(json.ab_action);if(tags&&$('ab-test-ub-tag'))
{ll_pagegoal_ab('userbooktag');}}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send(params);}
function ll_ub_set_shelf(edition_id,selection_id,actual_id,userbook_id,type)
{if(!type||type=='undefined')type='shelf';if($('ub-shelf-'+edition_id+'-'+selection_id))
{if($('ub-shelf-'+edition_id+'-'+selection_id).hasClass('active'))
{$('ub-shelf-'+edition_id+'-'+selection_id).removeClass('active');$('ub-'+type+'s-'+edition_id).value=$('ub-'+type+'s-'+edition_id).value.replace(','+selection_id,'');}
else
{$('ub-shelf-'+edition_id+'-'+selection_id).addClass('active');if($('ub-'+type+'s-'+edition_id).value.indexOf(','+selection_id+',')==-1)
{$('ub-'+type+'s-'+edition_id).value=$('ub-'+type+'s-'+edition_id).value+selection_id+',';}}
$('ub-shelf-'+edition_id+'-'+selection_id).onclick='';$('ub-shelf-'+edition_id+'-'+selection_id).removeEvents('click').addEvent('click',function(){ll_ub_set_shelf(edition_id,selection_id,actual_id,userbook_id,type)});userbook_update(edition_id,actual_id,userbook_id);}}
function ll_ub_shelf_add(edition_id,actual_id,userbook_id,type)
{if(!type||type=='undefined')type='shelf';var title=$('ub-input-'+type+'-'+edition_id).value;if(title=='')
{alert('Введите название полки');return false;}
var own='';if($('ub-own-p-'+edition_id+'-value').value>0)own+='p';if($('ub-own-a-'+edition_id+'-value').value>0)own+='a';if($('ub-own-e-'+edition_id+'-value').value>0)own+='e';new Request({url:'/selection/addusershelf',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);return false;}
if(json.selection_id)
{var a=new Element('a',{'href':'javascript:void(0)','id':'ub-shelf-'+edition_id+'-'+json.selection_id,'class':'menu-item','title':json.title,'onclick':'ll_ub_set_shelf('+edition_id+', '+json.selection_id+','+actual_id+', '+userbook_id+')'});a.innerHTML='<span class="ub-check"></span>'+json.title;if($('ub-div-'+type+'-'+edition_id))
{$('ub-div-'+type+'-'+edition_id).appendChild(a);$('ub-div-'+type+'-'+edition_id).scrollTop=$('ub-div-'+type+'-'+edition_id).scrollHeight;$('ub-input-'+type+'-'+edition_id).value='';$('ub-'+type+'-'+edition_id).hide();$('ub-a-'+type+'-'+edition_id).show();ll_ub_set_shelf(edition_id,json.selection_id,actual_id,userbook_id,type);}}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send('edition_id='+edition_id+'&title='+encodeURIComponent(title)+'&book_type='+own+'&type='+type);}
function ll_shelf_add_tag()
{if(!$('tag-select')||$('tag-select').value<=0)
{alert('Выберите тег');return false;}
if($('shelf-old').checked&&$('selection-id')&&$('selection-id').value>0)
{ll_selection_add_tag();return false;}
var title=$('shelf-title').value;if(title=='')
{alert('Введите название полки');return false;}
new Request({url:'/selection/addusershelf',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);return false;}
if(json.selection_id)
{$('selection-id').options[$('selection-id').options.length]=new Option(title,json.selection_id);$('selection-id').value=json.selection_id;ll_selection_add_tag();}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send('title='+encodeURIComponent(title));}
function ll_selection_import_shelf()
{if(!$('selection-select')||$('selection-select').value<=0)
{alert('Подборка не найдена');return false;}
var selection_id=$('selection-select').value;new Request({url:'/selection/importtoshelf',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);return false;}
if(json.selection_id)
{$('selection-select').remove($('selection-select').selectedIndex);$('selection-id').options[$('selection-id').options.length]=new Option(json.title,json.selection_id);}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send('selection_id='+selection_id);}
function source_buy(source_id)
{}
if($('my-selection-book-list-form')&&$$('.my-shelf-book-list-checkbox')&&$$('.my-shelf-book-list-checkbox').length>0)
{$$('.my-shelf-book-list-checkbox').addEvent('change',function(){var count=0;$$('.my-shelf-book-list-checkbox').each(function(item){if(item.checked)count++;});if(count>0)
{$('my-selection-book-list-form').show();if($('shelf-count'))$('shelf-count').innerHTML=count;}
else
{$('my-selection-book-list-form').hide();}});}
function kv_note(challenge_id,type)
{var is_new_design=$('is-new-design')?$('is-new-design').value:0;var notes=($('kv-comments-'+challenge_id))?$('kv-comments-'+challenge_id).value:'';new Request({url:'/challenge/commentsave',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);}
else
{if(type=='delete'&&$('kv-comment-container-'+challenge_id))
{$('kv-comment-container-'+challenge_id).hide();if($('kv-comment-text-'+challenge_id))$('kv-comment-text-'+challenge_id).innerHTML='';}
else if(type=='edit'||type=='save')
{if(json.content&&$('kv-comment-container-'+challenge_id))$('kv-comment-container-'+challenge_id).innerHTML=json.content;if($('kv-comment-container-'+challenge_id))$('kv-comment-container-'+challenge_id).show();}}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("challenge_id="+challenge_id+"&notes="+encodeURIComponent(notes)+"&type="+encodeURIComponent(type)+"&is_new_design="+is_new_design);}
function ll_note_edit(edition_id,userbook_id,type)
{if(type=='edit')
{$('xa-menu-colums-'+edition_id+'-'+userbook_id).hide();$('xa-menu-tags-'+edition_id+'-'+userbook_id).hide();$('xa-edit-notes-link-'+edition_id+'-'+userbook_id).hide();$('xa-notes-'+edition_id+'-'+userbook_id).hide();$('xa-edit-notes-'+edition_id+'-'+userbook_id).show();$('xa-arrow-'+edition_id+'-'+userbook_id).addClass('for-notes');}
else if(type=='cancel'||type=='delete'||type=='save')
{$('xa-menu-colums-'+edition_id+'-'+userbook_id).show();if($('ub-status-'+edition_id)&&$('ub-status-'+edition_id).value>-2)$('xa-menu-tags-'+edition_id+'-'+userbook_id).show();$('xa-edit-notes-'+edition_id+'-'+userbook_id).hide();$('xa-arrow-'+edition_id+'-'+userbook_id).removeClass('for-notes');}
if(type=='cancel')
{if($('ub-notes-old-'+edition_id)&&$('ub-notes-'+edition_id))$('ub-notes-'+edition_id).value=$('ub-notes-old-'+edition_id).value;}
else if(type=='delete')
{if($('ub-notes-old-'+edition_id)&&$('ub-notes-'+edition_id))
{$('ub-notes-'+edition_id).value='';$('ub-notes-old-'+edition_id).value='';}}
else if(type=='save')
{if($('ub-notes-old-'+edition_id)&&$('ub-notes-'+edition_id))$('ub-notes-old-'+edition_id).value=$('ub-notes-'+edition_id).value;}
if($('ub-notes-'+edition_id)&&$('ub-notes-'+edition_id).value=='')
{$('xa-edit-notes-link-'+edition_id+'-'+userbook_id).innerHTML='<span class="i-edit-note"></span>'+'Добавить комментарий';if(type=='cancel'||type=='delete'||type=='save')
{$('xa-notes-'+edition_id+'-'+userbook_id).hide();$('xa-edit-notes-link-'+edition_id+'-'+userbook_id).show();}}
else
{$('xa-edit-notes-link-'+edition_id+'-'+userbook_id).innerHTML='<span class="i-edit-note"></span>'+'Редактировать комментарий';if(type=='cancel'||type=='delete'||type=='save')
{$('ub-note-'+edition_id).innerHTML=$('ub-notes-'+edition_id).value.replace(/\n/g,'<br>');$('xa-notes-'+edition_id+'-'+userbook_id).show();}}
return;}
function ll_tag_edit(edition_id,userbook_id,type)
{if(type=='edit')
{$('xa-menu-colums-'+edition_id+'-'+userbook_id).hide();$('xa-menu-notes-'+edition_id+'-'+userbook_id).hide();$('xa-edit-tags-link-'+edition_id+'-'+userbook_id).hide();$('xa-edit-tags-'+edition_id+'-'+userbook_id).show();$('xa-arrow-'+edition_id+'-'+userbook_id).addClass('for-tags');}
else if(type=='cancel'||type=='delete'||type=='save')
{$('xa-menu-colums-'+edition_id+'-'+userbook_id).show();$('xa-menu-notes-'+edition_id+'-'+userbook_id).show();$('xa-edit-tags-'+edition_id+'-'+userbook_id).hide();$('xa-arrow-'+edition_id+'-'+userbook_id).removeClass('for-tags');}
if(type=='cancel')
{if($('ub-tag-old-'+edition_id)&&$('ub-tag-'+edition_id))$('ub-tag-'+edition_id).value=$('ub-tag-old-'+edition_id).value;}
else if(type=='delete')
{if($('ub-tag-old-'+edition_id)&&$('ub-tag-'+edition_id))
{$('ub-tag-'+edition_id).value='';$('ub-tag-old-'+edition_id).value='';}}
else if(type=='save')
{if($('ub-tag-old-'+edition_id)&&$('ub-tag-'+edition_id))$('ub-tag-old-'+edition_id).value=$('ub-tag-'+edition_id).value;}
if(type=='cancel'||type=='delete'||type=='save')
{if($('ub-tag-'+edition_id).value=='')
{$('ub-note-'+edition_id).innerHTML=$('ub-notes-'+edition_id).value.replace(/\n/g,'<br>');$('xa-edit-tags-link-'+edition_id+'-'+userbook_id).show();}}
if($('ub-tags-'+edition_id)&&$('ub-tag-'+edition_id))$('ub-tags-'+edition_id).value=$('ub-tag-'+edition_id).value;if($('ub-tags-other-'+edition_id)&&$('ub-tag-'+edition_id))$('ub-tags-other-'+edition_id).value=$('ub-tag-'+edition_id).value;if($('ub-tag-'+edition_id)&&$('ub-tag-'+edition_id).value=='')
{$('xa-edit-tags-link-'+edition_id+'-'+userbook_id).innerHTML='<span class="i-edit-note"></span>'+'Добавить тег';if(type=='cancel'||type=='delete'||type=='save')
{$('xa-edit-tags-link-'+edition_id+'-'+userbook_id).show();$('xa-tags-'+edition_id+'-'+userbook_id).hide();}}
else if(type=='cancel'||type=='delete'||type=='save')
{$('ub-tag-full-'+edition_id).innerHTML=$('ub-tag-'+edition_id).value;$('xa-edit-tags-link-'+edition_id+'-'+userbook_id).hide();$('xa-tags-'+edition_id+'-'+userbook_id).show();}
return;}
function ll_tag_edit_new(edition_id,userbook_id,type)
{if(type=='edit')
{$('ub-tag-'+edition_id).value=$('ub-tag-old-'+edition_id).value;$('ub-data-'+edition_id).hide();$('xa-edit-tags-'+edition_id+'-'+userbook_id).show();}
else if(type=='save'||type=='cancel'||type=='delete')
{if(type=='delete')
{$('ss-my-tags-'+edition_id+'-'+userbook_id).hide();$('my-tags-block-'+edition_id+'-'+userbook_id).hide();$('ss-add-tags-'+edition_id+'-'+userbook_id).show();$('add-tags-block-'+edition_id+'-'+userbook_id).show();$('my-tags-'+edition_id+'-'+userbook_id).innerHTML='';$('ub-tag-old-'+edition_id).value='';$('ub-tag-'+edition_id).value='';}
else if(type=='save')
{if(/\S/.test($('ub-tag-'+edition_id).value))
{$('ss-my-tags-'+edition_id+'-'+userbook_id).show();$('my-tags-block-'+edition_id+'-'+userbook_id).show();$('ss-add-tags-'+edition_id+'-'+userbook_id).hide();$('add-tags-block-'+edition_id+'-'+userbook_id).hide();$('my-tags-'+edition_id+'-'+userbook_id).innerHTML=$('ub-tag-'+edition_id).value;}
else
{$('ss-my-tags-'+edition_id+'-'+userbook_id).hide();$('my-tags-block-'+edition_id+'-'+userbook_id).hide();$('ss-add-tags-'+edition_id+'-'+userbook_id).show();$('add-tags-block-'+edition_id+'-'+userbook_id).show();$('my-tags-'+edition_id+'-'+userbook_id).innerHTML='';$('ub-tag-'+edition_id).value='';$('ub-tag-old-'+edition_id).value='';}}
else
{if(!/\S/.test($('ub-tag-old-'+edition_id).value))
{$('ub-tag-'+edition_id+'-clear-link').hide();}
else
{$('ub-tag-'+edition_id+'-clear-link').show();}}
$('ub-data-'+edition_id).show();$('xa-edit-tags-'+edition_id+'-'+userbook_id).hide();}}
function ll_note_edit_new(edition_id,userbook_id,type)
{if(type=='edit')
{$('ub-notes-'+edition_id).value=$('ub-notes-old-'+edition_id).value;$('ub-data-'+edition_id).hide();if($('ub-right-block-'+edition_id))$('ub-right-block-'+edition_id).style.backgroundColor='#fff8b1';$('xa-edit-notes-'+edition_id+'-'+userbook_id).show();if($('xa-arrow-'+edition_id+'-'+userbook_id))$('xa-arrow-'+edition_id+'-'+userbook_id).addClass('yellow');}
else if(type=='save'||type=='cancel'||type=='delete')
{if(type=='delete')
{$('my-notes-block-'+edition_id+'-'+userbook_id).hide();$('add-notes-block-'+edition_id+'-'+userbook_id).show();$('ub-note-'+edition_id).innerHTML='';$('ub-notes-old-'+edition_id).value='';}
else if(type=='save')
{if(/\S/.test($('ub-notes-'+edition_id).value))
{$('my-notes-block-'+edition_id+'-'+userbook_id).show();$('add-notes-block-'+edition_id+'-'+userbook_id).hide();$('ub-note-'+edition_id).innerHTML=$('ub-notes-'+edition_id).value.replace(/\n/g,'<br>');$('ub-notes-old-'+edition_id).value=$('ub-notes-'+edition_id).value;}
else
{$('my-notes-block-'+edition_id+'-'+userbook_id).hide();$('add-notes-block-'+edition_id+'-'+userbook_id).show();$('ub-note-'+edition_id).innerHTML='';$('ub-notes-old-'+edition_id).value='';}}
else
{if(!/\S/.test($('ub-notes-'+edition_id).value))
{$('ub-notes-'+edition_id+'-clear-link').hide();}}
if($('ub-right-block-'+edition_id))$('ub-right-block-'+edition_id).style.backgroundColor='';$('ub-data-'+edition_id).show();if($('xa-edit-notes-'+edition_id+'-'+userbook_id))$('xa-edit-notes-'+edition_id+'-'+userbook_id).hide();if($('xa-arrow-'+edition_id+'-'+userbook_id))$('xa-arrow-'+edition_id+'-'+userbook_id).removeClass('yellow');}}
function ll_ub_note_new(edition_id,type,go,strict_edition_id)
{var is_new_design=$('is-new-design')?$('is-new-design').value:0;var notes=($('ub-notes-'+edition_id))?$('ub-notes-'+edition_id).value:'';if(!strict_edition_id)strict_edition_id=0;new Request({url:'/user/note',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);}
else
{if(type=='delete'&&$('user-note-container-'+edition_id))
{$('user-note-container-'+edition_id).hide();if($('user-note-text-'+edition_id))$('user-note-text-'+edition_id).innerHTML='';}
else if(type=='edit'||type=='save')
{if(notes!='')
{if(json.content&&$('user-note-container-'+edition_id))$('user-note-container-'+edition_id).innerHTML=json.content;if($('user-note-container-'+edition_id))$('user-note-container-'+edition_id).show();}
else
{if(json.content&&$('user-note-container-'+edition_id))$('user-note-container-'+edition_id).innerHTML='';if($('user-note-container-'+edition_id))$('user-note-container-'+edition_id).hide();}}}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("edition_id="+edition_id+"&notes="+encodeURIComponent(notes)+"&type="+encodeURIComponent(type)+"&is_new_design="+is_new_design+"&strict_edition_id="+strict_edition_id);}
function userbook_tag_update_new(edition_id,actual_id,userbook_id)
{if(userbook_id=='undefined')userbook_id=0;if(actual_id==0)actual_id=edition_id;var params="edition_id="+actual_id;params+="&tagschanged=true";var tags=$('ub-tag-'+actual_id).value;$('ub-tag-old-'+actual_id).value=tags;var is_new_design=$('is-new-design')?$('is-new-design').value:0;params+="&tags="+encodeURIComponent(tags)+"&is_new_design="+is_new_design;new Request({url:'/user/savebook',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);if($('a-ub-save-'+edition_id).hasClass('i-clock'))$('a-ub-save-'+edition_id).removeClass('i-clock');return false;}
else
{if(tags&&$('ab-test-ub-tag'))
{ll_pagegoal_ab('userbooktag');}
return true;}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send(params);}
function ll_ub_add_tag(edition_id,userbook_id,tag)
{var added_tags=', '+$('ub-tag-old-'+edition_id).value+',';if(added_tags.indexOf(', '+tag.toLowerCase()+',')<0&&added_tags.indexOf(', '+tag+',')<0)
{if(!($('my-tags-block-'+edition_id+'-'+userbook_id)).isVisible())
{$('ss-my-tags-'+edition_id+'-'+userbook_id).show();$('my-tags-block-'+edition_id+'-'+userbook_id).show();$('ss-add-tags-'+edition_id+'-'+userbook_id).hide();$('add-tags-block-'+edition_id+'-'+userbook_id).hide();$('my-tags-'+edition_id+'-'+userbook_id).innerHTML+=tag;}
else
{$('my-tags-'+edition_id+'-'+userbook_id).innerHTML+=', '+tag;}
if($('ub-tag-old-'+edition_id).value!=='')
{$('ub-tag-old-'+edition_id).value+=', '+tag;}
else
{$('ub-tag-old-'+edition_id).value+=tag;}
$('ub-tag-'+edition_id).value=$('ub-tag-old-'+edition_id).value;}}
function ll_all_editions(edition_id)
{var is_new_design=$('is-new-design')?$('is-new-design').value:0;new Request({url:'/book/alleditions',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);}
else if(json.html&&$('book-'+edition_id+'-alleditions'))
{$('book-'+edition_id+'-alleditions').innerHTML=json.html;var gallery=new slideGallery($('edition-carousel-'+edition_id),{current:json.position,steps:3,mode:"line",random:false,stop:".stop",start:".start",duration:7000,speed:400,margin:0,paging:false,marginLeft:-100,marginRight:200,nextItem:'.next-carousel',prevItem:'.prev-carousel'});}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("edition_id="+edition_id+"&is_new_design="+is_new_design);}
function ll_set_top_edition(edition_id)
{var is_new_design=$('is-new-design')?$('is-new-design').value:0;if($('top-edition-'+edition_id)&&$('top-edition-'+edition_id).hasClass('active'))return;new Request({url:'/book/settopedition',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);}
else if(json.error_code==0)
{var type=json.is_work?'works':'editions';var elements=$$('.top-'+type);for(var i=0;i<elements.length;i++)
{if(elements[i].hasClass('active'))
{var old_edition_id=elements[i].id.substring(12);elements[i].removeClass('active');elements[i].setAttribute('title','Сделать заглавным '+(json.is_work?'произведением':'изданием'));elements[i].setAttribute('onclick','ll_set_top_edition('+old_edition_id+');');elements[i].innerHTML='Сделать главным';}}
$('top-edition-'+edition_id).addClass('active');$('top-edition-'+edition_id).innerHTML='<span class="i-point-on"></span>Главное '+(json.is_work?'произведение':'издание');$('top-edition-'+edition_id).setAttribute('title','Главное '+(json.is_work?'произведение':'издание'));$('top-edition-'+edition_id).setAttribute('onclick','');}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("edition_id="+edition_id+"&is_new_design="+is_new_design);}
window.addEvent("domready",function(){if($('user-mainmenu'))
{var SortableMenu=new Sortables('user-mainmenu',{constrain:true,clone:true,snap:10,handle:'.handle-drag-content',revert:{duration:50}});}
if($('select-logins'))together_fill_login();});function together_fill_login()
{if(!$('select-logins'))return false;if($('together[login]'))
{var login=$('together[login]').value;var current_login=$('current-login')?$('current-login').value:'';if(login==''||login==current_login)
{$('select-logins').innerHTML='<option value="0">Сначала введите логин</option>';}
else
{$('select-logins').innerHTML='<option value="'+current_login+'">'+current_login+'</option><option value="'+login+'">'+login+'</option>';}
return false;}
if($$('.accounts-checkbox')&&$$('.accounts-checkbox').length>0)
{var content='';var count=0;var current_value=$('select-logins').value;$$('.accounts-checkbox').each(function(item){if(item.checked)
{count++;var login=item.id.substring(9);content+='<option value="'+login+'"'+(current_value==login?' selected':'')+'>'+login+'</option>';}});if(content==''||count==1)content='<option value="0">Сначала выберите аккаунты</option>';$('select-logins').innerHTML=content;return false;}}
function checkbox_toggle(elem,class_name)
{var checked=elem.checked?false:true;var elements=$$('.'+class_name);if(elements&&elements.length<=0)return false;for(var i=0;i<elements.length;i++)
{elements[i].disabled=checked?true:false;}}
function nodeScriptReplace(node)
{if(nodeScriptIs(node)===true){node.parentNode.replaceChild(nodeScriptClone(node),node);}
else{var elements=node.getElements('script');if(elements.length<=0)return node;for(var i=0;i<elements.length;i++)
{elements[i].parentNode.replaceChild(nodeScriptClone(elements[i]),elements[i]);}}
return node;}
function nodeScriptIs(node)
{return node.tagName==='SCRIPT';}
function nodeScriptClone(node)
{var script=document.createElement("script");script.text=node.innerHTML;if(node.attributes.length<=0)return script;for(var i=node.attributes.length-1;i>=0;i--){script.setAttribute(node.attributes[i].name,node.attributes[i].value);}
return script;}
function show_warn_period()
{$('warn-type').value==5?xshow('warn-period'):xhide('warn-period');}
function show_warn_ip()
{$('warn-type').value==5?xshow('warn-ip'):xhide('warn-ip');}
function clone_path(node,doc)
{var path=doc.createElement('path');if(node.attributes.length<=0)return path;for(var i=node.attributes.length-1;i>=0;i--){path.setAttribute(node.attributes[i].name,node.attributes[i].value);}
return path;}
var count_steps=0;function game_addstep()
{if(count_steps==0)count_steps=$$('.game-steps-edit').length-2;count_steps++;$('game-step-new').innerHTML=$('game-step-new').innerHTML+$('sample-step').innerHTML.replace(/key/g,count_steps);}
function game_deletestep(step_no)
{if(count_steps==0)count_steps=$$('.game-steps-edit').length-2;$$('.game-step-edit-'+step_no).hide();if($('step-delete-input-'+step_no))$('step-delete-input-'+step_no).value=1;if($('step-delete-'+step_no))$('step-delete-'+step_no).hide();if($('step-return-'+step_no))$('step-return-'+step_no).show();}
function game_returnstep(step_no)
{if(count_steps==0)count_steps=$$('.game-steps-edit').length-2;$$('.game-step-edit-'+step_no).show('table-row');if($('step-delete-input-'+step_no))$('step-delete-input-'+step_no).value=0;if($('step-return-'+step_no))$('step-return-'+step_no).hide();if($('step-delete-'+step_no))$('step-delete-'+step_no).show();}
function game_winner(gameobject_id,type,gamewinner_id)
{if(type=='delete'&&!confirm('Вы действительно хотите удалить работу из финалистов?'))
{return false;}
var html=gameobject_id;var html_winner=gameobject_id+(gamewinner_id?'-'+gamewinner_id:'');gamewinner_id=gamewinner_id?gamewinner_id:0;var data={type:type,gameobject_id:gameobject_id,gamewinner_id:gamewinner_id};if(type=='save')
{data.no=$('gamewinner-no-'+html)?$('gamewinner-no-'+html).value:0;data.game_prize_id=$('gamewinner-prize-'+html)?$('gamewinner-prize-'+html).value:0;}
else
{$('gamewinner-'+html).innerHTML='';}
new Request({url:'/game/winner',method:'post',data:data,onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if($('gamewinner-'+html))$('gamewinner-'+html).innerHTML=json.content?json.content:'';if(type=='delete')
{if($('gamewinner-edit-'+html_winner))$('gamewinner-edit-'+html_winner).hide();if($('gamewinner-delete-'+html_winner))$('gamewinner-delete-'+html_winner).hide();if($('winner-no-'+html))
{$('winner-no-'+html).innerHTML=json.no_all;}}
else if(type=='save')
{if($('gamewinner-delete-'+html_winner))
{$('gamewinner-delete-'+html_winner).show();$('gamewinner-delete-'+html_winner).innerHTML='<span class="i-delete"></span>Убрать '+json.no+' место';}
else if($('gamewinner-add-'+html))
{var el=new Element('li');el.innerHTML='<a href="javascript:void(0);" id="gamewinner-delete-'+html+'-'+json.gamewinner_id+'" onclick="$(\'gameobject-more-'+html+'\').hide();game_winner('+gameobject_id+', \'delete\', '+json.gamewinner_id+');" title="Убрать из финалистов"><span class="i-delete"></span>Убрать '+json.no+' место</a>';el.inject($('gamewinner-add-'+html),'after');}
if($('gamewinner-edit-'+html_winner))
{$('gamewinner-edit-'+html_winner).show();$('gamewinner-edit-'+html_winner).innerHTML='<span class="i-edit-black"></span>Редактировать '+json.no+' место';}
else
{var el=new Element('li');el.innerHTML='<a href="javascript:void(0);" id="gamewinner-edit-'+html+'-'+json.gamewinner_id+'" onclick="$(\'gameobject-more-'+html+'\').hide();game_winner('+gameobject_id+', \'edit\', '+json.gamewinner_id+');" title="Редактировать финалиста"><span class="i-edit-black"></span>Редактировать '+json.no+' место</a>';el.inject($('gamewinner-add-'+html),'after');}
if($('winner-no-'+html))
{$('winner-no-'+html).innerHTML=json.no_all;}}
else
{hideonclick('gamewinner-'+html,false,true);}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function game_tour_archive(game_id)
{var is_new_design=$('is-new-design')?$('is-new-design').value:'';new Request({url:'/game/tourarchive',method:'post',data:{game_id:game_id,is_new_design:is_new_design},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(json.content)
{$('tour-archive').innerHTML=json.content;}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function gameobject_status(gameobject_id,type)
{var is_new_design=$('is-new-design')?$('is-new-design').value:'';var token=$('gameobject-status-'+gameobject_id+'-'+type)?$('gameobject-status-'+gameobject_id+'-'+type).getAttribute('t'):'';new Request({url:'/game/objectstatus',method:'post',data:{gameobject_id:gameobject_id,type:type,token:token,is_new_design:is_new_design},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
var blocks=['open','close','post','entry'];var shows=type=='open'||type=='entry'?['close','post']:(type=='close'?['open','post']:['entry']);for(var i=0;i<blocks.length;i++)
{if(!$('gameobject-status-'+gameobject_id+'-'+blocks[i]))continue;if(shows.indexOf(blocks[i])>-1)
{$('gameobject-status-'+gameobject_id+'-'+blocks[i]).show();}
else
{$('gameobject-status-'+gameobject_id+'-'+blocks[i]).hide();}}
if($('gameobject-close-'+gameobject_id))
{if(type=='close')$('gameobject-close-'+gameobject_id).show();else $('gameobject-close-'+gameobject_id).hide();}
if($('gameobject-'+gameobject_id))
{if(type=='post')$('gameobject-'+gameobject_id).addClass('game-object-post');else $('gameobject-'+gameobject_id).removeClass('game-object-post');}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function game_contests_archive()
{var is_new_design=$('is-new-design')?$('is-new-design').value:'';new Request({url:'/game/contestsarchive',method:'post',data:{is_new_design:is_new_design},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(json.content)
{$('contest-archive').innerHTML=json.content;}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function game_contest(object_alias,object_id,step_id,type,gameobject_id)
{var is_new_design=$('is-new-design')?$('is-new-design').value:'';gameobject_id=gameobject_id?gameobject_id:0;new Request({url:'/game/addentry',method:'post',data:{is_new_design:is_new_design,object_alias:object_alias,object_id:object_id,step_id:step_id,type:type,gameobject_id:gameobject_id},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(type=='contest')
{xhide('contest-contest-a-'+object_id);xshow('contest-uncontest-a-'+object_id);$('contest-uncontest-a-'+object_id).set('onclick','game_contest(\''+object_alias+'\','+object_id+','+step_id+',\'uncontest\', '+json.gameobject_id+')');}
else
{xhide('contest-uncontest-a-'+object_id);xshow('contest-contest-a-'+object_id);}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function game_comment_toogle(url)
{var value=Cookie.read('show_game_comment');if(!value)value=0;Cookie.write('show_game_comment',value==0?1:0,{duration:365*10});if(url)location.href=url;else location.reload();return false;}
var gameobject_comment=function(gameobject_id,url)
{if(!$('gameobject-newcomment-'+gameobject_id))
{if(url&&url!='')
{location.href=url+'#reply';}
else
{location.hash='';location.hash='#reply';}
return false;}
var is_new_design=$('is-new-design')?$('is-new-design').value:'';if($('gameobject-newcomment-'+gameobject_id).innerHTML!='')
{xshow('gameobject-newcomment-'+gameobject_id);location.hash='';location.hash='gameobject-newcomment-'+gameobject_id;}
else
{new Request({url:'/game/commentform',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message.text);}
if(json.content)
{$('gameobject-newcomment-'+gameobject_id).innerHTML=json.content;xshow('gameobject-newcomment-'+gameobject_id);if($('gameobject-newcommentlist-'+gameobject_id))xshow('gameobject-newcommentlist-'+gameobject_id);location.hash='';location.hash='gameobject-newcomment-'+gameobject_id;}
ll_texteditor_bind($(gameobject_id+'comment_text'));return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("gameobject_id="+gameobject_id+'&is_new_design='+is_new_design);}}
var gameobject_edit=function(gameobject_id)
{if(!$('gameobject-'+gameobject_id))return false;if($('gameobject-more-'+gameobject_id))$('gameobject-more-'+gameobject_id).hide();if($('gameobject-divform-'+gameobject_id))
{gameobject_canceledit(gameobject_id);return false;}
var is_new_design=$('is-new-design')?$('is-new-design').value:'';new Request({url:'/game/objectedit',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message);return false;}
if(json.content)
{var form=new Element('div',{'id':'gameobject-divform-'+gameobject_id,'style':'padding:20px;border-top: 1px solid #ebebeb;'});form.innerHTML=json.content;$('gameobject-'+gameobject_id).hide();form.inject($('gameobject-'+gameobject_id),'before');if($('gameobject-texteditor-'+gameobject_id))ll_texteditor_bind($('gameobject-texteditor-'+gameobject_id));}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("gameobject_id="+gameobject_id+'&is_new_design='+is_new_design);}
var gameobject_save=function(gameobject_id)
{if(!$('gameobject-form-'+gameobject_id))return false;var is_new_design=$('is-new-design')?$('is-new-design').value:'';new Request({url:'/game/objectsave/'+gameobject_id,method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message);return false;}
if(json.content)
{$('gameobject-'+gameobject_id).dispose();$('gameobject-divform-'+gameobject_id).innerHTML=json.content;$('gameobject-'+gameobject_id).inject($('gameobject-divform-'+gameobject_id),'before');$('gameobject-divform-'+gameobject_id).dispose();}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send($('gameobject-form-'+gameobject_id));}
var gameobject_canceledit=function(gameobject_id)
{if($('gameobject-divform-'+gameobject_id))$('gameobject-divform-'+gameobject_id).dispose();if($('gameobject-'+gameobject_id))$('gameobject-'+gameobject_id).show();}
function ll_ub_save_new(edition_id,actual_id,userbook_id)
{userbook_update_new(edition_id,actual_id,userbook_id);$('xa-menu-'+edition_id+'-'+(userbook_id>0?userbook_id:0)).dispose();ub_popup_close=true;}
function ll_quick_extended_ub(edition_id,actual_id,evt,plain,strict,content_edition_id,userbook_id,rand_id)
{if(content_edition_id=='undefined')content_edition_id=0;if(userbook_id=='undefined')userbook_id=0;if(strict||actual_id==0)actual_id=edition_id;var is_new_design=$('is-new-design')?$('is-new-design').value:0;var view_mode=$('ub-viewmode-'+edition_id)?$('ub-viewmode-'+edition_id).value:'plain';var htmlname='-userbook-'+actual_id+'-'+userbook_id;var coords=getMouseCoords(evt);new Request({url:'/user/quickextendedbook',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json,null,'ll_quick_extended_ub('+edition_id+', '+actual_id+', event, '+plain+', '+strict+', '+content_edition_id+', '+userbook_id+','+rand_id+')');if(json['error'])
{alert(json.error);}
else if(json.tologin)
{return false;}
else
{var container=$('body');if(container&&view_mode=='popup')
{if($('div'+htmlname))$('div'+htmlname).dispose();var div=new Element('div',{id:'div'+htmlname});var w=getClientWidth(true);if(coords['x']+500>w)coords['x']-=450;var x_coord=-20;var y_coord=24;if(coords['x']<0)coords['x']=0;var st='position:absolute;top:'+(coords['y']+y_coord)+'px;left:'+(coords['x']+x_coord)+'px;';if(isIE())div.style.cssText=st;div.setAttribute('style',st);div.innerHTML=json.content;container.adopt(div);}
else if(json.content)$('xa-main-'+edition_id+'-'+userbook_id+'-'+rand_id).innerHTML=json.content;xshow('xa-'+actual_id+'-'+userbook_id);if($('xa-menu-extended-'+actual_id+'-'+userbook_id))
{hideonclick('xa-menu-extended-'+actual_id+'-'+userbook_id,null,false,function(){if($('div'+htmlname))$('div'+htmlname).dispose();},'click');userbook_change_new('xa-menu-extended-'+actual_id+'-'+userbook_id,edition_id,actual_id,userbook_id);}}},onRequest:initAd,onSuccess:function()
{closeAd();},onFailure:function()
{failure();}}).send("edition_id="+edition_id+"&actual_id="+actual_id+"&plain="+plain+"&view_mode="+view_mode+"&strict="+strict+'&content_edition_id='+content_edition_id+'&userbook_id='+userbook_id+'&is_new_design='+is_new_design);return false;}
function ll_ub_set_own_new(edition_id,own,actual_id,userbook_id)
{var el='ub-own-'+own+'-'+edition_id+'-value';if($(el).value>0)$(el).value=0;else $(el).value=1;var status=$('ub-status-'+edition_id).value;var is_new_design=$('is-new-design')?$('is-new-design').value:0;var own='';if($('ub-own-p-'+edition_id+'-value').value>0)own+='p';if($('ub-own-a-'+edition_id+'-value').value>0)own+='a';if($('ub-own-e-'+edition_id+'-value').value>0)own+='e';var rating=$('ub-rating-'+edition_id)?$('ub-rating-'+edition_id).value:0;var priority=$('ub-priority-'+edition_id)?$('ub-priority-'+edition_id).value:0;userbook_id=userbook_id||0;var day=$('date-'+edition_id+'-day').value;var month=$('date-'+edition_id+'-month').value;var year=$('date-'+edition_id+'-year').value;var params="userbook_id="+userbook_id+"&edition_id="+edition_id+"&status="+status;params+="&is_new_design="+is_new_design;params+="&own="+own+"&rating="+rating+"&day="+day+"&month="+month+"&year="+year+"&priority="+priority;var cls='menu-item';var cls_active='menu-item active';new Request({url:'/user/savebook',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);if($('a-ub-save-'+edition_id).hasClass('i-clock'))$('a-ub-save-'+edition_id).removeClass('i-clock');}
else
{if(own&&$('ab-test-ub-type'))
{ll_pagegoal_ab('userbooktype');}
if($('ub-own-p-'+edition_id+'-value').value>0)$('ub-own-p-'+edition_id).set('class',cls_active);else $('ub-own-p-'+edition_id).set('class',cls);if($('ub-own-a-'+edition_id+'-value').value>0)$('ub-own-a-'+edition_id).set('class',cls_active);else $('ub-own-a-'+edition_id).set('class',cls);if($('ub-own-e-'+edition_id+'-value').value>0)$('ub-own-e-'+edition_id).set('class',cls_active);else $('ub-own-e-'+edition_id).set('class',cls);}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send(params);}
var basket_labirint_change=function(source_id,page_no)
{if(!($('labirint-buy')))return false;var elem=$('labirint-source-'+source_id+'-'+page_no);var labirint_buy=$('labirint-buy').getAttribute('data-value');if(elem.hasClass('active'))
{var elems=$$('.labirint-source-'+source_id);if(elems.length>0)
{for(var i=0;i<elems.length;i++)
{elems[i].removeClass('active');elems[i].innerHTML='В корзину';elems[i].setAttribute('title','Добавить в корзину');}}
$('labirint-buy').setAttribute('data-value',labirint_buy.replace(source_id+',',''));}
else
{var elems=$$('.labirint-source-'+source_id);if(elems.length>0)
{for(var i=0;i<elems.length;i++)
{elems[i].addClass('active');elems[i].innerHTML='В корзине';elems[i].setAttribute('title','Убрать из корзины');}}
if(labirint_buy.indexOf(','+source_id+',')==-1)$('labirint-buy').setAttribute('data-value',labirint_buy+=source_id+',');}
labirint_buy=$('labirint-buy').getAttribute('data-value');var count=labirint_buy.split(',').length-1;if(count>1)
{$('btn-buy').innerHTML='Купить '+human_ending(count-1,'книг','','у','и')+' со скидкой';}
else
{$('btn-buy').innerHTML='Купить со скидкой';}
return false;}
var basket_labirint_buy=function(code,alias)
{if(!($('labirint-buy')))return false;var labirint_buy=$('labirint-buy').getAttribute('data-value');if(labirint_buy==',')
{alert('Добавьте книги в корзину');return false;}
if(code=='')
{alert('Укажите код');return false;}
code=code!=null&&code!='undefined'?code:'';if(typeof(ga)=='function')
{ga('send','pageview','/virtual_url/labirint/'+alias+'/buy');ga('send','event','labirint','buy',alias);}
new Request({url:'/book/labirintbuy',method:'post',data:{source_ids:labirint_buy,code:code,alias:alias},onComplete:function(json)
{json=strToJson(json);prepare(json,'','basket_labirint_bind(\''+labirint_buy+'\')');if(json.error_code)
{if(json.user_exists&&$('labirint-remind'))
{$('labirint-remind').show();return false;}
else if(json.message)alert(json.message);return false;}
if(json.url)location.href=json.url;return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
var basket_labirint_bind=function(source_ids)
{if(!source_ids)return false;var arr=source_ids.split(',');if(arr.length<=0)return false;var source_id=0;for(var i=0;i<arr.length;i++)
{source_id=parseInt(arr[i]);if(!isNaN(source_id)&&source_id>0)basket_labirint_change(source_id);}
basket_labirint_buy();}
var basket_labirint_remind=function()
{new Request({url:'/book/labirintremind',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)alert(json.message);return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
var ll_ub_checkisempty_textarea=function(textarea_id)
{if(/\S/.test($(textarea_id).value))
{if(!$(textarea_id+'-clear-link').isVisible())$(textarea_id+'-clear-link').show();}
else
{if($(textarea_id+'-clear-link').isVisible())$(textarea_id+'-clear-link').hide();}}
var bind_genres_popup=function()
{var json_genres_tree=get_genres_json();var prepared_json=strToJson(json_genres_tree);var ul_menu_more_genres=new Element('ul',{id:'menu-more-genres',class:'share menu-more-genres','styles':{'display':'none'}});var left=document.getElementById('genre-item').offsetLeft+36;var div_triangle=new Element('div',{class:'triangle-msg',id:'genre-triangle','styles':{'left':left+'px'}});var div_blocks=new Element('div',{class:'blocks'});var div_gray_block=new Element('div',{class:'gray-block'});var a_all_genres=new Element('a',{href:'/genres'});a_all_genres.innerHTML='Все жанры';a_all_genres.inject(div_gray_block);var div_separator=new Element('div',{class:'separator'});var ul=new Element('ul');var k=1;for(var i in prepared_json)
{var li=new Element('li');var a=new Element('a',{href:'/genre/'+prepared_json[i]});a.innerHTML=prepared_json[i];a.inject(li);li.inject(ul);if((k>1&&k%7==0))
{var div_genre_columns=new Element('div',{class:'genre-columns'});ul.inject(div_genre_columns);div_genre_columns.inject(div_blocks);var ul=new Element('ul');}
k+=1;}
if(ul.children.length)
{var div_genre_columns=new Element('div',{class:'genre-columns'});ul.inject(div_genre_columns);div_genre_columns.inject(div_blocks);}
div_triangle.inject(ul_menu_more_genres);div_blocks.inject(ul_menu_more_genres);div_separator.inject(ul_menu_more_genres);div_gray_block.inject(ul_menu_more_genres);$$('.footer')[0].insertBefore($(ul_menu_more_genres),$$('.footer')[0].firstChild);};var bind_userbook_containers=function()
{var result={};var userbook_containers=$$('.userbook-container');userbook_containers.each(function(item,key){var params={};params['edition_id']=item.dataset.edition_id;params['data_show']=item.dataset.show;params['show_extended']=item.dataset.show_extended;params['view_mode']=item.dataset.view_mode;params['userbook_id']=item.dataset.userbook_id;params['strict_edition_id']=item.dataset.strict_edition_id;params['rand_id']=item.dataset.rand_id;params['is_new_design']='ll2015b';result[key]=params;});if(result[0])
{new Request({url:'/user/binduserbookcontainer',method:'post',data:{userbook_containers:JSON.stringify(result)},onComplete:function(json)
{json=strToJson(json);prepare(json);if(!json.error_code)
{json.containers.each(function(item,key){var edition_id=item.edition_id;var userbook_id=item.userbook_id;var rand_id=item.rand_id;if($('xa-main-'+edition_id+'-'+userbook_id+'-'+rand_id))$('xa-main-'+edition_id+'-'+userbook_id+'-'+rand_id).innerHTML=item.html;});return false;}}}).send();}
result;};var bind_userbook_rating_containers=function()
{var result={};var userbook_rating_containers=$$('.userbook-rating-container');userbook_rating_containers.each(function(item,key){var params={};params['edition_id']=$(item).getAttribute('data-edition_id');params['userbook_id']=$(item).getAttribute('data-userbook_id');params['style']=$(item).getAttribute('data-style');params['strict_edition_id']=$(item).getAttribute('data-strict_edition_id');params['rand_id']=item.dataset.rand_id;params['star_size']=item.dataset.star_size;var user_rating_mode=$(item).getAttribute('data-user_rating_mode');if(user_rating_mode)params['user_rating_mode']=user_rating_mode;result[key]=params;});if(result[0])
{new Request({url:'/user/binduserbookratingcontainer',method:'post',data:{userbook_rating_containers:JSON.stringify(result)},onComplete:function(json)
{json=strToJson(json);prepare(json);if(!json.error_code)
{json.containers.each(function(item,key){var edition_id=item.edition_id;var userbook_id=item.userbook_id;var rand_id=item.rand_id;if($('xa-rating-'+edition_id+'-'+userbook_id+'-'+rand_id))$('xa-rating-'+edition_id+'-'+userbook_id+'-'+rand_id).innerHTML=item.html;});return false;}}}).send();}
result;};var llgallery=Array();function ub_get_list(gallery)
{if(!gallery)return false;var list_type=gallery.gallery.getAttribute('data-list');var login=gallery.gallery.getAttribute('data-login');var count=gallery.gallery.getAttribute('data-count');if(!list_type||!login)return false;var gallery_name=list_type+'-'+login;if(llgallery[gallery_name]!=null&&llgallery[gallery_name]==0)return false;var start=llgallery[gallery_name]!=null?llgallery[gallery_name]+1:2;var is_new_design=$('is-new-design')?$('is-new-design').value:0;new Request({url:'/user/getlist',method:'post',data:{list_type:list_type,login:login,start:start,count:count,is_new_design:is_new_design},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(gallery&&json.content)
{gallery.itemsParent.innerHTML+=json.content;gallery.reinitElements();}
llgallery[gallery_name]=start;if(json.end_data)
{llgallery[gallery_name]=0;}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function selection_get_list(gallery)
{if(!gallery)return false;var selection_id=gallery.gallery.getAttribute('data-selection');var page=gallery.gallery.getAttribute('data-page');var special_alias=gallery.gallery.getAttribute('data-special');var gallery_name='selection'+'-'+selection_id;if(llgallery[gallery_name]!=null&&llgallery[gallery_name]==0)return false;var start=llgallery[gallery_name]!=null?llgallery[gallery_name]+1:2;var is_new_design=$('is-new-design')?$('is-new-design').value:0;new Request({url:'/selection/getlist',method:'post',data:{selection_id:selection_id,page:page,special_alias:special_alias,start:start,is_new_design:is_new_design},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(gallery&&json.content)
{gallery.itemsParent.innerHTML+=json.content;gallery.reinitElements();}
llgallery[gallery_name]=start;if(json.end_data)
{llgallery[gallery_name]=0;}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function giveaway_agreement(giveaway_id)
{new Request({url:'/giveaway/agreement',method:'post',data:{id:giveaway_id},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(json.content&&$('giveaway-agreement-'+giveaway_id))
{$('giveaway-agreement-'+giveaway_id).innerHTML=json.content;}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function giveaway_enter(giveaway_id)
{var giveaway=getCookie('__giveaway');if(giveaway.indexOf('g'+giveaway_id+'_')==-1)
{var now=new Date();var time=now.getTime();time+=3600*24*30*10*1000;now.setTime(time);document.cookie='__giveaway='+giveaway+'g'+giveaway_id+'_;path=/;expires='+now.toUTCString();}
location.href='/giveaway/enter/'+giveaway_id;}
function getCookie(name){var matches=document.cookie.match(new RegExp("(?:^|; )"+name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,'\\$1')+"=([^;]*)"));return matches?decodeURIComponent(matches[1]):'';}
function toggle_more(element,target,type)
{if(!$(element)||!$(target))return false;var type=type?type:'';var display=$(element).style.display=='none'?false:true;if(display)
{var prefix='<span class="i-search-down">';var postfix='';var title='Подробнее';if(type=='booklist'||type=='profile'||type=='bornauthor')
{prefix='';postfix='<span class="i-search-down">';}
if(type=='bornauthor')
{title='Показать';if($('born-authors-more'))$('born-authors-more').hide();if($('author-calendar-table'))$('author-calendar-table').removeClass('open');}
$(element).style.display='none';$(target).innerHTML=prefix+title+postfix;$(target).setAttribute('title',title);}
else
{var prefix='<span class="i-search-up">';var postfix='';var title='Свернуть';if(type=='booklist'||type=='profile'||type=='bornauthor')
{prefix='';postfix='<span class="i-search-up">';}
if(type=='bornauthor')
{title='Скрыть';if($('born-authors-more'))$('born-authors-more').show();if($('author-calendar-table'))$('author-calendar-table').addClass('open');}
$(element).style.display='';$(target).innerHTML=prefix+title+postfix;$(target).setAttribute('title',title);}}
function ll_admin_stats_select(stat_alias)
{if(typeof(stat_alias)=='undefined'||stat_alias=='')
return false;if(stat_alias=='topicstats'||stat_alias=='poststats'||stat_alias=='libraryevents'||stat_alias=='giveawaystats'||stat_alias=='conteststats'||stat_alias=='mobstats')
{if(stat_alias=='topicstats'||stat_alias=='poststats')
{$('url-row').firstChild.nextElementSibling.innerHTML='Ссылка на '+(stat_alias=='topicstats'?'раздел':'статью');$('url-row').style.display='';}
else
{$('url-row').style.display='none';}
$('login-row').style.display='none';}
else
{$('url-row').style.display='none';$('login-row').style.display='';}}
function toggle_tab(target,class_menu,class_tab)
{if(!$(target+'-button')||!$(target+'-tab'))return false;$$('.'+class_tab).hide();$(target+'-tab').show();var elements=$$('.'+class_menu);if(elements.length>0)
{for(var i=0;i<elements.length;i++)
{elements[i].removeClass('active');}}
$(target+'-button').addClass('active');}
function mmkv_update_ll_id(mmvk_book_id)
{var ll_edition_id=$('ll-id-input-'+mmvk_book_id).value;if(ll_edition_id=='')
{alert('Необходимо указать идентификатор книги на ЛайвЛиб');return false;}
var params="edition_id="+ll_edition_id+"&mmkv_book_id="+mmvk_book_id;new Request({url:'/mmkv/updatellid',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);}
else
{alert(json.okay);}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send(params);}
function mmkv_update_ll_publisher_id(mmvk_participant_id)
{var ll_publisher_link=$('ll-publisher-link-input-'+mmvk_participant_id).value;if(ll_publisher_link=='')
{alert('Необходимо указать ссылку издательства на ЛайвЛиб');return false;}
var params="publisher_link="+ll_publisher_link+"&mmkv_participant_id="+mmvk_participant_id;new Request({url:'/mmkv/updatellpublisher',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);}
else
{alert(json.okay);}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send(params);}
function mmkv_map_clear()
{var svgdoc=$('moozoom').contentDocument;var paper=Snap(svgdoc.getElementById('map'));var elements=paper.selectAll('.svg-hover');if(elements.length>0)
{for(var i=0;i<elements.length;i++)
{elements[i].removeClass('svg-hover');elements[i].attr('opacity','0.3');}}
var elements=paper.selectAll('.tooltip');if(elements.length>0)
{for(var i=0;i<elements.length;i++)
{elements[i].remove();}}
mmkv_tooltip_clear();}
function mmkv_tooltip_clear()
{var elements=$$('.mibf-tooltip-text');if(elements.length>0)
{for(var i=0;i<elements.length;i++)
{elements[i].dispose();}}}
function mmkv_map_tooltip(element,text,stand,clear,without_text)
{if(clear&&clear!='undefined')mmkv_map_clear();text=text||'';stand=stand||'';if(text==stand)stand='';without_text=without_text||false;var elements=element.split(',');var svgdoc=$('moozoom').contentDocument;var paper=Snap(svgdoc.getElementById('map'));if(elements.length>0)
{var tooltips=paper.selectAll('.tooltip');var with_tooltip=true;if(tooltips.length/2+elements.length>6)
{mmkv_tooltip_clear();with_tooltip=false;}
for(var i=0;i<elements.length;i++)
{if(!elements[i])continue;var el=paper.select('#'+elements[i]);if(!el)continue;var size=el.getBBox();el.attr({'opacity':'1','class':'svg-hover'});var x=size.cx;var y=size.y;var tooltip=paper.path('M'+x+','+y+' C'+x+','+y+' '+(x+60)+','+(y-67)+' '+(x+60)+','+(y-102)+' C'+(x+60)+','+(y-137)+' '+(x+33)+','+(y-165)+' '+(x)+','+(y-165)+' C'+(x-33)+','+(y-165)+' '+(x-60)+','+(y-137)+' '+(x-60)+','+(y-102)+' C'+(x-60)+','+(y-67)+' '+(x)+','+(y)+' '+(x)+','+(y)+' Z');tooltip.attr({'fill':'#39424C',class:'tooltip'});if(with_tooltip&&text&&!without_text)
{var number=(tooltips.length/2+1);var tooltip_center=paper.text(x-21.75,(y-78),number);tooltip_center.attr({'style':'font-size:72px;fill:#ffffff;font-weight:bold;font-family:Arial;',class:'tooltip'});var t='<table class="mibf-tooltip-text"><tr><td title="'+text+'"><b>'+number+'.</b>&nbsp;'+text+'</td><td style="white-space:nowrap;padding-left:10px;text-align:right;"><b>'+stand+'</b></td></tr></table>';$('mibf-tooltip-'+(number>3?'right':'left')).innerHTML+=t;}
else
{var tooltip_center=paper.path('M'+x+','+(y-78)+' C'+(x+12)+','+(y-78)+' '+(x+22)+','+(y-88)+' '+(x+22)+','+(y-100)+' C'+(x+22)+','+(y-112)+' '+(x+12)+','+(y-122)+' '+(x)+','+(y-122)+' C'+(x-12)+','+(y-122)+' '+(x-22)+','+(y-112)+' '+(x-22)+','+(y-100)+' C'+(x-22)+','+(y-88)+' '+(x-12)+','+(y-78)+' '+(x)+','+(y-78)+' Z');tooltip_center.attr({'fill':'#FFFFFF',class:'tooltip'});}
tooltips=paper.selectAll('.tooltip');}}}
function filter_fill()
{var container=$('filter-container');var elements=$$('#filter-container a');if(elements.length<=0)return false;var more=$('ul-filter-more');var elementsmore=$$('#ul-filter-more li');var size=$('filter-full').getSize();var width=0;var margin_li=10;var margin_container=90;var more_count=1;for(var i=0;i<elements.length-more_count-elementsmore.length;i++)
{var elsize=elements[i].getSize();width+=(i>0?margin_li:0)+elsize.x;if(width>size.x-margin_container)
{if($('filter-more'))$('filter-more').style.display='';for(var j=elements.length-1-more_count-elementsmore.length;j>=i;j--)
{var current_menus=$$('#ul-filter-more li');var li=new Element('li',{'class':elements[j].hasClass=='active'?'active':''});li.appendChild(elements[j].removeClass('btn-feed'));if(current_menus.length>0)
{more.insertBefore(li,current_menus[0]);}
else
{more.appendChild(li);}}
var current_menus=$$('#ul-filter-more li');$('filter-more-count').innerHTML='Ещё '+current_menus.length;$('filter-container').setAttribute('style','width:100%;');$('filter-full').setAttribute('style','overflow:inherit;');return false;}}
return false;}
if($('filter-container'))
{filter_fill();}
function ll_book_set_list(name,type,redirect)
{if(redirect&&redirect!=null&&redirect!='undefined')
{location.href=redirect;}
else
{Cookie.write(name,type,{duration:365*10});location.reload();}}
function ll_book_top(edition_id,type)
{new Request({url:'/user/booktop',method:'post',data:{edition_id:edition_id,type:type},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(type=='add')
{if($('book-add-top-'+edition_id))$('book-add-top-'+edition_id).hide();if($('book-delete-top-'+edition_id))$('book-delete-top-'+edition_id).show();}
else if(type=='delete')
{if($('book-add-top-'+edition_id))$('book-add-top-'+edition_id).show();if($('book-delete-top-'+edition_id))$('book-delete-top-'+edition_id).hide();}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
var bookhints=Array();window.addEvent("domready",function(){if($('sortable-list'))
{var sort_no=0;var SortableBook=new Sortables('#sortable-list .book-container',{constrain:true,clone:true,snap:10,handle:'.handle-drag-content',revert:{duration:50},onStart:function(el,clone){SortableBook.serialize(0,function(element,index){if(el==element)sort_no=index;});},onComplete:function(el){var edition_id=el.getAttribute('id').substring(15);k=1;SortableBook.serialize(0,function(element,index){if(el==element)
{if(sort_no==index)return;if(sort_no<index)k=0;new Request({url:'/user/booktopsort',method:'post',data:{edition_id:edition_id,no:index+k},onComplete:function(json)
{json=strToJson(json);prepare(json);return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}});}});}
if($('hint-book'))
{var with_buy=$('sources')?1:0;new Request({url:'/hint/bookhint',method:'post',data:{with_buy:with_buy},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{return false;}
if(json.hints)
{bookhints=json.hints;}
if(json.first&&bookhints[json.first]&&$('hint-type-'+json.first))
{$('hint-book').show();$('body').style.overflow='hidden';$('hint-type-'+json.first).innerHTML=bookhints[json.first];if(typeof(ga)=='function')ga('send','pageview','/virtual_url/hint/book/'+json.first);}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}});function hint_book(current,next)
{if($('hint-type-'+current))$('hint-type-'+current).innerHTML='';var prev_block=current
var next_block=next;var blocks=['addbook','shelf','review'];if(blocks.indexOf(current)>-1)prev_block='userbook';if(blocks.indexOf(next)>-1)next_block='userbook';if($('hint-type-'+next)&&bookhints[next])$('hint-type-'+next).innerHTML=bookhints[next];if($('book-hint-block-'+prev_block))$('book-hint-block-'+prev_block).removeClass('book-hint-block');if($('book-hint-block-'+next_block))$('book-hint-block-'+next_block).addClass('book-hint-block');if(typeof(ga)=='function')ga('send','pageview','/virtual_url/hint/book/'+next);if($('hint-hash-'+next))
{location.hash='';location.hash='hint-hash-'+next;}}
var is_search_friend_query_back=true;function ll_friend_search(event,search_login,user_page_login,page_name,page_no)
{if(page_no==null||page_no=='undefined')page_no=1;if(event.keyCode==13||event.keyCode==38||event.keyCode==40)
{set_selection_search(event.keyCode,'friend_search_res');}
if(event.keyCode>=9&&event.keyCode<=27)return false;if(event.keyCode>=33&&event.keyCode<=46)return false;if(event.keyCode>=91&&event.keyCode<=93)return false;if(event.keyCode>=112&&event.keyCode<=157)return false;if(event.keyCode>=186||event.keyCode==188)return false;if(!is_search_friend_query_back)return false;var is_new_design=$('is-new-design')?$('is-new-design').value:0;is_search_friend_query_back=false;new Request({method:'post',url:'/account/friendsearch',onComplete:function(json)
{is_search_friend_query_back=true;json=strToJson(json);if(json.message&&json.error_code!=0)
{alert(json.message);return false;}
if(json.error_code==0)
{if(page_name=='edit')
{$('friends-edit-table').innerHTML=json.content;}
else
{if(page_no==1)
{$('finded-'+page_name+'-block').innerHTML=json.content;}
else
{$('more-'+page_name+'-link-'+page_no).remove();$('finded-'+page_name+'-block').innerHTML+=json.content;}
if(json.more_users)
{var a=new Element('a',{'href':'javascript:void(0)','id':'more-'+page_name+'-link-'+(page_no+1),'title':'Еще читатели','onclick':'ll_friend_search(event, "'+search_login+'","'+user_page_login+'", "'+page_name+'", '+(page_no+1)+')'});a.innerHTML='Еще читатели';$('finded-'+page_name+'-block').appendChild(a);}
if($$('.pager-ll2015b')[0]!='undefined'&&$$('.pager-ll2015b')[0]!=null)
{json.show_pager?$$('.pager-ll2015b')[0].style.display='block':$$('.pager-ll2015b')[0].style.display='none';}
if($$('.comparison.spinning')[0])
{addDOMLoadEvent(bind_user_similarity());}}
if(search_login.length)
{location.hash='#'+search_login;}
if(search_login!=$('input-search-friend').value.trim())
{ll_friend_search({keyCode:158},$('input-search-friend').value.trim(),user_page_login,page_name);}}}}).send('search_login='+search_login+'&user_page_login='+user_page_login+'&page_name='+page_name+'&page_no='+page_no+'&is_new_design='+is_new_design);}
var scrollconf={scroll_init:false,scroll_side:true,scroll_stop:false,scroll_timer:null,first_step:150,timer_interval:20000,elements:null,context:null,context_bottom:false,step:800,height_fix:0,current_banner:0,promo_replaces:Array(),promo_url:''};window.addEvent('load',function(){side_scroll();window.addEvent('scroll',side_scroll);});var side_scroll=function()
{if(scrollconf.scroll_stop)return false;var el=$('column-absolute');if(!el)return false;var elfix=$('column-fixed');if(!elfix)return false;var position=el.getPosition($('body'));var position_fix=position.y;scrollconf.position_fix=position_fix;var scrollTop=(window.pageYOffset!==undefined)?window.pageYOffset:document.body.scrollTop;var height_all=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight);var fixsize=elfix.getSize();var height_fix=fixsize.y;var footer=$('nav-wrapper')?$('nav-wrapper').getSize():null;var height_footer=(footer?footer.y:282)+300;scrollconf.height_footer=height_footer;var first=false;if(!scrollconf.scroll_init)
{side_scroll_init();first=true;}
if(scrollconf.scroll_side)
{if(height_all-position.y-height_footer<position_fix+80)
{elfix.removeClass('fixed-on');elfix.style.top='';el.style.position='relative';scrollconf.scroll_stop=true;scrollconf.to_bottom=false;}
else if(position_fix-80>scrollTop)
{elfix.removeClass('fixed-on');elfix.style.top='';scrollconf.to_bottom=false;}
else if(position_fix-80<=scrollTop&&scrollTop<=height_all-height_fix-height_footer-70)
{elfix.addClass('fixed-on');elfix.style.top='';side_banner_show(scrollTop,position_fix);scrollconf.to_bottom=false;}
else if(scrollTop>height_all-height_fix-height_footer-70)
{if($('column-fixed').hasClass('fixed-on')||first)
{var top=height_all-position_fix-height_fix-height_footer-70;elfix.removeClass('fixed-on');elfix.style.top=(top)+'px';scrollconf.to_bottom=true;}}}
clearInterval(scrollconf.scroll_timer);scrollconf.scroll_timer=setInterval(side_rotate,scrollconf.timer_interval);}
var side_scroll_init=function()
{var el=$('column-absolute');if(!el)return false;var elfix=$('column-fixed');if(!elfix)return false;var position=el.getPosition($('body'));var position_fix=position.y;var height_all=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight);var footer=$('nav-wrapper')?$('nav-wrapper').getSize():null;var height_footer=footer?footer.y:282;scrollconf.scroll_init=true;scrollconf.elements=$$('.side-blocks');scrollconf.context=$('side-ajax');var h=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;var csize=scrollconf.context?scrollconf.context.getSize():null;scrollconf.context_bottom=false;if(csize&&csize.y+450<=height_all-position_fix-height_footer&&(csize&&csize.y+450<=h))
{scrollconf.context_bottom=true;el.style.position='relative';}
else if(scrollconf.context)
{scrollconf.elements[scrollconf.elements.length]=scrollconf.context;scrollconf.elements.length+=1;}
if(scrollconf.elements.length>0||scrollconf.context_bottom)
{}
var scrollTop=(window.pageYOffset!==undefined)?window.pageYOffset:document.body.scrollTop;side_banner_show(scrollTop,position_fix,true);if(scrollconf.scroll_timer)clearInterval(scrollconf.scroll_timer);scrollconf.scroll_timer=setInterval(side_rotate,scrollconf.timer_interval);}
var side_rotate=function()
{if(!scrollconf.elements||scrollconf.elements.length<=1)return;var next=0;for(var i=0;i<scrollconf.elements.length;i++)
{if(scrollconf.elements[i].isDisplayed())
{next=i+1;break;}}
if(next>=scrollconf.elements.length||!scrollconf.elements[next])next=0;scrollconf.elements.hide();scrollconf.elements[next].show();if(scrollconf.to_bottom)
{var height_all=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight);var elfix=$('column-fixed');var fixsize=elfix.getSize();var height_fix=fixsize.y;var top=height_all-scrollconf.position_fix-height_fix-scrollconf.height_footer-70;elfix.style.top=(top)+'px';}}
var side_banner_show=function(scrollTop,position_fix,on_init)
{if(scrollconf.context_bottom)scrollconf.context.show();else if(on_init&&scrollconf.context)scrollconf.context.hide();if(scrollconf.step==0)return;var top=scrollTop-position_fix-scrollconf.first_step;var current=0;if(scrollTop-position_fix<scrollconf.first_step&&scrollTop-position_fix>0)
{var current=0;}
else
{var number=Math.round(top/scrollconf.step+0.5,0);var current=0;if(number>0)
{current=number%scrollconf.elements.length;}}
if(!scrollconf.elements[current])current=0;if(!scrollconf.elements[current]||scrollconf.elements[current].isDisplayed()||(scrollconf.elements[current]==scrollconf.current_banner&&!on_init))
{return;}
if(!scrollconf.promo_replaces[current]&&!on_init)
{scrollconf.promo_replaces[current]=true;var promo_id=scrollconf.elements[current].getAttribute('id');if(scrollconf.promo_url!=''&&promo_id&&promo_id!=scrollconf.promo_url&&promo_id.indexOf(scrollconf.promo_url)>-1&&scrollconf.elements[current].innerHTML.indexOf('yandex')>-1&&scrollconf.elements[current].innerHTML.indexOf('criteo')==-1)
{nodeScriptReplace(scrollconf.elements[current]);}}
scrollconf.elements.hide();if(!on_init||on_init=='undefined')scrollconf.elements[current].style.opacity='0';scrollconf.elements[current].show();if(!on_init||on_init=='undefined')scrollconf.elements[current].set('tween',{duration:1000}).fade('1');clearInterval(scrollconf.scroll_timer);scrollconf.scroll_timer=setInterval(side_rotate,scrollconf.timer_interval);scrollconf.current_banner=current;return;if(scrollconf.elements.length>0)
{for(var i=scrollconf.elements.length-1;i>=0;i--)
{if(scrollTop-position_fix>i*scrollconf.step)
{if(scrollconf.elements[i].isDisplayed()||(i==scrollconf.current_banner&&!on_init))
{break;}
scrollconf.elements.hide();if(!on_init||on_init=='undefined')scrollconf.elements[i].style.opacity='0';scrollconf.elements[i].show();if(!on_init||on_init=='undefined')scrollconf.elements[i].set('tween',{duration:1000}).fade('1');clearInterval(scrollconf.scroll_timer);scrollconf.scroll_timer=setInterval(side_rotate,scrollconf.timer_interval);scrollconf.current_banner=i;break;}}}}
var soc_services={facebook:{counterUrl:'https://graph.facebook.com/fql?q=SELECT+total_count+FROM+link_stat+WHERE+url%3D%22{url}%22',convertNumber:function(data){return data.data[0].total_count;}},twitter:{counterUrl:'https://cdn.api.twitter.com/1/urls/count.json?url={url}',convertNumber:function(data){return data.count;}},vkontakte:{counterUrl:'https://vk.com/share.php?act=count&url={url}&index=1',counter:function(url){if(!window.VK)window.VK={};window.VK.Share={count:function(idx,number){counter_show(number,'vkontakte');}};Asset.javascript(url,{id:'counter-vk-script'});}},odnoklassniki:{counterUrl:'http://connect.ok.ru/dk?st.cmd=extLike&ref={url}&uid=1',counter:function(url){if(!window.ODKL)window.ODKL={};window.ODKL.updateCount=function(idx,number){counter_show(number,'odnoklassniki');};Asset.javascript(url,{id:'counter-ok-script'});}}}
function counter_show(number,service)
{if(number>0&&number!='undefined'&&$('counter-soc-'+service))$('counter-soc-'+service).innerHTML=number;}
function parse_counters(elements,url)
{for(var i=0;i<elements.length;i++)
{var service=elements[i].id.substring(12);if(!soc_services[service])continue;var options=soc_services[service];var jsonUrl=options.counterUrl&&options.counterUrl.replace(/\{url\}/g,encodeURIComponent(url));if(jsonUrl&&options.counter&&typeof(options.counter)=='function'){options.counter(jsonUrl);}
else if(options.counterUrl){if(service=='facebook')
{new Request.JSONP({url:jsonUrl,onComplete:function(json)
{var number=json;if(soc_services.facebook.convertNumber&&typeof(soc_services.facebook.convertNumber)=='function'){number=soc_services.facebook.convertNumber(json);counter_show(number,'facebook');}}}).send();}
else
{new Request.JSONP({url:jsonUrl,onComplete:function(json)
{var number=json;if(soc_services.twitter.convertNumber&&typeof(soc_services.twitter.convertNumber)=='function'){number=soc_services.twitter.convertNumber(json);counter_show(number,'twitter');}}}).send();}}}}
if($$('.counter-soc'))
{parse_counters($$('.counter-soc'),'http://www.livelib.ru/bestbooks/2015');}
window.addEvent('scroll',function(){var el=$('nomination-absolute');if(!el)return false;var elfix=$('nomination-fixed');if(!elfix)return false;var position=el.getPosition($('body'));var position_fix=position.y;var height_all=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight);var scrollTop=(window.pageYOffset!==undefined)?window.pageYOffset:document.body.scrollTop;var footer=$('nav-wrapper')?$('nav-wrapper').getSize():null;var height_footer=footer?footer.y:282;var fixsize=elfix.getSize();var height_fix=fixsize.y;var bottom_height=735;if(position_fix-80>scrollTop)
{elfix.removeClass('fixed-on');elfix.style.top='';}
else if(position_fix-120<=scrollTop&&scrollTop<height_all-height_fix-height_footer-bottom_height)
{elfix.addClass('fixed-on');elfix.style.top='';}
else if(scrollTop+120>=height_all-height_fix-height_footer-bottom_height)
{if(elfix.hasClass('fixed-on'))
{var top=height_all-position_fix-height_fix-height_footer-bottom_height;elfix.removeClass('fixed-on');elfix.style.top=(top)+'px';}}});function bind_captcha()
{new Request({method:'post',url:'/service/bindcaptcha',onComplete:function(json)
{json=strToJson(json);if(json.is_captcha)
{if($('login-captcha')==null)$('form-login-data').innerHTML+='<div id="login-captcha" style="margin-top: 10px;"><input type="text" name="user[captcha]" placeholder="Текст с картинки" tabindex="3" style="margin-right: 10px;width: 216px;"><img src="/service/captcha/login" style="vertical-align: -9px; margin-right: -2px;"></div>';if($('register-captcha')==null)$('form-register-data').innerHTML+='<div id="register-captcha" style="margin-top: 10px;"><input type="text" name="register[captcha]" placeholder="Текст с картинки" tabindex="3" style="margin-right: 10px;width: 216px;"><img src="/service/captcha/register" style="vertical-align: -9px; margin-right: -2px;"></div>';}}}).send();}
function set_ip_status(ip,status_element)
{var status_id=$(status_element).value;new Request({method:'post',url:'/admin/setipstatus',onComplete:function(json)
{json=strToJson(json);if(json.error)
{alert('Ошибка!');return false;}
else
{$('tinyalert').innerHTML+='<div class="green"><a href="javascript:void(0)" title="Закрыть" class="action a-close" onclick="this.getParent().hide();"><span class="i-clear"></span></a>Статус ip изменен</div>';}}}).send("ip="+ip+"&status_id="+status_id);}
function nf17_update_ll_id(nf17_book_id)
{var ll_edition_id=$('ll-id-input-'+nf17_book_id).value;if(ll_edition_id=='')
{alert('Необходимо указать идентификатор книги на ЛайвЛиб');return false;}
var params="edition_id="+ll_edition_id+"&nf17_book_id="+nf17_book_id;new Request({url:'/nonfiction/updatellid',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);}
else
{alert(json.okay);}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send(params);}
function nf17_update_ll_publisher_id(nf17_participant_id)
{var ll_publisher_link=$('ll-publisher-link-input-'+nf17_participant_id).value;if(ll_publisher_link=='')
{alert('Необходимо указать ссылку издательства на ЛайвЛиб');return false;}
var params="publisher_link="+ll_publisher_link+"&nf17_participant_id="+nf17_participant_id;new Request({url:'/nonfiction/updatellpublisher',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert(json.error);}
else
{alert(json.okay);}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send(params);}
function menu_content_change()
{var container=$('menu-content');var elements=$$('#menu-content li');var more_div_container=$$('div#more-li');if(elements.length<=0)return false;var more=more_div_container[0].getElementById('ul-context-more');var elementsmore=more.getElementsByTagName("LI");var size=$('menu-content').getParent().getSize();var width=0;var margin_li=0;var margin_container=more_div_container[0].getElementById('a-context-more').hasClass('button')?0:215;var more_count=more_div_container[0].getElementById('a-context-more').hasClass('button')?0:1;for(var i=0;i<elements.length;i++)
{var elsize=elements[i].getSize();width+=(i>0?margin_li:0)+elsize.x;if(width>(size.x-parseInt(window.getComputedStyle($('menu-content').getParent()).paddingLeft)-Math.abs(parseInt(window.getComputedStyle($('menu-content').getParent()).marginLeft))))
{if(more_div_container[0])more_div_container[0].style.display='';more_div_container[0].getElementById('a-context-more').style.display=more_div_container[0].getElementById('a-context-more').hasClass('button')?'inline-block':'inline';for(var j=elements.length-1;j>=i;j--)
{var current_menus=more.getElementsByTagName("LI");if(current_menus.length>0)
{more.insertBefore(elements[j],current_menus[0]);}
else
{more.appendChild(elements[j]);}}
return false;}}
elementsmore=more.getElementsByTagName("LI");if(elementsmore.length<=0)
{more_div_container[0].getElementById('a-context-more').hide();if(!more.hasClass('dont-hide'))more.style.visibility='hidden';if(more_div_container[0])more_div_container[0].hide();return false;}
for(i=0;i<elementsmore.length;i++)
{var elsize=elementsmore[i].getSize();width+=(i>0?margin_li:0)+elsize.x;if(width<=(size.x-parseInt(window.getComputedStyle($('menu-content').getParent()).paddingLeft)-Math.abs(parseInt(window.getComputedStyle($('menu-content').getParent()).marginLeft)))-margin_container)
{container.insertBefore(elementsmore[i],more_div_container[0].getElementById('more-li'));if(i==elementsmore.length-1||elementsmore.length==0)
{more_div_container[0].getElementById('a-context-more').hide();if(!more.hasClass('dont-hide'))more.style.visibility='hidden';}}
else
{return false;}}
return false;}
if($('menu-content'))
{menu_content_change();window.onresize=function(event){menu_content_change();};}
function nf17_map_clear()
{var svgdoc=$('moozoom').contentDocument;var paper=Snap(svgdoc.getElementById('map'));var elements=paper.selectAll('.svg-hover');if(elements.length>0)
{for(var i=0;i<elements.length;i++)
{elements[i].removeClass('svg-hover');elements[i].attr('opacity','0.3');}}
var elements=paper.selectAll('.tooltip');if(elements.length>0)
{for(var i=0;i<elements.length;i++)
{elements[i].remove();}}
if($('marked-path'))$('marked-path').value='';nf17_tooltip_clear();}
function nf17_tooltip_clear()
{var elements=$$('.nf17-tooltip-text');if(elements.length>0)
{for(var i=0;i<elements.length;i++)
{elements[i].dispose();}}}
function nf17_map_tooltip(element,text,stand,clear,without_text)
{if(clear&&clear!='undefined')nf17_map_clear();text=text||'';stand=stand||'';if(text==stand)stand='';without_text=without_text||false;var elements=element.split(',');var svgdoc=$('moozoom').contentDocument;var paper=Snap(svgdoc.getElementById('map'));if(elements.length>0)
{var tooltips=paper.selectAll('.tooltip');var with_tooltip=true;if(tooltips.length/2+elements.length>6)
{nf17_tooltip_clear();with_tooltip=false;}
for(var i=0;i<elements.length;i++)
{if(!elements[i])continue;var el=paper.select('#'+elements[i]);if(!el)continue;var size=el.getBBox();el.attr({'opacity':'1','class':'svg-hover'});var x=size.cx;var y=size.y;var tooltip=paper.path('M'+x+','+y+' C'+x+','+y+' '+(x+30)+','+(y-34)+' '+(x+30)+','+(y-51)+' C'+(x+30)+','+(y-68)+' '+(x+17)+','+(y-82)+' '+(x)+','+(y-82)+' C'+(x-17)+','+(y-82)+' '+(x-30)+','+(y-68)+' '+(x-30)+','+(y-51)+' C'+(x-30)+','+(y-34)+' '+(x)+','+(y)+' '+(x)+','+(y)+' Z');tooltip.attr({'fill':'#39424C',class:'tooltip'});if(with_tooltip&&text&&!without_text)
{var number=(tooltips.length/2+1);var tooltip_center=paper.text(x-15,(y-33),number);tooltip_center.attr({'style':'font-size:52px;fill:#ffffff;font-weight:bold;font-family:Arial;',class:'tooltip'});var t='<table class="nf17-tooltip-text"><tr><td title="'+text+'"><b>'+number+'.</b>&nbsp;'+text+'</td><td style="white-space:nowrap;padding-left:10px;text-align:right;"><b>'+stand+'</b></td></tr></table>';$('nf17-tooltip-'+(number>3?'right':'left')).innerHTML+=t;}
else
{var tooltip_center=paper.path('M'+x+','+(y-39)+' C'+(x+6)+','+(y-39)+' '+(x+11)+','+(y-44)+' '+(x+11)+','+(y-50)+' C'+(x+11)+','+(y-56)+' '+(x+6)+','+(y-61)+' '+(x)+','+(y-61)+' C'+(x-6)+','+(y-61)+' '+(x-11)+','+(y-57)+' '+(x-11)+','+(y-50)+' C'+(x-11)+','+(y-44)+' '+(x-6)+','+(y-39)+' '+(x)+','+(y-39)+' Z');tooltip_center.attr({'fill':'#FFFFFF',class:'tooltip'});}
tooltips=paper.selectAll('.tooltip');}}}
function antispam_set_status(message_id,status_id)
{new Request({method:'post',url:'/antispam/setmessagestatus',onComplete:function(json)
{json=strToJson(json);if(json.error)
{alert('Ошибка!');return false;}
else
{$('row-message-'+message_id).destroy();}}}).send("message_id="+message_id+"&status_id="+status_id);}
function antispam_remove_keyword(word_id)
{new Request({method:'post',url:'/antispam/removekeyword',onComplete:function(json)
{json=strToJson(json);if(json.error)
{alert('Ошибка!');return false;}
else
{$('word-'+word_id).style.display='none';}}}).send("word_id="+word_id);}
function profile_bg_image()
{if(!$('profile-bg-name')||!$('profile-bg-file'))return false;var file=$('profile-bg-file').value;if(!file)
{file='загрузить обложку';if($('profile-bg-action'))$('profile-bg-action').value='current';}
else
{file=file.replace(/(.+)[\/|\\]([^\/\\]+)/g,"$2");if(file.length>20)file=file.substring(0,20)+'...';if($('profile-bg-action'))$('profile-bg-action').value='file';}
$('profile-bg-name').innerHTML=file;}
function profile_bg_url()
{if(!$('profile-bg-url'))return false;if($('profile-bg-url').value!='')
{if($('profile-bg-name'))$('profile-bg-name').innerHTML='загрузить обложку';if($('profile-bg-file'))$('profile-bg-file').value='';if($('profile-bg-action'))$('profile-bg-action').value='url';}
else
{if($('profile-bg-action'))$('profile-bg-action').value='current';}}
function profile_bg_delete()
{if(!confirm('Вы действительно хотите удалить файл?'))return false;if($('profile-bg-action'))$('profile-bg-action').value='current';new Request({method:'post',data:{picture_action:'no'},url:'/user/profilebg',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message);return false;}
else
{if($('profile-bg-wrapper'))$('profile-bg-wrapper').setAttribute('style','');if(json.old_date&&$('profile-bg-return'))
{$('profile-bg-return').show('inline');$('profile-bg-remove').hide();$('profile-bg-return').setAttribute('onclick','profile_bg_return(\''+json.old_date+'\')');}
if($('profilepic-edit-popup'))$('profilepic-edit-popup').dispose();if($('profile-bg-btn'))$('profile-bg-btn').innerHTML='Добавить обложку';}}}).send();if($('profile-bg-name'))$('profile-bg-name').innerHTML='загрузить обложку';if($('profile-bg-url'))$('profile-bg-url').value='';}
function profile_bg_return(pic_date)
{if($('profile-bg-action'))$('profile-bg-action').value='current';new Request({method:'post',data:{picture_action:'return',pic_date:pic_date},url:'/user/profilebg',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message);return false;}
else
{if(json.picture_url&&$('profile-bg-wrapper'))
{$('profile-bg-wrapper').setAttribute('style','margin-top:20px;background:#fff url('+json.picture_url+') center center no-repeat;');if($('profile-bg-btn'))$('profile-bg-btn').innerHTML='Изменить обложку';}
else if(json.picture_action&&json.picture_action=='no')
{$('profile-bg-wrapper').setAttribute('style','');}
$('profile-bg-return').hide();$('profile-bg-remove').show('inline');$('profile-bg-return').setAttribute('onclick','');}}}).send();if($('profile-bg-name'))$('profile-bg-name').innerHTML='загрузить обложку';if($('profile-bg-url'))$('profile-bg-url').value='';}
function profile_bg_save()
{var is_new_design=$('is-new-design')?$('is-new-design').value:'';var file=$('profile-bg-file')&&$('profile-bg-file').files&&$('profile-bg-file').files[0]?$('profile-bg-file').files[0]:null;var picture_action=$('profile-bg-action')?$('profile-bg-action').value:'current';var url=$('profile-bg-url')?$('profile-bg-url').value:'';var xhr=new XMLHttpRequest();upload=xhr.upload;formData=new FormData();formData.append('file',file);formData.append('url',url);formData.append('picture_action',picture_action);xhr.onreadystatechange=function(){if(xhr.readyState==4)
if((xhr.status>=200&&xhr.status<300)||xhr.status==304){this.response=this.response||this.responseText;var json=strToJson(this.response);prepare(json);if(json.message)
{alert(json.message);return false;}
if(json.picture_url&&$('profile-bg-wrapper'))
{$('profile-bg-wrapper').setAttribute('style','margin-top:20px;background:#fff url('+json.picture_url+') center center no-repeat;');if($('profile-bg-remove'))$('profile-bg-remove').show('inline');if($('profile-bg-return'))$('profile-bg-return').hide();if($('profile-bg-btn'))$('profile-bg-btn').innerHTML='Изменить обложку';}
else if(json.picture_action&&json.picture_action=='no')
{$('profile-bg-wrapper').setAttribute('style','');}
if($('profile-bg'))$('profile-bg').hide();}else onerror.call(xhr);};xhr.open('POST','/user/profilebg',false);xhr.setRequestHeader('X-Requested-With','XMLHttpRequest');xhr.send(formData);}
function check_block()
{if(typeof(ga)!='function')return false;var value=0;if(window.adblock===undefined)value=1;ga('send','event','adblock',value==1?'yes':'no','',{nonInteraction:true});}
var bookprice_success=function(json)
{if(!json||!json.data)return false;var source_edition_id=$('sources-edition-id')?$('sources-edition-id').value:0;var result=Array();result.paper=Array();result.ebook=Array();result.audio=Array();result.sub=Array();json.data.each(function(item){if(!result[item.type])result[item.type]=Array();result[item.type].push(item);});if($('sources-ajax-api-old'))bookprice_success_old(result,source_edition_id);else bookprice_success_new(result,source_edition_id);var img=new Element('img',{src:(document.location.protocol=='https:'?'https:':'http:')+'//www.pricelib.ru/service/bookpriceshow/'+pldata_default.api_key,'style':'display:none;'});if($('sources-ajax-api-old'))$('sources-ajax-api-old').appendChild(img);else if($('sources-ajax-api'))$('sources-ajax-api').appendChild(img);}
var bookprice_success_new=function(result,source_edition_id)
{var count_paper=result.paper?result.paper.length:0;var count_ebook=result.ebook?result.ebook.length:0;var count_audio=result.audio?result.audio.length:0;var count_sub=result.sub?result.sub.length:0;var max_rows=5;var html='';for(var t in result)
{var first=true;if(result[t].length>0&&typeof(result[t])=='object')
{var i=0;result[t].each(function(item){if(first)
{if(item.type=='paper')
{html+='<h2>Купить бумажную книгу</h2>';max_rows=5;}
else if(item.type=='ebook')
{html+='<h2 class="source-ebook">Скачать электронную книгу</h2>';max_rows=1;}
else if(item.type=='audio')
{html+='<h2 class="source-ebook">Купить аудиокнигу</h2>';max_rows=1;}
else if(item.type=='sub')
{html+='<h2 class="source-ebook">Читать по подписке</h2>';max_rows=1;}
html+='<table cellspacing="0"><tbody>';first=false;}
if(i>=max_rows)html+='</tbody><tbody class="sources-hide" style="display:none;">';html+='<tr style="cursor:pointer;">';html+='<td class="source-link" onclick="window.open(\''+item.shop_url+'\',\'_blank\');pldata_default.onItem(\''+item.shop_url+'\',\''+item.shop_alias+'\',\''+item.shop_domain+'\',\''+item.price+'\',\''+item.currency+'\',\''+item.is_discount+'\',\''+item.type+'\');ga(\'send\', \'event\', \'book-buy\', '+source_edition_id+', \''+item.shop_title+'\', 1);"><span class="source-action" style="'+(item.color?'color:'+item.color:'')+'"><img src="'+item.shop_icon+'" style="width:16px;vertical-align: -3px;margin-right: 3px;">'+item.shop_title+'</span></td>';html+='<td onclick="window.open(\''+item.shop_url+'\',\'_blank\');pldata_default.onItem(\''+item.shop_url+'\',\''+item.shop_alias+'\',\''+item.shop_domain+'\',\''+item.price+'\',\''+item.currency+'\',\''+item.is_discount+'\',\''+item.type+'\');ga(\'send\', \'event\', \'book-buy\', '+source_edition_id+', \''+item.shop_title+'\', 1);" style="text-align: right; font-weight: bold; color: '+(item.color?item.color:(item.currency=='UAH'||item.currency=='BYR'?'#2A9430':'#0768D8'))+';">';html+='<span class="source-action" style="white-space: nowrap;margin-left:'+(item.currency=='BYR'?-20:10)+'px; padding-left: 2px;">'+item.price_lbl+'</span>'+(item.is_discount?'<br><span style="color: red;">скидка!</span>':'');html+='</td>';if($('sources-advert'))html+='<td style="padding-top: 0px;width: 20px;"><a href="/context/createadvert/book/'+source_edition_id+'/source/'+item.source_original_id+'" title="Создать объявление" style="margin:0px 0px 5px 0px;"><span class="i-fragment"></span></a></td>';if($('sources-link-shop'))html+='<td style="width:26px;">'+(item.shop_url_exact!=''?'<a href="'+item.shop_url_exact+'"><span style="margin: -3px 0 0px 4px;" class="i-book-info"></span></a>':'')+'</td>';html+='</tr>';i++;});html+='</tbody></table>';}}
$('sources-api-ajax').show();$('source-blocks').innerHTML=html;if(count_paper<5&&count_ebook<1&&count_audio<1&&count_sub<1)
{if($$('#sources-api-ajax .sources-inner'))$$('#sources-api-ajax .sources-inner')[0].addClass('full');}
if(count_ebook>1||count_paper>5||count_audio>1||count_sub>1)
{if($$('#sources-api-ajax .sources-footer'))$$('#sources-api-ajax .sources-footer')[0].show();}}
var bookprice_success_old=function(result,source_edition_id)
{var html='<table cellspacing="0" style="margin-top:7px;"><tbody>';var first_title=false
for(var t in result)
{var first=true;if(result[t].length>0&&typeof(result[t])=='object')
{var i=0;result[t].each(function(item){if(first)
{html+='<tr><td colspan="4" style="padding-bottom:7px;'+(first_title?'padding-top:14px;':'')+'"><span style="font-weight:bold;">'
if(item.type=='paper')
{html+='Бумажные книги';}
else if(item.type=='ebook')
{html+='Электронные книги';}
else if(item.type=='audio')
{html+='Аудиокниги';}
else if(item.type=='sub')
{html+='Читать по подписке';}
html+='</span></td>';if($('sources-advert'))html+='<td></td>';if($('sources-link-shop'))html+='<td></td>';html+='</tr>';first=false;first_title=true;}
html+='<tr>';html+='<td colspan="2" style="padding: 1px 0;"><a onclick="pldata_default.onItem(\''+item.shop_url+'\',\''+item.shop_alias+'\',\''+item.shop_domain+'\',\''+item.price+'\',\''+item.currency+'\',\''+item.is_discount+'\',\''+item.type+'\');ga(\'send\', \'event\', \'book-buy\', '+source_edition_id+', \''+item.shop_title+'\', 1);" target="_blank" class="action" style="text-decoration: underline;" rel="nofollow" href="'+item.shop_url+'"><img src="'+item.shop_icon+'" style="width:16px;vertical-align: -3px;margin-right: 7px;">'+item.shop_title+'</a></td>';html+='<td class="small unnoticeable" style="text-align: right; padding: 2px 0 1px '+(item.currency=='BYR'?0:6)+'px; font-weight: bold; color: '+(item.currency=='UAH'||item.currency=='BYR'?'#2A9430':'#0768D8')+';">';html+=item.price_lbl;html+='</td>';html+='<td class="small unnoticeable" style="text-align: right; padding: 2px 0 1px 6px; font-weight: bold; color: red;">'+(item.is_discount?'скидка!':'')+'</td>';if($('sources-advert'))html+='<td><a href="/context/createadvert/book/'+source_edition_id+'/source/'+item.source_original_id+'" title="Создать объявление" style="margin-left:10px;" class="action">объявление</a></td>';if($('sources-link-shop'))html+='<td>'+(item.shop_url_exact!=''?'<a href="'+item.shop_url_exact+'"><span style="margin-left: 7px" class="i-description"></span></a>':'')+'</td>';html+='</tr>';i++;});}}
html+='</tbody></table>';$('source-blocks').show('inline-block');$('sources-ajax-api-old').innerHTML=html;}
var bookprice_click=function(shop_url,shop_alias,shop_domain,price,currency,is_discount,type)
{if($('ab-bookprice'))ll_pagegoal_ab('buybook');if(!$('id-login'))return false;var d=new Date();var source_edition_id=$('sources-edition-id')?$('sources-edition-id').value:(pldata_default&&pldata_default.edition_id?pldata_default.edition_id:0);var src='/service/shopper/'+shop_alias+'?date='+d.getTime()+'&edition_id='+source_edition_id;if(!$('shopper-click'))
{var el=new Element('img',{id:'shopper-click',style:'width:1px;height:1px;',src:src});if($('sources-ajax-api'))$('sources-ajax-api').appendChild(el);else if($('sources-ajax-api-old'))$('sources-ajax-api-old').appendChild(el);}
else
{$('shopper-click').setAttribute('src',src);}}
var bookprice_error=function()
{if($('source-context-book'))$('source-context-book').dispose();}
function ll_bookside(edition_id,api_key)
{var script=document.createElement('script');script.type='text/javascript';script.src=(document.location.protocol=='https:'?'https:':'http:')+"//www.pricelib.ru/api/contextbook?edition_id="+encodeURI(edition_id)+'&api_key='+encodeURI(api_key)+'&callback=ll_contextbook';script.defer='defer';script.async=true;document.head.appendChild(script);}
function ll_contextbook(json)
{if(!json)return false;json=strToJson(json);if(!json||json.status)return false;var html='<a target="_blank" style="float: left;" rel="nofollow" href="'+json.shop_url+'" title="Купить в '+json.shop_title+'"><img src="'+json.img_src+'" alt="Купить в '+json.shop_title+'" style="background-color: #ffffff;float: left;width: 90px;" target="_blank" rel="nofollow"></a>';html+='<div class="wordbreak" style="line-height: 125%;  padding-left: 95px;"><div style="margin-bottom: 2px"><a target="_blank" rel="nofollow" href="'+json.shop_url+'" class="title" style="font-weight: bold;">Купить бумажную книгу</a><br></div><div class="text">Вы можете купить книгу '+(json.book_name!=''?'«'+json.book_name+'» ':'')+(json.price_discount>0?('за '+Math.round(json.price_discount,0)+'&nbsp;'+json.currency_lbl):'в интернет-магазине.')+'</div><br><span class="link" style="color: green;">'+json.shop_title+'</span></div>';if($('source-context-book'))$('source-context-book').innerHTML=html;}
var bookchart_build=function()
{if(!$('chart-form'))return false;new Request({url:'/book/stats',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);$('charts').innerHTML='';if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(!json.data)return false;var options={height:450,hAxis:{title:'Дата',gridlines:{color:'#fff',count:15},format:'yyyy-MM-dd',slantedText:true,slantedTextAngle:45},vAxis:{title:'Количество',minValue:0,textPosition:'out',viewWindowMode:'explicit'},legend:{position:'right'}};for(var i in json.data)
{options.title=json.data[i].title;options.vAxis.maxValue=json.data[i].max;options.vAxis.gridlines={count:json.data[i].gridlines};options.vAxis.viewWindow={max:json.data[i].max,min:0};var el=document.createElement('div');el.id='chart-'+i;document.getElementById('charts').appendChild(el);var dataTable=new google.visualization.DataTable();dataTable.addColumn('date','Дата');if(json.colums&&json.colums.length>0)
{for(var j=0;j<json.colums.length;j++)
{dataTable.addColumn('number',json.colums[j]);}}
dataTable.addRows(json.data[i].data.length);for(var j=0;j<json.data[i].data.length;j++)
{for(var k=0;k<json.data[i].data[j].length;k++)
{dataTable.setCell(j,k,k==0?new Date(json.data[i].data[j][k]):json.data[i].data[j][k]);}}
var chart=new google.visualization.LineChart(el);chart.draw(dataTable,options);}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send($('chart-form'));}
function test_result_add()
{if(!$('test-results')||!$('test-result-example'))return false;var count=$$('.test-results').length-1;if(count<0)count=0;var element=new Element('tbody');element.innerHTML=$('test-result-example').innerHTML.replace(/key/g,count);$('test-result-table').insertBefore(element,$('test-results'));if($('form[results]['+count+'][description_original]'))ll_texteditor_bind($('form[results]['+count+'][description_original]'));if($('test-results-title'))$('test-results-title').show('table-row');if($('result-title-'+count))$('result-title-'+count).innerHTML='Ответ '+(count+1);}
function test_result_delete(key)
{var html='.test-results-'+key;if(!$$(html)||$$(html).length<=0)return false;for(var i=0;i<$$(html).length;i++)
{$$(html)[i].addClass('test-deleted');}
if($('form[results]['+key+'][is_delete]'))$('form[results]['+key+'][is_delete]').value=1;if($('result-delete-'+key))$('result-delete-'+key).hide();if($('result-return-'+key))$('result-return-'+key).show('inline');}
function test_result_return(key)
{var html='.test-results-'+key;if(!$$(html)||$$(html).length<=0)return false;for(var i=0;i<$$(html).length;i++)
{$$(html)[i].removeClass('test-deleted');}
if($('form[results]['+key+'][is_delete]'))$('form[results]['+key+'][is_delete]').value=0;if($('result-return-'+key))$('result-return-'+key).hide();if($('result-delete-'+key))$('result-delete-'+key).show('inline');}
function test_result_disable(key,value)
{var elements=['picture_action_current','picture_action_new','picture','picture_action_url','url','picture_action_no'];if($('form[results]['+key+'][description_original]'))$('form[results]['+key+'][description_original]').disabled=value;if($('form[results]['+key+'][title]'))$('form[results]['+key+'][title]').disabled=value;for(var i=0;i<elements.length;i++)
{if($('test_'+key+'_'+elements[i]))$('test_'+key+'_'+elements[i]).disabled=value;}}
function test_result_submit()
{if(!$('form[title]')||$('form[title]').value=='')
{alert('Укажите название теста');return false;}
if(!$('form[alias]')||$('form[alias]').value=='')
{alert('Укажите алиас теста');return false;}
var count=$$('.test-results').length-1;if(count<0)count=0;if(count<2)
{alert('У теста должно быть минимум два ответа');return false;}
var current=count;for(var i=0;i<count;i++)
{if($$('.test-results')[i])
{if($$('.test-results')[i].hasClass('test-deleted'))current=current-1;else if($('form[results]['+i+'][title]')&&$('form[results]['+i+'][title]').value=='')
{alert('Укажите название для ответа '+(i+1));return false;}}}
if(current<2)
{alert('У теста должно быть минимум два ответа');return false;}
$('test-result-form').submit();}
function test_question_add()
{if(!$('test-questions-after')||!$('test-question-example'))return false;var count=$$('.test-questions').length-1;if(count<0)count=0;var element=new Element('tbody',{id:'test-question-count-'+count});element.innerHTML=$('test-question-example').innerHTML.replace(/key/g,count);$('test-question-table').insertBefore(element,$('test-questions-after'));if($('question-title-'+count))$('question-title-'+count).innerHTML='Вопрос '+(count+1);test_question_addvariant(count);test_question_addvariant(count);}
function test_question_addvariant(key)
{if(!$('test-variant-example')||!$('test-variants-'+key))return false;var count=$$('.test-questionv-'+key).length;if(count<0)count=0;var elements=$$('#test-variant-example tr');for(var i=0;i<elements.length;i++)
{var element=new Element('tr');element.innerHTML=elements[i].innerHTML.replace(/key/g,key).replace(/kvariant/g,count);element.className=(i==0?'test-variants ':'')+'test-variant-'+key+'-'+count+' test-questions-'+key+(i==0?' test-questionv-'+key:'');$('test-variants-'+key).parentNode.insertBefore(element,$('test-variants-'+key));if($('question-title-'+key+'-'+count))$('question-title-'+key+'-'+count).innerHTML='Ответ '+(count+1);}}
function test_question_delete(key)
{var html='.test-questions-'+key;if(!$$(html)||$$(html).length<=0)return false;for(var i=0;i<$$(html).length;i++)
{$$(html)[i].addClass('test-deleted');}
if($('form[questions]['+key+'][is_delete]'))$('form[questions]['+key+'][is_delete]').value=1;if($('question-delete-'+key))$('question-delete-'+key).hide();if($('question-return-'+key))$('question-return-'+key).show('inline');if($('test-variants-'+key))$('test-variants-'+key).hide();test_question_save(key);}
function test_question_return(key)
{var html='.test-questions-'+key;if(!$$(html)||$$(html).length<=0)return false;for(var i=0;i<$$(html).length;i++)
{$$(html)[i].removeClass('test-deleted');}
if($('form[questions]['+key+'][is_delete]'))$('form[questions]['+key+'][is_delete]').value=0;if($('question-delete-'+key))$('question-delete-'+key).show('inline');if($('question-return-'+key))$('question-return-'+key).hide();if($('test-variants-'+key))$('test-variants-'+key).show('table-row');test_question_save(key);}
function test_variant_delete(key,kvariant)
{var html='.test-variant-'+key+'-'+kvariant;if(!$$(html)||$$(html).length<=0)return false;for(var i=0;i<$$(html).length;i++)
{$$(html)[i].addClass('variant-deleted');}
if($('form[questions]['+key+'][variants]['+kvariant+'][is_delete]'))$('form[questions]['+key+'][variants]['+kvariant+'][is_delete]').value=1;if($('variant-delete-'+key+'-'+kvariant))$('variant-delete-'+key+'-'+kvariant).hide();if($('variant-return-'+key+'-'+kvariant))$('variant-return-'+key+'-'+kvariant).show('inline');}
function test_question_save(key)
{new Request({method:'post',url:'/test/savequestion',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(json.content)
{$('test-question-count-'+key).innerHTML=json.content;}}}).send($('test-question-count-'+key));}
function test_question_edit(key,question_id)
{new Request({method:'post',data:{question_id:question_id,key:key},url:'/test/editquestion',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(json.content&&$('test-question-count-'+key))
{$('test-question-count-'+key).innerHTML=json.content;}}}).send();}
function test_variant_return(key,kvariant)
{var html='.test-variant-'+key+'-'+kvariant;if(!$$(html)||$$(html).length<=0)return false;for(var i=0;i<$$(html).length;i++)
{$$(html)[i].removeClass('variant-deleted');}
if($('form[questions]['+key+'][variants]['+kvariant+'][is_delete]'))$('form[questions]['+key+'][variants]['+kvariant+'][is_delete]').value=0;if($('variant-delete-'+key+'-'+kvariant))$('variant-delete-'+key+'-'+kvariant).show('inline');if($('variant-return-'+key+'-'+kvariant))$('variant-return-'+key+'-'+kvariant).hide();}
function ll_save_book_lang(id)
{var lang=$('booklangselect-'+id).options[$('booklangselect-'+id).selectedIndex].value;if(lang==null||lang=='')
{alert('Выберите язык');return false;}
new Request({method:'post',url:'/book/savelanguage',onComplete:function(json)
{json=strToJson(json);if(json.result)
{if($('booklangresult-'+id))$('booklangresult-'+id).innerHTML=' язык книги сохранен';if($('book-lang-tr-'+id))$('book-lang-tr-'+id).dispose();}
else
{alert('Ошибка сохранения языка!');}}}).send('id='+id+'&lang='+lang);}
function test_select_variant(question_id,variant_id,next_auto)
{new Request({url:'/test/savevariant',method:'post',data:{question_id:question_id,variant_id:variant_id},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if($('next-page-'+question_id))
{$('next-page-'+question_id).setAttribute('onclick','');$('next-page-'+question_id).addClass('active');if(next_auto)$('next-page-'+question_id).click();}
var elements=$$('.answer');if(elements.length>0)
{for(var i=0;i<elements.length;i++)
{elements[i].removeClass('checked');}}
if($('variant-container-'+variant_id))$('variant-container-'+variant_id).addClass('checked');if(json.question_stats.hasOwnProperty('variant_stats'))
{for(var i=0;i<elements.length;i++)
{if(elements[i].id=='variant-container-'+json.question_stats.correct_variant_id)
{elements[i].addClass('correct');}
else
{elements[i].addClass('incorrect');}}
if(json.question_stats.correct_variant_id==variant_id)
{if($('correct'))$('correct').show();}
else
{if($('incorrect'))$('incorrect').show();}
for(var i=0;i<json.question_stats.variant_stats.length;i++)
{if($('variant-stats-'+json.question_stats.variant_stats[i].variant_id))$('variant-stats-'+json.question_stats.variant_stats[i].variant_id).innerHTML=json.question_stats.variant_stats[i].percent+'%';}
$$('.variant-stats').each(function(item){if($(item).innerHTML=='')$(item).innerHTML='0%';});$$('.answer-radio-inputs').dispose();}
if(json.times_up)
{$('next-page-'+question_id).href=json.result_link;$('next-page-'+question_id).innerHTML='Узнать результат';location.href=json.result_link;}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function test_book_shows()
{var elements=$$('.test-book-link');if(!elements||elements.length<=0)return false;for(var i=0;i<elements.length;i++)
{var book_id=elements[i].getAttribute('data-book_id');var test_alias=elements[i].getAttribute('data-test_alias');if(book_id&&book_id>0&&test_alias&&test_alias!='')
{if(typeof(ga)=='function')
{ga('send','event','testshowbook',test_alias,book_id,{nonInteraction:true});}}}}
function bind_user_similarity()
{var users_to_calculate=$$('.comparison.spinning');var user_blocks=[];var params=[];users_to_calculate.each(function(item,key){if(typeof item.dataset.user_login!='undefined'&&typeof item.dataset.user2_login!='undefined')
{params.push({'user_login':item.dataset.user_login,'user2_login':item.dataset.user2_login});}
if((key==users_to_calculate.length-1)||(params.length==5)){user_blocks.push(params);params=[];}});if(user_blocks[0])
{for(var i=0;i<Math.ceil((users_to_calculate.length)/5);i++)
{new Request({url:'/user/bindsimilarity',method:'post',data:{similar_users:JSON.stringify(user_blocks[i])},onComplete:function(json)
{json=strToJson(json);prepare(json);if(!json.error_code)
{users_to_calculate.each(function(html_block,key){json.similar_users.each(function(similar_item,key){if(html_block.dataset.user_login==similar_item.user_login&&html_block.dataset.user2_login==similar_item.user2_login)
{html_block.removeClass('spinning');html_block.innerHTML=similar_item.similarity?similar_item.similarity+'%':'?';html_block.style.backgroundColor=similar_item.color;html_block.title=similar_item.similarity?'Профили совпадают на '+similar_item.similarity+'%':'Процент совпадения профилей неизвестен';if($('compare-link-'+similar_item.user_login+'-'+similar_item.user2_login))$('compare-link-'+similar_item.user_login+'-'+similar_item.user2_login).setAttribute('title',similar_item.similarity?'Профили совпадают на '+similar_item.similarity+'%':'Процент совпадения профилей неизвестен');}});});return false;}}}).send();}}}
function userpic_edit(object_alias,object_id)
{var is_new_design=$('is-new-design')?$('is-new-design').value:'';object_id=object_id||0;new Request({url:'/user/edituserpic',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(json.content&&$('user-pic-edit'))
{$('user-pic-edit').innerHTML=json.content;if($('imgsource'))
{$('imgsource').addEvent('load',function(){if(json.thumbnail)picture_crop(object_alias,json.object_id,json.thumbnail.thumb_type,json.thumbnail.width,json.thumbnail.height,json.thumbnail.maxwidth,json.thumbnail.maxheight,json.thumbnail.fixedratio,json.thumbnail.imageratio);});}}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send('object_alias='+object_alias+'&object_id='+object_id+'&is_new_design='+is_new_design);}
function userpic_load(from_url,object_alias,object_id)
{var is_new_design=$('is-new-design')?$('is-new-design').value:'';if(from_url)
{var url=$('picture-url-new')?$('picture-url-new').value:'';if($('userpic-url-load'))
{if($('userpic-url-load').hasClass('userpic-start'))return false;if($('userpic-file-load')&&$('userpic-file-load').hasClass('userpic-start'))return false;$('userpic-url-load').innerHTML='Загрузка...';$('userpic-url-load').addClass('userpic-start');if($('userpic-file-load'))$('userpic-file-load').addClass('userpic-start');}
new Request({url:'/user/changeuserpic',method:'post',data:{url:url,from_url:true,object_alias:object_alias,object_id:object_id,is_new_design:is_new_design},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);if($('userpic-url-load'))
{$('userpic-url-load').innerHTML='Загрузить';$('userpic-url-load').removeClass('userpic-start');if($('userpic-file-load'))$('userpic-file-load').removeClass('userpic-start');}
return false;}
if(json.content&&json.thumbnail)
{$('crop-image').innerHTML=json.content;userpic_new_return();if($('imgsource'))
{$('imgsource').addEvent('load',function(){picture_crop(object_alias,json.object_id,json.thumbnail.thumb_type,json.thumbnail.width,json.thumbnail.height,json.thumbnail.maxwidth,json.thumbnail.maxheight,json.thumbnail.fixedratio,json.thumbnail.imageratio);});}
else
{(function(){picture_crop(object_alias,json.object_id,json.thumbnail.thumb_type,json.thumbnail.width,json.thumbnail.height,json.thumbnail.maxwidth,json.thumbnail.maxheight,json.thumbnail.fixedratio,json.thumbnail.imageratio);}).delay(500);}}
if($('userpic-url-load'))
{$('userpic-url-load').innerHTML='Загрузить';$('userpic-url-load').removeClass('userpic-start');if($('userpic-file-load'))$('userpic-file-load').removeClass('userpic-start');}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
else
{var file=$('picture-new-file')&&$('picture-new-file').files&&$('picture-new-file').files[0]?$('picture-new-file').files[0]:null;var xhr=new XMLHttpRequest();upload=xhr.upload;formData=new FormData();formData.append('object_alias',object_alias);formData.append('object_id',object_id);formData.append('is_new_design',is_new_design);formData.append('file',file);if($('userpic-file-load'))
{if($('userpic-file-load').hasClass('userpic-start'))return false;if($('userpic-url-load')&&$('userpic-url-load').hasClass('userpic-start'))return false;$('userpic-file-load').innerHTML='Загрузка...';$('userpic-file-load').addClass('userpic-start');if($('userpic-url-load'))$('userpic-url-load').addClass('userpic-start');}
xhr.onreadystatechange=function(){if(xhr.readyState==4)
if((xhr.status>=200&&xhr.status<300)||xhr.status==304){this.response=this.response||this.responseText;var json=strToJson(this.response);prepare(json);if(json.message)
{alert(json.message);if($('userpic-file-load'))
{$('userpic-file-load').innerHTML='Загрузить с компьютера';$('userpic-file-load').removeClass('userpic-start');if($('userpic-url-load'))$('userpic-url-load').removeClass('userpic-start');}
return false;}
if(json.content&&json.thumbnail)
{$('crop-image').innerHTML=json.content;userpic_new_return();if($('imgsource'))
{$('imgsource').addEvent('load',function(){picture_crop(object_alias,json.object_id,json.thumbnail.thumb_type,json.thumbnail.width,json.thumbnail.height,json.thumbnail.maxwidth,json.thumbnail.maxheight,json.thumbnail.fixedratio,json.thumbnail.imageratio);});}
else
{(function(){picture_crop(object_alias,json.object_id,json.thumbnail.thumb_type,json.thumbnail.width,json.thumbnail.height,json.thumbnail.maxwidth,json.thumbnail.maxheight,json.thumbnail.fixedratio,json.thumbnail.imageratio);}).delay(300);}}
if($('userpic-file-load'))
{$('userpic-file-load').innerHTML='Загрузить с компьютера';$('userpic-file-load').removeClass('userpic-start');if($('userpic-url-load'))$('userpic-url-load').removeClass('userpic-start');}}else onerror.call(xhr);};xhr.open('POST','/user/changeuserpic',false);xhr.setRequestHeader('X-Requested-With','XMLHttpRequest');xhr.send(formData);}}
function userpic_save(object_alias,object_id,type,x,y,w,h,imageratio)
{var is_new_design=$('is-new-design')?$('is-new-design').value:'';if($('userpic-save-btn'))
{if($('userpic-save-btn').hasClass('userpic-start'))
{return false;}
$('userpic-save-btn').innerHTML='Сохранение...';$('userpic-save-btn').addClass('userpic-start');}
new Request({url:'/user/saveuserpic',method:'post',data:{object_alias:object_alias,object_id:object_id,type:type,x:x,y:y,w:w,h:h,imageratio:imageratio,is_new_design:is_new_design},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);if($('userpic-save-btn'))
{$('userpic-save-btn').innerHTML='Сохранить';$('userpic-save-btn').removeClass('userpic-start');}
return false;}
if(json.url&&$('profile-avatar')&&(object_alias=='userpic'||object_alias=='auface'||object_alias=='grouppic'||object_alias=='mobpic'||object_alias=='awardpic'))
{$('profile-avatar').setAttribute('style','background-image:url('+json.url+')');$(object_alias+'-edit-popup').destroy();}
if(json.url&&$('profile-avatar')&&(object_alias=='profilepic'||object_alias=='authorpic'||object_alias=='groupprofilepic'||object_alias=='mobprofilepic'||object_alias=='awardprofilepic'))
{$('profile-bg-wrapper').setAttribute('style','margin-top:20px;background:#fff url('+json.url+') center center no-repeat;');$(object_alias+'-edit-popup').destroy();if(object_alias=='authorpic')$('profile-bg-wrapper').addClass('issetpic');}
if($('userpic-save-btn'))
{$('userpic-save-btn').innerHTML='Сохранить';$('userpic-save-btn').removeClass('userpic-start');}
if(typeof(ga)=='function')
{ga('send','pageview','/virtual_url/'+object_alias+'/change/'+object_id);}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function userpic_new()
{if($('picture-default'))$('picture-default').hide();if($('picture-new'))$('picture-new').show();if($('cropframe'))$('cropframe').hide();if($('imglayer'))$('imglayer').style.opacity='1';if($('body'))
{$('body').removeEvent('keyup',function(){});$('body').addEvent('keyup',function(e){var code=e.code||e.keyCode||e.which;if(code==27)userpic_new_return();});}}
function userpic_new_return()
{if($('picture-new'))$('picture-new').hide();if($('picture-default'))$('picture-default').show();if($('cropframe'))$('cropframe').show();if($('imglayer'))$('imglayer').style.opacity='0.5';if($('body'))$('body').removeEvent('keyup',function(){});}
function userpic_delete(object_alias,object_id)
{if(!confirm('Вы действительно хотите удалить файл?'))return false;if($('profile-bg-action'))$('profile-bg-action').value='current';new Request({method:'post',data:{object_alias:object_alias,object_id:object_id},url:'/user/deleteuserpic',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message)
{alert(json.message);return false;}
else
{var object_wrappers=['profilepic','authorpic','groupprofilepic'];if($('profile-bg-wrapper')&&object_wrappers.indexOf(object_alias)>-1)$('profile-bg-wrapper').setAttribute('style','');if($('profile-avatar')&&object_wrappers.indexOf(object_alias)==-1)$('profile-avatar').setAttribute('style','');if($(object_alias+'-edit-popup'))$(object_alias+'-edit-popup').dispose();if($('profile-bg-btn')&&object_wrappers.indexOf(object_alias)>-1)$('profile-bg-btn').innerHTML='Добавить обложку';if($('userpic-edit-a')&&object_wrappers.indexOf(object_alias)==-1)$('userpic-edit-a').innerHTML='<span class="i-tag-add" style="margin-left:-3px;"></span>Добавить';if(object_alias=='authorpic')$('profile-bg-wrapper').removeClass('issetpic');}}}).send();if($('profile-bg-name'))$('profile-bg-name').innerHTML='загрузить обложку';if($('profile-bg-url'))$('profile-bg-url').value='';}
var picture_crop=function(object_alias,object_id,type,width,height,maxwidth,maxheight,fixedratio,imageratio)
{if(typeof cropclass!='undefined')
{cropclass.removeEvents('onCrop');delete cropclass;}
var max=maxwidth<maxheight?maxwidth:maxheight;if($('popup-window')&&maxheight>0)$('popup-window').style.minHeight=(maxheight+175)+'px';cropclass=new CwCrop({onCrop:function(values){userpic_save(object_alias,object_id,type,values.x,values.y,values.w,values.h,imageratio);},minsize:{x:width,y:height},maxsize:{x:maxwidth,y:maxwidth/fixedratio},initialposition:{x:0,y:0},initialmax:true,fixedratio:fixedratio});if($('draghandle'))
{var hammer=new Hammer.Manager($('draghandle'));var pan=new Hammer.Pan();hammer.add([pan]);hammer.on("panstart panmove panend pancancel",function(e){if(e.pointers&&e.pointers.length>0)
{e.page={x:e.pointers[0].pageX,y:e.pointers[0].pageY};}
if(e.type=='panstart')
{cropclass.myMove.start(e);}
else if(e.type=='panmove')
{cropclass.myMove.drag(e);}
else if(e.type=='pancancel'||e.type=='panend')
{cropclass.myMove.stop(e);}
var e=new Event(e).stop();});}
if($('resizeHandleXY'))
{var hammer2=new Hammer.Manager($('resizeHandleXY'));var pan2=new Hammer.Pan();hammer2.add([pan2]);hammer2.on("panstart panmove panend pancancel",function(e){if(e.pointers&&e.pointers.length>0)
{e.page={x:e.pointers[0].pageX,y:e.pointers[0].pageY};}
if(e.type=='panstart')
{cropclass.myResizeXY.start(e);}
else if(e.type=='panmove')
{cropclass.myResizeXY.drag(e);}
else if(e.type=='pancancel'||e.type=='panend')
{cropclass.myResizeXY.stop(e);}
var e=new Event(e).stop();});}}
function set_critic_review_param(param_id,param_type)
{if($(param_type+'-'+param_id).hasClass('selected'))
{$(param_type+'-'+param_id).removeClass('selected');$(param_type+'-id').value=0;return false;}
var btn_links=$$('.'+param_type+'-params');btn_links.each(function(item){item.removeClass('selected');});if($(param_type+'-select'))
{$(param_type+'-select').removeClass('selected');}
if($(param_type+'-'+param_id).getParent().tagName=='SELECT')
{$(param_type+'-select').addClass('selected');for(var i=0;i<$(param_type+'-select').options.length;i++)
{if($(param_type+'-select').options[i].id==param_type+'-'+param_id)$(param_type+'-select').options[i].selected=true;}}
else
{$(param_type+'-'+param_id).addClass('selected');}
$(param_type+'-id').value=param_id;return;}
function critic_add()
{if(typeof $('critic-add-name')!='undefined')
{var critic_name=$('critic-add-name').value;var critic_login=$('critic-add-login').value;var media_id=$('media-id').value;if(critic_name=='')
{alert('Необходимо ввести имя критика!');return false;}
else if(critic_login=='')
{alert('Необходимо ввести логин критика на ЛайвЛиб!');return false;}
else if(media_id==''||media_id==0)
{alert('Необходимо выбрать медиа для критика!');return false;}
new Request({url:'/media/addcritic',method:'post',data:{critic_name:critic_name,critic_login:critic_login,media_id:media_id},onComplete:function(json)
{json=strToJson(json);prepare(json);if(!json.error_code&&json.critic_id)
{if($('critic-select'))
{$('critic-select').innerHTML+='<option id="critic-'+json.critic_id+'" value='+json.critic_id+'>'+critic_name+'</option>';}
else
{$('critic-wrapper').innerHTML+='<a class="btn-link critic-params" id="critic-'+json.critic_id+'" href="javascript:void(0);" title="'+critic_name+'" onclick="set_critic_review_param('+json.critic_id+', \'critic\');">'+critic_name+'</a>';}
$('critic-add-form').style.display='none';set_critic_review_param(json.critic_id,'critic');return false;}
else if(json.error_code=='-1')
{alert('Указанное медиа не найдено!');return false;}
else if(json.error_code=='-2')
{alert('Читатель с таким логином не найден!');return false;}}}).send();}
return;}
function media_add()
{if(typeof $('media-add-name')!='undefined')
{var media_name=$('media-add-name').value;var media_url=$('media-add-url').value;if(media_name=='')
{alert('Необходимо ввести название медиа!');return false;}
else if(media_url=='')
{alert('Необходимо ввести ссылку медиа!');return false;}
new Request({url:'/media/addmedia',method:'post',data:{media_name:media_name,media_url:media_url},onComplete:function(json)
{json=strToJson(json);prepare(json);if(!json.error_code&&json.media_id)
{if($('media-select'))
{$('media-select').innerHTML+='<option id="media-'+json.media_id+'" value='+json.media_id+'>'+media_name+'</option>';}
else
{$('media-wrapper').innerHTML+='<a class="btn-link media-params" id="media-'+json.media_id+'" href="javascript:void(0);" title="'+media_name+'" onclick="set_critic_review_param('+json.media_id+', \'media\');">'+media_name+'</a>';}
$('media-add-form').style.display='none';set_critic_review_param(json.media_id,'media');return false;}}}).send();}
return;}
function group_add()
{if(typeof $('group-add-name')!='undefined')
{var group_name=$('group-add-name').value;if(group_name=='')
{alert('Необходимо ввести название группы!');return false;}
new Request({url:'/topexclude/addgroup',method:'post',data:{group_name:group_name},onComplete:function(json)
{json=strToJson(json);prepare(json);if(!json.error_code&&json.group_id)
{if($('group-select'))
{$('group-select').innerHTML+='<option id="group-'+json.group_id+'" value='+json.group_id+'>'+group_name+'</option>';}
else
{$('group-wrapper').innerHTML+='<a class="btn-link group-params" id="group-'+json.group_id+'" href="javascript:void(0);" title="'+group_name+'" onclick="set_critic_review_param('+json.group_id+', \'group\');">'+group_name+'</a>';}
$('group-add-form').style.display='none';set_critic_review_param(json.group_id,'group');return false;}}}).send();}
return;}
function ll_ub_change_edition_edit(edition_id,actual_id,alias,userbook_id)
{if(alias==null||alias=='undefined')alias='';if(userbook_id==null||userbook_id=='undefined')userbook_id=0;var is_new_design=$('is-new-design')&&$('is-new-design').value?$('is-new-design').value:'';var params="edition_id="+edition_id+'&actual_id='+actual_id+'&alias='+alias+'&userbook_id='+userbook_id+'&is_new_design='+is_new_design;var htmlname='-ub-editions-'+edition_id;if($('a'+htmlname))
{if(!$('xa-change-edition-'+edition_id+'-'+userbook_id).isDisplayed())
{if($('ub-data-'+edition_id))$('ub-data-'+edition_id).hide();$('xa-change-edition-'+edition_id+'-'+userbook_id).show();}
else
{return false;}}
new Request({url:'/user/bookeditions',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json['error'])
{alert(json.error);}
else
{$('div'+htmlname).show();$('div'+htmlname).innerHTML=json.content;}},onRequest:initAd,onSuccess:function()
{closeAd();},onFailure:function()
{$('xa-change-edition-'+edition_id+'-'+userbook_id).hide();if($('ub-data-'+edition_id))$('ub-data-'+edition_id).show();failure();}}).send(params);return false;}
function ll_ub_change_edition_cancel(edition_id,userbook_id)
{if($('xa-change-edition-'+edition_id+'-'+userbook_id))$('xa-change-edition-'+edition_id+'-'+userbook_id).hide();if($('ub-data-'+edition_id))$('ub-data-'+edition_id).show();}
function ll_ub_change_edition(edition_id,new_edition_id,userbook_id,is_work)
{var el;if(is_work)
{el='ub-work-edition-id-'+edition_id;}
else
{el='ub-edition-id-'+edition_id;}
$(el).value=new_edition_id;userbook_update_new(edition_id,edition_id,userbook_id);if($('a-ub-editions-'+edition_id))
{$('a-ub-editions-'+edition_id).setAttribute('onclick','ll_ub_change_edition_edit('+edition_id+','+new_edition_id+', \'p\', '+userbook_id+');');}
ll_ub_change_edition_cancel(edition_id,userbook_id);}
function ll_rec_save_ub_wish(book_id,element_name,rand_id,star_size)
{var element=$(element_name);if(star_size=='s')
{var halfs=false;}
else
{star_size='l';var halfs=true;}
if(element.hasClass('active'))
{ll_ub_quick_save(book_id,book_id,-2,0,0,0);element.addClass('inactive');element.removeClass('active');element.innerHTML='Хочу прочитать';ll_stars_new(book_id,0,halfs,star_size,false,rand_id);books_selected--;}
else
{ll_ub_quick_save(book_id,book_id,0,0,0,0);books_selected++;element.addClass('active');element.removeClass('inactive');}
update_books_title();}
function check_message()
{var count=0;$$('.message-checkbox').each(function(item){if(item.checked)
{count++;}});if(count>0)
{var page=$('message-page')&&$('message-page').value?$('message-page').value:'';var base='сообщен';if(page=='notifications')
{base='уведомлен';}
$('messages-checked-text').innerHTML=human_ending(count,base,'ий','ие','ия')+' выбрано';$('messages-checked-text').style.display='block';if(!$('checked-form').isVisible())$('checked-form').style.display='block';}
else
{$('messages-checked-text').style.display='';$('checked-form').style.display='';}}
function ll_get_comment_branch(comment_id)
{var is_new_design=$('is-new-design')?$('is-new-design').value:'';if($('comment-loading-holder-'+comment_id))
{if(is_new_design!='')$('comment-loading-holder-'+comment_id).innerHTML='<span class="recloader" style="position:absolute;bottom:15px" id="comment-loading-'+comment_id+'"></span>';else $('comment-loading-holder-'+comment_id).innerHTML='<img id="comment-loading-'+comment_id+'" src="https://s.livelib.ru/img/loading.gif">';}
new Request({url:'/comment/getbranch',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert('Ошибка!');return false;}
else if($('comment-loading-'+comment_id))
{if($('comment-loading-'+comment_id))$('comment-loading-'+comment_id).destroy();$('commentbranch'+comment_id).innerHTML=json.content;}},onRequest:initAd,onSuccess:function()
{closeAd();},}).send('comment_id='+comment_id+'&is_new_design='+is_new_design);}
function service_pinger(is_pinger)
{var elements=$$('.sysmsg-row');var message_ids='';if(elements.length>0)
{for(var i=0;i<elements.length;i++)
{var id=elements[i].id.substring(7);message_ids+=id+',';}}
if(is_pinger)
{new Request({method:'post',url:'/service/pinger',initialDelay:30000,delay:60000,limit:120000,onComplete:function(json){json=strToJson(json);service_pinger_complete(json);}}).startTimer({message_ids:message_ids});}
else
{new Request({method:'post',url:'/service/pinger',onComplete:function(json){json=strToJson(json);service_pinger_complete(json);}}).send({message_ids:message_ids});}}
function service_pinger_complete(json)
{if(!json&&$('tinyalert'))
{if($('server_err_msg'))
{if(!($('server_err_msg')).isVisible())
$('server_err_msg').show();}
else
{$('tinyalert').innerHTML+='<div id="server_err_msg" class="red"><a href="javascript:void(0)" title="Закрыть" class="action a-close" onclick="this.getParent().hide();"><span class="i-clear"></span></a>Внимание! Нет соединения с сервером. Возможно, пропал  интернет или обновляется сайт.</div>';}}
else
{if($('server_err_msg'))
$('server_err_msg').hide();if($('msgs'))
{var message='';if(json.count>0&&json.count_notify==0)
message=' ('+json.count+')';if(json.count>0&&json.count_notify>0)
message=' ('+json.count+'/'+json.count_notify+')';if(json.count==0&&json.count_notify>0)
message=' (-/'+json.count_notify+')';$('msgs').innerHTML='Сообщения'+message;$('msgs').style.fontWeight=json.count>0||json.count_notify>0?'bold':'normal';}
if($('msgs-new'))
$('msgs-new').innerHTML=json.count>0?json.count:'';if($('ntfs-new'))
$('ntfs-new').innerHTML=json.count_notify>0?json.count_notify:'';if($('msgs-new-header-count'))
{if(json.count>0)
{var tmp_msg_count=json.count>999?Math.round(json.count/1000)+'K':json.count;$('msgs-new-header-count').style.visibility='visible';$('msgs-new-header-count').innerHTML='<span>'+tmp_msg_count+'</span>';if($('msgs-new-header'))
$('msgs-new-header').setAttribute('title',human_ending(json.count,'нов','ых','ое','ых')+' '+human_ending(json.count,'сообщен','ий','ие','ия','','','',true));}
else
{$('msgs-new-header-count').style.visibility='hidden';if($('msgs-new-header'))
$('msgs-new-header').setAttribute('title','Для вас нет новых сообщений');}}
if($('ntfs-new-header-count'))
{if(json.count_notify>0)
{var tmp_ntfs_count=json.count_notify>999?Math.round(json.count_notify/1000)+'K':json.count_notify;$('ntfs-new-header-count').style.visibility='visible';$('ntfs-new-header-count').innerHTML='<span>'+tmp_ntfs_count+'</span>';if($('ntfs-new-header'))
$('ntfs-new-header').setAttribute('title',human_ending(json.count_notify,'нов','ых','ое','ых')+' '+human_ending(json.count_notify,'уведомлен','ий','ие','ия','','','',true));}
else
{$('ntfs-new-header-count').style.visibility='hidden';if($('ntfs-new-header'))
$('ntfs-new-header').setAttribute('title','Для вас нет новых уведомлений');}}
if($('msgsin')&&!$('is-new-design'))
{$('msgsin').innerHTML='Непрочитанные'+(json.count>0?' ('+json.count+')':'');$('msgsin').style.fontWeight=json.count>0?'bold':'normal';}
else if($('is-new-design'))
{if(json.count>0)
{if(!$('ll2015b-msgs-unread-li'))
{var unread_li=new Element('LI',{id:'ll2015b-msgs-unread-li',class:'standart'});var unread_li_a=new Element('A',{id:'msgsin',href:'/messages/unread',title:'Непрочитанные сообщения'});unread_li_a.innerHTML='Непрочитанные';unread_li_a.inject(unread_li);unread_li.inject($('ll2015b-msgs-sent-li'),'after');}}
else if($('ll2015b-msgs-unread-li'))
{$('ll2015b-msgs-unread-li').dispose();}
if($('ll2015b-msgs-inbox-a')) $('ll2015b-msgs-inbox-a').innerHTML='Полученные'+(json.count>0?' ('+json.count+')':'');if($('ll2015b-msgs-inbox-li'))$('ll2015b-msgs-inbox-li').style.fontWeight=json.count>0?'bold':'normal';if(json.count_important>0)
{if(!$('ll2015b-msgs-important-li'))
{var important_li=new Element('LI',{id:'ll2015b-msgs-important-li',class:'standart'});var important_li_a=new Element('A',{id:'ll2015b-msgs-important-a',href:'/messages/important',title:'Важные'});important_li_a.innerHTML='Важные ('+json.count_important+')';important_li_a.inject(important_li);important_li.inject($('ll2015b-msg-notification-li'),'before');}
else
{$('ll2015b-msgs-important-a').innerHTML='Важные ('+json.count_important+')';}}
else if($('ll2015b-msgs-important-li'))
{$('ll2015b-msgs-important-li').dispose();}}
if($('msgsnotifications'))
{$('msgsnotifications').innerHTML='Уведомления'+(json.count_notify>0?' ('+json.count_notify+')':'');$('msgsnotifications').style.fontWeight=json.count_notify>0?'bold':'normal';}
if(!json.messages)
return false;if(json.messages.length>0)
{var prev_id=0;for(var i=0;i<json.messages.length;i++)
{if(json.messages[i].is_deleted&&$('sysmsg-'+json.messages[i].message_id))
{$('sysmsg-'+json.messages[i].message_id).dispose();continue;}
if(json.messages[i].messacge&&!$('sysmsg-'+json.messages[i].message_id))
{$('system-msgs-holder').innerHTML=json.messages[i].message+$('system-msgs-holder').innerHTML;if(prev_id>0)
{$('sysmsg-'+json.messages[i].message_id).inject($('sysmsg-'+prev_id),'after');}}
if($('sysmsg-'+json.messages[i].message_id))
prev_id=json.messages[i].message_id;}}
sysmsg_update();var elements=$$('.sysmsg-row');var message_ids='';if(elements.length>0)
{for(var i=0;i<elements.length;i++)
{var id=elements[i].id.substring(7);message_ids+=id+',';}}}}
function check_message_all()
{$$('.message-checkbox').each(function(item){if($('message-check-all').checked)
{item.checked=true;}
else
{item.checked=false;}});check_message();}
function togglecomments(path)
{var value=Cookie.read('expandcomments');if(!value)value=0;Cookie.write('expandcomments',value==0?1:0,{duration:365*10});location.href=path;}
function author_advanced(author_id,target)
{var elem=$('author-tags-'+author_id);if(elem&&target)
{var display=elem.style.display=='none'?true:false;target.innerHTML=display?'<span class="i-up-small"></span>':'<span class="i-down-small"></span>';target.setAttribute('title',display?'Свернуть':'Развернуть');target.toggleClass('open');}
elem.toggle();}
var author_born=function(page_no,current_date)
{var is_new_design=$('is-new-design')?$('is-new-design').value:'';new Request({url:'/author/born',method:'post',data:{page_no:page_no,current_date:current_date,is_new_design:is_new_design},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{return false;}
if(json.content&&$('born-authors-v'))
{var div=new Element('div');div.innerHTML=json.content;$('born-authors-v').appendChild(div);}
if(json.end_data)
{if($('born-authors-more'))$('born-authors-more').dispose();}
else if($('a-born-author-more'))
{$('a-born-author-more').setAttribute('onclick','author_born('+(page_no+1)+',"'+current_date+'");');}}}).send();}
var author_change_date=function(day,month)
{var current_day=$('calendar-day')?$('calendar-day').value:1;var current_month=$('calendar-month')?$('calendar-month').value:1;if(current_month!=month)
{if($('calendar-day'))$('calendar-day').value=day;author_changemonth(current_month,month-current_month);return false;}
if(current_day==day)
{return false;}
var is_new_design=$('is-new-design')?$('is-new-design').value:'';var is_show=$('born-authors-v')&&$('born-authors-v').style.display!='none'?true:false;current_month=parseInt(current_month);current_day=parseInt(current_day);if($('calendar-date-'+(current_month<10?'0':'')+current_month+'-'+current_day))
{$('calendar-date-'+(current_month<10?'0':'')+current_month+'-'+current_day).removeClass('current');}
if($('calendar-date-'+(month<10?'0':'')+month+'-'+day))
{$('calendar-date-'+(month<10?'0':'')+month+'-'+day).addClass('current');}
if($('calendar-day'))$('calendar-day').value=day;if($('calendar-month'))$('calendar-month').value=month;new Request({url:'/author/changeday',method:'post',data:{day:day,month:month,is_new_design:is_new_design,is_show:is_show},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{$('born-authors').innerHTML='Писатели не найдены';return false;}
if(json.content&&$('born-authors'))
{$('born-authors').innerHTML=json.content;}
else
{$('born-authors').innerHTML='Писатели не найдены';}}}).send();}
var change_author_month=false;var author_changemonth=function(current,value)
{if(change_author_month)return false;var months=['январь','февраль','март','апрель','май','июнь','июль','август','сентябрь','октябрь','ноябрь','декабрь'];if(months[current-1+value])
{$('current-month').innerHTML=months[current-1+value];if($('prev-month'))$('prev-month').setAttribute('onclick','author_changemonth('+(parseInt(current)+parseInt(value))+',-1);');if($('next-month'))$('next-month').setAttribute('onclick','author_changemonth('+(parseInt(current)+parseInt(value))+',1);');}
else
{return false;}
change_author_month=true;var current_day=$('calendar-day')?$('calendar-day').value:1;var current_month=$('calendar-month')?(parseInt($('calendar-month').value)+parseInt(value)):1;var is_new_design=$('is-new-design')?$('is-new-design').value:'';var is_show=$('born-authors-v')&&$('born-authors-v').style.display!='none'?true:false;new Request({url:'/author/changemonth',method:'post',data:{day:current_day,month:current_month,is_new_design:is_new_design,is_show:is_show},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{$('born-authors').innerHTML='Писатели не найдены';change_author_month=false;return false;}
if(json.content&&$('born-authors'))
{$('born-authors').innerHTML=json.content;}
else
{$('born-authors').innerHTML='Писатели не найдены';}
if(json.calendar&&$('author-calendar'))
{$('author-calendar').innerHTML=json.calendar;}
change_author_month=false;return false;}}).send();}
var author_add_country=function()
{var country_code=$('author-country-select').value;if(country_code==0||country_code==''||!country_code)return false;if($('author-country-'+country_code))
{alert('Страна уже привязана к автору');return false;}
var country_name=$('author-country-select').options[$('author-country-select').selectedIndex].text;var html='<span id="author-country-'+country_code+'"><input type="hidden" name="author[countries]['+country_code+']" value="'+country_name+'">'+country_name+'<a class="action" href="javascript:void(0);" onclick="'+'$(\'author-country-'+country_code+'\').dispose();"><span class="i-delete"></span></a>, </span>';$('current-country').innerHTML+=html;}
var author_add_data=function(alias)
{var value=$('author-'+alias+'-select').value;if(value==0||value==''||!value)return false;if($('author-'+alias+'-'+value))
{alert('Объект уже привязан к автору');return false;}
var name=$('author-'+alias+'-select').options[$('author-'+alias+'-select').selectedIndex].text;var fieldname=alias=='type'?'author_types':alias;var html='<span id="author-'+alias+'-'+value+'"><input type="hidden" name="author['+fieldname+']['+value+']" value="'+name+'">'+name+'<a class="action" href="javascript:void(0);" onclick="'+'$(\'author-'+alias+'-'+value+'\').dispose();"><span class="i-delete"></span></a>, </span>';$('current-'+alias).innerHTML+=html;}
var notifications_read_all=function()
{var top_notification_id=0;$$('.message-row').each(function(item,key){if(key==0)
{top_notification_id=$(item).dataset.message_id;return false;}});location.href='/messages/notify/group/'+top_notification_id+'/readall';}
var set_ntfc_group=function()
{var is_grouped=0;if($('ntfc-groupped').checked)is_grouped=1;var date=new Date;date.setDate(date.getDate()+365);document.cookie='llntfcgroup='+is_grouped+'; path=/; expires='+date.toUTCString();location.reload();}
var bind_message_filter=function(m_page,m_message_id,m_filter)
{var is_new_design=$('is-new-design')?$('is-new-design').value:'';if(m_page==null||m_page=='undefined'||m_page==''||m_message_id==null||m_message_id=='undefined'||m_message_id=='')return false;new Request({url:'/message/bindfilter',method:'post',data:{page:m_page,message_id:m_message_id,filter:m_filter,is_new_design:is_new_design},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{return false;}
if($('messages-filter-'+m_page))
{$('messages-filter-'+m_page).innerHTML=json.filter_content;}}}).send();}
var confirmemail_close=function()
{$$('.popup-back-ce').hide();if($('popup-confirm-email'))$('popup-confirm-email').hide();}
function send_email_confirmation()
{new Request({url:'/account/sendemailconfirmation',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{return false;}
$('confirm-email1').style.display='none';$('confirm-email2').style.display='block';}}).send();}
function confirm_email()
{if($('confirm-code').value=='')return false;var code=$('confirm-code').value;new Request({url:'/account/emailconfirm',method:'post',onComplete:function(json)
{json=strToJson(json);if(json.error)
{alert('Неправильный код подтверждения');return false;}
location.reload();}}).send('code='+code);}
function email_prepare(url)
{new Request({url:'/account/checkemailconfirmed',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.confirm_email)return false;location.href=url;}}).send();}
function attach_post_object(var_post_id,var_object_id,var_object_alias)
{if(var_object_id=='undefined'||typeof(var_object_id)=='undefined'||var_object_alias=='undefined'||typeof(var_object_alias)=='undefined'||var_post_id=='undefined'||typeof(var_post_id)=='undefined')return false;new Request({url:'/post/attachobject',method:'post',data:{post_id:var_post_id,object_id:var_object_id,object_alias:var_object_alias},onComplete:function(json)
{json=strToJson(json);if(json.error_code)
{alert(json.message);return false;}
else
{$('attach-row-'+var_object_alias+'-status-'+var_object_id).innerHTML='<span class="i-info"></span>';$('attach-link-'+var_object_alias+'-'+var_object_id).innerHTML='отвязать';$('attach-link-'+var_object_alias+'-'+var_object_id).onclick='';$('attach-link-'+var_object_alias+'-'+var_object_id).removeEvents('click').addEvent('click',function(){unattach_post_object(json.post_object_id)});}}}).send();}
function unattach_post_object(var_post_object_id)
{if(var_post_object_id=='undefined'||typeof(var_post_object_id)=='undefined')return false;new Request({url:'/post/unattachobject',method:'post',data:{post_object_id:var_post_object_id},onComplete:function(json)
{json=strToJson(json);if(json.error_code)
{alert(json.message);return false;}
else
{$('attach-row-'+json.object_alias+'-status-'+json.object_id).innerHTML='';$('attach-link-'+json.object_alias+'-'+json.object_id).innerHTML='привязать';$('attach-link-'+json.object_alias+'-'+json.object_id).onclick='';$('attach-link-'+json.object_alias+'-'+json.object_id).removeEvents('click').addEvent('click',function(){attach_post_object(json.post_id,json.object_id,json.object_alias)});}}}).send();}
function email_check()
{new Request({url:'/account/checkemailconfirmed',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.confirm_email)return false;location.href=url;}}).send();}
var analitics_sort=function(type,param)
{var elements=$$('.filter-sort-'+type+'-arrow');var el=$('filter-sort-'+type+'-'+param);if(!el||!elements||elements.length<=0)return false;if(el.style.display!='none')
{$('form[order]').value=$('form[order]').value==''||$('form[order]').value=='desc'?'asc':'desc';}
else
{$('form[order]').value='desc';}
$('form[table]').value=type!='stats'?type:'';$('form[sort]').value=param;$('userbook-form-div').submit();}
genre_query_back=true;var ll_genre_hint=function(event,input_element,result_element)
{if(event.keyCode>=9&&event.keyCode<27)return false;if(event.keyCode>=33&&event.keyCode<=46)return false;if(event.keyCode>=91&&event.keyCode<=93)return false;if(event.keyCode>=112&&event.keyCode<=157)return false;if(event.keyCode==27&&typeof(newrecs_clear_genres)=='function')
{newrecs_clear_genres();return false;}
text=$(input_element).value.trim();if(text=='')return false;if(!genre_query_back)return false;genre_query_back=false;new Request({url:'/genre/searchrec',method:'post',data:{genre:text},onComplete:function(json)
{genre_query_back=true;json=strToJson(json);if(json.content)
{$(result_element).innerHTML=json.content;$('genre-list-holder').style.display='block';if(text!=$(input_element).value.trim())
{ll_genre_hint({keyCode:158},input_element,result_element);}}
return false;}}).send();}
var genre_search_back=true;var ll_genre_search=function(event,page,input_element,result_element)
{if(event.keyCode>=9&&event.keyCode<27)return false;if(event.keyCode>=33&&event.keyCode<=46)return false;if(event.keyCode>=91&&event.keyCode<=93)return false;if(event.keyCode>=112&&event.keyCode<=157)return false;if(event.keyCode==27)
{return false;}
var text=$(input_element).value.trim();if(text=='')return false;if(!genre_search_back)return false;genre_search_back=false;new Request({url:'/genre/searchgenre',method:'post',data:{genre:text,page:page},onComplete:function(json)
{genre_search_back=true;json=strToJson(json);if($('form[genre_id]'))$('form[genre_id]').value=0;if(json.content)
{$(result_element).innerHTML=json.content;if($(result_element).style.display=='none')
{clicktoggle(result_element,$(input_element));}
if(text!=$(input_element).value.trim())
{ll_genre_search({keyCode:158},page,input_element,result_element);}}
return false;}}).send();}
var analytics_genre=function(genre_id,genre_name)
{if($('form[genre_id]'))$('form[genre_id]').value=genre_id;if($('genre-input'))$('genre-input').value=genre_name;if($('genre-list-holder'))$('genre-list-holder').hide();if($('agenre-clear'))$('agenre-clear').show('inline-block');}
var analytics_genre_clear=function()
{if($('form[genre_id]'))$('form[genre_id]').value=0;if($('genre-input'))$('genre-input').value='';if($('genre-list-holder'))$('genre-list-holder').hide();if($('agenre-clear'))$('agenre-clear').hide();}
function analytics_genre_disabled(is_disabled)
{if(is_disabled)
{if($('genre-input'))$('genre-input').addClass('disabled');if($('genre-input'))$('genre-input').disabled=true;}
else
{if($('genre-input'))$('genre-input').removeClass('disabled');if($('genre-input'))$('genre-input').disabled=false;}}
var analytics_genre_default=function()
{$('genre-list-holder').innerHTML=popular_genres;clicktoggle('genre-list-holder',this);}
var analytics_book=function(book_id,book_name)
{if($('form[book_id]'))$('form[book_id]').value=book_id;if($('afind-book'))$('afind-book').value=book_name;if($('afind-res'))$('afind-res').innerHTML='';if($('genre-list-holder'))$('genre-list-holder').hide();if($('abook-clear'))$('abook-clear').show('inline');analytics_genre_disabled(true);analytics_author_disabled(true);}
var analytics_book_clear=function()
{if($('form[book_id]'))$('form[book_id]').value=0;if($('afind-book'))$('afind-book').value='';if($('abook-clear'))$('abook-clear').hide();analytics_genre_disabled(false);analytics_author_disabled(false);}
var analytics_author=function(author_id,author_name)
{if($('form[author_id]'))$('form[author_id]').value=author_id;if($('author-input'))$('author-input').value=author_name;if($('author-list-holder'))$('author-list-holder').innerHTML='';if($('genre-list-holder'))$('genre-list-holder').hide();if($('author-clear'))$('author-clear').show('inline');}
var analytics_author_default=function()
{$('author-list-holder').innerHTML=popular_authors;clicktoggle('author-list-holder',this);searchauthorhints['author-input']='';}
var analytics_author_clear=function()
{if($('form[author_id]'))$('form[author_id]').value=0;if($('author-input'))$('author-input').value='';if($('author-list-holder'))$('author-list-holder').hide();if($('author-clear'))$('author-clear').hide();searchauthorhints['author-input']='';}
function analytics_author_disabled(is_disabled)
{if(is_disabled)
{if($('author-input'))$('author-input').addClass('disabled');if($('author-input'))$('author-input').disabled=true;}
else
{if($('author-input'))$('author-input').removeClass('disabled');if($('author-input'))$('author-input').disabled=false;}}
var analytics_load=function(el,filter,page)
{var is_new_design=$('is-new-design')?$('is-new-design').value:'';new Request({url:'/main/analytics',data:{filter:filter,page:page,is_new_design:is_new_design},method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{alert(json.message);return false;}
if(json.content)
{$('table-'+page+'-load').innerHTML=json.content;}
if(json.page_last)
{el.hide();}
else
{el.setAttribute('href','/analytics/'+page+'/'+filter);el.setAttribute('onclick','');el.innerHTML='Подробнее<span class="i-search-down"></span>';}
return false;}}).send();}
var analytics_load_table=function(page,current,page_no,filter)
{var is_new_design=$('is-new-design')?$('is-new-design').value:'';new Request({url:'/main/analyticstable',data:{filter:filter,page:page,is_new_design:is_new_design,page_no:page_no,current:current},method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{alert(json.message);return false;}
if(json.content)
{$('table-container-'+page).innerHTML=json.content;$('table-loader-'+page).dispose();}
return false;}}).send();}
if($('analytic-page')&&$$('.table-analytics-load')&&$$('.table-analytics-load').length>0)
{var elements=$$('.table-analytics-load');for(var i=0;i<elements.length;i++)
{var page=elements[i].id.substring(13);var current=elements[i].getAttribute('data-current');var page_no=elements[i].getAttribute('data-page_no');var filter=elements[i].getAttribute('data-filter');analytics_load_table(page,current,page_no,filter);}}
function cycle_out(work_id,edition_id)
{if(!confirm('Вы уверены, что произведение не входит в циклы?'))return false;new Request({url:'/work/cycleout',data:{work_id:work_id,edition_id:edition_id},method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{alert(json.message);return false;}
if($('work-cycle'))$('work-cycle').dispose();if($('work-cycle-tr'))$('work-cycle-tr').dispose();return false;}}).send();}
function cycle_set(work_id,edition_id,el)
{edition_id=edition_id||0;el=el||'work-cycle-form';new Request({url:'/work/cycleset',data:{work_id:work_id,edition_id:edition_id},method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{alert(json.message);return false;}
if(json.content)
{$(el).innerHTML=json.content;}
return false;}}).send();}
function cycle_search()
{var text=$('search-cycle')?$('search-cycle').value:'';if(!text||text=='')
{alert('Введите текст для поиска!');return false;}
new Request({url:'/work/cyclefind',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{alert(json.message);return false;}
if(json.content)
{$('result-work-div').innerHTML=json.content;}
return false;}}).send($('form-cycle'));}
function cycle_new()
{if($('cycle-result'))$('cycle-result').hide();if($('cycle-new'))$('cycle-new').show();$('is-cycle-new').value=1;if($('cycle-btn-new'))$('cycle-btn-new').hide();if($('cycle-btn-cancel'))$('cycle-btn-cancel').show('inline');if($('cycle-btn-save'))$('cycle-btn-save').hide();if($('cycle-btn-add'))$('cycle-btn-add').show();}
function cycle_cancel()
{if($('cycle-new'))$('cycle-new').hide();if($('cycle-result'))$('cycle-result').show();$('is-cycle-new').value=0;if($('cycle-btn-cancel'))$('cycle-btn-cancel').hide();if($('cycle-btn-new'))$('cycle-btn-new').show('inline');if($('cycle-btn-add'))$('cycle-btn-add').hide();if($('cycle-btn-save')&&$('selection-result')&&$('selection-result').value>0)$('cycle-btn-save').show();}
function cycle_save()
{new Request({url:'/work/cyclesave',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{alert(json.message);return false;}
if(json.url&&json.title&&$('work-cycle'))
{$('work-cycle').innerHTML='<b>Цикл:</b> <a href="'+json.url+'">'+json.title+'</a><br>';}
if($('cycle-form-cont'))$('cycle-form-cont').dispose();return false;}}).send($('cycle-form'));}
var llcontext={};var cotext_replace_start=false;function context_replace(promo,rand,context)
{var el=promo+'-'+rand;var parent=document.getElementById(el)?document.getElementById(el).parentNode.parentNode:null;var parent2=parent!=null&&parent.firstElementChild?parent.firstElementChild:null;var parent3=parent2!=null&&parent2.firstElementChild?parent2.firstElementChild:null;var parent4=parent3!=null&&parent3.firstElementChild?parent3.firstElementChild:null;var style=parent?getComputedStyle(parent,null).display:null;var style2=parent2?getComputedStyle(parent2,null).display:null;var style3=parent3?getComputedStyle(parent3,null).display:null;var style4=null;var style_block=style=='none'||style2=='none'||style3=='none'||style4=='none'||style=='none !important'||style2=='none !important'||style3=='none !important'||style4=='none !important'?true:false;if((window.adblock===undefined||style_block)&&!cotext_replace_start)
{cotext_replace_start=true;if($(promo+'-f-'+rand))
{var is_new_design=$('is-new-design')?$('is-new-design').value:'';if(is_new_design)$(promo+'-f-'+rand).style.paddingTop='30px';if(is_new_design)$(promo+'-f-'+rand).style.marginTop='30px';$(promo+'-f-'+rand).style.marginBottom='30px';$(promo+'-f-'+rand).style.background='#fff';}
inject_context_script(promo+'-f-'+rand,context);}}
function inject_context_script(id,url)
{llcontext={id:id,alias:'llheader',position:'horizontal',url:url};var parent=document.getElementById(id);if(!parent)return;parent.innerHTML='<div style="display:block !important;visibility: visible !important;"'+(id.indexOf('-f-')==-1?'class="header-pshadow"':'')+'><div id="'+id+'" style="display:block !important;padding:20px 0;background:#fff"></div></div>';var script=document.createElement('script');script.type='text/javascript';script.src=(location.protocol=='https:'?'https://':'http://')+location.host+'/'+url+'.js';script.defer='defer';script.async=true;document.head.appendChild(script);}
var soctimers={};var socprepare=socprepare||{};function social_post(object_alias,network,activate,onsettings,object_id,object_alias_queue)
{if($('socpost-notify'))$('socpost-notify').dispose();onsettings=onsettings||false;object_id=object_id||0;object_alias_queue=object_alias_queue||'';if(!activate&&!onsettings)
{$('soc-post-'+object_alias+'-'+network).addClass('unactive');$('soc-post-'+object_alias+'-'+network).setAttribute('onclick','social_post(\''+object_alias+'\', \''+network+'\', '+!activate+', '+object_id+', \''+object_alias_queue+'\')');$('soc-post-'+object_alias+'-'+network+'-input').value=0;return false;}
if(onsettings&&(socprepare[network]||!activate))
{if(!activate&&!confirm('Отключить автоматический шеринг?'))return false;social_post_change(object_alias,network,activate,{},true,object_id,object_alias_queue);return false;}
if(network=='vkontakte')
{var win=window.open((location.protocol=='https:'?'https://':'http://')+location.host+'/oauth/vkontakte','Вконтакте','width=800,height=600');if(soctimers[network])
{clearInterval(soctimers[network]);soctimers[network]=null;}
soctimers[network]=setInterval(function(){social_post_bind(object_alias,network,activate,win,onsettings,object_id,object_alias_queue);},500);}
else if(network=='facebook')
{var win=window.open((location.protocol=='https:'?'https://':'http://')+location.host+'/oauth/facebook','Facebook','width=800,height=600');if(soctimers[network])
{clearInterval(soctimers[network]);soctimers[network]=null;}
soctimers[network]=setInterval(function(){social_post_bind(object_alias,network,activate,win,onsettings,object_id,object_alias_queue);},500);}
else if(network=='twitter')
{var win=window.open((location.protocol=='https:'?'https://':'http://')+location.host+'/oauth/twitter','Твиттер','width=800,height=600');if(soctimers[network])
{clearInterval(soctimers[network]);soctimers[network]=null;}
soctimers[network]=setInterval(function(){social_post_bind(object_alias,network,activate,win,onsettings,object_id,object_alias_queue);},500);}}
function social_post_change(object_alias,network,activate,data,onsettings,object_id,object_alias_queue)
{data=data||{};onsettings=onsettings||false;data.object_alias=object_alias;data.network=network;data.activate=activate;data.onsettings=onsettings;data.object_id=object_id;data.object_alias_queue=object_alias_queue;if(activate)socprepare[network]=true;new Request({url:'/account/socialpostchange',data:data,method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{alert(json.message);return false;}!activate?$('soc-post-'+object_alias+'-'+network).addClass('unactive'):$('soc-post-'+object_alias+'-'+network).removeClass('unactive');$('soc-post-'+object_alias+'-'+network).setAttribute('onclick','social_post(\''+object_alias+'\', \''+network+'\', '+!activate+', '+onsettings+',\''+object_alias_queue+'\')');if($('soc-post-'+object_alias+'-'+network+'-input'))$('soc-post-'+object_alias+'-'+network+'-input').value=!activate?0:1;var actions=['book_rate','book_add','book_fav','author_fav','game_part'];if($('autopublish_actions')&&actions.indexOf(object_alias)>-1)
{var networks=['vkontakte','facebook','twitter'];var is_active=false;for(var i=0;i<actions.length;i++)
{for(var j=0;j<networks.length;j++)
{if(!$('soc-post-'+actions[i]+'-'+networks[j]).hasClass('unactive'))
{is_active=true;break;}}
if(is_active)break;}
if(is_active)$('autopublish_actions').hide();else $('autopublish_actions').show();}
return false;},onFailure:function()
{}}).send();}
function social_post_bind(object_alias,network,activate,win,onsettings,object_id,object_alias_queue)
{try{if(!win.location||!win.location.href)return false;}
catch(e){return false;}
if(!win||win.closed||!win.document)
{if(soctimers[network])
{clearInterval(soctimers[network]);soctimers[network]=null;}
return false;}
var doc=win.document;var el=doc.getElementById('social-status');if(!el)return false;if(el.value=='ok')
{if(soctimers[network])
{clearInterval(soctimers[network]);soctimers[network]=null;}
social_post_change(object_alias,network,activate,{},onsettings,object_id,object_alias_queue);win.close();}}
var vk_data={};var vk_start=false;var vk_interval=null;function social_publish(post_id)
{new Request({url:'/account/socialpostsend',data:{post_id:post_id},method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
return false;},onFailure:function()
{}}).send();}
function social_publish_popup(data)
{vk_data=data;if(!$('fixed-vkontakte'))return false;$('fixed-vkontakte').innerHTML='Опубликовать запись <span style="font-style:italic;">'+data.title+'</span> на вашей стене Вконтакте?<br><br><input style="margin-right:10px;" type="button" onclick="social_publish_vk('+data.post_id+')" class="btn150" value="Опубликовать"> <a href="javascript:void(0);" onclick="social_publish_cancel('+data.post_id+');">Отмена</a>';$('fixed-vkontakte').show();}
function social_publish_vk(post_id)
{json=vk_data;VK.Api.call('wall.post',{owner_id:json.network_id,message:json.text,attachments:(json.attachment?json.attachment+',':'')+json.url,guid:json.guid},function(r){var data={post_id:post_id,status:'error'};if(r.response){data.status='ok';}
new Request({url:'/account/publishpost',data:data,method:'post'}).send();});$('fixed-vkontakte').hide();}
function social_publish_cancel(post_id)
{new Request({url:'/account/socialpostcancel',data:{post_id:post_id},method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{alert(json.message);return false;}
if($('fixed-vkontakte'))$('fixed-vkontakte').hide();return false;},onFailure:function()
{}}).send();}
function social_actions_notoffer()
{var value=$('is_autopublish_actions')&&$('is_autopublish_actions').checked?true:false;new Request({url:'/account/socialnotoffer',data:{value:value},method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{alert(json.message);return false;}
return false;},onFailure:function()
{}}).send();}
function link_add(){var body=$('body');var selection=window.getSelection();var pagelink="\n<br>Подробнее на livelib.ru:<br>\n"+document.location.href;var copytext=selection+pagelink;var newdiv=document.createElement('div');newdiv.style.position='absolute';newdiv.style.left='-99999px';body.appendChild(newdiv);newdiv.innerHTML=copytext;selection.selectAllChildren(newdiv);setTimeout(function(){body.removeChild(newdiv);},0);}
function social_popup_show(object_alias,object_id,add_object_alias)
{if($('is-social-popup-'+object_alias))
{add_object_alias=add_object_alias||'';new Request({url:'/account/socpopup',method:'post',data:{object_alias:object_alias,object_id:object_id,add_object_alias:add_object_alias},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if($('soc-popup-cont')&&json.content)$('soc-popup-cont').innerHTML=json.content;nodeScriptReplace($('soc-popup-cont'));return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}}
var ub_current_id=null;var ub_new_id=null;var ub_popup_close=false;var ub_popup_timer=null;var ub_social_timer=null;var ub_soc_type='book_rate';function social_ub_bind()
{if(ub_current_id&&ub_current_id>0&&ub_popup_close)
{if(ub_popup_timer)clearInterval(ub_popup_timer);social_popup_show(ub_soc_type,ub_current_id);ub_popup_close=false;ub_current_id=null;}}
if($('is-social-popup-book_rate')||$('is-social-popup-book_add'))
{ub_popup_timer=setInterval(social_ub_bind,300);}
function social_post_ub_bind()
{if(ub_new_id&&ub_new_id>0&&ub_popup_close)
{social_add_queue('book_add',ub_new_id);ub_popup_close=false;ub_new_id=null;}}
if($('is-social-book_rate')||$('is-social-book_add'))
{ub_social_timer=setInterval(social_post_ub_bind,300);}
function social_add_queue(object_alias,object_id,object_alias_queue)
{object_alias_queue=object_alias_queue||'';new Request({url:'/account/socaddqueue',method:'post',data:{object_alias:object_alias,object_id:object_id,object_alias_queue:object_alias_queue},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(json.content&&$('soc-vk-cont'))
{$('soc-vk-cont').innerHTML=json.content;nodeScriptReplace($('soc-vk-cont'));}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
if($('is-social-popup-game_part')&&$('is-game-part-alias')&&$('is-game-part-id'))
{social_popup_show('game_part',$('is-game-part-id').value,$('is-game-part-alias').value);}
var selectiongetreadstats=function(selection_id)
{if($('read-stats').isDisplayed())
{xhide('read-stats');return;}
var is_new_design=$('is-new-design')?$('is-new-design').value:0;new Request({url:'/selection/getreadstats',method:'post',data:{selection_id:selection_id,is_new_design:is_new_design},onComplete:function(json)
{json=strToJson(json);if(json.message&&json.error_code!=0)
{alert(json.message);return false;}
if(json.error_code==0)
{$('read-stats').innerHTML=json.content;xshow('read-stats');}
return false;},onFailure:function()
{failure();}}).send();}
function social_prepare_action()
{new Request({url:'/account/socprepareaction',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(json.content)
{var div=document.createElement('div');div.innerHTML=json.content;$('body').appendChild(div);nodeScriptReplace(div);}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function update_user_timezone()
{var offset=new Date().getTimezoneOffset();var value=Cookie.read('_llutmz');if((!value&&value!=0)||(value&&value!=offset))
{Cookie.write('__llutmz',offset,{duration:365,domain:'.livelib.ru'});Cookie.write('__llutmf',0,{duration:365,domain:'.livelib.ru'});}
return offset;}
update_user_timezone();function selection_uncheck_list(gallery)
{var selection_id=$('selection-id')?$('selection-id').value:0;var gallery_name='selection'+'-'+selection_id;if(llgallery[gallery_name]!=null&&llgallery[gallery_name]==0)return false;var last_id=$('sel-unchecking-last-id')?$('sel-unchecking-last-id').value:0;var is_new_design=$('is-new-design')?$('is-new-design').value:0;new Request({url:'/selection/genunchecking',method:'post',data:{selection_id:selection_id,last_id:last_id,is_new_design:is_new_design},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(gallery&&json.content)
{gallery.itemsParent.innerHTML+=json.content;gallery.reinitElements();}
llgallery[gallery_name]=json.last_id;if(json.end_data)
{llgallery[gallery_name]=0;}
if($('sel-unchecking-last-id'))$('sel-unchecking-last-id').value=json.last_id;return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function selebook_check(check_id,status)
{if(status=='remove'&&!confirm('Исключить книгу из подборки?'))return false;var no=$('sel-check-no-'+check_id)?$('sel-check-no-'+check_id).value:0;new Request({url:'/selection/checkingstatus',method:'post',data:{check_id:check_id,no:no,status:status},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
$('sel-check-'+check_id).fireEvent('slideremove');if($('sel-check-'+check_id))$('sel-check-'+check_id).dispose();return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function selebook_work_view()
{var is_work=0;if($('selework-view').checked)is_work=1;var date=new Date;date.setDate(date.getDate()+365);document.cookie='__llselworkview='+is_work+'; path=/; expires='+date.toUTCString();location.reload();}
function series_set(edition_id,search,el)
{edition_id=edition_id||0;el=el||'book-series-form';new Request({url:'/selection/seriesset',data:{edition_id:edition_id,search:search},method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{alert(json.message);return false;}
if(json.content)
{$(el).innerHTML=json.content;}
return false;}}).send();}
function series_search()
{var text=$('search-cycle')?$('search-cycle').value:'';if(!text||text=='')
{alert('Введите текст для поиска!');return false;}
new Request({url:'/selection/seriesfind',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{alert(json.message);return false;}
if(json.content)
{$('result-work-div').innerHTML=json.content;}
return false;}}).send($('form-cycle'));}
function series_save()
{new Request({url:'/selection/seriessave',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{alert(json.message);return false;}
if(json.url&&json.title&&$('book-series'))
{$('book-series').innerHTML='<b>Серия:</b> <a href="'+json.url+'">'+json.title+'</a><br>';}
if($('cycle-form-cont'))$('cycle-form-cont').dispose();return false;}}).send($('cycle-form'));}
function series_out(edition_id,is_cycle)
{is_cycle=is_cycle||0;if(!confirm(is_cycle?'Вы уверены, что это не многотомное издание?':'Вы уверены, что это внесерийное издание?'))return false;new Request({url:'/selection/seriesout',data:{edition_id:edition_id,is_cycle:is_cycle},method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{alert(json.message);return false;}
if(is_cycle)
{if($('multivolume-tr'))$('multivolume-tr').dispose();}
else
{if($('book-series'))$('book-series').innerHTML='';if($('book-series-tr'))$('book-series-tr').dispose();}
return false;}}).send();}
function series_find(edition_id,is_cycle)
{var text=$('input-search-sel')?$('input-search-sel').value:'';if(!text||text=='')
{alert('Введите текст для поиска!');return false;}
var is_new_design=$('is-new-design')?$('is-new-design').value:'';is_cycle=is_cycle||0;new Request({url:'/selection/seriesfind',data:{searchtext:text,edition_id:edition_id,page:'book',is_new_design:is_new_design,is_cycle:is_cycle},method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{alert(json.message);return false;}
if(json.content)
{$('series-search').innerHTML=json.content;}
return false;}}).send();}
function series_include(edition_id,selection_id,is_new,is_cycle)
{var is_new_design=$('is-new-design')?$('is-new-design').value:'';is_new=is_new||0;is_cycle=is_cycle||0;var title=$('series-title')?$('series-title').value:'';var number=$('series-number')?$('series-number').value:'';var number_from=$('series-number-from')?$('series-number-from').value:'';if(selection_id>0&&$('series-number-'+selection_id))
{number=$('series-number-'+selection_id).value;}
new Request({url:'/selection/includebook',data:{selection_id:selection_id,edition_id:edition_id,is_new_design:is_new_design,is_cycle_new:is_new,title:title,is_cycle:is_cycle,number:number,number_from:number_from},method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{alert(json.message);return false;}
if(json.content)
{if($('series-'+selection_id))$('series-'+selection_id).dispose();$('series-new').innerHTML+=json.content;if($('series-out'))$('series-out').hide();if(is_new)
{if($('series-title'))$('series-title').value='';if($('series-number'))$('series-number').value='';if($('series-number-from'))$('series-number-from').value='';var text=is_cycle&&is_cycle==2?'Подборка многотомных изданий успешно добавлена!':(is_cycle?'Цикл успешно добавлен!':'Серия успешно добавлена!');$('tinyalert').innerHTML+='<div id="server_okay_msg" class="green"><a href="javascript:void(0)" title="Закрыть" class="action a-close" onclick="this.getParent().hide();"><span class="i-clear"></span></a>'+text+'</div>';}}
if(is_new)
{location.hash='';location.hash='series-'+json.selection_id;}
return false;}}).send();}
function series_exclude(edition_id,selection_id,is_cycle)
{var is_new_design=$('is-new-design')?$('is-new-design').value:'';is_cycle=is_cycle||0;new Request({url:'/selection/excludebook',data:{selection_id:selection_id,edition_id:edition_id,is_new_design:is_new_design,is_cycle:is_cycle},method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{alert(json.message);return false;}
if($('series-'+selection_id))$('series-'+selection_id).dispose();return false;}}).send();}
function selection_check(selection_id)
{new Request({url:'/selection/check',data:{selection_id:selection_id},method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(json.check)
{if($('check-sel-icon-'+selection_id))$('check-sel-icon-'+selection_id).addClass('i-check').removeClass('i-check-gray');if($('check-sel-'+selection_id))$('check-sel-'+selection_id).style.color='green';}
else
{if($('check-sel-icon-'+selection_id))$('check-sel-icon-'+selection_id).addClass('i-check-gray').removeClass('i-check');if($('check-sel-'+selection_id))$('check-sel-'+selection_id).style.color='';}
return false;}}).send();}
function ll_content_lang_get_code()
{var code=$('langs-for-content').getSelected()[0].dataset.code;$('content-lang-code-input').value=code;}
function conten_langs_row()
{if($$('.content-lang-radio'))
{$$('.content-lang-radio').each(function(item){if(item.checked)$('content-langs-row').style.display=$(item).value==2?'table-row':'none';});}}
function curator_alert_close(edition_id)
{if($('curator-alert'))$('curator-alert').dispose();new Request({url:'/book/closealert',data:{edition_id:edition_id},method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
return false;}}).send();}
function setusersex(param_sex,element)
{new Request({url:'/user/setsex',data:{sex:param_sex},method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{alert('Ошибка!');return false;}
var parent_div=element.parentNode.parentNode;var id=parseInt(parent_div.id.substring(7,100));message_set_status(id,2,'notifications');}}).send();}
if($('div-info-selebook-hint'))
{hideonclick('div-info-selebook-hint');var date=new Date;date.setDate(date.getDate()+365*10);document.cookie='__selebook_hint='+1+'; path=/; expires='+date.toUTCString();}
var searchauthorhints=Array();var is_search_query_author_back=true;var ll_author_search=function(event,search_element,input_element,object_alias)
{if(event.keyCode==13||event.keyCode==38||event.keyCode==40)
{set_selection_author_search(event.keyCode,input_element);}
if(event.keyCode>=9&&event.keyCode<=27)return false;if(event.keyCode>=33&&event.keyCode<=46)return false;if(event.keyCode>=91&&event.keyCode<=93)return false;if(event.keyCode>=112&&event.keyCode<=157)return false;var width=$(search_element).style.width;var text=$(search_element).value.trim();if(text=='')
{$(input_element).innerHTML='';return;}
if(!is_search_query_author_back)return false;if(typeof searchauthorhints[search_element]!='undefined'&&searchauthorhints[search_element]==text)
{if($(input_element).style.display=='none')clicktoggle(input_element,$(search_element));return;}
searchauthorhints[search_element]=text;is_search_query_author_back=false;new Request({url:'/main/authorsearch',method:'post',data:{text:text,object_alias:object_alias,input_element:input_element,width:width},onComplete:function(json)
{is_search_query_author_back=true;json=strToJson(json);if(json.message&&json.error_code!=0)
{alert(json.message);return false;}
if(json.content)
{$(input_element).innerHTML=json.content;if($(input_element).style.display=='none')
{clicktoggle(input_element,$(search_element));}
if(text!=$(search_element).value.trim())
{ll_author_search({keyCode:158},search_element,input_element,object_alias);}}
return false;},onFailure:function()
{failure();}}).send();}
var set_selection_author_search=function(key_code,element)
{var elem=getElementsByName('a','hint-'+element);if(elem.length<=0)return false;var select_element=0;for(var i=0;i<elem.length;i++)
{if(elem[i].hasClass('selected'))
{select_element=i+1;var last_element=elem[i];}}
if(key_code==13&&select_element>0)
{$(element+'-hint-'+select_element).click();return false;}
if(key_code==40)
{select_element=select_element+1;}
if(key_code==38)
{select_element=select_element-1;}
var el=$(element+'-hint-'+select_element);if($(el)=='undefined'||$(el)==null)
{return false;}
else
{el.addClass('selected');if(!($(last_element)=='undefined'||$(last_element)==null))last_element.removeClass('selected');}}
var reset_select_author=function(element)
{var elem=getElementsByName('a','hint-'+element);if(elem.length<=0)return false;for(var i=0;i<elem.length;i++)
{elem[i].removeClass('selected');}}
var oauthtimers={};function network_auth(network,redirect,callback)
{var title='Вход через соцсеть';var url=(location.protocol=='https:'?'https://':'http://')+location.host+'/oauth/network/'+network;var params='width=800,height=600';callback=!callback||callback==null||callback=='undefined'?null:callback;var win=window.open(url,title,params);win.focus();if(oauthtimers[network])
{clearInterval(oauthtimers[network]);oauthtimers[network]=null;}
oauthtimers[network]=setInterval(function(){network_auth_bind(win,network,redirect,callback);},500);}
function network_auth_bind(win,network,redirect,callback)
{try{if(!win.location||!win.location.href)return false;}
catch(e){return false;}
if(!win||win.closed||!win.document)
{if(oauthtimers[network])
{clearInterval(oauthtimers[network]);oauthtimers[network]=null;}
return false;}
var doc=win.document;var el=doc.getElementById('social-status');if(!el||!el.value)return false;if(el.value=='ok')
{var code=doc.getElementById('social-code')&&doc.getElementById('social-code').value?doc.getElementById('social-code').value:null;if(code)
{if(callback)callback(encodeURIComponent(code),network);else location.href=redirect+'?social='+network+'&token='+encodeURIComponent(code);}}
if(oauthtimers[network])
{clearInterval(oauthtimers[network]);oauthtimers[network]=null;}
win.close();}
function promo_check_property(el,var_alias,var_promo_id)
{if(var_promo_id==0&&$('checklist-properties'))
{if(!$('hidden-'+var_alias))
{var checklist_property=new Element('input',{id:'hidden-'+var_alias,name:'form[checklist]['+var_alias+']',type:'hidden'});$('checklist-properties').appendChild(checklist_property);}
$('hidden-'+var_alias).setAttribute('value',$(el).hasClass('checked')?0:1);$$('.'+var_alias+'-check').each(function(item){if($(item).hasClass('checked'))
{$(item).removeClass('checked');}
else
{$(item).addClass('checked');}});}
else if(var_promo_id>0)
{new Request({url:'/promo/propertycheck',method:'post',data:{promo_id:var_promo_id,property_alias:var_alias,property_value:$(el).hasClass('checked')?0:1},onComplete:function(json)
{$$('.'+var_alias+'-check').each(function(item){if($(item).hasClass('checked'))
{$(item).removeClass('checked');}
else
{$(item).addClass('checked');}});return false;},onFailure:function()
{failure();}}).send();}}
function add_bot()
{if($('bot-new').value=='')return;var text=$('bot-new').value;var new_id=Math.round(Math.random()*1000000);$('bot-list').innerHTML+='<tr id="bot-'+new_id+'"><td>'
+text+'</td>'
+'<input type="hidden" name="form[bot-'+new_id+']" value="'+text+'"/>'
+'<td><a class="action" href="javascript:void(0);" onclick="$(\'bot-'+new_id+'\').destroy();">удалить</a>'
+'</td></tr>';}
function group_country_load(el)
{if(!el)return false;var value=el.value;if($('city-list'))
{$('city-list').innerHTML='';$('city-list').options[0]=new Option(' -- ',0);}
if(value==''||!value)
{if($('city-list'))$('city-list').hide();return false;}
if($('city-list-label'))$('city-list-label').innerHTML='Загрузка...';new Request({url:'/main/citylist',method:'post',data:{country_code:value},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message&&json.error_code!=0)
{alert(json.message);return false;}
if($('city-list-label'))$('city-list-label').innerHTML='';$('city-list').innerHTML='';$('city-list').options[0]=new Option(' -- ',0);if(json.error_code==0&&json.result)
{for(var i=0;i<json.result.length;i++)
{$('city-list').options[i+1]=new Option(json.result[i].name,json.result[i].id);}
$('city-list').show('inline');}
else
{$('city-list').hide();}
return false;},onFailure:function()
{failure();}}).send();}
function ll_exclude_from_dup(var_edition_id,var_group_isbn)
{if($('edition-'+var_edition_id+'-dup-isbn-'+var_group_isbn))
{new Request({url:'/admin/excludeeditionfromdup',method:'post',data:{edition_id:var_edition_id,isbn:var_group_isbn},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message&&json.error_code!=0)
{alert(json.message);return false;}
if(json.error_code==0)
{$('edition-'+var_edition_id+'-dup-isbn-'+var_group_isbn).hide();}
return false;},onFailure:function()
{failure();}}).send();}}
function group_enter(group_id,is_unsub,is_exit,is_sub,page_type)
{is_exit=is_exit||false;is_sub=is_sub||false;page_type=page_type||'';if($('group-action-form-'+group_id)&&$('group-action-form-'+group_id).style.display!='none'&&!is_exit)
{$('group-action-form-'+group_id).hide();return false;}
is_unsub=is_unsub||false;if(is_unsub&&!confirm('Отменить подписку?'))
{return false;}
new Request({url:'/group/enter',method:'post',data:{group_id:group_id,is_exit:is_exit,is_sub:is_sub,page_type:page_type},onComplete:function(json)
{json=strToJson(json);prepare(json,null,'if ($(\'group-action-a-'+group_id+'\')) $(\'group-action-a-'+group_id+'\').click();');if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(json.content_inner)
{if($('group-action-'+group_id))$('group-action-'+group_id).innerHTML=json.content_inner;if($('group-action-form-'+group_id))$('group-action-form-'+group_id).hide();if(toggle_elements['group-action-form-'+group_id+'-'+'group-action-a-'+group_id]!=null)
{toggle_elements['group-action-form-'+group_id+'-'+'group-action-a-'+group_id]=null;}}
if(json.content&&json.is_select&&$('group-action-form-'+group_id))
{$('group-action-form-'+group_id).innerHTML=json.content;if($('group-action-a-'+group_id))clicktoggle('group-action-form-'+group_id,$('group-action-a-'+group_id),'block');$('group-action-form-'+group_id).show();}
else if(json.content&&$('group-action-'+group_id))
{$('group-action-'+group_id).innerHTML=json.content;$('group-action-form-'+group_id).hide();}
if($('object-subscription-group'))
{json.in_group?$('object-subscription-group').hide():$('object-subscription-group').show('inline-block');if(json.content_subscr)$('object-subscription-group-inner').innerHTML=json.content_subscr;}
if(json.in_group&&page_type=='locked')
{location.reload();}
if(page_type=='locked'&&$('group-action-locked-'+group_id))
{$('group-action-locked-'+group_id).hide();$('tinyalert').innerHTML+='<div id="server_okay_msg" class="green"><a href="javascript:void(0)" title="Закрыть" class="action a-close" onclick="this.getParent().hide();"><span class="i-clear"></span></a>Заявка на вступление в группу добавлена</div>';}
if($('group-page')&&$('group-page').value=='invitations'&&(json.in_group||json.is_waiting))
{group_invitation(group_id,'accept');}
return false;},onFailure:function()
{failure();}}).send();}
function group_share(object_id,type)
{var login_name=type=='banned-search'?'input-search-groupban':'input-search-groupshare';var result_name=type=='banned-search'?'ban-user-result':'share-user-result';var login=$(login_name)?$(login_name).value:'';if(login==''||!login)
{alert('Введите логин для поиска!');return false;}
if($(result_name))$(result_name).innerHTML='<span class="recloader" style=""></span>';type=type||'share';var url=type=='seleuser'?'selection':'group';new Request({url:'/'+url+'/sharesearch',method:'post',data:{'object_id':object_id,login:login,type:type},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);if($(result_name))$(result_name).innerHTML='';return false;}
if($(result_name))$(result_name).innerHTML=json.content?json.content:'';return false;},onFailure:function()
{if($(result_name))$(result_name).innerHTML='';failure();}}).send();}
function group_user_share(el)
{if(!el.hasClass('share-selected'))
{el.addClass('share-selected');el.innerHTML='<div style="position:absolute;top:-5px;right:-10px;" title="Отправить приглашение"><span class="i-point-on"></span></div>';if($('share-clear-btn'))$('share-clear-btn').show('inline');if($('share-search-btn'))$('share-search-btn').removeClass('btn-event-gray');}
else
{el.removeClass('share-selected');el.innerHTML='';var elements=$$('.share-selected');if(elements.length<=0)
{if($('share-clear-btn'))$('share-clear-btn').hide();if($('share-search-btn'))$('share-search-btn').addClass('btn-event-gray');}}}
function group_shares_clear()
{var elements=$$('.share-selected');if(elements.length<=0)
{if($('share-clear-btn'))$('share-clear-btn').hide();if($('share-search-btn'))$('share-search-btn').addClass('btn-event-gray');return false;}
for(var i=0;i<elements.length;i++)
{elements[i].removeClass('share-selected');elements[i].innerHTML='';}
if($('share-clear-btn'))$('share-clear-btn').hide();if($('share-search-btn'))$('share-search-btn').addClass('btn-event-gray');}
function group_shares(group_id)
{var elements=$$('.share-selected');if(elements.length<=0)
{alert('Выберите читателей, чтобы отправить им приглашение!');return false;}
var data={};for(var i=0;i<elements.length;i++)
{var login=elements[i].id?elements[i].id.substring(12):'';if(login!='')data[i]=login;}
new Request({url:'/group/shareinvite',method:'post',data:{group_id:group_id,logins:data},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
$('tinyalert').innerHTML+='<div id="server_okay_msg" class="green"><a href="javascript:void(0)" title="Закрыть" class="action a-close" onclick="this.getParent().hide();"><span class="i-clear"></span></a>Пользователи приглашены в группу</div>';group_shares_clear();return false;},onFailure:function()
{failure();}}).send();}
function group_users(type)
{if($('btn-'+type)&&$('btn-'+type).hasClass('active'))
{return false;}
$$('.group-users-block').hide();$$('.group-users-btn').removeClass('active');type=='participants-search'?$$('.group-users-hide').hide():$$('.group-users-hide').show();if($(type))$(type).show();if($('btn-'+type))$('btn-'+type).addClass('active');if($('btn-more-'+type))$('btn-more-'+type).show('inline-block');}
function group_user_search(group_id)
{var login=$('input-search-group')?$('input-search-group').value:'';if(login==''||!login)
{alert('Введите логин для поиска!');return false;}
var type='participants-search';group_users(type);if($(type))$(type).innerHTML+='<span id="loader-more" class="recloader" style=""></span>';new Request({url:'/group/usersearch',method:'post',data:{group_id:group_id,login:login,type:type},onComplete:function(json)
{json=strToJson(json);prepare(json);if($('loader-more'))$('loader-more').dispose();if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(json.content&&$(type))
{$(type).innerHTML=json.content;}
if(json.last_page&&$('btn-more-'+type))
{$('btn-more-'+type).style.visibility='hidden';}
else if($('btn-more-'+type))
{$('btn-more-'+type).style.visibility='visible';$('btn-more-'+type).setAttribute('onclick','group_users_more('+group_id+',\''+type+'\', 2, '+json.per_page+', \''+encodeURIComponent(login)+'\')');}
return false;},onFailure:function()
{if($('loader-more'))$('loader-more').dispose();failure();}}).send();return false;}
function group_user_status(status,group_id,login,type)
{new Request({url:'/group/userstatus',method:'post',data:{group_id:group_id,login:login,status:status,type:type},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);}
if((!json.error_code||json.error_code==1)&&$(type+'-login-'+login))
{if(type=='banned-search'&&$('banned'))$('banned').appendChild($(type+'-login-'+login));else $(type+'-login-'+login).dispose();if(type=='candidates'&&$$('#candidates .group-user').length==0&&$('candidates-block'))
{$('candidates-block').dispose();}}
return false;},onFailure:function()
{failure();}}).send();return false;}
function group_users_more(group_id,type,page_no,per_page,login)
{login=login||'';if(type=='participants-search'&&(login==''||!login))
{alert('Введите логин для поиска!');return false;}
if($(type))$(type).innerHTML+='<span id="loader-more" class="recloader" style=""></span>';new Request({url:'/group/users',method:'post',data:{group_id:group_id,login:login,type:type,page_no:page_no,per_page:per_page},onComplete:function(json)
{json=strToJson(json);prepare(json);if($('loader-more'))$('loader-more').dispose();if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(json.object_ids&&json.object_ids.length>0)
{for(var i=0;i<json.object_ids.length;i++)
{if($(type+'-login-'+json.object_ids[i]))$(type+'-login-'+json.object_ids[i]).dispose();}}
if(json.content&&$(type))
{$(type).innerHTML+=json.content;}
if(json.last_page&&$('btn-more-'+type))
{$('btn-more-'+type).style.visibility='hidden';}
else if($('btn-more-'+type))
{$('btn-more-'+type).setAttribute('onclick','group_users_more('+group_id+',\''+type+'\', '+(parseInt(page_no)+1)+', '+per_page+', \''+encodeURIComponent(login)+'\')');}
return false;},onFailure:function()
{if($('loader-more'))$('loader-more').dispose();failure();}}).send();}
function group_search_prepare()
{if($('input-search-book')&&$('input-search-book').value!='')return true;else if($('group-search-tag')&&$('group-search-tag').value!='')return true;else if($('group-search-reader')&&$('group-search-reader').value!='')return true;else if($('group-search-location')&&$('group-search-location').value!='')return true;else if($('group-search-sort')&&$('group-search-sort').value!=''&&$('group-search-sort').value!='relevance')return true;var elems=$$('.group-categories');if(elems.length>0)
{for(var i=0;i<elems.length;i++)
{if(elems[i]&&elems[i].checked)return true;}}
alert('Введите параметры для поиска групп!');return false;}
var is_feed_post=false
function group_post()
{if(!$('feed-description')||$('feed-description')=='')
{alert('Введите текст записи!');return false;}
if(is_feed_post)return false;is_feed_post=true;var div=new Element('div',{id:'loader-new','style':'height:52px;text-align:center;'});div.innerHTML+='<span id="loader-more" class="recloader" style="position: relative;"></span>';$('feed-new').inject(div,'before');new Request({url:'/group/postadd',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if($('loader-new'))$('loader-new').dispose();if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(json.content&&$('feed-new'))
{var divc=new Element('div');divc.innerHTML+=json.content;$('feed-new').parentNode.insertBefore(divc,$('feed-new'));$('feed-new').inject(divc,'before');}
if($('feed-title'))$('feed-title').value='';if($('feed-description'))$('feed-description').value='';$('tinyalert').innerHTML+='<div id="server_okay_msg" class="green"><a href="javascript:void(0)" title="Закрыть" class="action a-close" onclick="this.getParent().hide();"><span class="i-clear"></span></a>Запись опубликована!</div>';if($('post-feed-form'))$('post-feed-form').hide();if($('post-feed-add'))$('post-feed-add').show();is_feed_post=false;return false;},onFailure:function()
{if($('loader-new'))$('loader-new').dispose();is_feed_post=false;failure();}}).send($('feed-form'));}
function group_invitation(group_id,type)
{new Request({url:'/group/invitation',method:'post',data:{group_id:group_id,type:type},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if($('group-'+group_id))
{$('group-'+group_id).dispose();var groups=$$('.card-block-inner');if(groups.length>0)
{if($('groups-count-invited'))$('groups-count-invited').innerHTML=groups.length;var last=groups[groups.length-1];if(last)
{var last_group_id=last.id.substr(6);if($('border-group-'+last_group_id))$('border-group-'+last_group_id).removeClass('block-border-b');}}
else
{if($('groups-invited'))$('groups-invited').hide();if($('invitation-container'))$('invitation-container').innerHTML='<div class="with-pad">Нет приглашений</div>';}}
return false;},onFailure:failure}).send();}
function book_genre_add(genre_id,genre_name)
{if(!$('book-genres-inner'))return false;if($('genre-'+genre_id))
{if(!$('genre-'+genre_id).checked)
{$('genre-'+genre_id).checked=true;select_genre(genre_id);}
return false;}
var is_work=$('is_work')&&$('is_work').value==1?true:false;var el=new Element('span');el.innerHTML='<input type="checkbox" style="vertical-align:-2px;" id="genre-'+genre_id+'" checked="true" onchange="select_genre('+genre_id+');" name="'+(is_work?'work':'book')+'[genres]['+genre_id+']"><label for="genre-'+genre_id+'">'+genre_name+'</label> <a href="javascript:void(0);" id="genre-main-'+genre_id+'" class="genre-main semiref" onclick="book_genre_main('+genre_id+');">основной</a><br>';$('book-genres-inner').appendChild(el);select_genre(genre_id);}
function book_genre_main(genre_id)
{var elements=$$('.genre-main');if(elements.length<=0)return false;for(var i=0;i<elements.length;i++)
{elements[i].style.fontWeight=(elements[i].id&&elements[i].id=='genre-main-'+genre_id)?'bold':'normal';}
if($('book[is_main_genre]'))$('book[is_main_genre]').value=genre_id;}
function post_set_fixed(post_id,is_fixed)
{new Request({url:'/post/setfixed',method:'post',data:{post_id:post_id,is_fixed:is_fixed},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(is_fixed)
{if($('li-post-fixed-'+post_id))$('li-post-fixed-'+post_id).hide();if($('li-post-unfixed-'+post_id))$('li-post-unfixed-'+post_id).show();if($('post-label-fixed-'+post_id))$('post-label-fixed-'+post_id).show();}
else
{if($('li-post-unfixed-'+post_id))$('li-post-unfixed-'+post_id).hide();if($('li-post-fixed-'+post_id))$('li-post-fixed-'+post_id).show();if($('post-label-fixed-'+post_id))$('post-label-fixed-'+post_id).hide();}
return false;},onFailure:function()
{failure();}}).send();}
function addplayer(name){return soundManager.setup({url:'/audio/player/',onready:function(){soundManager.createSound({id:name,url:'http://s.test.livelib.ru/audio/'+name,whileplaying:function(){$('progress').style.width=((this.position/this.duration)*100)+'%';},});},ontimeout:function(){alert('Ошибка!');}});}
function bind_test_timer(seconds,question_id)
{var test_timer=setInterval(function(){if($('test-timer-holder'))$('test-timer-holder').innerHTML=time_format(seconds);if(seconds<=0)
{clearInterval(test_timer);test_select_variant(question_id,0);}
seconds=seconds-1;},1000);}
var time_format=(function(){function num(val){val=Math.floor(val);return val<10?'0'+val:val;}
return function(sec){if(sec<=0)return'00:00:00';var minutes=sec/60%60,seconds=sec%60;return num(minutes)+":"+num(seconds);};})();function event_users_more(event_id,type,page_no,per_page,login)
{login=login||'';if(type=='participants-search'&&(login==''||!login))
{alert('Введите логин для поиска!');return false;}
if($(type))$(type).innerHTML+='<span id="loader-more" class="recloader" style=""></span>';new Request({url:'/event/users',method:'post',data:{event_id:event_id,login:login,type:type,page_no:page_no,per_page:per_page},onComplete:function(json)
{json=strToJson(json);prepare(json);if($('loader-more'))$('loader-more').dispose();if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(json.object_ids&&json.object_ids.length>0)
{for(var i=0;i<json.object_ids.length;i++)
{if($(type+'-login-'+json.object_ids[i]))$(type+'-login-'+json.object_ids[i]).dispose();}}
if(json.content&&$(type))
{if(page_no==1)$(type).innerHTML=json.content;else $(type).innerHTML+=json.content;}
if(json.last_page&&$('btn-more-'+type))
{$('btn-more-'+type).hide();}
else if($('btn-more-'+type))
{$('btn-more-'+type).setAttribute('onclick','event_users_more('+event_id+',\''+type+'\', '+(parseInt(page_no)+1)+', '+per_page+', \''+encodeURIComponent(login)+'\')');}
return false;},onFailure:function()
{if($('loader-more'))$('loader-more').dispose();failure();}}).send();}
function event_user_search(event_id,per_page)
{var login=$('input-search-groupshare')?$('input-search-groupshare').value:'';if(login==''||!login)
{alert('Введите логин для поиска!');return false;}
var type='participants-search';group_users(type);per_page=per_page||24;event_users_more(event_id,type,1,per_page,login);}
function event_status(event_id,status,guid)
{new Request({url:'/event/status',method:'post',data:{event_id:event_id,status:status,guid:guid},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(json.content&&$('event-now-'+event_id))
{if(toggle_elements['event-actions-now-'+event_id+'-'])toggle_elements['event-actions-now-'+event_id+'-']=null;$('event-now-'+event_id).innerHTML=json.content;}
return false;},onFailure:function()
{failure();}}).send();}
function event_search_prepare()
{if($('input-search-book')&&$('input-search-book').value!='')return true;if($('toggle_period')&&$('toggle_period').checked)return true;if($('form[city_id]')&&$('form[city_id]').value&&$('form[city_id]').value>0)return true;if($('form[type]')&&$('form[type]').value&&$('form[type]').value!='all')return true;alert('Введите параметры для поиска мероприятий!');return false;}
function nonfiction_head()
{var position=Cookie.read('nf_head_position');if(!position)position='expanded';var start=position=='expanded'?0:-350;var header=$$('.header')[0];header.style.position='relative';if(position=='expanded')
{$('pageh').style.height='0px';$('fixed-menu').style.position='inherit';}
var cycle=setInterval(function(){if((position=='expanded'&&start<-350)||(position=='rolluped'&&start>0)){clearInterval(cycle);if(position=='rolluped')
{$('pageh').style.height='80px';$('fixed-menu').style.position='fixed';}
$('nf-head-manipulator').removeClass(position).addClass(position=='rolluped'?'expanded':'rolluped');$('ll-logo').removeClass(position).addClass(position=='rolluped'?'expanded':'rolluped');Cookie.write('nf_head_position',position=='expanded'?'rolluped':'expanded',{duration:365*10});return;}
draw(start);start=position=='expanded'?start-5:start+5;},3);function draw(margin){header.style.marginTop=margin+'px';}}
path_ids='';function show_map(map)
{$$('.change-map-link').each(function(item){item.removeClass('active');if(item.id=='map'+map+'-link')item.addClass('active');});var div_moozoom=new Element('div',{'class':'moozoom','id':'nonfiction-map','data-zoomin':'nonfiction-2016-zoomin','data-zoomout':'nonfiction-2016-zoomout','data-zoomreset':'nonfiction-2016-zoomreset','styles':{'position':'relative','width':'100%','height':'100%'}});var moo_object=new Element('object',{'id':'moozoom','draggable':'true','data':'/nonfiction/map'+map+'.svg','type':'image/svg+xml','styles':{'display':'inline-block','width':'100%','height':'100%','z-index':'99'}});var div=new Element('div',{'styles':{'position':'absolute','right':'0px','bottom':'0px','z-index':'100','top':'0px','left':'0px'}});$('moozoom-wrapper').innerHTML='';moo_object.inject(div_moozoom);div.inject(div_moozoom);div_moozoom.inject($('moozoom-wrapper'));moo_object.onload=function()
{var zoom_n=new mooZoom({image:$('nonfiction-map'),callback:function(){if(path_ids.length>0)nf17_map_tooltip(path_ids);path_ids='';}});moo_object.onload=function(){};return false;}}
var fired_animate_map=0;function animate_map(){if(fired_animate_map==1)
return;fired_animate_map=1;var right_block=$$('.right-block')[0];var left_block=$$('.left-block')[0];var container_block=$$('.container')[0];var map_block=$('moozoom-wrapper');var separator_border=$$('.separator-border')[0];var head_manipulator=$('nf-head-manipulator');var ll_logo=$('ll-logo');var right_block_width=right_block.offsetWidth;var map_block_width=map_block.offsetWidth;var style_r=right_block.currentStyle||window.getComputedStyle(right_block);var style_l=left_block.currentStyle||window.getComputedStyle(left_block);var style_sb=separator_border.currentStyle||window.getComputedStyle(separator_border);var style_hm=head_manipulator.currentStyle||window.getComputedStyle(head_manipulator);var style_mb=map_block.currentStyle||window.getComputedStyle(map_block);var style_ll=ll_logo.currentStyle||window.getComputedStyle(ll_logo);var current_margin_left=parseInt(style_r.marginLeft);var current_max_width=parseInt(style_l.maxWidth);var current_sb_left=parseInt(style_sb.left);var current_hm_left=parseInt(style_hm.left);var current_ll_left=parseInt(style_ll.left);if($('moozoom-wrapper').hasClass('toggled'))
{if(map_block.offsetWidth>670)
{map_block.innerHTML='';map_block.style.maxWidth='670px';map_block.style.left
map_block.style.left=((left_block.offsetWidth/2)-670/2)+'px';var map=$$('.change-map-link.active')[0].id=='map3-link'?3:2;var div_moozoom=new Element('div',{'class':'moozoom','id':'nonfiction-map','data-zoomin':'nonfiction-2016-zoomin','data-zoomout':'nonfiction-2016-zoomout','data-zoomreset':'nonfiction-2016-zoomreset','styles':{'position':'relative','width':'100%','height':'100%'}});var moo_object=new Element('object',{'id':'moozoom','draggable':'true','data':'/nonfiction/map'+map+'.svg','type':'image/svg+xml','styles':{'display':'inline-block','width':'100%','height':'100%','z-index':'99'}});var div=new Element('div',{'styles':{'position':'absolute','right':'0px','bottom':'0px','z-index':'100','top':'0px','left':'0px'}});moo_object.inject(div_moozoom);div.inject(div_moozoom);div_moozoom.inject($('moozoom-wrapper'));moo_object.onload=function()
{var zoom_n=new mooZoom({image:$('nonfiction-map'),callback:function(){var marks=$('marked-path')?$('marked-path').value:'';if(marks.length>0)
$('marked-path').value='';nf17_map_tooltip(marks);}});moo_object.onload=function(){};return false;}}
var map_left_offset=parseInt(style_mb.left);var can_move=current_margin_left-680;var start=0;right_block.removeClass('blur');var cycle=setInterval(function(){if(start>can_move){clearInterval(cycle);container_block.style.overflow='';map_block.removeClass('toggled');map_block.onclick=function(){animate_map()};right_block.onclick=function(){};right_block.style.width='';fired_animate_map=0;}
draw_m(start);start=start+10;},2);function draw_m(margin){right_block.style.marginLeft=(current_margin_left-margin)+'px';left_block.style.maxWidth=(current_max_width-margin)+'px';if((margin/5)<map_left_offset)
{map_block.style.left=map_left_offset-(margin*0.5)+'px';separator_border.style.left=(current_sb_left-margin)+'px';head_manipulator.style.left=(current_hm_left-margin)+'px';ll_logo.style.left=(current_ll_left-margin)+'px';}}}
else
{var can_move=right_block_width-200;var start=0;$('moozoom-wrapper').addClass('toggled');var map_left_offset=(current_max_width+can_move)/2-(map_block_width/2);right_block.style.width=right_block_width+'px';container_block.style.overflow='hidden';right_block.addClass('blur');var cycle=setInterval(function(){if(start>can_move){clearInterval(cycle);map_block.onclick=function(){};right_block.onclick=function(){animate_map()};var new_size=left_block.offsetWidth-100>680?left_block.offsetWidth-100:680;new_size=new_size>900?900:new_size;if(new_size>680)
{map_block.style.left=((left_block.offsetWidth/2)-(new_size/2))+'px';var map=$$('.change-map-link.active')[0].id=='map3-link'?3:2;var div_moozoom=new Element('div',{'class':'moozoom','id':'nonfiction-map','data-zoomin':'nonfiction-2016-zoomin','data-zoomout':'nonfiction-2016-zoomout','data-zoomreset':'nonfiction-2016-zoomreset','styles':{'position':'relative','width':'100%','height':'100%'}});var moo_object=new Element('object',{'id':'moozoom','draggable':'true','data':'/nonfiction/map'+map+'.svg','type':'image/svg+xml','styles':{'display':'inline-block','width':'100%','height':'100%','z-index':'99'}});var div=new Element('div',{'styles':{'position':'absolute','right':'0px','bottom':'0px','z-index':'100','top':'0px','left':'0px'}});map_block.innerHTML='';map_block.style.maxWidth=new_size+'px';moo_object.inject(div_moozoom);div.inject(div_moozoom);div_moozoom.inject($('moozoom-wrapper'));moo_object.onload=function()
{var zoom_n=new mooZoom({image:$('nonfiction-map'),callback:function(){var marks=$('marked-path')?$('marked-path').value:'';if(marks.length>0)
$('marked-path').value='';nf17_map_tooltip(marks);}});moo_object.onload=function(){};return false;}}
fired_animate_map=0;return false;}
draw(start);start=start+10;},2);function draw(margin){right_block.style.marginLeft=(current_margin_left+margin)+'px';left_block.style.maxWidth=(current_max_width+margin)+'px';if((margin*0.5)<map_left_offset)
{map_block.style.left=(margin*0.5)+'px';separator_border.style.left=(current_sb_left+margin)+'px';head_manipulator.style.left=(current_hm_left+margin)+'px';ll_logo.style.left=(current_ll_left+margin)+'px';}}}}
function toggle_filter()
{if($('filter-toggler').hasClass('toggled'))
{var text='Свернуть фильтр <span class="arrow"></span>';var value=0;$('filter-toggler').removeClass('toggled');}
else
{var text='Развернуть фильтр <span class="arrow"></span>';$('filter-toggler').addClass('toggled');var value=1;}
$('filter-toggler').innerHTML=text;Cookie.write('nf_event_filter',value,{duration:365*10});$('event-filter').style.display=$('event-filter').isVisible()?'none':'block';}
function nf_set_filter()
{if($$('.filter-button.active').length<=0)return false;var category_str='';var date_str='';var time_str='';$$('.filter-button.active').each(function(item){if(item.hasClass('category'))category_str+=item.dataset.value+';';if(item.hasClass('date'))date_str+=item.dataset.value+';';if(item.hasClass('time'))time_str+=item.dataset.value+';';});var search_string=$('search-input').value;search_string=search_string.length>0?'/search/'+search_string:'';var filter_url='';if(category_str.length>0||date_str.length>0||time_str.length>0)
{if(category_str.length>0)
{filter_url+='category:'+category_str}
if(date_str.length>0)
{filter_url+=(filter_url.length>0?'-':'')+'date:'+date_str}
if(time_str.length>0)
{filter_url+=(filter_url.length>0?'-':'')+'time:'+time_str}}
filter_url=filter_url.length>0?'/filter/'+filter_url:'';location.href='/nonfiction'+search_string+filter_url;}
function set_map_mark(marks,floor)
{if(marks=='dnk')return false;if(floor==null||floor=='undefined')floor=2;if($('marked-path'))$('marked-path').value=marks;if($('map'+floor+'-link').hasClass('active'))
{nf17_map_tooltip(marks);}
else
{path_ids=marks;show_map(floor);}}
function ll_exclude_review_from_api(object_id)
{return ll_exlude_unexclude_review_from_api(object_id,'exclude');}
function ll_unexclude_review_from_api(object_id)
{return ll_exlude_unexclude_review_from_api(object_id,'unexclude');}
function ll_exlude_unexclude_review_from_api(object_id,action)
{new Request({url:'/review/apiexclude',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error)
{messageobj.display(json.error);}
else
{xhide($('span-review-api-'+action+'-'+object_id));}},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send("review_id="+object_id+"&apiaction="+action);return false;}
var searchuserhints=Array();var is_search_query_user_back=true;var ll_user_search_new=function(event,search_element,input_element,object_alias,object_id)
{if(event.keyCode==13||event.keyCode==38||event.keyCode==40)
{set_selection_user_search(event.keyCode,input_element);}
if(event.keyCode>=9&&event.keyCode<=27)return false;if(event.keyCode>=33&&event.keyCode<=46)return false;if(event.keyCode>=91&&event.keyCode<=93)return false;if(event.keyCode>=112&&event.keyCode<=157)return false;var width=$(search_element).style.width;var text=$(search_element).value.trim();if(text=='')
{$(input_element).innerHTML='';return;}
if(!is_search_query_user_back)return false;if(typeof searchuserhints[search_element]!='undefined'&&searchuserhints[search_element]==text)
{if($(input_element).style.display=='none')clicktoggle(input_element,$(search_element));return;}
searchuserhints[search_element]=text;is_search_query_user_back=false;if(!object_id)object_id=0;eventstop(event);new Request({url:'/main/usersearch',method:'post',data:{text:text,object_alias:object_alias,input_element:input_element,width:width,object_id:object_id},onComplete:function(json)
{is_search_query_user_back=true;json=strToJson(json);if(json.message&&json.error_code!=0)
{alert(json.message);return false;}
if(json.content)
{$(input_element).innerHTML=json.content;if($(input_element).style.display=='none')
{clicktoggle(input_element,$(search_element));}
if(text!=$(search_element).value.trim())
{ll_user_search_new({keyCode:158},search_element,input_element,object_alias,object_id);}}
return false;},onFailure:function()
{failure();}}).send();}
var set_selection_user_search=function(key_code,element)
{var elem=getElementsByName('a','hint-'+element);if(elem.length<=0)return false;var select_element=0;for(var i=0;i<elem.length;i++)
{if(elem[i].hasClass('selected'))
{select_element=i+1;var last_element=elem[i];}}
if(key_code==13&&select_element>0)
{$(element+'-hint-'+select_element).click();return false;}
if(key_code==40)
{select_element=select_element+1;}
if(key_code==38)
{select_element=select_element-1;}
var el=$(element+'-hint-'+select_element);if($(el)=='undefined'||$(el)==null)
{return false;}
else
{el.addClass('selected');if(!($(last_element)=='undefined'||$(last_element)==null))last_element.removeClass('selected');}}
var reset_select_user=function(element)
{var elem=getElementsByName('a','hint-'+element);if(elem.length<=0)return false;for(var i=0;i<elem.length;i++)
{elem[i].removeClass('selected');}}
function mob_personal_add(login,request_id)
{if(!$('request-'+request_id+'-pers')||!$('request-'+request_id+'-pers-cont'))return false;if($('request-'+request_id+'-pers-login-'+login))
{alert('Читатель уже добавлен!');return false;}
var span=new Element('span');span.innerHTML=$('request-'+request_id+'-pers').innerHTML.replace(/\$robot/g,login);$('request-'+request_id+'-pers-cont').appendChild(span);if($('request-'+request_id+'-pers-holder'))$('request-'+request_id+'-pers-holder').hide();if($('request-'+request_id+'-pers-input'))
{$('request-'+request_id+'-pers-input').value='';searchuserhints=Array();}}
function mob_send_curator(request_id)
{new Request({url:'/mob/curatorsend',method:'post',onComplete:function(json)
{json=strToJson(json);if(json.message&&json.error_code!=0)
{alert(json.message);return false;}
$('tinyalert').innerHTML+='<div id="server_okay_msg" class="green"><a href="javascript:void(0)" title="Закрыть" class="action a-close" onclick="this.getParent().hide();"><span class="i-clear"></span></a>Сообщение отправлено!</div>';if($('curator-comment-'+request_id))$('curator-comment-'+request_id).hide();if($('curator-comment-text-'+request_id))$('curator-comment-text-'+request_id).value='';return false;},onFailure:function()
{failure();}}).send($('curator-form-'+request_id));}
function mob_request_filter(request_id,filter)
{var value='Все';if(filter=='all')
{xshow('req-'+request_id+'-comments');xshow('req-'+request_id+'-responses');$$('.req-'+request_id+'-resp-status-active').show();$$('.req-'+request_id+'-resp-status-decline').show();$$('.req-'+request_id+'-resp-status-accept').show();value='Все';}
else if(filter=='responses')
{xhide('req-'+request_id+'-comments');xshow('req-'+request_id+'-responses');$$('.req-'+request_id+'-resp-status-active').show();$$('.req-'+request_id+'-resp-status-decline').show();$$('.req-'+request_id+'-resp-status-accept').show();value='Советы';}
else if(filter=='comments')
{xhide('req-'+request_id+'-responses');xshow('req-'+request_id+'-comments');value='Комментарии';}
else if(filter=='decline')
{xhide('req-'+request_id+'-comments');xshow('req-'+request_id+'-responses');$$('.req-'+request_id+'-resp-status-decline').show();$$('.req-'+request_id+'-resp-status-active').hide();$$('.req-'+request_id+'-resp-status-accept').hide();value='Отказы';}
else if(filter=='active')
{xhide('req-'+request_id+'-comments');xshow('req-'+request_id+'-responses');$$('.req-'+request_id+'-resp-status-active').show();$$('.req-'+request_id+'-resp-status-decline').hide();$$('.req-'+request_id+'-resp-status-accept').hide();value='Новые советы';}
else if(filter=='accept')
{xhide('req-'+request_id+'-comments');xshow('req-'+request_id+'-responses');$$('.req-'+request_id+'-resp-status-accept').show();$$('.req-'+request_id+'-resp-status-decline').hide();$$('.req-'+request_id+'-resp-status-active').hide();value='Принятые советы';}
if($('mob-responses-toggler-'+request_id))
{var title=$('mob-responses-toggler-'+request_id).getAttribute('title');if(title=='Показать советы')xtoggle2('mob-responses-'+request_id,'mob-responses-toggler-'+request_id,'Показать советы','Скрыть советы');}
$('target-request-filter-'+request_id).innerHTML='<span class="i-arrow-select-down" style="float:right;"></span>'+value;$('target-request-filter-'+request_id).setAttribute('title',value);$('div-request-filter-'+request_id).hide();}
function mob_request_cur(request_id)
{new Request({url:'/mob/requestcur',method:'post',onComplete:function(json)
{json=strToJson(json);if(json.message&&json.error_code!=0)
{alert(json.message);}
if(json.content&&$('curreq-'+request_id))
{$('curreq-'+request_id).innerHTML=json.content;}
return false;},onFailure:function()
{failure();}}).send('request_id='+request_id);}
function mob_req_cur_status(request_id,req_id,status)
{new Request({url:'/mob/requestcurstatus',method:'post',onComplete:function(json)
{json=strToJson(json);if(json.message&&json.error_code!=0)
{alert(json.message);}
if(json.content&&$('curreq-'+request_id))
{$('curreq-'+request_id).innerHTML=json.content;}
return false;},onFailure:function()
{failure();}}).send('request_id='+request_id+'&req_id='+req_id+'&status='+status);}
function mob_claim(request_id,response_id)
{response_id=response_id||0;var htmlname='_claim_form_'+request_id+'_'+response_id;var comments=$$('.textarea'+htmlname).get('value').toString();var type=$$('.select'+htmlname).get('value').toString();$('div'+htmlname).destroy();new Request({url:'/mob/claim',method:'post',data:{request_id:request_id,response_id:response_id,comments:comments,type:type},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
var color='green';if(json.error_code)color='red';if(json.message)$('tinyalert').innerHTML+='<div id="server_err_msg" class="'+color+'"><a href="javascript:void(0)" title="Закрыть" class="action a-close" onclick="this.getParent().hide();"><span class="i-clear"></span></a>'+json.message+'</div>';if(response_id==0&&$('req-claim-li-'+request_id))$('req-claim-li-'+request_id).dispose();if(response_id>0&&$('req-claim-li-response-'+response_id))$('req-claim-li-response-'+response_id).dispose();return false;},onFailure:function()
{failure();}}).send();}
function mob_claim_form(e,request_id,response_id)
{var coords=getMouseCoords(e);response_id=response_id||0;var htmlname='_claim_form_'+request_id+'_'+response_id;if($('div'+htmlname))
{$('div'+htmlname).destroy();return false;}
new Request({url:'/mob/claimform',method:'post',data:{request_id:request_id,response_id:response_id},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message&&json.error_code!=0)
{alert(json.message);return false;}
if(json.error_code==0)
{var container=$('body');if(container)
{var w=getClientWidth();if(coords['x']+500>w)coords['x']-=450;if(coords['x']<0)coords['x']=0;var div=new Element('div',{id:'div'+htmlname});var st='width:115px;position:absolute;top:'+(coords['y']+10)+'px;left:'+coords['x']+'px;';if(isIE())div.style.cssText=st;div.setAttribute('style',st);div.innerHTML=json.content;container.adopt(div);}}
return false;},onFailure:function()
{failure();}}).send();}
function mob_book_search(request_id)
{var search=$('input-search-book'+request_id)?$('input-search-book'+request_id).value:'';if(search==''||!search)
{alert('Укажите ссылку на книгу или название книги');return false;}
if($('result-search-'+request_id))
{$('result-search-'+request_id).show();$('result-search-'+request_id).innerHTML='<span id="loader-more" class="recloader" style=""></span>';if($('req-response-btn-'+request_id))$('req-response-btn-'+request_id).addClass('btn-event-gray');}
new Request({url:'/mob/booksearch',method:'post',data:{request_id:request_id,search:search},onComplete:function(json)
{json=strToJson(json);prepare(json);if($('loader-more'))$('loader-more').dispose();if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(json.content&&$('result-search-'+request_id))
{$('result-search-'+request_id).innerHTML=json.content;}
if($('req-response-btn-'+request_id))
{if(json.dont_read)
{$('req-response-btn-'+request_id).removeClass('btn-event-gray');if($('req-resp-book-'+request_id)&&json.edition_id)$('req-resp-book-'+request_id).value=json.edition_id;}
else
{$('req-response-btn-'+request_id).addClass('btn-event-gray');}}
return false;},onFailure:function()
{failure();}}).send();}
function mob_curator(mob_id,status)
{new Request({url:'/mob/curator',method:'post',data:{status:status,mob_id:mob_id},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.message&&json.error_code!=0)
{alert(json.message);return false;}
if(json.error_code==0)
{if(status=='active')
{if($('mob-curator-unactive-'+mob_id))$('mob-curator-unactive-'+mob_id).hide();if($('mob-curator-active-'+mob_id))$('mob-curator-active-'+mob_id).show();}
else
{if($('mob-curator-active-'+mob_id))$('mob-curator-active-'+mob_id).hide();if($('mob-curator-unactive-'+mob_id))$('mob-curator-unactive-'+mob_id).show();}}
return false;},onFailure:function()
{failure();}}).send();}
function mob_response_select(request_id,edition_id)
{if($('req-response-btn-'+request_id))$('req-response-btn-'+request_id).removeClass('btn-event-gray');var div=$('resp-book-find-'+request_id+'-'+edition_id);if($('result-search-'+request_id))
{$('result-search-'+request_id).innerHTML='';$('result-search-'+request_id).appendChild(div);}
if($('req-resp-book-'+request_id))$('req-resp-book-'+request_id).value=edition_id;if($('resp-book-find-'+request_id))$('resp-book-find-'+request_id).dispose();}
function mob_resp_just(response_id)
{new Request({url:'/mob/respjust',method:'post',data:{response_id:response_id},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if($('resp-just-a-'+response_id))
{$('resp-just-a-'+response_id).dispose();}
return false;},onFailure:function()
{failure();}}).send();}
function mob_request_toggle(type,el,target,mob_type)
{var hide_mob_req;var mob_type_value=mob_type||'hide_mob_req';if(type=='hide')
{$$('.response-toggle').hide();$$('.request-book-toggle').hide();$$('.request-text-toggle-a').show();$$('.request-book-toggle-a').show('inline-block');$$('.request-comment-full').hide();$$('.request-comment-brief').show();hide_mob_req=0;}
else if(type=='show')
{$$('.response-toggle').hide();$$('.request-book-toggle').show();$$('.request-text-toggle-a').hide();$$('.request-book-toggle-a').hide();$$('.request-comment-brief').hide();$$('.request-comment-full').show();hide_mob_req=1;}
else
{$$('.response-toggle').show();$$('.request-book-toggle').show();$$('.request-text-toggle-a').hide();$$('.request-book-toggle-a').hide();$$('.request-comment-brief').hide();$$('.request-comment-full').show();hide_mob_req=2;}
var elems=$$('.request-text-toggle');if(elems.length>0)
{for(var i=0;i<elems.length;i++)
{if(!elems[i])continue;elems[i].style.maxHeight=type=='hide'?'125px':'none';}}
var elems=$$('.response-toggle-a');if(elems.length>0)
{for(var i=0;i<elems.length;i++)
{if(!elems[i])continue;elems[i].innerHTML=type=='showall'?'Скрыть советы':'Показать советы';elems[i].setAttribute('title',type=='showall'?'Скрыть советы':'Показать советы');}}
var now=new Date();var time=now.getTime();time+=3600*24*7*1000;now.setTime(time);document.cookie=mob_type+'='+hide_mob_req+'; expires='+now.toUTCString();if($(target)&&$(el))
{$(target).innerHTML='<span class="i-arrow-select-down" style="float:right;"></span>'+$(el).innerHTML;$(target).setAttribute('title',$(el).innerHTML);}
if($('div-mob-filter'))$('div-mob-filter').hide();return false;}
function get_friends_readers(edition_id)
{new Request({url:'/book/getfriends',method:'post',onComplete:function(json)
{json=strToJson(json);if(json.content)
{$('friend-ratings').innerHTML=json.content;}
return false;},onFailure:function(){failure();}}).send('edition_id='+edition_id);}
var db_year='all';var db_type='all';function dashboard_set(type,value)
{var elems=$$('.tab-'+type);if(elems.length<=0)return false;for(var i=0;i<elems.length;i++)
{if(elems[i])elems[i].removeClass('active');}
if($('tab-'+type+'-'+value))$('tab-'+type+'-'+value).addClass('active');elems=$$('.db-'+type);for(var i=0;i<elems.length;i++)
{if(!elems[i])continue;var cln='';if(type=='type'&&db_year!='all')cln='db-year-'+db_year;else if(type=='year'&&db_type!='all')cln='db-type-'+db_type;if((elems[i].hasClass('db-'+type+'-'+value)||value=='all')&&(cln==''||elems[i].hasClass(cln)))
{elems[i].style.display=type=='stats'?'block':'table-cell';if(type=='year')elems[i].setAttribute('colspan',value!='all'||elems[i].hasClass('db-title')?5:1);}
else
{elems[i].hide();}}
if(type=='year')db_year=value;if(type=='type')db_type=value;}
function ll_ub_read_again_2017(edition_id,userbook_id,rand_id,checked,viewmode,old_userbook_id)
{if($('loader-more-'+edition_id+'-'+userbook_id))
{return false;}
var rand_html='-'+edition_id+'-'+(old_userbook_id&&old_userbook_id>0?old_userbook_id:userbook_id)+'-'+rand_id;$('ub-read-again-'+edition_id+'-span').innerHTML+='<span id="loader-more-'+edition_id+'-'+userbook_id+'" class="recloader" style="margin-left:20px;"></span>';new Request({url:'/user/bookreadagain',method:'post',data:{edition_id:edition_id,userbook_id:userbook_id,rand_id:rand_id,checked:checked,is_new_design:'ll2015b',viewmode:viewmode,old_userbook_id:old_userbook_id},onComplete:function(json)
{json=strToJson(json);if($('xa-main'+rand_html)&&json.content&&json.userbook_id)
{$('xa-main'+rand_html).innerHTML=json.content;var htmlname='-userbook-'+edition_id+'-'+json.userbook_id;hideonclick('xa-menu-'+edition_id+'-'+json.userbook_id,null,false,function(){if($('div'+htmlname))$('div'+htmlname).dispose();},'click',function(){ub_popup_close=true;});}
return false;},onFailure:function(){failure();}}).send();}
function genrebook_next(gallery)
{if(!gallery)return false;var genre_id=gallery.gallery.getAttribute('data-genre_id');var count=gallery.gallery.getAttribute('data-count');if(!genre_id)return false;var gallery_name=genre_id+'-'+count;if(llgallery[gallery_name]!=null&&llgallery[gallery_name]==0)return false;var start=llgallery[gallery_name]!=null?llgallery[gallery_name]+1:2;if(start==3)return false;var is_new_design=$('is-new-design')?$('is-new-design').value:0;new Request({url:'/genre/getbooklist',method:'post',data:{genre_id:genre_id,start:start,count:count,is_new_design:is_new_design},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(gallery&&json.content)
{gallery.itemsParent.innerHTML+=json.content;var elements=gallery.itemsParent.getElements('li');var index=0;for(var i=0;i<elements.length;i++)
{if(elements[i].style.display=='none')
{elements[i].dispose();index++;}
if(index==count)
{break;}}
gallery.reinitElements();}
llgallery[gallery_name]=start;if(json.end_data)
{llgallery[gallery_name]=0;}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function special_object_add(special_alias,object_alias)
{var link=$('object-new-link').value;if(!link)
{alert('Укажите ссылку на объект!');return false;}
var sort_no=$('object-new-sort').value;var selected=$('object-new-selected').checked;if(!sort_no&&!selected)
{alert('Укажите, будет ли объект закреплен и/или выделен!');return false;}
new Request({url:'/special/objectadd',method:'post',data:{special_alias:special_alias,object_alias:object_alias,link:link,sort_no:sort_no,selected:selected},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if(json.content&&$('special-object-new'))
{if(json.object_id&&$('special-object-'+json.object_id))$('special-object-'+json.object_id).dispose();$('special-object-new').innerHTML+=json.content;}
$('object-new-link').value='';$('object-new-sort').value='';$('object-new-selected').setAttribute('checked',false);return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function special_object_change(el,field,object_id)
{var value = field == 'selected' ? $(el).checked : $(el).value;new Request({url:'/special/objectchange',method:'post',data:{field:field,object_id:object_id,value:value},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
function special_object_delete(object_id)
{if(!confirm('Вы точно хотите удалить объект?'))return false;new Request({url:'/special/objectdelete',method:'post',data:{object_id:object_id},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
if($('special-object-'+object_id))$('special-object-'+object_id).dispose();return false;},onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send();}
var lazy_load=false;var callback_function='';function load_more_elements(element,callback){if(!element||lazy_load)
return false;lazy_load=true;var start_from=element.dataset.start_from;var limit=element.dataset.limit;var object_alias=element.dataset.object_alias;var spinner=new Element('span',{class:'ll-loader',id:object_alias+'-spinner'});spinner.inject(element);var add_param='';if(object_alias=='challenges_top')
add_param=element.dataset.year;new Request({method:'post',url:'/main/getmoreobjects',onComplete:function(json)
{json=strToJson(json);if(!json.error_code)
{element.innerHTML+=json.content;element.dataset.start_from=parseInt(element.dataset.start_from)+1;}
else if(json.error_code==1)
{element.onscroll=object_alias=='challenges_top'?function(){draw_link();}:'';}
$(object_alias + '-spinner').dispose();lazy_load=false;if(callback)callback_function=callback;if(typeof callback_function=='function')
{callback_function();}}}).send('start_from='+start_from+'&limit='+limit+'&object_alias='+object_alias+'&add_param='+add_param);}
function draw_link()
{var your_rect = $('your-mark').getBoundingClientRect();var wrapper_rect = $('challenges-wrapper').getBoundingClientRect();
if($('my-top-challenge'))
{var row_rect = $('my-top-challenge').getBoundingClientRect();var row_rect_height =  $('my-top-challenge').offsetHeight;}
else
{var row_rect = Array();row_rect.top = wrapper_rect.bottom;;var row_rect_height = 267;}
var y1 = your_rect.top - wrapper_rect.top + parseInt($('your-mark').offsetHeight/2);var y2 = (row_rect.top - wrapper_rect.top) + parseInt(row_rect_height/2);$('link-area').innerHTML = '<line x1="91" y1="'+ y1 +'" x2="115" y2="'+ y1 +'" style="stroke:rgb(255,100,103);stroke-width:1"></line><line x1="115" y1="'+ y1 +'" x2="115" y2="'+ y2 +'" style="stroke:rgb(255,100,103);stroke-width:1"></line><line x1="115" y1="'+ y2 +'" x2="143" y2="'+ y2 +'" style="stroke:rgb(255,100,103);stroke-width:1"></line>';
}
function selection_shares(selection_id)
{var elements=$$('.share-selected');if(elements.length<=0)
{alert('Выберите читателей, чтобы отправить им приглашение!');return false;}
var data={};for(var i=0;i<elements.length;i++)
{var login=elements[i].id?elements[i].id.substring(12):'';if(login!='')data[i]=login;}
new Request({url:'/selection/shareinvite',method:'post',data:{selection_id:selection_id,logins:data},onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.message)alert(json.message);return false;}
$('tinyalert').innerHTML+='<div id="server_okay_msg" class="green"><a href="javascript:void(0)" title="Закрыть" class="action a-close" onclick="this.getParent().hide();"><span class="i-clear"></span></a>Читатели приглашены в помощники</div>';group_shares_clear();return false;},onFailure:function()
{failure();}}).send();}
function change_book_author(id)
{var el=$('ab-'+id);if(!el){return false;}
var url=$('new-author-'+id).value;if(!url){return false;}
new Request({method:'post',url:'/book/changeauthor',onComplete:function(json)
{json=strToJson(json);if(json.error)
{alert(json.error);return false;}
if(json.status && json.status=='ok'){el.destroy();}}}).send('edition_id='+id+'&url='+encodeURIComponent(url));}
function add_jury()
{var reader = $('jury-new').value;
if (!reader) return false;   
new Request({method:'post',url:'/user/addjury',onComplete:
function (json){json = strToJson(json);
if (json.error){$('tinyalert').innerHTML += '<div class="red" onclick="this.hide();"><a href="javascript:void(0)" class="action a-close"><span class="i-clear"></span></a>' + json.error + '</div>';  
return false;}    
if (json.status && json.status == 'ok'){
$('tinyalert').innerHTML += '<div class="green" onclick="this.hide();"><a href="javascript:void(0)" class="action a-close"><span class="i-clear"></span></a>' + json.message + '</div>';  
$('jury-new').value = '';}}}).send('reader=' + encodeURIComponent(reader));}