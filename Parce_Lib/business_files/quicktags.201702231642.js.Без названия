
var ButtonListClass=new Class({initialize:function(event,elementclass)
{this.objList=Array();this.objListH=Array();this.objInitList=Array();this.objInitListOID=Array();this.objInitListEvent=Array();this.event=event;this.elementclass=elementclass;},addObject:function(button,event)
{this.objInitList.push(button);this.objInitListOID.push(button.id);this.objInitListEvent.push(event);},bindAll:function()
{for(i=0;i<this.objInitList.length;i++)
{this.objList[i]=this.objInitList[i];this.objListH[i]=this.objList[i][this.objInitListEvent[i]].bindWithEvent(this.objList[i]);if($(this.objInitListOID[i]))$(this.objInitListOID[i]).addEvent(this.event,this.objListH[i]);}},unbindAll:function()
{for(i=0;i<this.objInitList.length;i++)
{if($(this.objInitListOID[i]))
{$(this.objInitListOID[i]).removeEvent(this.event,this.objListH[i]);}}},clear:function()
{this.unbindAll();this.objList=Array();this.objListH=Array();this.objInitList=Array();this.objInitListOID=Array();this.objInitListEvent=Array();}});var edButton=new Class({initialize:function(editor,id,display,style,tagStart,tagEnd,access,open)
{this.editor=editor;this.id=id;this.display=display;this.style=style;this.tagStart=tagStart;this.tagEnd=tagEnd;this.access=access;this.open=open;},edInsertTag:function(){var myField=$(this.editor.edCanvas['id']);if(document.selection){myField.focus();sel=document.selection.createRange();if(sel.text.length>0){sel.text=this.tagStart+sel.text+this.tagEnd;}
else{if(!this.editor.edCheckOpenTags(this)||this.tagEnd==''){sel.text=this.tagStart;this.editor.edAddTag(this);}
else{sel.text=this.tagEnd;this.editor.edRemoveTag(this);}}
myField.focus();}
else if(myField.selectionStart||myField.selectionStart=='0'){var startPos=myField.selectionStart;var endPos=myField.selectionEnd;var cursorPos=endPos;var scrollTop=myField.scrollTop;if(startPos!=endPos){myField.value=myField.value.substring(0,startPos)
+this.tagStart
+myField.value.substring(startPos,endPos)
+this.tagEnd
+myField.value.substring(endPos,myField.value.length);cursorPos+=this.tagStart.length+this.tagEnd.length;}
else{if(!this.editor.edCheckOpenTags(this)||this.tagEnd==''){myField.value=myField.value.substring(0,startPos)
+this.tagStart
+myField.value.substring(endPos,myField.value.length);this.editor.edAddTag(this);cursorPos=startPos+this.tagStart.length;}
else{myField.value=myField.value.substring(0,startPos)
+this.tagEnd
+myField.value.substring(endPos,myField.value.length);this.editor.edRemoveTag(this);cursorPos=startPos+this.tagEnd.length;}}
myField.focus();myField.selectionStart=cursorPos;myField.selectionEnd=cursorPos;myField.scrollTop=scrollTop;}
else{if(!this.editor.edCheckOpenTags(this)||this.tagEnd==''){myField.value+=this.tagStart;this.editor.edAddTag(this);}
else{myField.value+=this.tagEnd;this.editor.edRemoveTag(this);}
myField.focus();}},edInsertIFrame:function(){var myField=$(this.editor.edCanvas['id']);var myValue=prompt('Ссылка на YouTube:','');if(myValue){myValue='<llvideo width="560" height="315">'+myValue+'</llvideo>';this.edInsertContent(myValue);}},edInsertContent:function(myValue,replaceText){if(replaceText=='undefined'||replaceText==null)replaceText=true;var myField=$(this.editor.edCanvas['id']);if(document.selection){myField.focus();sel=document.selection.createRange();sel.text=replaceText?myValue:myValue+sel.text;myField.focus();}
else if(myField.selectionStart||myField.selectionStart=='0'){if(!replaceText)myField.selectionEnd=myField.selectionStart;var startPos=myField.selectionStart;var endPos=myField.selectionEnd;var scrollTop=myField.scrollTop;myField.value=myField.value.substring(0,startPos)
+myValue
+myField.value.substring(endPos,myField.value.length);myField.focus();myField.selectionStart=startPos+myValue.length;myField.selectionEnd=startPos+myValue.length;myField.scrollTop=scrollTop;}else{myField.value+=myValue;myField.focus();}},edInsertLink:function(i,defaultValue){var myField=$(this.editor.edCanvas['id']);if(!defaultValue){defaultValue='http://';}
if(!this.editor.edCheckOpenTags(this)){var URL=prompt('URL:',defaultValue);if(URL){this.tagStart='<a href="'+URL+'">';this.edInsertTag(i);}}
else{this.edInsertTag(i);}},edInsertExtLink:function(i,defaultValue){var myField=$(this.editor.edCanvas['id']);if(!defaultValue){defaultValue='http://';}
if(!this.editor.edCheckOpenTags(this)){var URL=prompt('Enter the URL',defaultValue);if(URL){this.tagStart='<a href="'+URL+'" rel="external">';this.edInsertTag(i);}}
else{this.edInsertTag(i);}},edInsertImage:function(event)
{var myField=$(this.editor.edCanvas['id']);getpictures(myField.id,1,event);},edInsertBook:function(){var myField=$(this.editor.edCanvas['id']);var myValue=prompt('Идентификатор или ISBN книги:','');if(myValue){myValue='<book id="'+myValue+'">'
+prompt('Автор и название книги:','')
+'</book>';this.edInsertContent(myValue);}},edInsertReader:function(){var myField=$(this.editor.edCanvas['id']);var myValue=prompt('Логин читателя:','');if(myValue){myValue='<reader>'
+myValue
+'</reader>';this.edInsertContent(myValue);}},edInsertCut:function(){var myValue='<llcut>Дальше...</llcut>';this.edInsertContent(myValue,false);},edInsertIconBook:function(){var myValue='<llicon class="book">'+'</llicon>';this.edInsertContent(myValue,false);},edInsertIconAuthor:function(){var myValue='<llicon class="author">'+'</llicon>';this.edInsertContent(myValue,false);},edInsertIconReader:function(){var myValue='<llicon class="reader">'+'</llicon>';this.edInsertContent(myValue,false);},edInsertIconSelection:function(){var myValue='<llicon class="selection">'+'</llicon>';this.edInsertContent(myValue,false);},edInsertIconCharacter:function(){var myValue='<llicon class="character">'+'</llicon>';this.edInsertContent(myValue,false);},edInsertIconFilm:function(){var myValue='<llicon class="film">'+'</llicon>';this.edInsertContent(myValue,false);},edInsertFootnote:function(){var myField=$(this.editor.edCanvas['id']);var note=prompt('Enter the footnote:','');if(!note||note==''){return false;}
var now=new Date;var fnId='fn'+now.getTime();var fnStart=$(this.editor.edCanvas['id']).value.indexOf('<ol class="footnotes">');if(fnStart!=-1){var fnStr1=$(this.editor.edCanvas['id']).value.substring(0,fnStart)
var fnStr2=$(this.editor.edCanvas['id']).value.substring(fnStart,$(this.editor.edCanvas['id']).value.length)
var count=countInstances(fnStr2,'<li id="')+1;}
else{var count=1;}
var count='<sup><a href="#'+fnId+'n" id="'+fnId+'" class="footnote">'+count+'</a></sup>';this.edInsertContent(count);if(fnStart!=-1){fnStr1=$(this.editor.edCanvas['id']).value.substring(0,fnStart+count.length)
fnStr2=$(this.editor.edCanvas['id']).value.substring(fnStart+count.length,$(this.editor.edCanvas['id']).value.length)}
else{var fnStr1=$(this.editor.edCanvas['id']).value;var fnStr2="\n\n"+'<ol class="footnotes">'+"\n"
+'</ol>'+"\n";}
var footnote='    <li id="'+fnId+'n">'+note+' [<a href="#'+fnId+'">back</a>]</li>'+"\n"
+'</ol>';$(this.editor.edCanvas['id']).value=fnStr1+fnStr2.replace('</ol>',footnote);},countInstances:function(string,substr){var count=string.split(substr);return count.length-1;},edPreview:function()
{this.editor.edPreview();},edCancel:function()
{this.editor.edCancel();},edSave:function()
{this.editor.edSave();},edClear:function()
{this.editor.edClear();}});var edLink=new Class({initialize:function(display,URL,newWin)
{this.display=display;this.URL=URL;if(!newWin){newWin=0;}
this.newWin=newWin;}});var TextEditorClass=new Class({initialize:function(id,llcut,llicons,storage_id,onCancel,onSave){this.id=id;this.storage_id=storage_id;this.onCancel=onCancel;this.onSave=onSave;this.text=this.storage_id!=undefined?$(this.storage_id).value:'';this.llcut=llcut;this.llicons=llicons;this.buttonList=new ButtonListClass('click',edButton);this.objsToBind=new Array();this.edButtons=new Array();this.edControls=new Array();this.edOpenTags=new Array();this.design=$('texteditor-design')?$('texteditor-design').value:'';this.showPreview=1;this.previewButton='';this.clearButton='';this.initButtons();this.edCanvas={'id':this.id+'-canvas','name':this.id+'-canvas'};this.edPreviewArea=this.id+'-preview';this.showSaveCancelButtons=true;},activate:function(container_id){this.container_id=container_id;if(this.design=='ll2015b')
{$(container_id).innerHTML='<div class="text-editor-container" id="'+this.id+'-ed_editor"><div class="editor-textarea">'+
this.edTextArea()+'<div class="text-editor-separator"></div>'+'<span>'+
this.edToolbar()+'</span></div>'+
this.edControlBar()+
(this.showPreview==1?'<div class="ed_preview" id="'+this.edPreviewArea+'" style="display:none"></div>':'')+'</div>';}
else
{$(container_id).innerHTML='<div id="'+this.id+'-ed_editor"><span>'+
this.edToolbar()+
this.edTextArea()+
this.edControlBar()+'</span></div>'+'<div class="ed_preview" id="'+this.edPreviewArea+'" style="display:none"></div>';}
if(this.previewButton&&this.previewButton!='undefined'&&$(this.previewButton))
{this.buttonList.addObject(new edButton(this,this.previewButton,'','','','','',-1),'edPreview');}
if(this.clearButton&&this.clearButton!='undefined'&&$(this.clearButton))
{this.buttonList.addObject(new edButton(this,this.clearButton,'','','','','',-1),'edClear');}
this.buttonList.bindAll();},expand:function(canvas_options){var container=new Element('div',{'id':this.id+'-container'});var main_id=this.id;container.onkeydown=function(e)
{if(!e)var e=window.event;if((e.keyCode==66||e.keyCode==73||e.keyCode==85||e.keyCode==89)&&e.ctrlKey==true)
{if(e.keyCode==66)$(main_id+'-ed_bold').click();else if(e.keyCode==73)$(main_id+'-ed_italic').click();else if(e.keyCode==85)$(main_id+'-ed_under').click();else if(e.keyCode==89)$(main_id+'-ed_youtube').click();e.preventDefault();}};this.text=$(canvas_options['id']).value;container.injectAfter(canvas_options['id']);var preview=$(canvas_options['id']).getAttribute('data-preview');this.showPreview=preview!=null&&preview!=undefined?preview:1;this.previewButton=$(canvas_options['id']).getAttribute('data-preview-button');this.clearButton=$(canvas_options['id']).getAttribute('data-clear-button');$(canvas_options['id']).dispose();this.edCanvas=canvas_options;this.showSaveCancelButtons=false;this.activate(this.id+'-container');},deactivate:function(){this.buttonList.clear();$(this.container_id).innerHTML='';},edTextArea:function(){var options='';for(var obj in this.edCanvas)
{options+=obj+'="'+this.edCanvas[obj]+'" ';}
var result=(this.design=='ll2015b'?'':'<br />')+'<textarea'+(this.design=='ll2015b'&&this.text==''?' placeholder="..."':'')+' class="ed_textarea" '+options+'>'+this.text+'</textarea><br />'+
(this.design=='ll2015b'?'':('<div style="height: 9px; text-align: center" id="resizer-'+this.edCanvas['id']+'" onmousemove="Resize.init(\''+this.edCanvas['id']+'\', this.id);"><img width="5" height="9" src="https://s.livelib.ru/img/resizer.gif" /></div>'));return result;},edControlBar:function(){var result='';if(this.design=='ll2015b')
{if(this.showPreview==0)return result;var result='<div>';for(i=0;i<this.edControls.length;i++){result+=this.edShowButton(this.edControls[i][0]);}
result+='</div>';}
else
{var result='<div style="margin-top: -13px">';for(i=0;i<this.edControls.length;i++){result+=this.edShowButton(this.edControls[i][0]);}
result+='</div>';}
return result;},initButtons:function(){if(this.design=='ll2015b')
{this.edButtons=[[new edButton(this,this.id+'-ed_bold','B','font-size:16px;font-weight:700;margin-left:-6px;','<b>','</b>','b',0),'edInsertTag'],[new edButton(this,this.id+'-ed_italic','I','font-size:16px;font-weight:700;','<i>','</i>','i',0),'edInsertTag'],[new edButton(this,this.id+'-ed_under','U','font-size:16px;font-weight:700;','<u>','</u>',0),'edInsertTag'],[new edButton(this,this.id+'-ed_block','Цитата','min-width:55px;','<blockquote>','</blockquote>','q',0),'edInsertTag'],[new edButton(this,this.id+'-ed_link','Ссылка','min-width:55px;','','</a>','a',0),'edInsertLink'],[new edButton(this,this.id+'-ed_book','Книга','','','','k',-1),'edInsertBook'],[new edButton(this,this.id+'-ed_reader','Читатель','','','','r',-1),'edInsertReader'],[new edButton(this,this.id+'-ed_picture','Картинка','','','','',-1),'edInsertImage'],[new edButton(this,this.id+'-ed_youtube',' YouTube ','','','','y',0),'edInsertIFrame']];}
else
{this.edButtons=[[new edButton(this,this.id+'-ed_bold',' B ','','<b>','</b>','b',0),'edInsertTag'],[new edButton(this,this.id+'-ed_italic',' I ','','<i>','</i>','i',0),'edInsertTag'],[new edButton(this,this.id+'-ed_under',' U ','','<u>','</u>',0),'edInsertTag'],[new edButton(this,this.id+'-ed_block','цитата','','<blockquote>','</blockquote>','q',0),'edInsertTag'],[new edButton(this,this.id+'-ed_link','ссылка','','','</a>','a',0),'edInsertLink'],[new edButton(this,this.id+'-ed_book','книга','','','','k',-1),'edInsertBook'],[new edButton(this,this.id+'-ed_reader','читатель','','','','r',-1),'edInsertReader'],[new edButton(this,this.id+'-ed_picture','картинка','','','','',-1),'edInsertImage'],[new edButton(this,this.id+'-ed_youtube',' YouTube ','','','','y',0),'edInsertIFrame']];}
if(this.llcut)
{this.edButtons.push([new edButton(this,this.id+'-ed_cut',' &nbsp; ','width: 32px; background-image: url(http://s.livelib.ru/img/icons/blue-document-broken.png); background-position: center; background-repeat: no-repeat;','','','',-1),'edInsertCut']);}
if(this.llicons)
{var addname=this.design=='ll2015b'?'2015':'';this.edButtons.push([new edButton(this,this.id+'-ed_ibook',' &nbsp; ','width: 32px; background-image: url(http://s.livelib.ru/img/icons/book'+addname+'.png); background-position: center; background-repeat: no-repeat;','','','',-1),'edInsertIconBook']);this.edButtons.push([new edButton(this,this.id+'-ed_iauthor',' &nbsp; ','width: 32px; background-image: url(http://s.livelib.ru/img/icons/author'+addname+'.png); background-position: center; background-repeat: no-repeat;','','','',-1),'edInsertIconAuthor']);this.edButtons.push([new edButton(this,this.id+'-ed_iselection',' &nbsp; ','width: 32px; background-image: url(http://s.livelib.ru/img/icons/selection'+addname+'.png); background-position: center; background-repeat: no-repeat;','','','',-1),'edInsertIconSelection']);this.edButtons.push([new edButton(this,this.id+'-ed_ireader',' &nbsp; ','width: 32px; background-image: url(http://s.livelib.ru/img/icons/reader'+addname+'.png); background-position: center; background-repeat: no-repeat;','','','',-1),'edInsertIconReader']);this.edButtons.push([new edButton(this,this.id+'-ed_icharacter',' &nbsp; ','width: 32px; background-image: url(http://s.livelib.ru/img/icons/character'+addname+'.png); background-position: center; background-repeat: no-repeat;','','','',-1),'edInsertIconCharacter']);this.edButtons.push([new edButton(this,this.id+'-ed_ifilm',' &nbsp; ','width: 32px; background-image: url(http://s.livelib.ru/img/icons/film'+addname+'.png); background-position: center; background-repeat: no-repeat;','','','',-1),'edInsertIconFilm']);}
for(i=0;i<this.edButtons.length;i++)
{if(this.edButtons[i]!='undefined')
{this.buttonList.addObject(this.edButtons[i][0],this.edButtons[i][1]);}}
this.edControls=this.showSaveCancelButtons?[[new edButton(this,this.id+'-ed_cancel','Отменить','','','','',-1),'edCancel'],[new edButton(this,this.id+'-ed_preview','Просмотреть','','','','',-1),'edPreview'],[new edButton(this,this.id+'-ed_save','Сохранить','','','','',-1),'edSave'],]:[[new edButton(this,this.id+'-ed_preview','Просмотреть','','','','',-1),'edPreview']];for(i=0;i<this.edControls.length;i++)
{this.buttonList.addObject(this.edControls[i][0],this.edControls[i][1]);}},edShowButton:function(button){var accesskey=button.access?' accesskey="'+button.access+'"':'';var style=button.style?' style="'+button.style+'"':'';if(this.design=='ll2015b')
{return'<a href="javascript:void(0);" id="'+button.id+'" '+accesskey+style+' class="textarea-button" title="'+button.display+'" />'+button.display+'</a>';}
else
{return'<input type="button" id="'+button.id+'" '+accesskey+style+' class="ed_button" value="'+button.display+'" />';}},edAddTag:function(button){if(button.tagEnd!=''){this.edOpenTags[this.edOpenTags.length]=button;if(this.design=='ll2015b')
{$(button.id).innerHTML='/'+$(button.id).innerHTML;$(button.id).addClass('ed-active');}
else $(button.id).value='/'+$(button.id).value;}},edRemoveTag:function(button){for(i=0;i<this.edOpenTags.length;i++){if(this.edOpenTags[i].id==button.id){this.edOpenTags.splice(i,1);if(this.design=='ll2015b')
{$(button.id).innerHTML=$(button.id).innerHTML.replace('/','');$(button.id).removeClass('ed-active');}
else $(button.id).value=$(button.id).value.replace('/','');}}},edCheckOpenTags:function(button){var tag=0;for(i=0;i<this.edOpenTags.length;i++){if(this.edOpenTags[i].id==button.id){tag++;}}
if(tag>0){return true;}
else{return false;}},edCloseAllTags:function(){var count=this.edOpenTags.length;for(o=0;o<count;o++){this.edInsertTag(this.edOpenTags[edOpenTags.length-1]);}},edToolbar:function(){var result='';for(i=0;i<this.edButtons.length;i++){result+=this.edShowButton(this.edButtons[i][0]);if(this.design=='ll2015b')
{result+='<span class="button-delimiter"></span>';}}
return result;},processUpdate:function(originalRequest)
{data=strToJson(originalRequest);if(data.message)
{messageobj.display(data.message);return;}
$(this.edPreviewArea).innerHTML=data.html.replace(/\n/g,"<br>");xshow(this.edPreviewArea);},edPreview:function(){url='/service/parsehtml';pars='text='+strToQueryString($(this.edCanvas['id']).value);new Request({url:url,method:'post',onComplete:this.processUpdate.bind(this),onRequest:initAd,onSuccess:closeAd,onFailure:failure}).send(pars);return false;},edCancel:function(){this.deactivate();if(this.onCancel!=undefined)
{onCancel.call(this);}},edSave:function(){if($(this.storage_id)!=undefined)
{$(this.storage_id).value=$(this.edCanvas['id']).value;}
this.deactivate();if(this.onCancel!=undefined)
{onSave.call(this,$(this.edCanvas['id']).value);}},edClear:function(){if($(this.edCanvas.id))$(this.edCanvas.id).value='';}});