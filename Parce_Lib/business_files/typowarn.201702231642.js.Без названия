
var selected_text,full_text,selection_start,selection_end,context='';var check_event=function(e){if(!e)e=window.event;if(!document.getElementById('form-typo')&&(e.ctrlKey)&&((e.keyCode==10)||(e.keyCode==13))){check_selected_text();}}
var check_selected_text=function(){var txt_values=get_selected_text();if(txt_values.selected_text.length>200){alert('Выделенный текст слишком большой!');}
else if(txt_values.selected_text.length>0){context=get_context_selected(txt_values);init_type_form();}}
var get_selected_text=function(){if(window.getSelection){txt=window.getSelection();selected_text=txt.toString();full_text=txt.anchorNode.textContent;selection_start=txt.anchorOffset>txt.focusOffset?txt.focusOffset:txt.anchorOffset;selection_end=txt.anchorOffset>txt.focusOffset?txt.anchorOffset:txt.focusOffset;}
else if(document.getSelection){txt=document.getSelection();selected_text=txt.toString();full_text=txt.anchorNode.textContent;selection_start=txt.anchorOffset>txt.focusOffset?txt.focusOffset:txt.anchorOffset;selection_end=txt.anchorOffset>txt.focusOffset?txt.anchorOffset:txt.focusOffset;}
else if(document.selection){txt=document.selection.createRange();selected_text=txt.text;full_text=txt.parentElement().innerText;var stored_range=txt.duplicate();stored_range.moveToElementText(txt.parentElement());stored_range.setEndPoint('EndToEnd',txt);selection_start=stored_range.text.length-txt.text.length;selection_end=selection_start+selected_text.length;}
else{return;}
var txt={selected_text:selected_text,full_text:full_text,selection_start:selection_start,selection_end:selection_end};return txt;}
var get_context_selected=function(txt){selection_start=txt.selection_start;selection_end=txt.selection_end;var context=txt.full_text;var context_first=context.substring(0,selection_start);var context_second=context.substring(selection_start,selection_end);var context_third=context.substring(selection_end,context.length);context=context_first+'<strong>'+context_second+'</strong>'+context_third;var context_start=selection_start-60;if(context_start<0){context_start=0;}
var context_end=selection_end+60;if(context_end>context.length){context_end=context.length;}
context=context.substring(context_start,context_end);context_start=context.indexOf(' ')+1;if(selection_start+60<context.length){context_end=context.lastIndexOf(' ',selection_start+60);}
else{context_end=context.length;}
selection_start=context.indexOf('<strong>');if(context_start>selection_start){context_start=0;}
if(context_start){context=context.substring(context_start,context_end);}
return context;}
var init_type_form=function(){new Request({url:'/main/checktypotask',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);var is_captcha=false
if(!json.is_register&&json.counter&&(json.counter+1)%3==0)
{is_captcha=true;}
var block_fade=document.createElement('div');block_fade.style.cssText='width: 100%; height: 100%; position: fixed; background: url('+(document.location.protocol=='https'?'https':'http')+'://s.livelib.ru/img/popup-bg.png); z-index: 1000;';var block_form=document.createElement('div');block_form.style.cssText='width: 350px; height: auto; position: fixed; top: 50%; left: 50%; margin-top: -200px; margin-left: -175px;background-color:#f5f5f7; z-index: 1002;padding:40px 20px; box-sizing: border-box; overflow: auto;'
block_form.setAttribute('id','form-typo-container');var close_span=document.createElement('span');close_span.style.cssText='cursor: pointer; position: absolute;right: 10px;top: 10px;display: block;width: 11px;height: 11px;background: url(https://s.livelib.ru/img/skins/ll2015b/icons32.png) no-repeat -64px -265px;';var span_text_page=document.createElement('span');span_text_page.style.cssText='display: block;line-height: 20px;margin-bottom: 5px;';span_text_page.innerHTML='Адрес страницы:';var page_input=document.createElement('input');page_input.style.cssText='width: 100%;padding: 5px;box-sizing: border-box;margin-bottom: 15px;border-radius: 3px;border: 1px solid #ccc;';page_input.setAttribute('readonly','readonly');page_input.setAttribute('name','location');page_input.setAttribute('value',window.location.href);var span_text_typo=document.createElement('span');span_text_typo.style.cssText='display: block;line-height: 20px;margin-bottom: 5px;';span_text_typo.innerHTML='Ошибка:';var typo_block=document.createElement('div');typo_block.style.cssText='line-height:20px;margin-bottom:15px;background-image: -webkit-linear-gradient(top,#fcf8e3 0,#f8efc0 100%);background-image: -o-linear-gradient(top,#fcf8e3 0,#f8efc0 100%);background-image: -webkit-gradient(linear,left top,left bottom,from(#fcf8e3),to(#f8efc0));background-image: linear-gradient(to bottom,#fcf8e3 0,#f8efc0 100%);filter: progid:DXImageTransform.Microsoft.gradient(startColorstr="#fffcf8e3", endColorstr="#fff8efc0", GradientType=0);background-repeat: repeat-x;border: 1px solid #f5e79e;border-radius: 3px;padding: 5px;';typo_block.innerHTML=context;var typo_hidden_input=document.createElement('input');typo_hidden_input.setAttribute('type','hidden');typo_hidden_input.setAttribute('value',context);typo_hidden_input.setAttribute('name','typo');var span_comment=document.createElement('span');span_comment.style.cssText='display: block;line-height: 20px;margin-bottom: 5px;';span_comment.innerHTML='Комментарий:';var textarea=document.createElement('textarea');textarea.setAttribute('rows','5');textarea.setAttribute('name','comment');textarea.style.cssText='width: 100%;margin-bottom: 15px;max-width: 100%;border: 1px solid #ccc;border-radius: 3px;padding: 5px;box-sizing: border-box;';var input_submit=document.createElement('input');input_submit.setAttribute('type','submit');input_submit.setAttribute('class','btn100');input_submit.setAttribute('value','Сохранить');input_submit.style.cssText='display: block; margin: 0 auto;'
var typo_form=document.createElement('form');typo_form.setAttribute('id','form-typo');typo_form.setAttribute('method','post');typo_form.setAttribute('onsubmit','typosend(); return false;');block_form.appendChild(close_span);block_form.appendChild(span_text_page);block_form.appendChild(page_input);block_form.appendChild(span_text_typo);block_form.appendChild(typo_block);block_form.appendChild(span_comment);block_form.appendChild(textarea);if(is_captcha)
{var typo_captcha=document.createElement('img');typo_captcha.setAttribute('id','typo-captcha');typo_captcha.setAttribute('src','/service/captcha/typotask');typo_captcha.style.cssText='vertical-align: -10px;';var typo_captcha_input=document.createElement('input');typo_captcha_input.setAttribute('id','typo-captcha-input');typo_captcha_input.setAttribute('name','captcha');typo_captcha_input.setAttribute('placeholder','Текст с картинки');typo_captcha_input.style.cssText='width: 80%;padding: 5px;box-sizing: border-box;margin-bottom: 15px;border-radius: 3px;border: 1px solid rgb(204, 204, 204); margin-right: 12px';block_form.appendChild(typo_captcha_input);block_form.appendChild(typo_captcha);}
block_form.appendChild(input_submit);block_form.appendChild(typo_hidden_input);typo_form.appendChild(block_form);block_fade.appendChild(typo_form);close_span.addEventListener('click',function(){block_fade.parentNode.removeChild(block_fade)});document.body.appendChild(block_fade);document.body.insertBefore(block_fade,document.body.firstChild);}}).send();}
var typosend=function()
{var form_send=$('form-typo');new Request({url:'/main/savetypotask',method:'post',onComplete:function(json)
{json=strToJson(json);prepare(json);if(json.error_code)
{if(json.error_code==-1)
{var typo_captcha_input=document.getElementById('typo-captcha-input');var typo_captcha=document.getElementById('typo-captcha');typo_captcha_input.innerHTML='';typo_captcha.setAttribute('src','/service/captcha/typotask');}
alert(json.message);return false;}
var close_span=document.createElement('span');close_span.style.cssText='cursor: pointer; position: absolute;right: 10px;top: 10px;display: block;width: 11px;height: 11px;background: url(https://s.livelib.ru/img/skins/ll2015b/icons32.png) no-repeat -64px -265px;';close_span.addEventListener('click',function(){document.body.removeChild(document.body.firstChild)});var typo_form_container=document.getElementById('form-typo-container');typo_form_container.innerHTML=json.message;typo_form_container.appendChild(close_span);return false;}}).send(form_send);}
document.onkeypress=function(e){check_event(e)};